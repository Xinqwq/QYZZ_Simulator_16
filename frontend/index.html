<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>青云之志 算分器</title>
    <style>
      :root{
        --bg:#F2F2F0;        /* 雾灰 */
        --text:#3F3F3A;      /* 暖灰 */
        --muted:#7C7C75;     /* 次文本 */
        --card:#FFFFFF;      /* 卡片底 */
        --line:#E1E1DC;      /* 线条 */
        --primary:#9AA3A0;   /* 莫兰迪绿灰 */
        --primary-strong:#6F7976;
        --accent:#C4B7A6;    /* 莫兰迪米杏 */
        --accent-light:rgba(196, 183, 166, 0.1);  /* 浅色强调 */
        --accent-hover:rgba(196, 183, 166, 0.2);  /* 悬停强调 */
        --ok:#B7D0C5;        /* 莫兰迪绿 */
        --warn:#E3C9A8;      /* 莫兰迪杏 */
        --danger:#D9B8B6;    /* 莫兰迪粉 */
        --radius:10px;
        --gap:0px;
        /* 次数列样式变量 */
        --count-cell-bg:rgba(154, 163, 160, 0.1);
        --count-cell-border:rgba(154, 163, 160, 0.3);
        --count-cell-text:#3F3F3A;
        --count-cell-hover-bg:rgba(154, 163, 160, 0.15);
      }
      
      /* 配色方案 */
      .theme-16QwQ {
        --bg:#F0F8FF; --text:#2C3E50; --muted:#7F8C8D; --card:#FFFFFF; --line:#D5DBDB;
        --primary:#73CCFF; --primary-strong:#5BB3FF; --accent:#ACF06D; --accent-light:rgba(172, 240, 109, 0.1); --accent-hover:rgba(172, 240, 109, 0.2); --ok:#E8A469; --warn:#F0DF6D; --danger:#AC9076;
        --count-cell-bg:rgba(115, 204, 255, 0.1); --count-cell-border:rgba(115, 204, 255, 0.3); --count-cell-text:#2C3E50; --count-cell-hover-bg:rgba(115, 204, 255, 0.15);
      }
      .theme-buxingshx {
        --bg:#F0FFF0; --text:#2F4F2F; --muted:#696969; --card:#FFFFFF; --line:#DCDCDC;
        --primary:#00E874; --primary-strong:#00CC66; --accent:#00B0F0; --accent-light:rgba(0, 176, 240, 0.1); --accent-hover:rgba(0, 176, 240, 0.2); --ok:#B6FF47; --warn:#EEFF00; --danger:#FF6B6B;
        --count-cell-bg:rgba(0, 232, 116, 0.1); --count-cell-border:rgba(0, 232, 116, 0.3); --count-cell-text:#2F4F2F; --count-cell-hover-bg:rgba(0, 232, 116, 0.15);
      }
      .theme-life {
        --bg:#F8F9FF; --text:#4A4A6A; --muted:#8A8A9A; --card:#FFFFFF; --line:#E8E8F0;
        --primary:#A5EAFF; --primary-strong:#8DD8FF; --accent:#9EC4F6; --accent-light:rgba(158, 196, 246, 0.1); --accent-hover:rgba(158, 196, 246, 0.2); --ok:#BEFFF8; --warn:#E1DCFC; --danger:#D2C0F9;
        --count-cell-bg:rgba(165, 234, 255, 0.1); --count-cell-border:rgba(165, 234, 255, 0.3); --count-cell-text:#4A4A6A; --count-cell-hover-bg:rgba(165, 234, 255, 0.15);
      }
      .theme-purple {
        --bg:#F5FFF5; --text:#2F4F2F; --muted:#696969; --card:#FFFFFF; --line:#E0E0E0;
        --primary:#65BFBE; --primary-strong:#4A9B9A; --accent:#DEEDA1; --accent-light:rgba(222, 237, 161, 0.1); --accent-hover:rgba(222, 237, 161, 0.2); --ok:#BDE031; --warn:#FFF200; --danger:#008F75;
        --count-cell-bg:rgba(101, 191, 190, 0.1); --count-cell-border:rgba(101, 191, 190, 0.3); --count-cell-text:#2F4F2F; --count-cell-hover-bg:rgba(101, 191, 190, 0.15);
      }
      .theme-rainbow {
        --bg:#FFF8F0; --text:#4A3C2A; --muted:#8A7A6A; --card:#FFFFFF; --line:#F0E0D0;
        --primary:#FFB78C; --primary-strong:#FFA066; --accent:#FFF08C; --accent-light:rgba(255, 240, 140, 0.1); --accent-hover:rgba(255, 240, 140, 0.2); --ok:#BBFF8C; --warn:#8CFFCE; --danger:#BD8CFF;
        --count-cell-bg:rgba(255, 183, 140, 0.1); --count-cell-border:rgba(255, 183, 140, 0.3); --count-cell-text:#4A3C2A; --count-cell-hover-bg:rgba(255, 183, 140, 0.15);
      }
      .theme-wonderful {
        --bg:#191A1E; --text:#968d8d; --muted:#c25252; --card:#c9c9d8; --line:#FF3B3E;
        --primary:#FF3B3E; --primary-strong:#E03437; --accent:#FF8657; --accent-light:rgba(255, 134, 87, 0.1); --accent-hover:rgba(255, 134, 87, 0.2); --ok:#FFBA70; --warn:#FF8657; --danger:#FF3B3E;
        --count-cell-bg:rgba(255, 59, 62, 0.1); --count-cell-border:rgba(255, 59, 62, 0.3); --count-cell-text:#968d8d; --count-cell-hover-bg:rgba(255, 59, 62, 0.15);
      }
      .theme-16yyds {
        --bg:#E5FD56; --text:#2D3A1A; --muted:#779149; --card:#f6ffc1; --line:#C6DC74;
        --primary:#95a3f3; --primary-strong:#D1F33A; --accent:#C6DC74; --accent-light:rgba(198, 220, 116, 0.1); --accent-hover:rgba(198, 220, 116, 0.2); --ok:#A8BB92; --warn:#899AB0; --danger:#6A79CE;
        --count-cell-bg:rgba(149, 163, 243, 0.1); --count-cell-border:rgba(149, 163, 243, 0.3); --count-cell-text:#2D3A1A; --count-cell-hover-bg:rgba(149, 163, 243, 0.15);
      }
      
      .theme-selector {
        display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
      }
      .theme-option {
        display: flex; align-items: center; gap: 6px; padding: 6px 10px; 
        border: 2px solid var(--line); border-radius: 20px; cursor: pointer; 
        transition: all 0.2s; font-size: 12px; background: var(--card);
      }
      .theme-option:hover { border-color: var(--primary); }
      .theme-option.active { border-color: var(--primary); background: var(--primary); color: white; }
      .theme-colors {
        display: flex; gap: 3px;
      }
      .theme-color {
        width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1);
      }
      
      /* 数字输入按钮样式 */
      .number-input-group {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .number-btn {
        width: 24px; height: 24px;
        border: 1px solid var(--line);
        background: var(--card);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        color: var(--text);
        transition: all 0.15s;
      }
      .number-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .number-input-group input[type="number"] {
        flex: 1;
        text-align: center;
        padding: 4px 6px;
        font-size: 12px;
      }
      
      /* 配置区块样式 */
      .config-block {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 12px;
        min-height: 200px;
        position: relative;
      }
      .config-block h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--text);
        border-bottom: 1px solid var(--line);
        padding-bottom: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .config-block .block-toggle {
        font-size: 16px;
        font-weight: bold;
        color: var(--muted);
        transition: transform 0.2s;
        margin-left: 8px;
      }
      .config-block.collapsed .block-toggle {
        transform: rotate(-90deg);
      }
      
      /* 区块选择器样式 */
      .block-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
        padding: 12px;
        background: transparent;
        border: none;
        border-radius: 8px;
      }
      .block-btn {
        padding: 6px 12px;
        border: 1px solid var(--line);
        background: var(--card);
        color: var(--text);
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      .block-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .block-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .block-btn.active:hover {
        background: var(--primary-strong);
        border-color: var(--primary-strong);
      }
      
      /* 隐藏/显示区块 */
      .config-block.hidden {
        display: none;
      }
      
      /* 精度按钮样式 */
      .precision-buttons {
        display: flex;
        gap: 4px;
      }
      .precision-btn {
        padding: 4px 12px;
        border: 1px solid var(--line);
        background: var(--card);
        color: var(--text);
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .precision-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .precision-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .config-block .block-content {
        transition: all 0.3s ease;
        overflow: hidden;
      }
      .config-block.collapsed .block-content {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
      }
      .config-block .block-content.expanded {
        max-height: none;
        opacity: 1;
      }
      
      /* 统一input和label布局 */
      .config-block label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 12px;
        color: var(--text);
      }
      .config-block label > * {
        flex-shrink: 0;
      }
      .config-block label input,
      .config-block label select {
        flex: 1;
        min-width: 0;
      }
      
      /* 数据小助手样式 */
      .data-helper {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
      }
      .data-helper h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--text);
        border-bottom: 1px solid var(--line);
        padding-bottom: 6px;
      }
      .data-table {
        font-size: 11px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--line);
        border-radius: 4px;
      }
      .data-table table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th,
      .data-table td {
        padding: 4px 6px;
        text-align: center;
        border-bottom: 1px solid var(--line);
      }
      .data-table th {
        background: var(--accent);
        font-weight: 600;
        color: var(--text);
        position: sticky;
        top: 0;
      }
      .data-table td {
        color: var(--text);
      }
      
      /* 未来关卡预测作为子模块的样式适配 */
      .config-block[data-block="predict"] .card-header {
        background: transparent; border: none; padding: 0; margin: 0 0 8px 0;
      }
      .config-block[data-block="predict"] .card-header h4 {
        margin: 0; font-size: 14px; color: var(--text);
      }
      .config-block[data-block="predict"] .card-header .card-toggle {
        padding: 2px 6px; font-size: 12px; border-radius: 4px; color: var(--muted);
      }
      .config-block[data-block="predict"] .card-content {
        padding: 0; border: none; background: transparent; margin-top: 8px;
      }
      .config-block[data-block="predict"] #currentLevelInfo {
        margin-bottom: 8px; padding: 10px; border-radius: 6px;
      }
      /* 内部两列结果面板的卡片化外观，缩小边距与圆角 */
      .config-block[data-block="predict"] .card-content > div[style*="flex"] > div {
        border: 1px solid var(--line); border-radius: 6px; padding: 10px; background: var(--card);
      }
      .config-block[data-block="predict"] .card-content h5,
      .config-block[data-block="predict"] .card-content h4 {
        margin: 0 0 8px 0; font-size: 13px; color: var(--text);
      }
      .config-block[data-block="predict"] #predBreakdown {
        gap: 12px;
      }
      /* 预测模块按钮：椭圆按钮外观 */
      .config-block[data-block="predict"] #updatePrediction {
        font-size: 11px; padding: 6px 14px; line-height: 1;
        border-radius: 999px; border: 1px solid var(--line);
        background: var(--primary); color: #fff;
      }
      .config-block[data-block="predict"] #updatePrediction:hover { background: var(--primary-strong); }

      /* 特定区块的表格不使用滚动条 */
      .config-block[data-block="display"] .data-table,
      .config-block[data-block="tech"] .data-table {
        max-height: none;
        overflow-y: visible;
      }
      
      /* 商店刷新星币区块显示12行数据 */
      .config-block[data-block="shop"] .data-table {
        max-height: 300px; /* 12行 × 30px/行 = 360px */
        overflow-y: auto;
      }
      .data-table tr:hover {
        background: rgba(154, 163, 160, 0.1);
      }
      
      /* 统一表格样式：大数字单位系统对照表的"单位"列、商店刷新星币的"刷新次数"列、魂牌模块的"次数"列 */
      .config-block[data-block="display"] .data-table tbody td:first-child,
      .config-block[data-block="shop"] .data-table tbody td:first-child,
      .config-block[data-block="tech"] .data-table tbody .count-cell {
        background: var(--accent-light, rgba(154, 163, 160, 0.1));
        font-weight: 500;
        color: var(--text);
      }
      
      /* 统一悬停效果 */
      .config-block[data-block="display"] .data-table tr:hover td:first-child,
      .config-block[data-block="shop"] .data-table tr:hover td:first-child,
      .config-block[data-block="tech"] .data-table tr:hover .count-cell {
        background: var(--accent-hover, rgba(154, 163, 160, 0.2));
      }
      
      .number-input-group input[type="number"] {
        width: 50px; padding: 4px 6px; text-align: center;
        border: 1px solid var(--line); border-radius: 4px;
        font-size: 12px;
      }
      
      /* 配置区块样式 */
      .config-block {
        padding: 12px; border: 1px solid var(--line); border-radius: 8px;
        background: var(--card);
        position: relative;
      }
      .resize-handle {
        position: absolute; top: 0; bottom: 0; width: 6px; cursor: ew-resize; opacity: 0.2;
      }
      .resize-handle.left { left: -3px; }
      .resize-handle.right { right: -3px; }
      .resize-handle:hover { opacity: 0.5; }
      .config-block h4 {
        margin: 0 0 12px 0; font-size: 14px; color: var(--text);
        border-bottom: 1px solid var(--line); padding-bottom: 6px;
      }
      /* 指定子模块去除标题分割线 */
      .config-block[data-block="level-select"] h4,
      .config-block[data-block="predict"] h4 { border-bottom: none; padding-bottom: 0; margin-bottom: 8px; }
      
      /* 轮播提示框 */
      .tips-carousel {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 50px;
        padding: 12px 16px;
        margin: 16px 0;
        min-height: 60px;
        display: flex;
        align-items: center;
        position: relative;
        overflow: hidden;
      }
      .tips-carousel::before {
        content: '💡';
        font-size: 18px;
        margin-right: 8px;
        flex-shrink: 0;
      }
      .tips-content {
        flex: 1;
        font-size: 14px;
        color: var(--text);
        line-height: 1.4;
        opacity: 0;
        transform: translateX(20px);
        transition: all 0.5s ease;
      }
      .tips-content.active {
        opacity: 1;
        transform: translateX(0);
      }
      .tips-dots {
        position: absolute;
        bottom: 8px;
        right: 12px;
        display: flex;
        gap: 4px;
      }
      .tips-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--muted);
        cursor: pointer;
        transition: background 0.3s;
      }
      .tips-dot.active {
        background: var(--primary);
      }
      
      /* 彩蛋模态框 */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .modal h2 {
        color: #FF3B3E;
        margin: 0;
      }
      .modal p {
        color: #333;
        margin: 0;
        line-height: 1.5;
      }
      .modal button {
        background: #FF3B3E;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        align-self: center;
      }
      .modal button:hover {
        background: #E03437;
      }
      *{ box-sizing:border-box }
      body { background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 20px; }
      h1,h3{ margin:0 0 10px 0; font-weight:600 }
      .card { background:var(--card); border: 1px solid var(--line); border-radius: var(--radius); padding: 14px; box-shadow: 0 1px 0 rgba(0,0,0,0.02); position: relative; }
      .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      .card-toggle { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
      .card-toggle:hover { background: var(--line); color: var(--text); }
      .card-content { transition: all 0.3s ease; overflow: hidden; }
      .card-content.collapsed { max-height: 0; opacity: 0; margin: 0; padding: 0; }
      /* 修复：配置大区容器在展开时允许内容溢出可见，防止右侧被裁剪 */
      #config-content { overflow: visible; }
      #config-content.collapsed { overflow: hidden; }
      label { display: block; font-size: 12px; color: var(--muted); margin-top: 8px; }
      input, select { width: 100%; padding: 9px 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px; background:#FAFAF8; color:var(--text); outline:none }
      input:focus, select:focus{ border-color: var(--primary); box-shadow: 0 0 0 3px rgba(154,163,160,0.15) }
      input:disabled { opacity: 0.5; cursor: not-allowed; }
      input[readonly] { 
        background-color: #f8f9fa; 
        border-color: #e9ecef; 
        cursor: not-allowed; 
        opacity: 0.8;
      }
      button { padding: 9px 14px; border-radius: 999px; border: 1px solid var(--line); background: var(--primary); color: white; cursor: pointer; transition:.15s }
      button:hover{ background: var(--primary-strong) }
      .btn-light{ background:#F5F5F3; color:var(--text) }
      .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
      .btn-radio { padding: 10px 14px; border: 1px solid var(--line); border-radius: 999px; background: #F6F6F4; color: var(--text); cursor: pointer; transition:.15s; font-size:13px }
      .btn-radio.active { background: var(--primary); color: #fff; border-color: var(--primary); }
      .tag-d, .tag-f, .tag-y { background: #F6F6F4; color: var(--text); border-color: var(--line); }
      .tag-d.alt, .tag-f.alt, .tag-y.alt { background: #F6F6F4; color: var(--text); }
      .tag-d.selected, .tag-f.selected, .tag-y.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
      .tag-d.alt.selected, .tag-f.alt.selected, .tag-y.alt.selected { background: var(--primary); color: #fff; }
      .fill-toggle{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); margin-bottom:8px; }
      .status { padding: 6px 10px; border-radius: 999px; display: inline-block; border:1px solid var(--line); background:#F8F8F6 }
      .under { background: var(--danger); color: #5E3B3A; }
      .ok { background: var(--warn); color: #6B4F2F; }
      .over5x { background: var(--ok); color: #2C5146; }
      .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
      .kv{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed var(--line) }
      .kv small{ color:var(--muted) }
      
      /* 悬浮窗样式 */
      .floating-window {
        position: fixed;
        top: 120px;
        right: auto;
        width: auto;
        min-width: 400px;
        max-width: 90vw;
        min-height: auto;
        max-height: 80vh;
        background: var(--card);
        border: 2px solid var(--primary);
        border-radius: var(--radius);
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        z-index: 1000;
        cursor: move;
        user-select: none;
        transition: all 0.3s ease;
      }
      
      .floating-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--primary);
        color: white;
        border-radius: var(--radius) var(--radius) 0 0;
        cursor: move;
        user-select: none;
      }
      .floating-title {
        font-weight: 600;
        font-size: 14px;
      }
      .floating-controls {
        display: flex;
        gap: 4px;
      }
      .floating-close {
        width: 20px;
        height: 20px;
        border: none;
        background: rgba(255,255,255,0.2);
        color: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      .floating-close:hover {
        background: rgba(255,255,255,0.3);
      }
      .floating-close:hover {
        background: #ff4444;
      }
      
      .floating-content {
        padding: 16px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      /* 开关样式 */
      .result-toggle {
        display: flex;
        align-items: center;
      }
      .toggle-switch {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
      }
      .toggle-switch input[type="checkbox"] {
        display: none;
      }
      .toggle-slider {
        width: 50px;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        position: relative;
        transition: background 0.3s;
      }
      .toggle-slider::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .toggle-switch input[type="checkbox"]:checked + .toggle-slider {
        background: var(--primary);
      }
      .toggle-switch input[type="checkbox"]:checked + .toggle-slider::before {
        transform: translateX(26px);
      }
      .toggle-label {
        font-weight: 500;
      }
      
      /* 按钮悬停提示样式 */
      .btn-tooltip {
        position: relative;
        cursor: pointer;
      }
      .btn-tooltip::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        margin-bottom: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .btn-tooltip::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        margin-bottom: -1px;
      }
      .btn-tooltip:hover::before,
      .btn-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(-2px);
      }
      
      /* 紧凑按钮样式 */
      .btn-radio {
        padding: 4px 8px !important;
        font-size: 10px !important;
        border-radius: 4px !important;
      }
      
      
      /* 预测高亮样式 */
      .prediction-highlight {
        background: linear-gradient(120deg, var(--primary) 0%, var(--primary-strong) 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .prediction-level-highlight {
        background: linear-gradient(120deg, var(--warn) 0%, #f59e0b 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .prediction-score-highlight {
        background: linear-gradient(120deg, var(--ok) 0%, #10b981 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      /* 全局 Alert 提示（右上角） */
      .alert-stack { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; }
      .alert { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:6px; font-size:12px; border:1px solid var(--line); box-shadow: 0 2px 6px rgba(0,0,0,0.06); background: var(--card); color: var(--text); }
      .alert-ok { background: rgba(16,185,129,0.08); color:#065f46; border-color: rgba(16,185,129,0.25); }
      .alert-warn { background: rgba(245,158,11,0.10); color:#92400e; border-color: rgba(245,158,11,0.25); }
      .alert-danger { background: rgba(239,68,68,0.10); color:#7f1d1d; border-color: rgba(239,68,68,0.25); }
      .alert .close { background:none; border:none; color:inherit; cursor:pointer; padding:2px 6px; border-radius:4px; }

      /* 预测结果：紧凑行样式 */
      .predict-list { display:flex; flex-direction:column; gap:6px; }
      .predict-row { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text); flex-wrap: wrap; overflow-wrap:anywhere; word-break:break-word; }
      .predict-badge { padding:2px 6px; border-radius:999px; font-size:11px; line-height:1; }
      .predict-badge.ok { background: rgba(16,185,129,0.12); color:#047857; border:1px solid rgba(16,185,129,0.25); }
      .predict-badge.fail { background: rgba(239,68,68,0.10); color:#991b1b; border:1px solid rgba(239,68,68,0.25); }
      .predict-meta { color: var(--muted); font-size:11px; }
      /* 预测标题中的括号参数更小更淡 */
      .predict-trigs { font-size: 11px; color: var(--muted); font-weight: 500; }
      /* 败北关卡的关卡位警告高亮 */
      .prediction-level-warning { background: var(--warn); color: #4a3c2a; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
      
      /* 紧凑下拉选择框样式 */
      .compact-select {
        padding: 2px 4px !important;
        font-size: 10px !important;
        border-radius: 4px !important;
        min-width: 80px !important;
        height: 24px !important;
        background: #F6F6F4 !important;
        border: 1px solid var(--line) !important;
        color: var(--text) !important;
      }
      
      /* 下拉选择框tooltip支持 */
      .compact-select.btn-tooltip {
        position: relative;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h1>
        <img src="src/assets/fairy16.png" alt="16" style="width: 96px; height: 96px; vertical-align: middle; margin: 0 12px;" />
        青云之志 算分小助手  ——  16祝各位大大欧气满满！
      </h1>
      
      <!-- Tips轮播提示框 -->
      <div class="tips-carousel" style="flex:1; margin:0 20px;">
        <div class="tips-content active" id="tipsContent">进入关卡前和自摸时注意顺序哦</div>
        <div class="tips-dots" id="tipsDots"></div>
      </div>
      
      <div class="result-toggle">
        <label class="toggle-switch">
          <input type="checkbox" id="resultToggle" />
          <span class="toggle-slider"></span>
          <span class="toggle-label">计算结果</span>
        </label>
      </div>
    </div>
    
    <div class="theme-selector">
      <div class="theme-option" data-theme="default">
        <span>莫兰迪</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#9AA3A0;"></div>
          <div class="theme-color" style="background:#C4B7A6;"></div>
          <div class="theme-color" style="background:#B7D0C5;"></div>
          <div class="theme-color" style="background:#E3C9A8;"></div>
          <div class="theme-color" style="background:#D9B8B6;"></div>
        </div>
      </div>
      <div class="theme-option active" data-theme="16QwQ">
        <span>16QwQ</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#73CCFF;"></div>
          <div class="theme-color" style="background:#ACF06D;"></div>
          <div class="theme-color" style="background:#F0DF6D;"></div>
          <div class="theme-color" style="background:#E8A469;"></div>
          <div class="theme-color" style="background:#AC9076;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="buxingshx">
        <span>布识星河</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#00E874;"></div>
          <div class="theme-color" style="background:#EEFF00;"></div>
          <div class="theme-color" style="background:#00B0F0;"></div>
          <div class="theme-color" style="background:#FFFFFF; border:1px solid #ccc;"></div>
          <div class="theme-color" style="background:#B6FF47;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="life">
        <span>生命序章</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#A5EAFF;"></div>
          <div class="theme-color" style="background:#BEFFF8;"></div>
          <div class="theme-color" style="background:#9EC4F6;"></div>
          <div class="theme-color" style="background:#E1DCFC;"></div>
          <div class="theme-color" style="background:#D2C0F9;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="purple">
        <span>紫鼠法翠</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#FFF200;"></div>
          <div class="theme-color" style="background:#65BFBE;"></div>
          <div class="theme-color" style="background:#BDE031;"></div>
          <div class="theme-color" style="background:#DEEDA1;"></div>
          <div class="theme-color" style="background:#008F75;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="rainbow">
        <span>彩虹小小</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#FFB78C;"></div>
          <div class="theme-color" style="background:#FFF08C;"></div>
          <div class="theme-color" style="background:#BBFF8C;"></div>
          <div class="theme-color" style="background:#8CFFCE;"></div>
          <div class="theme-color" style="background:#BD8CFF;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="wonderful">
        <span>不思议世界</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#191A1E;"></div>
          <div class="theme-color" style="background:#482E31;"></div>
          <div class="theme-color" style="background:#FF3B3E;"></div>
          <div class="theme-color" style="background:#FF8657;"></div>
          <div class="theme-color" style="background:#FFBA70;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="16yyds">
        <span>十六YYDS</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#E5FD56;"></div>
          <div class="theme-color" style="background:#C6DC74;"></div>
          <div class="theme-color" style="background:#A8BB92;"></div>
          <div class="theme-color" style="background:#899AB0;"></div>
          <div class="theme-color" style="background:#6A79CE;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="easter-egg">
        <span>讨厌十六</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#FF0000;"></div>
          <div class="theme-color" style="background:#FF6600;"></div>
          <div class="theme-color" style="background:#FFCC00;"></div>
          <div class="theme-color" style="background:#00FF00;"></div>
          <div class="theme-color" style="background:#0066FF;"></div>
        </div>
      </div>
    </div>
    
    <!-- 彩蛋模态框 -->
    <div id="easterEggModal" class="modal">
      <div class="modal-content">
        <h2>🎉 彩蛋！</h2>
        <p>你敢点这个，达鼠泥，给16打钱！<br>hahahahaha 😄</p>
        <div style="text-align: center; margin: 20px 0;">
          <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px;">
            <img src="src/assets/yiyi.jpg" alt="notGood" style="max-width: 45%; height: auto;" />
            <img src="src/assets/appreciate.jpg" alt="appreciate" style="max-width: 45%; height: auto;" />
          </div>
          <div style="margin: 10px 0;">蟹蟹泥~</div>
        </div>
        <button onclick="closeEasterEgg()">关闭</button>
      </div>
    </div>
    

    <div class="row">
      <div class="col-left">
        <div class="card">
        <div class="card-header">
          <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
            <h3>关卡配置与护身符设置</h3>
            <div class="block-selector" style="display:flex; gap:4px; margin:0; flex-wrap:wrap;">
              <button class="block-btn active" data-block="level-select">选择关卡</button>
              <button class="block-btn active" data-block="values">数值设置</button>
              <button class="block-btn active" data-block="triggers">触发次数与王之召唤</button>
              <button class="block-btn active" data-block="display">大数字单位</button>
              <button class="block-btn " data-block="tech">科技</button>
              <button class="block-btn " data-block="shop">商店刷新星币</button>
              <button class="block-btn active" data-block="predict">未来关卡预测</button>
            </div>
            <button class="card-toggle" data-target="config-content">−</button>
          </div>
        </div>
        <div class="card-content" id="config-content">
        
        <!-- 两列布局：左侧选择关卡(15%)，右侧其他区块(85%) -->
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          
          <!-- 左侧：选择关卡 -->
          <div class="config-block" data-block="level-select" style="flex: 0 0 15%; min-width: 180px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 style="margin:0;">选择关卡</h4>
              <div style="display:flex; gap:4px;">
                <button id="prevLevel" style="padding:4px 8px; font-size:12px;" title="上一关">◀</button>
                <button id="nextLevel" style="padding:4px 8px; font-size:12px;" title="下一关">▶</button>
              </div>
            </div>
            <div class="block-content expanded">
            <label>目标分数
              <input id="targetScore" value="200" />
            </label>
            <label>选择关卡
              <select id="levelSelect"></select>
            </label>
            
            <!-- 起始关卡设置 -->
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-weight:600; color:var(--text);">起始关卡</span>
                <button id="unlockApply" style="padding:4px 8px; font-size:12px;">确认</button>
              </div>
              <label>盗印
                <select id="unlockD"></select>
              </label>
              <label>负重
                <select id="unlockF"></select>
              </label>
              <label>月光
                <select id="unlockY"></select>
              </label>
            </div>
            </div>
          </div>
          <!-- 右侧：其他区块flex布局 -->
          <div class="blocks-grid" id="blocksGrid" style="display: flex; flex-wrap: wrap; gap: 8px; flex: 1; width: 100%;">
          <!-- 区块2：数值设置 -->
          <div class="config-block" data-block="values" style="flex: 1; min-width: 200px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>数值设置<span class="block-toggle">▼</span></h4>
            <div class="block-content expanded">
            <label>胡牌番数
              <input id="finalMulInput" value="30" />
            </label>
            <label>小分分值
              <input id="baseScore" value="77" />
            </label>
            <label>盗印番数
              <input id="daoyin" value="2" readonly />
            </label>
            <div id="daoyin_display" style="font-size:10px; color:#9ca3af; margin:2px 0 8px 0; min-height:12px; text-align:right; padding-right:4px;"></div>
            <label>负重番数
              <input id="fuzhong" value="1.5" readonly />
            </label>
            <div id="fuzhong_display" style="font-size:10px; color:#9ca3af; margin:2px 0 8px 0; min-height:12px; text-align:right; padding-right:4px;"></div>
            <label>月光番数
              <input id="yueguang" value="2.5" readonly />
            </label>
            <div id="yueguang_display" style="font-size:10px; color:#9ca3af; margin:2px 0 8px 0; min-height:12px; text-align:right; padding-right:4px;"></div>
            </div>
          </div>
          <!-- 区块4：触发次数与王之召唤 -->
          <div class="config-block" data-block="triggers" style="flex: 1; min-width: 200px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>触发次数与王之召唤<span class="block-toggle">▼</span></h4>
            <div class="block-content expanded">
            
            <!-- 触发次数和理论最大次数在同一行 -->
            <div style="display:flex; gap:16px; margin-bottom:12px;">
              <!-- 实际触发次数 -->
              <div style="flex:1;">
                <div style="font-size:12px;color:#374151;margin-bottom:8px;">实际触发次数</div>
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">盗印:</label>
                    <input id="trigD" type="number" value="4" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">负重:</label>
                    <input id="trigF" type="number" value="7" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">月光:</label>
                    <input id="trigY" type="number" value="5" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                </div>
              </div>
              
              <!-- 理论最大次数 -->
              <div style="flex:1;">
                <div style="font-size:12px;color:#374151;margin-bottom:8px;">理论最大次数</div>
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">盗印:</label>
                    <input id="theoD" type="number" value="6" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">负重:</label>
                    <input id="theoF" type="number" value="7" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">月光:</label>
                    <input id="theoY" type="number" value="5" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 王之召唤 -->
            <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--line);">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <input type="checkbox" id="kingEnabled" disabled />
                <span style="font-size:12px;color:#6b7280;">王之召唤番数计算开发中...</span>
              </div>
              <div id="kingBox" style="display:none;">
                <label style="font-size:11px;">初始番数
                  <input id="kingInit" value="1" style="font-size:12px; padding:4px;" disabled />
                </label>
                <label style="font-size:11px;">触发次数
                  <input id="kingTriggers" type="number" value="" style="font-size:12px; padding:4px;" disabled />
                </label>
                <label style="font-size:11px;">基数
                  <input id="kingBase" value="" style="font-size:12px; padding:4px;" disabled />
                </label>
              </div>
            </div>
            </div>
          </div>
          <!-- 区块5：大数字单位 -->
          <div class="config-block" data-block="display" style="flex: 1; min-width: 200px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>大数字单位系统对照表<span class="block-toggle">▼</span></h4>
            <div class="block-content expanded">
            <div class="data-table">
              <table>
                <thead>
                  <tr>
                    <th>单位</th>
                    <th>指数</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>万</td><td>10^4</td></tr>
                  <tr><td>亿</td><td>10^8</td></tr>
                  <tr><td>兆</td><td>10^12</td></tr>
                  <tr><td>京</td><td>10^16</td></tr>
                  <tr><td>垓</td><td>10^20</td></tr>
                  <tr><td>秭</td><td>10^24</td></tr>
                  <tr><td>穰</td><td>10^28</td></tr>
                  <tr><td>沟</td><td>10^32</td></tr>
                  <tr><td>涧</td><td>10^36</td></tr>
                  <tr><td>正</td><td>10^40</td></tr>
                  <tr><td>载</td><td>10^44</td></tr>
                  <tr><td>极</td><td>10^48</td></tr>
                </tbody>
              </table>
            </div>
            </div>
          </div>
          <!-- 区块678合并：魂牌/公开牌/宝牌指示牌 -->
          <div class="config-block" data-block="tech" style="flex: 1; min-width: 300px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>魂牌 - 公开牌 - 宝牌指示牌<span class="block-toggle">▼</span></h4>
            <div class="block-content expanded">
            <div class="data-table">
              <table>
                <thead>
                  <tr>
                    <th>次数</th>
                    <th>星币</th>
                    <th>次数</th>
                    <th>星币</th>
                    <th>次数</th>
                    <th>星币</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td class="count-cell">0/9</td><td>10</td><td class="count-cell">6/18</td><td>2</td><td class="count-cell">1/10</td><td>5</td></tr>
                  <tr><td class="count-cell">1/9</td><td>20</td><td class="count-cell">7/18</td><td>4</td><td class="count-cell">2/10</td><td>10</td></tr>
                  <tr><td class="count-cell">2/9</td><td>30</td><td class="count-cell">8/18</td><td>6</td><td class="count-cell">3/10</td><td>15</td></tr>
                  <tr><td class="count-cell">3/9</td><td>40</td><td class="count-cell">9/18</td><td>8</td><td class="count-cell">4/10</td><td>20</td></tr>
                  <tr><td class="count-cell">4/9</td><td>50</td><td class="count-cell">10/18</td><td>10</td><td class="count-cell">5/10</td><td>30</td></tr>
                  <tr><td class="count-cell">5/9</td><td>80</td><td class="count-cell">11/18</td><td>20</td><td class="count-cell">6/10</td><td>50</td></tr>
                  <tr><td class="count-cell">6/9</td><td>100</td><td class="count-cell">12/18</td><td>30</td><td class="count-cell">7/10</td><td>80</td></tr>
                  <tr><td class="count-cell">7/9</td><td>150</td><td class="count-cell">13/18</td><td>40</td><td class="count-cell">8/10</td><td>120</td></tr>
                  <tr><td class="count-cell">8/9</td><td>200</td><td class="count-cell">14/18</td><td>50</td><td class="count-cell">9/10</td><td>160</td></tr>
                  <tr><td class="count-cell"> </td><td> </td><td class="count-cell">15/18</td><td>80</td><td class="count-cell"> </td><td> </td></tr>
                  <tr><td class="count-cell"> </td><td> </td><td class="count-cell">16/18</td><td>120</td><td class="count-cell"> </td><td> </td></tr>
                  <tr><td class="count-cell"> </td><td> </td><td class="count-cell">17/18</td><td>160</td><td class="count-cell"> </td><td> </td></tr>
                </tbody>
              </table>
            </div>
            </div>
          </div>
          
          <!-- 区块8：商店刷新星币 -->
          <div class="config-block" data-block="shop" style="flex: 1; min-width: 200px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>商店刷新星币<span class="block-toggle">▼</span></h4>
            <div class="block-content expanded">
          <div class="data-table">
            <table>
              <thead>
                <tr>
                  <th>刷新次数</th>
                  <th>所需星币</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>1</td><td>2</td></tr>
                <tr><td>2</td><td>3</td></tr>
                <tr><td>3</td><td>5</td></tr>
                <tr><td>4</td><td>8</td></tr>
                <tr><td>5</td><td>12</td></tr>
                <tr><td>6</td><td>18</td></tr>
                <tr><td>7</td><td>27</td></tr>
                <tr><td>8</td><td>41</td></tr>
                <tr><td>9</td><td>93</td></tr>
                <tr><td>10</td><td>140</td></tr>
                <tr><td>11</td><td>210</td></tr>
                <tr><td>12</td><td>315</td></tr>
                <tr><td>13</td><td>473</td></tr>
                <tr><td>14</td><td>710</td></tr>
                <tr><td>15</td><td>1065</td></tr>
                <tr><td>16</td><td>1598</td></tr>
                <tr><td>17</td><td>2397</td></tr>
                <tr><td>18</td><td>3596</td></tr>
                <tr><td>19</td><td>5394</td></tr>
                <tr><td>20</td><td>8091</td></tr>
                <tr><td>21</td><td>12137</td></tr>
                <tr><td>22</td><td>18206</td></tr>
              </tbody>
            </table>
          </div>
            </div>
          </div>
          <!-- 区块9：未来关卡预测区块 -->
          <div class="config-block" data-block="predict" style="flex: 1; min-width: 300px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <span style="font-weight:600; color:var(--text);">未来关卡预测</span>
              <button id="updatePrediction">更新预测</button>
            </div>
            <div class="card-content" id="prediction-content">
              <!-- 当前关卡信息与得分对比 -->
              <div id="currentLevelInfo" style="display:none; margin-bottom:16px; padding:12px; background:var(--accent); border-radius:8px;">
                <!-- 第一行：当前关卡+目标分，实际得分，理论得分 -->
                <div style="display:flex; gap:16px; margin-bottom:12px;">
                  <div style="flex:1; min-width:250px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">当前关卡与目标分</div>
                    <div id="predCurrentLevelTarget" style="font-size:13px; color:var(--text);">请先进行计算</div>
                  </div>
                  <div style="flex:1; min-width:200px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">实际当前总得分</div>
                    <div id="predCurrentScore" style="font-size:13px; color:var(--text);">-</div>
                  </div>
                  <div style="flex:1; min-width:200px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">理论最高当前关总得分</div>
                    <div id="predMaxScore" style="font-size:13px; color:var(--text);">-</div>
                  </div>
                </div>
                
                <!-- 第二行：分解（番数与触发次数） -->
                <div style="padding-top:12px; border-top:1px solid var(--line);">
                  <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">分解（番数与触发次数）</div>
                  <div id="predBreakdown" style="font-size:13px; line-height:1.6; color:var(--text); display:flex; gap:16px;">-</div>
                </div>
              </div>
              
              <!-- 预测结果 -->
              <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:stretch;">
                <!-- 当前触发次数预测 -->
                <div style="border:1px solid var(--line); border-radius:8px; padding:12px; flex:1; min-width:260px; display:flex; flex-direction:column;">
                  <h5 style="margin:0 0 12px 0; color:var(--text); font-size:14px; display:flex; align-items:center; gap:8px;">
                    <span>实际预测<span class="predict-trigs">（盗印=<span id="currentDaoyinTriggers">-</span>, 负重=<span id="currentFuzhongTriggers">-</span>, 月光=<span id="currentYueguangTriggers">-</span>）</span></span>
                    <span style="margin-left:auto; display:flex; gap:6px; align-items:center;" id="currentPredQuickStatus"></span>
                  </h5>
                  <div id="currentPrediction" style="font-size:11px; line-height:1.6; color:var(--text); margin-top:auto;">请先进行计算</div>
                </div>
                
                <!-- 理论最大触发次数预测 -->
                <div style="border:1px solid var(--line); border-radius:8px; padding:12px; flex:1; min-width:260px; display:flex; flex-direction:column;">
                  <h5 style="margin:0 0 12px 0; color:var(--text); font-size:14px; display:flex; align-items:center; gap:8px;">
                    <span>理论预测<span class="predict-trigs">（盗印=<span id="maxDaoyinTriggers">-</span>, 负重=<span id="maxFuzhongTriggers">-</span>, 月光=<span id="maxYueguangTriggers">-</span>）</span></span>
                    <span style="margin-left:auto; display:flex; gap:6px; align-items:center;" id="maxPredQuickStatus"></span>
                  </h5>
                  <div id="maxPrediction" style="font-size:11px; line-height:1.6; color:var(--text); margin-top:auto;">请先进行计算</div>
                </div>
              </div>
            </div>
          </div>
        </div>
          
          </div> <!-- 关闭右侧区块网格 -->
        </div> <!-- 关闭两列布局 -->
        
        </div>
      </div>

      

      <!-- 悬浮结果窗 -->
      <div id="floatingResult" class="floating-window" style="display:none;">
        <div class="floating-header">
          <div class="floating-title">计算结果</div>
          <div class="floating-controls">
            <button class="floating-close" id="floatingClose">×</button>
          </div>
        </div>
        <div class="floating-content" id="floatingContent">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:12px; color:#374151;">精度:</span>
              <div class="precision-buttons">
                <button class="precision-btn active" data-precision="2">2位</button>
                <button class="precision-btn" data-precision="4">4位</button>
              </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <button id="btn">计算</button>
              <span id="status" class="status">未计算</span>
            </div>
          </div>
          <div class="grid-3">
            <div>
              <div style="font-size:12px;color:#374151;">实际当前总得分</div>
              <div id="resTotalSci" style="font-weight:600;">-</div>
              <div id="resTotalCn" style="color:#6b7280;">-</div>
            </div>
            <div>
              <div style="font-size:12px;color:#374151;">理论最高当前关总得分</div>
              <div id="resTheoSci" style="font-weight:600;">-</div>
              <div id="resTheoCn" style="color:#6b7280;">-</div>
            </div>
            <div>
              <div style="font-size:12px;color:#374151;">目标分（用于对比）</div>
              <div id="resTargetSci" style="font-weight:600;">-</div>
              <div id="resTargetCn" style="color:#6b7280;">-</div>
            </div>
          </div>
          <div style="margin-top:8px; font-size:12px; color:#374151;">分解（番数与触发次数）</div>
          <div class="grid-3" style="margin-top:6px;">
            <div>
              <strong>盗印</strong>
              <div id="bdD">-</div>
            </div>
            <div>
              <strong>负重</strong>
              <div id="bdF">-</div>
            </div>
            <div>
              <strong>月光</strong>
              <div id="bdY">-</div>
            </div>
          </div>
        </div>
      </div>

    <div class="card" style="margin-top:var(--gap); width:100%; max-width:100%;">
      <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3>关卡目标分（分页展示，每页6项）</h3>
        </div>
        <div style="display:flex; gap:16px; align-items:center;">
          <div style="display:flex; gap:6px; align-items:center; flex-wrap:nowrap; white-space:nowrap;">
            <select id="historySelect" style="font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:6px; background:var(--card); color:var(--text); min-width:180px;">
              <option value="">选择历史配置</option>
            </select>
            <button id="dropdownDeleteBtn" class="btn-radio btn-light" style="font-size:12px; padding:4px 8px; white-space:nowrap;">删除当前配置…</button>
          </div>

          <div style="display:flex; gap:6px; align-items:center;">
            <button id="saveCurrentBtn" class="btn-radio" style="font-size:12px; padding:4px 8px;">存储当前数据</button>
            <div id="saveFlow" style="display:none; gap:6px; align-items:center;">
              <input id="historyName" placeholder="输入名称" style="font-size:12px; padding:4px 8px; width:160px; border:1px solid var(--line); border-radius:6px; background:var(--card); color:var(--text);" />
              <button id="confirmSaveBtn" class="btn-radio" style="font-size:12px; padding:4px 8px;">确认</button>
              <button id="cancelSaveBtn" class="btn-radio btn-light" style="font-size:12px; padding:4px 8px;">取消</button>
            </div>
          </div>

          <div style="display:flex; gap:4px; align-items:center; margin-left:auto;">
            <span style="font-size:12px; color:#374151;">布局:</span>
            <button id="layoutSwitch" class="btn-radio active" data-layout="single" style="font-size:12px; padding:4px 8px;">单行</button>
            <button id="layoutSwitch2" class="btn-radio" data-layout="two-column" style="font-size:12px; padding:4px 8px;">两栏</button>
          </div>
          <button id="prev5">上一页</button>
          <button id="next5">下一页</button>
          <span id="pageInfo5"></span>
          <button class="card-toggle" data-target="level5-content">−</button>
        </div>
      </div>
      <div class="card-content" id="level5-content">
        <div id="levelList5"></div>
      </div>
    </div>


    
    <script>
      const API_BASE = 'http://127.0.0.1:4001';
      const api = `${API_BASE}/api/calc`;
      // 前端同样提供大数解析与格式化，用于输入/回显
      const CN_UNITS = ["万","亿","兆","京","垓","秭","穰","沟","涧","正","载","极"]; const CN_EXPS = [4,8,12,16,20,24,28,32,36,40,44,48];
      function parseChinaJiLocal(raw) {
        const s = String(raw||'').trim();
        if (!s) return null;
        if (/^[-+]?\d+(?:\.\d+)?(?:e[-+]?\d+)?$/i.test(s)) return s;
        
        // 修复：支持"20000万.3434"这种格式，正确处理小数部分
        // 先尝试匹配：数字 + 单位 + .小数 格式
        let m = s.match(/^\s*([-+]?\d+)\s*([万亿兆京垓秭穰沟涧正载])\s*(\.\d+)\s*(极*)\s*$/);
        if (m) {
          const integerPart = parseFloat(m[1]);
          const unit = m[2];
          const decimalPart = m[3];
          const j = (m[4]||'').length;
          
          const idx = CN_UNITS.indexOf(unit);
          if (idx >= 0) {
            const base = CN_EXPS[idx];
            const result = (integerPart + parseFloat(decimalPart)) * Math.pow(10, base + j*48);
            return result.toString();
          }
        }
        
        // 匹配格式：数字(可选小数) + 单位(可选) + 极(可选)
        m = s.match(/^\s*([-+]?\d+(?:\.\d+)?)\s*([万亿兆京垓秭穰沟涧正载]?)(极*)\s*$/);
        if (!m) return null;
        
        const coeff = parseFloat(m[1]); 
        const unit = m[2]||''; 
        const j = (m[3]||'').length;
        
        let base = 0; 
        if (unit) { 
          const idx = CN_UNITS.indexOf(unit); 
          if (idx >= 0) base = CN_EXPS[idx]; 
        }
        
        // 计算最终结果
        const result = coeff * Math.pow(10, base + j*48);
        return result.toString();
      }
      // 格式化数字显示（纯数字 + 科学计数法 + 大数字）
      function formatNumberDisplay(value, digits=2) {
        if (!value || value === '-' || value === 0) return { raw: value || '0', sci: value || '0', cn: value || '0' };
        
        const num = parseFloat(value);
        if (!isFinite(num)) return { raw: '-', sci: '-', cn: '-' };
        
        // 纯数字格式
        let rawStr = num.toString();
        if (num >= 1e8) rawStr = ''; // 超过10^8不显示纯数字
        
        // 科学计数法格式
        const sciStr = num.toExponential(digits);
        
        // 大数字格式
        const cnStr = formatChinaJiLocal(num.toString(), digits);
        
        return { raw: rawStr, sci: sciStr, cn: cnStr };
      }

      function formatChinaJiLocal(expStr, digits=2){
        const s = String(expStr||'');
        
        // 处理纯数字格式（非科学计数法）
        if (/^\s*[-+]?\d+(?:\.\d+)?\s*$/.test(s)) {
          const num = parseFloat(s);
          if (!isFinite(num)) return '-';
          if (num < 10000) return num.toString();
          
          // 将纯数字转换为科学计数法处理
          const sciStr = num.toExponential();
          return formatChinaJiLocal(sciStr, digits);
        }
        
        // 处理科学计数法格式
        const m = s.match(/^\s*([-+]?\d+(?:\.\d+)?)e([-+]?\d+)\s*$/i);
        if (!m) return '-';
        
        let coeff = parseFloat(m[1]);
        let expo = parseInt(m[2], 10);
        
        // 如果系数或指数无法解析，返回原始字符串
        if (!isFinite(coeff) || !isFinite(expo)) {
          return s;
        }
        
        // 处理负数指数（小于1的数字）
        if (expo < 0) {
          return coeff.toFixed(digits);
        }
        
        // 处理超大指数（超过 JavaScript 安全范围）
        if (expo > 1000) {
          // 对于超大数字，直接使用科学计数法显示，不进行中国大数字转换
          return `${coeff.toFixed(digits)}e${expo}`;
        }
        
        // 归一化到 [1,10)
        while (coeff >= 10) { coeff /= 10; expo += 1; }
        while (coeff < 1 && coeff > 0) { coeff *= 10; expo -= 1; }
        if (coeff === 0) return '0';
        
        const ji = Math.floor(expo / 48);
        let rem = expo % 48; if (rem < 0) rem += 48; // 防御性处理
        let unit = '';
        let shift = rem;
        
        // 修复：确保能找到合适的单位
        for (let i = CN_EXPS.length - 1; i >= 0; i--) {
          if (rem >= CN_EXPS[i]) { 
            unit = CN_UNITS[i]; 
            shift = rem - CN_EXPS[i]; 
            break; 
          }
        }
        
        // 如果没有找到合适的单位，直接使用数字
        if (!unit && shift === 0) {
          return `${coeff.toFixed(digits)}${'极'.repeat(ji)}`;
        }
        
        const coeffAdj = coeff * Math.pow(10, shift);
        return `${coeffAdj.toFixed(digits)}${unit}${'极'.repeat(ji)}`;
      }

      function parseESci(str){
        const s = String(str||'');
        const m = s.match(/^\s*([-+]?\d+(?:\.\d+)?)e([-+]?\d+)\s*$/i);
        if (!m) return null;
        return { c: parseFloat(m[1]), e: parseInt(m[2],10) };
      }

      function compareStatusBySci(totalSci, targetSci){
        const a = parseESci(totalSci);
        const b = parseESci(targetSci);
        if (!a || !b) return null;
        if (a.e > b.e) return 'over5x';
        if (a.e < b.e) return 'under';
        // same exponent
        if (a.c >= 5 * b.c) return 'over5x';
        if (a.c >= b.c) return 'ok';
        return 'under';
      }
      const $ = (id) => document.getElementById(id);

      function setStatus(s) {
        const el = $('status');
        el.className = `status ${s}`;
        el.textContent = s;
      }

      async function computeWithForm(payloadOverride) {
        try {
          setStatus('计算中…');
          const basePayload = (() => {
            const levelConfig = { targetScore: $('targetScore').value.trim() };
            if (document.getElementById('kingEnabled').checked) {
              levelConfig.kingCallInitialMultiplier = $('kingInit').value.trim() || '1';
              const t = $('kingTriggers').value.trim();
              const b = $('kingBase').value.trim();
              if (t) levelConfig.kingCallTriggers = Number(t);
              if (b) levelConfig.kingCallBase = b;
            }
            const sequence = { baseScore: $('baseScore').value.trim(), items: [] };

            const options = {
              daoyinValue: $('daoyin').value.trim(),
              fuzhongValue: $('fuzhong').value.trim(),
              yueguangValue: $('yueguang').value.trim(),
              overrideTriggers: {
                daoyin: Number($('trigD').value.trim() || '0'),
                fuzhong: Number($('trigF').value.trim() || '0'),
                yueguang: Number($('trigY').value.trim() || '0'),
              },
              overrideTheoreticalMaxes: {
                daoyin: Number($('theoD').value.trim() || '0'),
                fuzhong: Number($('theoF').value.trim() || '0'),
                yueguang: Number($('theoY').value.trim() || '0'),
              }
            };
            return { levelConfig, sequence, options };
          })();
          if (!basePayload) return;

          const payload = payloadOverride ? { ...basePayload, ...payloadOverride } : basePayload;
          // 覆盖胡牌番数
          payload.options.finalMultiplierOverride = $('finalMulInput').value.trim();
          // 将三类番数输入也允许中文大数：预解析为科学计数
          ['daoyinValue','fuzhongValue','yueguangValue'].forEach(k=>{
            const v = payload.options[k];
            const p = parseChinaJiLocal(v);
            if (p) payload.options[k] = p;
          });
          // baseScore/targetScore 亦本地解析
          const pt = parseChinaJiLocal(payload.levelConfig.targetScore); if (pt) payload.levelConfig.targetScore = pt;
          const pb = parseChinaJiLocal(payload.sequence.baseScore); if (pb) payload.sequence.baseScore = pb;
          // 触发次数与理论最大次数确保为数字
          payload.options.overrideTriggers = payload.options.overrideTriggers || {};
          payload.options.overrideTheoreticalMaxes = payload.options.overrideTheoreticalMaxes || {};
          ['daoyin','fuzhong','yueguang'].forEach(k=>{
            payload.options.overrideTriggers[k] = Number(payload.options.overrideTriggers[k]||0);
            payload.options.overrideTheoreticalMaxes[k] = Number(payload.options.overrideTheoreticalMaxes[k]||0);
          });

          const resp = await fetch(api, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          const prec = getCurrentPrecision();
          $('resTotalSci').textContent = data.totalScore || '-';
          $('resTotalCn').textContent = data.totalScore ? formatChinaJiLocal(data.totalScore, prec) : '-';
          $('resTheoSci').textContent = data.theoreticalTotalScore || '-';
          $('resTheoCn').textContent = data.theoreticalTotalScore ? formatChinaJiLocal(data.theoreticalTotalScore, prec) : '-';
          $('resTargetSci').textContent = (payload.levelConfig && payload.levelConfig.targetScore) || '-';
          $('resTargetCn').textContent = (payload.levelConfig && payload.levelConfig.targetScore) ? formatChinaJiLocal(payload.levelConfig.targetScore, prec) : '-';
          const dv = data.breakdown?.daoyin?.value;
          const fv = data.breakdown?.fuzhong?.value;
          const yv = data.breakdown?.yueguang?.value;
          const dvSci = dv != null ? parseFloat(dv).toExponential(prec) : '-';
          const fvSci = fv != null ? parseFloat(fv).toExponential(prec) : '-';
          const yvSci = yv != null ? parseFloat(yv).toExponential(prec) : '-';
          const dvCn = dv != null ? formatChinaJiLocal(dvSci, getCurrentPrecision()) : '-';
          const fvCn = fv != null ? formatChinaJiLocal(fvSci, getCurrentPrecision()) : '-';
          const yvCn = yv != null ? formatChinaJiLocal(yvSci, getCurrentPrecision()) : '-';
          $('bdD').textContent = `番数=${dvSci} / ${dvCn}  触发=${data.breakdown?.daoyin?.triggers ?? '-'}`;
          $('bdF').textContent = `番数=${fvSci} / ${fvCn}  触发=${data.breakdown?.fuzhong?.triggers ?? '-'}`;
          $('bdY').textContent = `番数=${yvSci} / ${yvCn}  触发=${data.breakdown?.yueguang?.triggers ?? '-'}`;
          const localStatus = compareStatusBySci(data.totalScore, payload.levelConfig?.targetScore);
          setStatus(localStatus || data.status || '完成');
        } catch (err) {
          $('resTotalSci').textContent = '-';
          $('resTotalCn').textContent = '-';
          $('resTheoSci').textContent = '-';
          $('resTheoCn').textContent = '-';
          $('resTargetSci').textContent = '-';
          $('resTargetCn').textContent = '-';
          $('bdD').textContent = String(err);
          $('bdF').textContent = '';
          $('bdY').textContent = '';
          setStatus('under');
        }
      }

      $('btn').addEventListener('click', async () => computeWithForm());

      // 增长类型选择功能已移除，不再需要按钮式单选绑定

      // 增长区间（每5关）编辑器
      const ivData = {}; // key -> { dType, fType, yType } - 保留给每页5项使用

      // 关卡目标分数据（你提供的 JSON）
      const LEVEL_TARGETS = {
        "1-1": "200","1-2": "400","1-3": "800","2-1": "1000","2-2": "1500","2-3": "2100","3-1": "3000","3-2": "4000","3-3": "5200","4-1": "7000","4-2": "9800","4-3": "15000","5-1": "22500","5-2": "33300","5-3": "50000","Ex1": "1000000","Ex2": "12000000","Ex3": "90750000","Ex4": "8.11亿","Ex5": "84.28亿","Ex6": "1003.54亿","Ex7": "1.35兆","Ex8": "20.56兆","Ex9": "348.31兆","Ex10": "6542.41兆","Ex11": "13.55京","Ex12": "308.54京","Ex13": "7681.69京","Ex14": "20.84垓","Ex15": "664.10垓","Ex16": "2.46秭","Ex17": "105.10秭","Ex18": "5154.00秭","Ex19": "28.82穰","Ex20": "1830.00穰","Ex21": "13.14沟","Ex22": "1066.00沟","Ex23": "9.72涧","Ex24": "994.10涧","Ex25": "11.38正","Ex26": "1456.00正","Ex27": "20.79载","Ex28": "3306.0载","Ex29": "58.49极","Ex30": "1.25万极","Ex31": "300.70万极","Ex32": "8.71亿极","Ex33": "2792.00亿极","Ex34": "108.20兆极","Ex35": "4.63京极","Ex36": "2398.00京极","Ex37": "136.90垓极","Ex38": "9.41秭极","Ex39": "7147.00秭极","Ex40": "708.60穰极","Ex41": "91.69沟极","Ex42": "15.46涧极","Ex43": "3.40正极","Ex44": "9734.00正极","Ex45": "3627.00载极","Ex46": "1759.00极极","Ex47": "1109.00万极极","Ex48": "910.80亿极极","Ex49": "972.20兆极极","Ex50": "1349.00京极极","Ex51": "2811.00垓极极","Ex52": "8787.00秭极极","Ex53": "4.12沟极极","Ex54": "28.99涧极极","Ex55": "306.00正极极","Ex56": "4844.00载极极","Ex57": "11.5万极极极","Ex58": "409.9亿极极极","Ex59": "2.19京极极极","Ex60": "175.50垓极极极","Ex61": "2.11穰极极极","Ex62": "380.79沟极极极","Ex63": "10.30正极极极","Ex64": "4180.00载极极极","Ex65": "254.4万极极极极","Ex66": "23.23兆极极极极","Ex67": "3.18垓极极极极","Ex68": "6538.00秭极极极极","Ex69": "2015.00沟极极极极","Ex70": "931.40正极极极极","Ex71": "645.80极极极极极","Ex72": "671.70亿极极极极极","Ex73": "1047.00京极极极极极","Ex74": "2452.00秭极极极极极","Ex75": "8608.00沟极极极极极","Ex76": "4.53载极极极极极","Ex77": "35.79万极极极极极极","Ex78": "424.00兆极极极极极极","Ex79": "5.70E+310","Ex80": "5.70E+318","Ex81": "5.70E+326","Ex82": "5.70E+334","Ex83": "5.70E+342","Ex84": "5.70E+350","Ex85": "5.70E+359","Ex86": "5.70E+368","Ex87": "5.70E+377","Ex88": "5.70E+386","Ex89": "5.70E+395","Ex90": "5.70E+405","Ex91": "5.70E+415","Ex92": "5.70E+425","Ex93": "5.70E+435","Ex94": "5.70E+445","Ex95": "5.70E+455","Ex96": "5.70E+466","Ex97": "5.70E+477","Ex98": "5.70E+488","Ex99": "5.70E+499","Ex100": "9.99E+510","Ex101": "9.99E+522","Ex102": "9.99E+534","Ex103": "9.99E+546","Ex104": "9.99E+558","Ex105": "9.99E+571","Ex106": "9.99E+584","Ex107": "9.99E+597","Ex108": "9.99E+611","Ex109": "9.99E+625","Ex110": "9.99E+639","Ex111": "9.99E+654","Ex112": "9.99E+669","Ex113": "9.99E+684","Ex114": "9.99E+699","Ex115": "9.99E+715","Ex116": "9.99E+731","Ex117": "9.99E+748","Ex118": "9.99E+765","Ex119": "9.99E+783","Ex120": "9.99E+801"
      };

      // 分页展示 + 增长/沿用/手填 + 关卡选择填充
      const PAGE_SIZE = 10;
      const entries = Object.entries(LEVEL_TARGETS);
      const keyOrder = entries.map(([k]) => k);
      // 回溯某关的生效类型：若当前关未显式设置，回溯到最近一次设置；再没有则用全局选择
      function resolveTypeAtIndex(kind, idx){
        let cur = kind==='d' ? growthChoice.daoyin : kind==='f' ? growthChoice.fuzhong : growthChoice.yueguang;
        for (let i=0;i<=idx;i++){
          const k = keyOrder[i];
          const row = ivData[k];
          if (!row) continue;
          if (kind==='d' && row.dType) cur = row.dType;
          if (kind==='f' && row.fType) cur = row.fType;
          if (kind==='y' && row.yType) cur = row.yType;
        }
        return cur;
      }
      const levelsState = {}; // key -> { lockD, lockF, lockY, manuD, manuF, manuY }

      const GROWTH = {
        daoyin: {
          '普通盗印': Math.pow(1.3, 1),
          '天使盗印': 1.6,
          '膨胀盗印': Math.pow(1.3, 2),
          '膨胀盗印吃卡维': Math.pow(1.3, 4),
        },
        fuzhong: {
          '普通负重': Math.pow(1.5, 1),
          '天使负重': 2.0,
          '膨胀负重': Math.pow(1.5, 2),
        },
        yueguang: {
          '普通月光': Math.pow(1.5, 1),
          '天使月光': 2.0,
          '膨胀月光': Math.pow(1.5, 2),
        }
      };

      let growthChoice = { daoyin: '普通盗印', fuzhong: '普通负重', yueguang: '普通月光' };

      function computeRecommendedAll() {
        const result = {};
        let prev = { d: 1, f: 1, y: 1 };
        const uD = $('unlockD').value; const uF = $('unlockF').value; const uY = $('unlockY').value;
        const idxD = keyOrder.indexOf(uD); const idxF = keyOrder.indexOf(uF); const idxY = keyOrder.indexOf(uY);
        
        for (let i = 0; i < keyOrder.length; i++) {
          const key = keyOrder[i];
          const st = levelsState[key] || {};
          const ivRow = ivData[key] || {};
          
          // 优先使用 ivData 中的增长类型，否则使用全局默认
          const dType = ivRow.dType || growthChoice.daoyin;
          const fType = ivRow.fType || growthChoice.fuzhong;
          const yType = ivRow.yType || growthChoice.yueguang;
          
          const gd = GROWTH.daoyin[dType] || 1.3;
          const gf = GROWTH.fuzhong[fType] || 1.5;
          const gy = GROWTH.yueguang[yType] || 1.5;

          // 计算解锁与成长：解锁关为 1 番；解锁后下一关开始成长
          const recD = (i === idxD) ? 1 : (i < idxD || idxD<0) ? 0 : (st.lockD ? prev.d : prev.d * gd);
          const recF = (i === idxF) ? 1 : (i < idxF || idxF<0) ? 0 : (st.lockF ? prev.f : prev.f * gf);
          const recY = (i === idxY) ? 1 : (i < idxY || idxY<0) ? 0 : (st.lockY ? prev.y : prev.y * gy);

          const actualD = st.manuD ? parseFloat(st.manuD) : recD;
          const actualF = st.manuF ? parseFloat(st.manuF) : recF;
          const actualY = st.manuY ? parseFloat(st.manuY) : recY;

          result[key] = { recD, recF, recY, actualD, actualF, actualY };
          prev = { d: actualD, f: actualF, y: actualY };
        }
        return result;
      }

  // ===== 存储/读取 每关番数与增长类型 =====
  // 全局 Alert 栈与工具
  function ensureAlertStack(){
    let s = document.getElementById('alertStack');
    if (!s){
      s = document.createElement('div');
      s.id = 'alertStack';
      s.className = 'alert-stack';
      document.body.appendChild(s);
    }
    return s;
  }
  function showAlert(kind, text){
    const s = ensureAlertStack();
    const el = document.createElement('div');
    el.className = 'alert ' + (kind||'');
    el.innerHTML = `<span>${text}</span><button class="close">×</button>`;
    el.querySelector('.close').addEventListener('click', ()=> el.remove());
    s.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 3000);
  }
  const STORAGE_KEY = 'qyzz_level_data_v1'; // 单槽旧键，保留兼容
  const STORAGE_KEYS_MULTI = 'qyzz_level_data_multi_v1'; // 多槽管理
  const STORAGE_MULTI_KEY = 'qyzz_level_data_multi_v1';
  function snapshotLevelData(){
    const all = computeRecommendedAll();
    const data = { levels: {}, growthDefault: growthChoice };
    for (const key of keyOrder){
      const st = levelsState[key] || {};
      const ivRow = ivData[key] || {};
      const a = all[key] || {};
      data.levels[key] = {
        manuD: st.manuD ?? null,
        manuF: st.manuF ?? null,
        manuY: st.manuY ?? null,
        lockD: !!st.lockD,
        lockF: !!st.lockF,
        lockY: !!st.lockY,
        dType: ivRow.dType || null,
        fType: ivRow.fType || null,
        yType: ivRow.yType || null,
        recD: a.recD ?? null,
        recF: a.recF ?? null,
        recY: a.recY ?? null,
        actualD: a.actualD ?? null,
        actualF: a.actualF ?? null,
        actualY: a.actualY ?? null,
      };
    }
    return data;
  }

  function saveCurrentLevelData(){
    try{
      const data = snapshotLevelData();
      // 写入多槽：需要名称
      const name = (document.getElementById('historyName')?.value || '').trim();
      if (!name){ showAlert('alert-warn','请输入名称'); return; }
      const multiRaw = localStorage.getItem(STORAGE_KEYS_MULTI);
      const multi = multiRaw ? JSON.parse(multiRaw) : {};
      multi[name] = { t: Date.now(), data };
      localStorage.setItem(STORAGE_KEYS_MULTI, JSON.stringify(multi));
      populateHistorySelect();
      const sel = document.getElementById('historySelect'); if (sel) sel.value = name;
      showAlert('alert-ok','已保存：' + name);
    }catch(e){
      console.error('保存失败', e);
      showAlert('alert-danger','保存失败');
    }
  }

  function loadHistoryLevelData(){
    try{
      const sel = document.getElementById('historySelect');
      const key = sel ? sel.value : '';
      const multiRaw = localStorage.getItem(STORAGE_KEYS_MULTI);
      const multi = multiRaw ? JSON.parse(multiRaw) : {};
      const obj = multi[key];
      const data = obj && obj.data;
      if(!data || !data.levels){ showAlert('alert-danger','历史数据格式不正确'); return; }
      // 恢复默认增长选择
      if (data.growthDefault){
        growthChoice = { ...growthChoice, ...data.growthDefault };
      }
      // 恢复 per-level 状态与增长类型
      for (const key of Object.keys(data.levels)){
        const v = data.levels[key] || {};
        levelsState[key] = levelsState[key] || {};
        ivData[key] = ivData[key] || {};
        // 恢复手动/沿用
        levelsState[key].manuD = v.manuD ?? null;
        levelsState[key].manuF = v.manuF ?? null;
        levelsState[key].manuY = v.manuY ?? null;
        levelsState[key].lockD = !!v.lockD;
        levelsState[key].lockF = !!v.lockF;
        levelsState[key].lockY = !!v.lockY;
        // 恢复增长类型
        if (v.dType) ivData[key].dType = v.dType;
        if (v.fType) ivData[key].fType = v.fType;
        if (v.yType) ivData[key].yType = v.yType;
      }
      renderPage5();
      showAlert('alert-ok','已读取：' + key);
    }catch(e){
      console.error('读取失败', e);
      showAlert('alert-danger','读取失败');
    }
  }

  function deleteHistory(){
    const sel = document.getElementById('historySelect');
    const key = sel ? sel.value : '';
    if (!key){ showAlert('alert-warn','请选择要删除的配置'); return; }
    if (!confirm(`确认删除历史配置“${key}”吗？该操作不可撤销。`)) return;
    try{
      const multiRaw = localStorage.getItem(STORAGE_KEYS_MULTI);
      const multi = multiRaw ? JSON.parse(multiRaw) : {};
      delete multi[key];
      localStorage.setItem(STORAGE_KEYS_MULTI, JSON.stringify(multi));
      populateHistorySelect();
      showAlert('alert-ok','已删除：' + key);
    }catch(e){
      console.error('删除失败', e);
      showAlert('alert-danger','删除失败');
    }
  }

  function populateHistorySelect(){
    const sel = document.getElementById('historySelect');
    if (!sel) return;
    const multiRaw = localStorage.getItem(STORAGE_KEYS_MULTI);
    const multi = multiRaw ? JSON.parse(multiRaw) : {};
    const current = sel.value;
    sel.innerHTML = '<option value="">选择历史配置</option>' +
      Object.keys(multi).sort().map(k=>`<option value="${k}">${k}</option>`).join('');
    if (current && multi[current]) sel.value = current;
  }

  // ===== 多份历史配置 =====
  function readAllSlots(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_MULTI_KEY)||'{}'); }catch{ return {}; }
  }
  function writeAllSlots(obj){
    localStorage.setItem(STORAGE_MULTI_KEY, JSON.stringify(obj));
  }
  function refreshHistorySelect(){
    const sel = document.getElementById('historySelect');
    if (!sel) return;
    const all = readAllSlots();
    const current = sel.value;
    sel.innerHTML = '<option value="">选择历史配置</option>' + Object.keys(all).map(k=>`<option value="${k}">${k}</option>`).join('');
    if (current && all[current]) sel.value = current;
  }
  function saveNamedSlot(){
    const name = (document.getElementById('historyName')?.value||'').trim();
    if (!name){ alert('请输入名称'); return; }
    const all = readAllSlots();
    all[name] = { t: Date.now(), data: snapshotLevelData() };
    writeAllSlots(all);
    refreshHistorySelect();
    alert('已命名保存');
  }
  function loadNamedSlot(){
    const sel = document.getElementById('historySelect');
    const key = sel?.value||'';
    if (!key){ return; }
    const all = readAllSlots();
    const slot = all[key];
    if (!slot){ alert('未找到该配置'); return; }
    const obj = slot.data;
    if (!obj || !obj.levels){ alert('历史数据格式不正确'); return; }
    // 复用单槽加载逻辑
    const data = { data: obj };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    loadHistoryLevelData();
  }
  function deleteNamedSlot(){
    const sel = document.getElementById('historySelect');
    const key = sel?.value||'';
    if (!key){ alert('请选择要删除的配置'); return; }
    const all = readAllSlots();
    if (!all[key]){ alert('未找到该配置'); return; }
    delete all[key];
    writeAllSlots(all);
    refreshHistorySelect();
    alert('已删除配置');
  }

      // renderPage函数已删除，因为"每页10项"区块已被移除
      function renderAll(){ /* 不再需要 */ }
      // 解锁关卡下拉填充
      function fillUnlockSelects(){
        // 仅提供 1-1 ~ Ex10 的关卡供选择
        const ex10Idx = keyOrder.indexOf('Ex10');
        const allowKeys = ex10Idx >= 0 ? keyOrder.slice(0, ex10Idx + 1) : keyOrder;
        const opts = allowKeys.map(k=>`<option value="${k}">${k}</option>`).join('');
        $('unlockD').innerHTML = opts;
        $('unlockF').innerHTML = opts;
        $('unlockY').innerHTML = opts;
        // 默认值：盗印3-1、负重4-2、月光3-3 若存在，否则置为首关
        const fallback = keyOrder[0];
        const setIfExists = (elId, key)=>{ const el=$(elId); el.value = keyOrder.includes(key)? key : fallback; };
        setIfExists('unlockD','1-1'); setIfExists('unlockF','1-2'); setIfExists('unlockY','1-3');
      }
      fillUnlockSelects();
      // 确认起始关后，刷新右侧联动
      document.getElementById('unlockApply').addEventListener('click', ()=>{
        renderPage5();
      });

      // 关卡下拉
      const sel = $('levelSelect');
      sel.innerHTML = keyOrder.map(k => `<option value="${k}">${k}</option>`).join('');
      sel.addEventListener('change', () => {
        const k = sel.value;
        $('targetScore').value = LEVEL_TARGETS[k];
        
        // 联动读取关卡目标分模块的番数并填充到数值设置模块
        const all = computeRecommendedAll();
        const levelData = all[k];
        if (levelData) {
          $('daoyin').value = `${(levelData.actualD || 0).toFixed(6)}`;
          $('fuzhong').value = `${(levelData.actualF || 0).toFixed(6)}`;
          $('yueguang').value = `${(levelData.actualY || 0).toFixed(6)}`;
          // 同步刷新右下角格式显示
          updateStampDisplay();
        }
      });
      $('prevLevel').addEventListener('click', ()=>{ const idx=keyOrder.indexOf(sel.value); if(idx>0){ sel.value=keyOrder[idx-1]; sel.dispatchEvent(new Event('change')); }});
      $('nextLevel').addEventListener('click', ()=>{ const idx=keyOrder.indexOf(sel.value); if(idx>=0 && idx<keyOrder.length-1){ sel.value=keyOrder[idx+1]; sel.dispatchEvent(new Event('change')); }});

      // 新的每页6项列表，完全参照每页10项的成功模式
      const PAGE5 = 6;
      let page5 = 0;
      let currentLayout = 'single'; // 'single' 或 'two-column'

      function renderPage5(){
        const start = page5 * PAGE5;
        const keys = keyOrder.slice(start, start + PAGE5);
        const all = computeRecommendedAll();
        const mode = 'both'; // 固定使用both模式
        
        let html = '';
        
        if (currentLayout === 'single') {
          // 单行布局：每个关卡占一整行
          html = keys.map((k, index)=>{
          const vSci = parseChinaJiLocal(LEVEL_TARGETS[k]) || LEVEL_TARGETS[k];
          const vCn = parseChinaJiLocal(LEVEL_TARGETS[k]) ? formatChinaJiLocal(parseChinaJiLocal(LEVEL_TARGETS[k]), getCurrentPrecision()) : LEVEL_TARGETS[k];
          const vDisp = mode==='sci'? vSci : mode==='cn'? vCn : `${vSci} / ${vCn}`;
          const a = all[k];
          const rowId = k.replace(/[^a-zA-Z0-9]/g,'_');
          const st = levelsState[k] || {};
          
          return `
            <div style="border-bottom:1px solid #eee; padding:12px 0;">
              ${index === 0 ? `
              <!-- 盗印、负重、月光标题（只在每页第一关显示） -->
              <div class="grid-3" style="margin-bottom:12px; font-weight:600; color:var(--text); text-align:center;">
                <div style="padding:4px;">盗印</div>
                <div style="padding:4px;">负重</div>
                <div style="padding:4px;">月光</div>
              </div>
              ` : ''}
              
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <strong>${k}</strong>
                <span style="color:#6b7280;">目标分数：${vDisp}</span>
                <div style="display:flex; gap:8px;">
                  <button type="button" data-confirm5="${k}" class="btn-light">确认手动输入变更</button>
                  <button type="button" data-calc5="${k}">用本关参数计算</button>
                </div>
              </div>
              
              <div class="grid-3" style="margin-top:6px;">
                <div>
                  <!-- 番数输入行 -->
                  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                    <input type="text" id="g5D_${rowId}" name="g5D_${rowId}" value="${(a.actualD||0).toFixed(4)}" style="flex:1; padding:4px;" />
                  </div>
                  <div id="g5D_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                    ${(() => {
                      const formats = formatNumberDisplay((a.actualD||0), 2);
                      let displayText = '';
                      if (formats.raw) displayText += formats.raw;
                      if (formats.raw && formats.sci) displayText += ' / ';
                      if (formats.sci) displayText += formats.sci;
                      if (formats.cn && (a.actualD||0) >= 10000) {
                        displayText += ' / ' + formats.cn;
                      }
                      return displayText;
                    })()}
                  </div>
                  <!-- 按钮和推荐行 -->
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <small style="color:#6b7280;">推荐: ${(() => {
                      const val = (a.recD||0);
                      return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                    })()}</small>
                    <div class="btn-group" style="display:flex; gap:4px;">
                      <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:普通盗印" data-gtype="普通盗印" data-tooltip="普通盗印1.3">普通盗印</button>
                      <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:天使盗印" data-gtype="天使盗印" data-tooltip="天使盗印1.6">天使盗印</button>
                      <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:膨胀盗印" data-gtype="膨胀盗印" data-tooltip="膨胀盗印1.3^2">膨胀盗印</button>
                      <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:膨胀盗印吃卡维" data-gtype="膨胀盗印吃卡维" data-tooltip="膨胀盗印吃卡维1.3^4">膨胀盗印吃卡维</button>
                    </div>
                    <button type="button" class="btn-tooltip" data-lock5d="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockD ? '取消沿用' : '沿用上一关'}">${st.lockD ? '取消沿用' : '沿用上一关'}</button>
                  </div>
                </div>
                <div>
                  <!-- 番数输入行 -->
                  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                    <input type="text" id="g5F_${rowId}" name="g5F_${rowId}" value="${(a.actualF||0).toFixed(4)}" style="flex:1; padding:4px;" />
                  </div>
                  <div id="g5F_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                    ${(() => {
                      const formats = formatNumberDisplay((a.actualF||0), 2);
                      let displayText = '';
                      if (formats.raw) displayText += formats.raw;
                      if (formats.raw && formats.sci) displayText += ' / ';
                      if (formats.sci) displayText += formats.sci;
                      if (formats.cn && (a.actualF||0) >= 10000) {
                        displayText += ' / ' + formats.cn;
                      }
                      return displayText;
                    })()}
                  </div>
                  <!-- 按钮和推荐行 -->
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <small style="color:#6b7280;">推荐: ${(() => {
                      const val = (a.recF||0);
                      return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                    })()}</small>
                    <div class="btn-group" style="display:flex; gap:4px;">
                      <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:普通负重" data-gtype="普通负重" data-tooltip="普通负重1.5">普通负重</button>
                      <button type="button" class="btn-radio tag-f alt btn-tooltip" data-growth5="f:${k}:天使负重" data-gtype="天使负重" data-tooltip="天使负重2">天使负重</button>
                      <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:膨胀负重" data-gtype="膨胀负重" data-tooltip="膨胀负重2.25">膨胀负重</button>
                    </div>
                    <button type="button" class="btn-tooltip" data-lock5f="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockF ? '取消沿用' : '沿用上一关'}">${st.lockF ? '取消沿用' : '沿用上一关'}</button>
                  </div>
                </div>
                <div>
                  <!-- 番数输入行 -->
                  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                    <input type="text" id="g5Y_${rowId}" name="g5Y_${rowId}" value="${(a.actualY||0).toFixed(4)}" style="flex:1; padding:4px;" />
                  </div>
                  <div id="g5Y_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                    ${(() => {
                      const formats = formatNumberDisplay((a.actualY||0), 2);
                      let displayText = '';
                      if (formats.raw) displayText += formats.raw;
                      if (formats.raw && formats.sci) displayText += ' / ';
                      if (formats.sci) displayText += formats.sci;
                      if (formats.cn && (a.actualY||0) >= 10000) {
                        displayText += ' / ' + formats.cn;
                      }
                      return displayText;
                    })()}
                  </div>
                  <!-- 按钮和推荐行 -->
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <small style="color:#6b7280;">推荐: ${(() => {
                      const val = (a.recY||0);
                      return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                    })()}</small>
                    <div class="btn-group" style="display:flex; gap:4px;">
                      <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:普通月光" data-gtype="普通月光" data-tooltip="普通月光1.5">普通月光</button>
                      <button type="button" class="btn-radio tag-y alt btn-tooltip" data-growth5="y:${k}:天使月光" data-gtype="天使月光" data-tooltip="天使月光2">天使月光</button>
                      <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:膨胀月光" data-gtype="膨胀月光" data-tooltip="膨胀月光2.25">膨胀月光</button>
                    </div>
                    <button type="button" class="btn-tooltip" data-lock5y="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockY ? '取消沿用' : '沿用上一关'}">${st.lockY ? '取消沿用' : '沿用上一关'}</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        } else if (currentLayout === 'two-column') {
          // 两栏布局：左边前3个关卡，右边后3个关卡
          const leftColumn = keys.slice(0, 3);
          const rightColumn = keys.slice(3, 6);
          
          html = `
            <div style="display:flex; gap:16px; position:relative;">
              <div style="position:absolute; left:50%; top:0; bottom:0; width:1px; background:var(--line); pointer-events:none;"></div>
              <!-- 左栏 -->
              <div style="flex:1; padding-right:8px;">
                ${leftColumn.length > 0 ? `
                <!-- 左栏标题 -->
                <div class="grid-3" style="margin-bottom:12px; font-weight:600; color:var(--text); text-align:center;">
                  <div style="padding:4px;">盗印</div>
                  <div style="padding:4px;">负重</div>
                  <div style="padding:4px;">月光</div>
                </div>
                ` : ''}
                
                ${leftColumn.map((k, index) => {
                  const vSci = parseChinaJiLocal(LEVEL_TARGETS[k]) || LEVEL_TARGETS[k];
                  const vCn = parseChinaJiLocal(LEVEL_TARGETS[k]) ? formatChinaJiLocal(parseChinaJiLocal(LEVEL_TARGETS[k]), getCurrentPrecision()) : LEVEL_TARGETS[k];
                  const vDisp = mode==='sci'? vSci : mode==='cn'? vCn : `${vSci} / ${vCn}`;
                  const a = all[k];
                  const rowId = k.replace(/[^a-zA-Z0-9]/g,'_');
                  const st = levelsState[k] || {};
                  
                  return `
                    <div style="border-bottom:1px solid #eee; padding:12px 0;">
                      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <strong>${k}</strong>
                        <span style="color:#6b7280;">目标分数：${vDisp}</span>
                        <div style="display:flex; gap:8px;">
                          <button type="button" data-confirm5="${k}" class="btn-light">确认手动输入变更</button>
                          <button type="button" data-calc5="${k}">用本关参数计算</button>
                        </div>
                      </div>
                      
                      <div class="grid-3" style="margin-top:6px;">
                        <div>
                          <!-- 番数输入行 -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                            <input type="text" id="g5D_${rowId}" name="g5D_${rowId}" value="${(a.actualD||0).toFixed(4)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5D_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualD||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualD||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- 按钮和推荐行 -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">推荐: ${(() => {
                              const val = (a.recD||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:普通盗印" data-gtype="普通盗印" data-tooltip="普通盗印">普通盗印</button>
                              <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:天使盗印" data-gtype="天使盗印" data-tooltip="天使盗印">天使盗印</button>
                              <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:膨胀盗印" data-gtype="膨胀盗印" data-tooltip="膨胀盗印">膨胀盗印</button>
                              <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:膨胀盗印吃卡维" data-gtype="膨胀盗印吃卡维" data-tooltip="膨胀盗印吃卡维">膨胀盗印吃卡维</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5d="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockD ? '取消沿用' : '沿用上一关'}">${st.lockD ? '取消沿用' : '沿用上一关'}</button>
                          </div>
                        </div>
                        <div>
                          <!-- 番数输入行 -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                            <input type="text" id="g5F_${rowId}" name="g5F_${rowId}" value="${(a.actualF||0).toFixed(4)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5F_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualF||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualF||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- 按钮和推荐行 -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">推荐: ${(() => {
                              const val = (a.recF||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:普通负重" data-gtype="普通负重" data-tooltip="普通负重">普通负重</button>
                              <button type="button" class="btn-radio tag-f alt btn-tooltip" data-growth5="f:${k}:天使负重" data-gtype="天使负重" data-tooltip="天使负重">天使负重</button>
                              <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:膨胀负重" data-gtype="膨胀负重" data-tooltip="膨胀负重">膨胀负重</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5f="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockF ? '取消沿用' : '沿用上一关'}">${st.lockF ? '取消沿用' : '沿用上一关'}</button>
                          </div>
                        </div>
                        <div>
                          <!-- 番数输入行 -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                            <input type="text" id="g5Y_${rowId}" name="g5Y_${rowId}" value="${(a.actualY||0).toFixed(4)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5Y_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualY||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualY||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- 按钮和推荐行 -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">推荐: ${(() => {
                              const val = (a.recY||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:普通月光" data-gtype="普通月光" data-tooltip="普通月光">普通月光</button>
                              <button type="button" class="btn-radio tag-y alt btn-tooltip" data-growth5="y:${k}:天使月光" data-gtype="天使月光" data-tooltip="天使月光">天使月光</button>
                              <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:膨胀月光" data-gtype="膨胀月光" data-tooltip="膨胀月光">膨胀月光</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5y="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockY ? '取消沿用' : '沿用上一关'}">${st.lockY ? '取消沿用' : '沿用上一关'}</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              
              <!-- 右栏 -->
              <div style="flex:1; padding-left:8px;">
                ${rightColumn.length > 0 ? `
                <!-- 右栏标题 -->
                <div class="grid-3" style="margin-bottom:12px; font-weight:600; color:var(--text); text-align:center;">
                  <div style="padding:4px;">盗印</div>
                  <div style="padding:4px;">负重</div>
                  <div style="padding:4px;">月光</div>
                </div>
                ` : ''}
                
                ${rightColumn.map((k, index) => {
                  const vSci = parseChinaJiLocal(LEVEL_TARGETS[k]) || LEVEL_TARGETS[k];
                  const vCn = parseChinaJiLocal(LEVEL_TARGETS[k]) ? formatChinaJiLocal(parseChinaJiLocal(LEVEL_TARGETS[k]), getCurrentPrecision()) : LEVEL_TARGETS[k];
                  const vDisp = mode==='sci'? vSci : mode==='cn'? vCn : `${vSci} / ${vCn}`;
                  const a = all[k];
                  const rowId = k.replace(/[^a-zA-Z0-9]/g,'_');
                  const st = levelsState[k] || {};
                  
                  return `
                    <div style="border-bottom:1px solid #eee; padding:12px 0;">
                      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <strong>${k}</strong>
                        <span style="color:#6b7280;">目标分数：${vDisp}</span>
                        <div style="display:flex; gap:8px;">
                          <button type="button" data-confirm5="${k}" class="btn-light">确认手动输入变更</button>
                          <button type="button" data-calc5="${k}">用本关参数计算</button>
                        </div>
                      </div>
                      
                      <div class="grid-3" style="margin-top:6px;">
                        <div>
                          <!-- 番数输入行 -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                            <input type="text" id="g5D_${rowId}" name="g5D_${rowId}" value="${(a.actualD||0).toFixed(4)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5D_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualD||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualD||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- 按钮和推荐行 -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">推荐: ${(() => {
                              const val = (a.recD||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:普通盗印" data-gtype="普通盗印" data-tooltip="普通盗印">普通盗印</button>
                              <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:天使盗印" data-gtype="天使盗印" data-tooltip="天使盗印">天使盗印</button>
                              <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:膨胀盗印" data-gtype="膨胀盗印" data-tooltip="膨胀盗印">膨胀盗印</button>
                              <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:膨胀盗印吃卡维" data-gtype="膨胀盗印吃卡维" data-tooltip="膨胀盗印吃卡维">膨胀盗印吃卡维</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5d="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockD ? '取消沿用' : '沿用上一关'}">${st.lockD ? '取消沿用' : '沿用上一关'}</button>
                          </div>
                        </div>
                        <div>
                          <!-- 番数输入行 -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                            <input type="text" id="g5F_${rowId}" name="g5F_${rowId}" value="${(a.actualF||0).toFixed(4)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5F_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualF||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualF||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- 按钮和推荐行 -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">推荐: ${(() => {
                              const val = (a.recF||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:普通负重" data-gtype="普通负重" data-tooltip="普通负重">普通负重</button>
                              <button type="button" class="btn-radio tag-f alt btn-tooltip" data-growth5="f:${k}:天使负重" data-gtype="天使负重" data-tooltip="天使负重">天使负重</button>
                              <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:膨胀负重" data-gtype="膨胀负重" data-tooltip="膨胀负重">膨胀负重</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5f="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockF ? '取消沿用' : '沿用上一关'}">${st.lockF ? '取消沿用' : '沿用上一关'}</button>
                          </div>
                        </div>
                        <div>
                          <!-- 番数输入行 -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">番数:</span>
                            <input type="text" id="g5Y_${rowId}" name="g5Y_${rowId}" value="${(a.actualY||0).toFixed(4)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5Y_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualY||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualY||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- 按钮和推荐行 -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">推荐: ${(() => {
                              const val = (a.recY||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:普通月光" data-gtype="普通月光" data-tooltip="普通月光">普通月光</button>
                              <button type="button" class="btn-radio tag-y alt btn-tooltip" data-growth5="y:${k}:天使月光" data-gtype="天使月光" data-tooltip="天使月光">天使月光</button>
                              <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:膨胀月光" data-gtype="膨胀月光" data-tooltip="膨胀月光">膨胀月光</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5y="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockY ? '取消沿用' : '沿用上一关'}">${st.lockY ? '取消沿用' : '沿用上一关'}</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }
        
        $('levelList5').innerHTML = html;
        
        // 绑定事件（每次渲染后重新绑定）- 限定在 levelList5 容器内
        const container5 = document.getElementById('levelList5');
        
        // 更新按钮选中状态的函数（在 renderPage5 内部定义，供内部使用）
        const updateButtonStates = () => {
          // 遍历所有关卡的增长类型按钮
          keyOrder.forEach(level => {
            // 盗印按钮
            ['普通盗印', '天使盗印', '膨胀盗印', '膨胀盗印吃卡维'].forEach(type => {
              const btn = container5.querySelector(`button[data-gtype="${type}"][data-growth5^="d:${level}:"]`);
              if (btn) {
                const currentType = resolveTypeAtIndex('d', keyOrder.indexOf(level));
                btn.classList.toggle('selected', currentType === type);
              }
            });
            
            // 负重按钮
            ['普通负重', '天使负重', '膨胀负重'].forEach(type => {
              const btn = container5.querySelector(`button[data-gtype="${type}"][data-growth5^="f:${level}:"]`);
              if (btn) {
                const currentType = resolveTypeAtIndex('f', keyOrder.indexOf(level));
                btn.classList.toggle('selected', currentType === type);
              }
            });
            
            // 月光按钮
            ['普通月光', '天使月光', '膨胀月光'].forEach(type => {
              const btn = container5.querySelector(`button[data-gtype="${type}"][data-growth5^="y:${level}:"]`);
              if (btn) {
                const currentType = resolveTypeAtIndex('y', keyOrder.indexOf(level));
                btn.classList.toggle('selected', currentType === type);
              }
            });
          });
        };

        // 增长类型按钮
        container5.querySelectorAll('button[data-growth5]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Growth button clicked:', btn.getAttribute('data-growth5'));
            
            const dataValue = btn.getAttribute('data-growth5');
            const parts = dataValue.split(':');
            if (parts.length < 3) return;
            const kind = parts[0];
            const key = parts[1];
            const type = parts[2];
            
            console.log('Applying type:', type, 'from level:', key);
            
            const startIdx = keyOrder.indexOf(key);
            if (startIdx === -1) return;
            
            // 从该关起应用到所有后续关卡
            for (let i=startIdx; i<keyOrder.length; i++){
              const k2 = keyOrder[i];
              ivData[k2] = ivData[k2] || {};
              if (kind === 'd') ivData[k2].dType = type;
              if (kind === 'f') ivData[k2].fType = type;
              if (kind === 'y') ivData[k2].yType = type;
            }
            console.log('ivData updated, sample:', {
              '1-1': ivData['1-1'],
              '1-2': ivData['1-2'],
              '1-3': ivData['1-3']
            });
            
            // 更新按钮选中状态
            updateButtonStates();
            
            renderPage5();
          });
        });
        
        // 沿用上一关按钮 - 参考 renderPage 的实现
        container5.querySelectorAll('button[data-lock5d]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-lock5d');
            console.log('Lock D clicked for:', k);
            // 切换 lockD 状态（与 renderPage 一致）
            levelsState[k] = levelsState[k] || {};
            levelsState[k].lockD = !levelsState[k].lockD;
            console.log('lockD state:', levelsState[k].lockD);
            renderPage5();
          });
        });
        container5.querySelectorAll('button[data-lock5f]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-lock5f');
            levelsState[k] = levelsState[k] || {};
            levelsState[k].lockF = !levelsState[k].lockF;
            renderPage5();
          });
        });
        container5.querySelectorAll('button[data-lock5y]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-lock5y');
            levelsState[k] = levelsState[k] || {};
            levelsState[k].lockY = !levelsState[k].lockY;
            renderPage5();
          });
        });
        
        // 用本关参数计算按钮
        container5.querySelectorAll('button[data-calc5]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-calc5');
            const a = all[k];
            
            // 修复：同步设置关卡选择器和目标分数
            $('levelSelect').value = k;
            $('targetScore').value = LEVEL_TARGETS[k];
            
            $('daoyin').value = `${(a.actualD||0).toFixed(6)}`;
            $('fuzhong').value = `${(a.actualF||0).toFixed(6)}`;
            $('yueguang').value = `${(a.actualY||0).toFixed(6)}`;
            // 同步刷新右下角格式显示
            updateStampDisplay();
            const unlockD = $('unlockD').value;
            const unlockF = $('unlockF').value;
            const unlockY = $('unlockY').value;
            const kIdx = keyOrder.indexOf(k);
            const idxD = keyOrder.indexOf(unlockD);
            const idxF = keyOrder.indexOf(unlockF);
            const idxY = keyOrder.indexOf(unlockY);
            $('trigD').value = kIdx >= idxD && idxD>=0 ? $('trigD').value : '0';
            $('trigF').value = kIdx >= idxF && idxF>=0 ? $('trigF').value : '0';
            $('trigY').value = kIdx >= idxY && idxY>=0 ? $('trigY').value : '0';
            await computeWithForm();
            
            // 自动弹出计算结果模态框
            const resultToggle = document.getElementById('resultToggle');
            const floatingResult = document.getElementById('floatingResult');
            if (resultToggle && floatingResult) {
              resultToggle.checked = true;
              floatingResult.style.display = 'block';
            }
            // 更新预测
            updatePrediction();
          });
        });
        
        // 为番数输入框添加实时显示大数字系统的事件监听器
        container5.querySelectorAll('input[id^="g5D_"], input[id^="g5F_"], input[id^="g5Y_"]').forEach(input => {
          input.addEventListener('input', function() {
            const value = this.value.trim();
            const displayId = this.id.replace(/^g5([DFY])_/, 'g5$1_display_');
            const displayEl = document.getElementById(displayId);
            
            if (displayEl) {
              if (!value) {
                displayEl.textContent = '';
                return;
              }
              
              // 尝试解析输入值
              let num = parseFloat(value);
              if (isNaN(num)) {
                const sciStr = parseChinaJiLocal(value);
                if (sciStr) {
                  num = parseFloat(sciStr);
                }
              }
              
              if (!isNaN(num)) {
                const formats = formatNumberDisplay(num, 2);
                let displayText = '';
                
                if (formats.raw) displayText += formats.raw;
                if (formats.raw && formats.sci) displayText += ' / ';
                if (formats.sci) displayText += formats.sci;
                if (formats.cn && num >= 10000) {
                  displayText += ' / ' + formats.cn;
                }
                
                displayEl.textContent = displayText;
              } else {
                displayEl.textContent = '';
              }
            }
          });
        });
        
        // 确认手动输入变更按钮
        container5.querySelectorAll('button[data-confirm5]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-confirm5');
            const rowId = k.replace(/[^a-zA-Z0-9]/g,'_');
            
            // 获取用户输入的番数值
            const inputD = document.getElementById(`g5D_${rowId}`);
            const inputF = document.getElementById(`g5F_${rowId}`);
            const inputY = document.getElementById(`g5Y_${rowId}`);
            
            if (!inputD || !inputF || !inputY) return;
            
            // 解析输入值（支持大数字系统）
            const parseInput = (value) => {
              const trimmed = value.trim();
              if (!trimmed) return null;
              
              // 先尝试解析大数字系统（包括小数部分）
              const sciStr = parseChinaJiLocal(trimmed);
              if (sciStr) {
                const num = parseFloat(sciStr);
                return isNaN(num) ? null : num;
              }
              
              // 如果解析失败，尝试直接解析数字
              const num = parseFloat(trimmed);
              return isNaN(num) ? null : num;
            };
            
            const newD = parseInput(inputD.value);
            const newF = parseInput(inputF.value);
            const newY = parseInput(inputY.value);
            
            console.log('Confirming manual input for:', k, { newD, newF, newY });
            
            // 更新 levelsState 中的手动输入值（保存解析后的数值字符串）
            levelsState[k] = levelsState[k] || {};
            if (newD !== null) levelsState[k].manuD = newD.toString();
            if (newF !== null) levelsState[k].manuF = newF.toString();
            if (newY !== null) levelsState[k].manuY = newY.toString();
            
            // 清除后续关卡的手动输入值，确保按最后一次确认的手动输入为准
            const currentIndex = keyOrder.indexOf(k);
            for (let i = currentIndex + 1; i < keyOrder.length; i++) {
              const nextKey = keyOrder[i];
              if (levelsState[nextKey]) {
                delete levelsState[nextKey].manuD;
                delete levelsState[nextKey].manuF;
                delete levelsState[nextKey].manuY;
              }
            }
            
            // 刷新页面显示
            renderPage5();
          });
        });
        
        // 在事件绑定完成后更新按钮状态
        updateButtonStates();
        
        $('pageInfo5').textContent = `第 ${page5+1} 页 / 共 ${Math.ceil(keyOrder.length/PAGE5)} 页`;
      }
      
      document.getElementById('prev5').addEventListener('click', ()=>{ if (page5>0){ page5--; renderPage5(); }});
      document.getElementById('next5').addEventListener('click', ()=>{ if ((page5+1)*PAGE5 < keyOrder.length){ page5++; renderPage5(); }});
      
      // 布局切换按钮事件监听器
      document.getElementById('layoutSwitch').addEventListener('click', () => {
        currentLayout = 'single';
        document.getElementById('layoutSwitch').classList.add('active');
        document.getElementById('layoutSwitch2').classList.remove('active');
        renderPage5();
      });
      
      document.getElementById('layoutSwitch2').addEventListener('click', () => {
        currentLayout = 'two-column';
        document.getElementById('layoutSwitch2').classList.add('active');
        document.getElementById('layoutSwitch').classList.remove('active');
        renderPage5();
      });
      
      // 初始化渲染每页6项列表（放在定义与监听之后，避免引用顺序错误）
      renderPage5();
  // 初始化历史列表
  populateHistorySelect();
  // 绑定新流程控件
  const saveBtn = document.getElementById('saveCurrentBtn');
  if (saveBtn) saveBtn.addEventListener('click', ()=>{ const f=document.getElementById('saveFlow'); if (f) f.style.display='flex'; });
  const confirmSaveBtn = document.getElementById('confirmSaveBtn');
  if (confirmSaveBtn) confirmSaveBtn.addEventListener('click', ()=>{ saveCurrentLevelData(); const f=document.getElementById('saveFlow'); const i=document.getElementById('historyName'); if(f) f.style.display='none'; if(i) i.value=''; });
  const cancelSaveBtn = document.getElementById('cancelSaveBtn');
  if (cancelSaveBtn) cancelSaveBtn.addEventListener('click', ()=>{ const f=document.getElementById('saveFlow'); const i=document.getElementById('historyName'); if(f) f.style.display='none'; if(i) i.value=''; });
  const delBtn = document.getElementById('dropdownDeleteBtn');
  if (delBtn) delBtn.addEventListener('click', deleteHistory);
  const historySelect = document.getElementById('historySelect');
  if (historySelect) historySelect.addEventListener('change', ()=>{ if(historySelect.value) loadHistoryLevelData(); });
      
      
      // 未来关卡预测功能
      function predictFutureLevels() {
        try {
          const all = computeRecommendedAll();
          const currentLevel = $('levelSelect')?.value;
          const currentIdx = currentLevel ? keyOrder.indexOf(currentLevel) : -1;
          
          // 如果找不到当前关卡，不执行预测
          if (currentIdx === -1) {
            const currentEl = document.getElementById('currentPrediction');
            const maxEl = document.getElementById('maxPrediction');
            if (currentEl) currentEl.innerHTML = '<span style="color: var(--muted);">请先选择关卡</span>';
            if (maxEl) maxEl.innerHTML = '<span style="color: var(--muted);">请先选择关卡</span>';
            return;
          }
          
          // 获取当前触发次数
          const currentTrigD = Number(($('trigD')?.value) || '0');
          const currentTrigF = Number(($('trigF')?.value) || '0');
          const currentTrigY = Number(($('trigY')?.value) || '0');
          
          // 获取最大触发次数
          const maxTrigD = Number(($('maxTrigD')?.value) || '0');
          const maxTrigF = Number(($('maxTrigF')?.value) || '0');
          const maxTrigY = Number(($('maxTrigY')?.value) || '0');
        
        // 预测函数
        const predict = (trigD, trigF, trigY, label) => {
          let result = '';
          let found = false;
          
          for (let i = currentIdx + 1; i < keyOrder.length; i++) {
            const level = keyOrder[i];
            const targetScore = parseFloat(parseChinaJiLocal(LEVEL_TARGETS[level]) || LEVEL_TARGETS[level]);
            const levelData = all[level];
            
            if (!levelData) continue;
            
            // 计算总分数（使用指定的触发次数）
            const totalScore = levelData.baseScore * levelData.finalMultiplier * 
                             Math.pow(levelData.actualD, trigD) * 
                             Math.pow(levelData.actualF, trigF) * 
                             Math.pow(levelData.actualY, trigY);
            
            if (totalScore > targetScore) {
              const ratio = totalScore / targetScore;
              const targetDisp = formatChinaJiLocal(targetScore.toString(), 2);
              const scoreDisp = formatChinaJiLocal(totalScore.toString(), 2);
              
              result = `<span style="color: var(--ok); font-weight: bold;">${level}</span> - 目标: ${targetDisp}, 预计得分: ${scoreDisp} (${ratio.toFixed(1)}倍)`;
              found = true;
              break;
            }
          }
          
          if (!found) {
            result = '<span style="color: var(--muted);">无法在当前配置下超越目标分</span>';
          }
          
          return result;
        };
        
          // 更新预测显示
          const currentEl = document.getElementById('currentPrediction');
          const maxEl = document.getElementById('maxPrediction');
          
          if (currentEl) {
            currentEl.innerHTML = predict(currentTrigD, currentTrigF, currentTrigY, '当前配置');
          }
          
          if (maxEl) {
            maxEl.innerHTML = predict(maxTrigD, maxTrigF, maxTrigY, '最大配置');
          }
        } catch (error) {
          console.error('预测未来关卡时出错:', error);
          const currentEl = document.getElementById('currentPrediction');
          const maxEl = document.getElementById('maxPrediction');
          if (currentEl) currentEl.innerHTML = '<span style="color: var(--danger);">预测出错</span>';
          if (maxEl) maxEl.innerHTML = '<span style="color: var(--danger);">预测出错</span>';
        }
      }
      
      // 在计算完成后更新预测（已移除，避免重复调用）
      // const originalComputeWithForm = window.computeWithForm;
      // window.computeWithForm = async function() {
      //   const result = await originalComputeWithForm();
      //   updatePrediction(); // 使用新的预测函数
      //   return result;
      // };
      
      
      // 区块选择器功能
      function updateBlockVisibility() {
        const blocks = document.querySelectorAll('.config-block');
        blocks.forEach(block => {
          const blockType = block.dataset.block;
          const button = document.querySelector(`[data-block="${blockType}"].block-btn`);
          if (button) {
            if (button.classList.contains('active')) {
              block.classList.remove('hidden');
            } else {
              block.classList.add('hidden');
            }
          }
        });
      }
      
      // 区块折叠功能
      function toggleBlockCollapse(block) {
        const content = block.querySelector('.block-content');
        const toggle = block.querySelector('.block-toggle');
        
        if (content.classList.contains('expanded')) {
          content.classList.remove('expanded');
          content.classList.add('collapsed');
          block.classList.add('collapsed');
          toggle.textContent = '▶';
        } else {
          content.classList.remove('collapsed');
          content.classList.add('expanded');
          block.classList.remove('collapsed');
          toggle.textContent = '▼';
        }
      }
      
      // 初始化区块选择器事件监听
      document.querySelectorAll('.block-btn').forEach(button => {
        button.addEventListener('click', () => {
          button.classList.toggle('active');
          updateBlockVisibility();
        });
      });
      
      // 初始化区块折叠事件监听
      document.querySelectorAll('.config-block h4').forEach(header => {
        header.addEventListener('click', () => {
          toggleBlockCollapse(header.closest('.config-block'));
        });
      });
      
      // 初始化区块可见性
      updateBlockVisibility();
      
      // 悬浮窗功能
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };
      const floatingWindow = document.getElementById('floatingResult');
      const floatingHeader = floatingWindow.querySelector('.floating-header');
      const resultToggle = document.getElementById('resultToggle');
      const floatingClose = document.getElementById('floatingClose');
      
      // 开关控制悬浮窗显示/隐藏
      resultToggle.addEventListener('change', function() {
        if (this.checked) {
          floatingWindow.style.display = 'block';
        } else {
          floatingWindow.style.display = 'none';
        }
      });
      
      // 关闭按钮
      floatingClose.addEventListener('click', function(e) {
        e.stopPropagation();
        floatingWindow.style.display = 'none';
        resultToggle.checked = false;
      });
      
      // 拖拽功能
      floatingHeader.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('floating-close')) {
          return;
        }
        
        isDragging = true;
        const rect = floatingWindow.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', stopDrag);
        e.preventDefault();
      });
      
      function handleDrag(e) {
        if (!isDragging) return;
        
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        const floatingWidth = floatingWindow.offsetWidth;
        const floatingHeight = floatingWindow.offsetHeight;
        
        let newX = e.clientX - dragOffset.x;
        let newY = e.clientY - dragOffset.y;
        
        // 限制不超出页面边界
        newX = Math.max(0, Math.min(newX, windowWidth - floatingWidth));
        newY = Math.max(0, Math.min(newY, windowHeight - floatingHeight));
        
        floatingWindow.style.left = newX + 'px';
        floatingWindow.style.top = newY + 'px';
        floatingWindow.style.right = 'auto';
      }
      
      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', handleDrag);
        document.removeEventListener('mouseup', stopDrag);
      }
      
      // 初始化悬浮窗位置
      function initFloatingWindow() {
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        
        // 先显示悬浮窗以获取实际尺寸
        floatingWindow.style.display = 'block';
        const floatingWidth = floatingWindow.offsetWidth;
        const floatingHeight = floatingWindow.offsetHeight;
        
        // 默认位置：右侧居中
        let defaultX = windowWidth - floatingWidth - 20;
        let defaultY = Math.max(120, (windowHeight - floatingHeight) / 2);
        
        // 确保不超出边界
        defaultX = Math.max(20, Math.min(defaultX, windowWidth - floatingWidth - 20));
        defaultY = Math.max(20, Math.min(defaultY, windowHeight - floatingHeight - 20));
        
        floatingWindow.style.left = defaultX + 'px';
        floatingWindow.style.top = defaultY + 'px';
        floatingWindow.style.right = 'auto';
        
        // 初始隐藏
        floatingWindow.style.display = 'none';
      }
      
      // 页面加载时初始化
      initFloatingWindow();
      
      // 窗口大小改变时重新定位
      window.addEventListener('resize', function() {
        if (floatingWindow.style.display !== 'none') {
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;
          const floatingWidth = floatingWindow.offsetWidth;
          const floatingHeight = floatingWindow.offsetHeight;
          
          const currentLeft = parseInt(floatingWindow.style.left) || 0;
          const currentTop = parseInt(floatingWindow.style.top) || 0;
          
          let newX = Math.max(0, Math.min(currentLeft, windowWidth - floatingWidth));
          let newY = Math.max(0, Math.min(currentTop, windowHeight - floatingHeight));
          
          floatingWindow.style.left = newX + 'px';
          floatingWindow.style.top = newY + 'px';
        }
      });
      
      // 精度按钮功能
      document.querySelectorAll('.precision-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // 移除所有active类
          document.querySelectorAll('.precision-btn').forEach(b => b.classList.remove('active'));
          // 添加active类到当前按钮
          btn.classList.add('active');
          // 更新精度值
          const precision = parseInt(btn.dataset.precision);
          // 触发计算更新（如果已经有结果的话）
          if (document.getElementById('resTotalSci').textContent !== '-') {
            computeWithForm();
          }
        });
      });
      
      // 获取当前精度的函数
      function getCurrentPrecision() {
        const activeBtn = document.querySelector('.precision-btn.active');
        return activeBtn ? parseInt(activeBtn.dataset.precision) : 2;
      }

      // 配色方案切换
      let lastActiveTheme = 'default'; // 记录上一个有效的主题
      
      document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', () => {
          // 获取主题名称
          const themeName = option.dataset.theme;
          
          // 检查是否是彩蛋主题
          if (themeName === 'easter-egg') {
            // 恢复之前的状态，不改变active类
            document.getElementById('easterEggModal').style.display = 'block';
            return;
          }
          
          // 更新记录的有效主题
          lastActiveTheme = themeName;
          
          // 移除所有active类
          document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
          // 添加active类到当前选项
          option.classList.add('active');
          
          // 移除所有主题类
          document.body.classList.remove('theme-16QwQ', 'theme-buxingshx', 'theme-life', 'theme-purple', 'theme-rainbow', 'theme-wonderful', 'theme-16yyds');
          
          // 如果不是默认主题，添加对应的主题类
          if (themeName !== 'default') {
            document.body.classList.add(`theme-${themeName}`);
          }
          
          // 保存到localStorage
          localStorage.setItem('selectedTheme', themeName);
        });
      });
      
      // 彩蛋模态框关闭函数
      window.closeEasterEgg = function() {
        document.getElementById('easterEggModal').style.display = 'none';
      };
      
      // 轮播提示框功能
      const gameTips = [
        "进入关卡前和自摸时注意顺序哦",
        "吸星器，王之召唤等护身符+0分/×1番的时候先不要进链哦",
        "可以用迷雾印章、成长印章让盗印多吃印章哦",
        "商店买不到储备粮食的话，让改造王改绿卡试试看呢",
        "找生命的话，莱恩要放在墨镜猫右边哦",
        "找不到传导卡的时候，可以留恋人牌刷出传导后，用改造王改哦"
      ];
      
      let currentTipIndex = 0;
      let tipsInterval;
      
      function initTipsCarousel() {
        const tipsContent = document.getElementById('tipsContent');
        const tipsDots = document.getElementById('tipsDots');
        
        // 创建指示点
        gameTips.forEach((tip, index) => {
          const dot = document.createElement('div');
          dot.className = 'tips-dot';
          if (index === 0) dot.classList.add('active');
          dot.addEventListener('click', () => showTip(index));
          tipsDots.appendChild(dot);
        });
        
        // 开始自动轮播
        startTipsRotation();
        
        // 鼠标悬停时暂停轮播
        document.querySelector('.tips-carousel').addEventListener('mouseenter', stopTipsRotation);
        document.querySelector('.tips-carousel').addEventListener('mouseleave', startTipsRotation);
      }
      
      function showTip(index) {
        const tipsContent = document.getElementById('tipsContent');
        const dots = document.querySelectorAll('.tips-dot');
        
        // 移除当前活跃状态
        tipsContent.classList.remove('active');
        dots.forEach(dot => dot.classList.remove('active'));
        
        // 延迟后显示新内容
        setTimeout(() => {
          tipsContent.textContent = gameTips[index];
          tipsContent.classList.add('active');
          dots[index].classList.add('active');
          currentTipIndex = index;
        }, 250);
      }
      
      function startTipsRotation() {
        stopTipsRotation();
        tipsInterval = setInterval(() => {
          const nextIndex = (currentTipIndex + 1) % gameTips.length;
          showTip(nextIndex);
        }, 4000); // 每4秒切换一次
      }
      
      function stopTipsRotation() {
        if (tipsInterval) {
          clearInterval(tipsInterval);
          tipsInterval = null;
        }
      }
      
      // 加载保存的主题
      const savedTheme = localStorage.getItem('selectedTheme') || 'default';
      const themeOption = document.querySelector(`[data-theme="${savedTheme}"]`);
      if (themeOption) {
        themeOption.click();
      }
      
      // 为"选项（印章番数）"的输入框添加实时显示三种格式
      function updateStampDisplay() {
        const inputs = [
          { input: 'daoyin', display: 'daoyin_display' },
          { input: 'fuzhong', display: 'fuzhong_display' },
          { input: 'yueguang', display: 'yueguang_display' }
        ];
        
        inputs.forEach(({ input, display }) => {
          const inputEl = document.getElementById(input);
          const displayEl = document.getElementById(display);
          
          if (inputEl && displayEl) {
            const value = inputEl.value.trim();
            if (!value) {
              displayEl.textContent = '';
              return;
            }
            
            // 尝试解析输入值
            let num = parseFloat(value);
            if (isNaN(num)) {
              const sciStr = parseChinaJiLocal(value);
              if (sciStr) {
                num = parseFloat(sciStr);
              }
            }
            
            if (!isNaN(num)) {
              const formats = formatNumberDisplay(num, 2);
              let displayText = '';
              
              if (formats.raw) displayText += formats.raw;
              if (formats.raw && formats.sci) displayText += ' / ';
              if (formats.sci) displayText += formats.sci;
              if (formats.cn && num >= 10000) {
                displayText += ' / ' + formats.cn;
              }
              
              displayEl.textContent = displayText;
            } else {
              displayEl.textContent = '';
            }
          }
        });
      }
      
      // 为印章番数输入框添加事件监听器
      ['daoyin', 'fuzhong', 'yueguang'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('input', updateStampDisplay);
        }
      });
      
      // 初始化显示
      updateStampDisplay();
      
      
      // 确认起始关按钮事件监听器（带反馈）
      document.getElementById('unlockApply').addEventListener('click', ()=>{
        const button = document.getElementById('unlockApply');
        const originalText = button.textContent;
        
        // 显示反馈
        button.textContent = '✓ 已确认';
        button.style.background = 'var(--ok)';
        button.style.color = 'var(--card)';
        
        // 刷新页面
        renderPage5();
        
        // 2秒后恢复原状
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '';
          button.style.color = '';
        }, 2000);
      });
      
      // 初始化轮播提示框
      initTipsCarousel();

      // 卡片折叠/展开功能
      document.querySelectorAll('.card-toggle').forEach(button => {
        button.addEventListener('click', () => {
          const targetId = button.dataset.target;
          const content = document.getElementById(targetId);
          const isCollapsed = content.classList.contains('collapsed');
          
          if (isCollapsed) {
            content.classList.remove('collapsed');
            button.textContent = '−';
          } else {
            content.classList.add('collapsed');
            button.textContent = '+';
          }
        });
      });
      
      // 区块折叠/展开功能
      document.querySelectorAll('.config-block h4').forEach(header => {
        header.addEventListener('click', () => {
          const block = header.closest('.config-block');
          const content = block.querySelector('.block-content');
          const toggle = block.querySelector('.block-toggle');
          const isCollapsed = block.classList.contains('collapsed');
          
          if (isCollapsed) {
            block.classList.remove('collapsed');
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            toggle.textContent = '▼';
          } else {
            block.classList.add('collapsed');
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            toggle.textContent = '▶';
          }
        });
      });

      // 数字输入控件功能
      document.querySelectorAll('.number-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const target = btn.dataset.target;
          const action = btn.dataset.action;
          const input = document.getElementById(target);
          
          if (input) {
            let value = parseInt(input.value) || 0;
            if (action === 'increase') {
              value += 1;
            } else if (action === 'decrease') {
              value = Math.max(0, value - 1);
            }
            input.value = value;
            
            // 触发input事件，确保其他监听器能收到更新
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });
      });

      // 王之召唤开关（已屏蔽）
      // const kingEnabled = document.getElementById('kingEnabled');
      // const kingBox = document.getElementById('kingBox');
      // kingEnabled.addEventListener('change', ()=>{
      //   kingBox.style.display = kingEnabled.checked ? 'block' : 'none';
      // });
      
      // 绑定预测更新按钮（移除重复绑定，统一在底部使用防抖机制）
      // document.getElementById('updatePrediction').addEventListener('click', updatePrediction);
      
      // 格式化数字显示（用于预测功能）
      function formatPredictionNumber(value, digits = 2) {
        if (!value || value === '-' || value === 0) return '0';
        
        let originalValue = value;
        let sciString = '';
        
        if (typeof value === 'string') {
          // 先尝试解析中国大数字系统格式
          const parsed = parseChinaJiLocal(value);
          originalValue = parsed || value;
          
          // 检查是否为科学计数法格式
          const sciMatch = originalValue.match(/^\s*([-+]?\d+(?:\.\d+)?)e([-+]?\d+)\s*$/i);
          if (sciMatch) {
            const coeff = parseFloat(sciMatch[1]);
            const expo = parseInt(sciMatch[2], 10);
            
            // 如果指数超过 JavaScript 安全范围，直接使用字符串处理
            if (expo > 1000 || !isFinite(coeff) || !isFinite(expo)) {
              sciString = originalValue;
            } else {
              const num = parseFloat(originalValue);
              if (isFinite(num)) {
                // 1万以下的数不显示科学计数法
                if (num < 10000) {
                  return num.toFixed(digits);
                }
                sciString = num.toExponential(15);
              } else {
                sciString = originalValue;
              }
            }
          } else {
            // 尝试解析为普通数字
            const num = parseFloat(originalValue);
            if (isFinite(num)) {
              // 1万以下的数不显示科学计数法
              if (num < 10000) {
                return num.toFixed(digits);
              }
              sciString = num.toExponential(15);
            } else {
              // 如果 parseFloat 失败，可能是超大数字，尝试直接处理
              sciString = originalValue;
            }
          }
        } else {
          const num = parseFloat(value);
          if (isFinite(num)) {
            // 1万以下的数不显示科学计数法
            if (num < 10000) {
              return num.toFixed(digits);
            }
            sciString = num.toExponential(15);
          } else {
            sciString = value.toString();
          }
        }
        
        // 如果 sciString 为空或无效，返回 '-'
        if (!sciString) return '-';
        
        // 生成科学计数法显示
        let sciDisplay = sciString;
        if (sciString.includes('e') || sciString.includes('E')) {
          const sciMatch = sciString.match(/^\s*([-+]?\d+(?:\.\d+)?)e([-+]?\d+)\s*$/i);
          if (sciMatch) {
            const coeff = parseFloat(sciMatch[1]);
            const expo = parseInt(sciMatch[2], 10);
            if (isFinite(coeff) && isFinite(expo)) {
              sciDisplay = `${coeff.toFixed(digits)}e${expo}`;
            }
          }
        }
        
        // 中国大数字系统转换
        const cn = formatChinaJiLocal(sciString, digits);
        
        return `${sciDisplay} / ${cn}`;
      }
      
      // 格式化目标分数显示（显示原始样式）
      function formatTargetScore(value) {
        if (!value || value === '-' || value === 0) return '0';
        
        // 先尝试解析中国大数字系统格式
        const parsed = parseChinaJiLocal(value);
        const num = parseFloat(parsed || value);
        
        // 若超出 JS Number 范围或解析失败，直接使用原始字符串 + 中国大数格式
        if (!isFinite(num) || isNaN(num)) {
          const raw = String(value);
          const cn = formatChinaJiLocal(raw, 2);
          return `${raw} / ${cn}`;
        }
        
        // 1万以下的数不显示科学计数法
        if (num < 10000) {
          return num.toString();
        }
        
        // 科学计数法
        const sci = num.toExponential(2);
        
        // 中国大数字系统
        const cn = formatChinaJiLocal(num.toString(), 2);
        
        return `${sci} / ${cn}`;
      }
      
      // 比较得分和目标分的辅助函数（处理科学计数法格式）
      function compareScores(score, targetStr) {
        if (!targetStr || targetStr === '-') return true; // 没有目标分则通过
        
        // 解析目标分为科学计数法格式
        const parsedTarget = parseChinaJiLocal(targetStr) || targetStr;
        
        // 如果目标分是科学计数法格式（如 "5.70E+310"）
        if (typeof parsedTarget === 'string' && parsedTarget.includes('E')) {
          // 将得分转换为科学计数法进行比较
          const scoreStr = score.toExponential();
          return compareScientificNotation(scoreStr, parsedTarget);
        }
        
        // 普通数字比较
        const targetNum = parseFloat(parsedTarget);
        if (isFinite(targetNum)) {
          return score >= targetNum;
        }
        
        // 如果无法解析目标分，默认通过
        return true;
      }
      
      // 比较两个科学计数法字符串
      function compareScientificNotation(scoreStr, targetStr) {
        try {
          // 解析科学计数法
          const parseSci = (str) => {
            const match = str.match(/^([+-]?\d+(?:\.\d+)?)[eE]([+-]?\d+)$/);
            if (!match) return null;
            return {
              coefficient: parseFloat(match[1]),
              exponent: parseInt(match[2])
            };
          };
          
          const scoreParts = parseSci(scoreStr);
          const targetParts = parseSci(targetStr);
          
          if (!scoreParts || !targetParts) return true;
          
          // 比较指数
          if (scoreParts.exponent > targetParts.exponent) return true;
          if (scoreParts.exponent < targetParts.exponent) return false;
          
          // 指数相同，比较系数
          return scoreParts.coefficient >= targetParts.coefficient;
        } catch (e) {
          console.warn('科学计数法比较失败:', e);
          return true;
        }
      }
      
      // 预测功能 - 复用计算结果区块的计算逻辑
      async function updatePrediction() {
        try {
          // 使用computeWithForm的计算逻辑来获取准确的结果
          const currentLevel = document.getElementById('levelSelect').value;
          const baseScore = parseFloat(document.getElementById('baseScore').value) || 0;
          
          if (baseScore <= 0) {
            // 清空显示
            const clearElement = (id) => {
              const el = document.getElementById(id);
              if (el) el.textContent = '请先进行计算';
            };
            
            clearElement('predCurrentLevelTarget');
            clearElement('predCurrentScore');
            clearElement('predMaxScore');
            clearElement('predBreakdown');
            clearElement('currentPrediction');
            clearElement('maxPrediction');
            return;
          }
          
          // 调用computeWithForm获取计算结果，但不更新UI
          const result = await computeWithFormInternal();
          
          if (result) {
            // 获取触发次数
            const trigD = parseInt(document.getElementById('trigD').value) || 0;
            const trigF = parseInt(document.getElementById('trigF').value) || 0;
            const trigY = parseInt(document.getElementById('trigY').value) || 0;
            const maxTrigD = parseInt(document.getElementById('theoD').value) || 0;
            const maxTrigF = parseInt(document.getElementById('theoF').value) || 0;
            const maxTrigY = parseInt(document.getElementById('theoY').value) || 0;
            
            // 获取护身符数值
            const daoyinValue = parseFloat(document.getElementById('daoyin').value) || 1;
            const fuzhongValue = parseFloat(document.getElementById('fuzhong').value) || 1;
            const yueguangValue = parseFloat(document.getElementById('yueguang').value) || 1;
            
            // 更新当前关卡信息与目标分
            const targetScoreStr = LEVEL_TARGETS[currentLevel];
            
            document.getElementById('predCurrentLevelTarget').innerHTML = `
              当前关卡：${currentLevel}  目标分:${formatTargetScore(targetScoreStr)}
            `;
            
            // 使用API返回的结果更新预测显示
            document.getElementById('predCurrentScore').textContent = result.totalScore || '-';
            document.getElementById('predMaxScore').textContent = result.theoreticalTotalScore || '-';
            
            // 更新分解（番数与触发次数）显示 - 使用API返回的准确数据
            const dv = result.breakdown?.daoyin?.value;
            const fv = result.breakdown?.fuzhong?.value;
            const yv = result.breakdown?.yueguang?.value;
            const dvSci = dv != null ? parseFloat(dv).toExponential(2) : '-';
            const fvSci = fv != null ? parseFloat(fv).toExponential(2) : '-';
            const yvSci = yv != null ? parseFloat(yv).toExponential(2) : '-';
            const dvCn = dv != null ? formatChinaJiLocal(dvSci, 2) : '-';
            const fvCn = fv != null ? formatChinaJiLocal(fvSci, 2) : '-';
            const yvCn = yv != null ? formatChinaJiLocal(yvSci, 2) : '-';
            
            document.getElementById('predBreakdown').innerHTML = `
              <div style="flex:1;">盗印 番数=${dvSci} / ${dvCn}  触发=${result.breakdown?.daoyin?.triggers ?? '-'}</div>
              <div style="flex:1;">负重 番数=${fvSci} / ${fvCn}  触发=${result.breakdown?.fuzhong?.triggers ?? '-'}</div>
              <div style="flex:1;">月光 番数=${yvSci} / ${yvCn}  触发=${result.breakdown?.yueguang?.triggers ?? '-'}</div>
            `;
            
            // 更新触发次数显示
            document.getElementById('currentDaoyinTriggers').textContent = trigD;
            document.getElementById('currentFuzhongTriggers').textContent = trigF;
            document.getElementById('currentYueguangTriggers').textContent = trigY;
            document.getElementById('maxDaoyinTriggers').textContent = maxTrigD;
            document.getElementById('maxFuzhongTriggers').textContent = maxTrigF;
            document.getElementById('maxYueguangTriggers').textContent = maxTrigY;
            
            // 计算预测 - 使用后端API进行准确计算
            const currentPrediction = await calculatePrediction(baseScore, trigD, trigF, trigY, currentLevel, daoyinValue, fuzhongValue, yueguangValue, 'current');
            const maxPrediction = await calculatePrediction(baseScore, maxTrigD, maxTrigF, maxTrigY, currentLevel, daoyinValue, fuzhongValue, yueguangValue, 'max');
            
            document.getElementById('currentPrediction').innerHTML = currentPrediction;
            document.getElementById('maxPrediction').innerHTML = maxPrediction;
          }
        } catch (err) {
          console.error('预测更新失败:', err);
          const currentEl = document.getElementById('currentPrediction');
          const maxEl = document.getElementById('maxPrediction');
          if (currentEl) currentEl.innerHTML = '<span style="color: var(--danger);">预测出错</span>';
          if (maxEl) maxEl.innerHTML = '<span style="color: var(--danger);">预测出错</span>';
        }
      }
      
      // 内部计算函数 - 复用computeWithForm的逻辑但不更新UI
      async function computeWithFormInternal() {
        try {
          const basePayload = (() => {
            const levelConfig = { targetScore: $('targetScore').value.trim() };
            if (document.getElementById('kingEnabled').checked) {
              levelConfig.kingCallInitialMultiplier = $('kingInit').value.trim() || '1';
              const t = $('kingTriggers').value.trim();
              const b = $('kingBase').value.trim();
              if (t) levelConfig.kingCallTriggers = Number(t);
              if (b) levelConfig.kingCallBase = b;
            }
            const sequence = { baseScore: $('baseScore').value.trim(), items: [] };

            const options = {
              daoyinValue: $('daoyin').value.trim(),
              fuzhongValue: $('fuzhong').value.trim(),
              yueguangValue: $('yueguang').value.trim(),
              overrideTriggers: {
                daoyin: Number($('trigD').value.trim() || '0'),
                fuzhong: Number($('trigF').value.trim() || '0'),
                yueguang: Number($('trigY').value.trim() || '0'),
              },
              overrideTheoreticalMaxes: {
                daoyin: Number($('theoD').value.trim() || '0'),
                fuzhong: Number($('theoF').value.trim() || '0'),
                yueguang: Number($('theoY').value.trim() || '0'),
              }
            };
            return { levelConfig, sequence, options };
          })();
          if (!basePayload) return null;

          const payload = basePayload;
          // 覆盖胡牌番数
          payload.options.finalMultiplierOverride = $('finalMulInput').value.trim();
          // 将三类番数输入也允许中文大数：预解析为科学计数
          ['daoyinValue','fuzhongValue','yueguangValue'].forEach(k=>{
            const v = payload.options[k];
            const p = parseChinaJiLocal(v);
            if (p) payload.options[k] = p;
          });
          // baseScore/targetScore 亦本地解析
          const pt = parseChinaJiLocal(payload.levelConfig.targetScore); if (pt) payload.levelConfig.targetScore = pt;
          const pb = parseChinaJiLocal(payload.sequence.baseScore); if (pb) payload.sequence.baseScore = pb;
          // 触发次数与理论最大次数确保为数字
          payload.options.overrideTriggers = payload.options.overrideTriggers || {};
          payload.options.overrideTheoreticalMaxes = payload.options.overrideTheoreticalMaxes || {};
          ['daoyin','fuzhong','yueguang'].forEach(k=>{
            payload.options.overrideTriggers[k] = Number(payload.options.overrideTriggers[k]||0);
            payload.options.overrideTheoreticalMaxes[k] = Number(payload.options.overrideTheoreticalMaxes[k]||0);
          });

          const resp = await fetch(api, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          return data;
        } catch (err) {
          console.error('内部计算失败:', err);
          return null;
        }
      }
      
      async function calculatePrediction(baseScore, trigD, trigF, trigY, startLevel, daoyinValue = 1, fuzhongValue = 1, yueguangValue = 1, type = 'current') {
        console.log('calculatePrediction', baseScore, trigD, trigF, trigY, startLevel, daoyinValue, fuzhongValue, yueguangValue, type);
        const currentLevelIdx = keyOrder.indexOf(startLevel);
        if (currentLevelIdx === -1) return '无效关卡';
        
        // 获取胡牌番数（最终番数）
        const finalMultiplier = parseFloat(document.getElementById('finalMulInput').value) || 1;
        
        // 准备关卡数据，只包含当前关卡之后的关卡
        const futureLevels = {};
        const all = computeRecommendedAll();
        
        for (let i = currentLevelIdx + 1; i < keyOrder.length; i++) {
          const levelKey = keyOrder[i];
          const levelData = all[levelKey];
          const targetScoreStr = LEVEL_TARGETS[levelKey];
          
          if (levelData && targetScoreStr) {
            // 确保番数值转换为科学计数法字符串格式，以便后端正确解析大数字
            const formatValueForBackend = (value) => {
              if (!value || value === 0) return '1';
              const num = parseFloat(value);
              if (!isFinite(num)) return '1';
              // 使用科学计数法格式，确保大数字不会丢失精度
              return num.toExponential(15);
            };
            
            futureLevels[levelKey] = {
              targetScore: targetScoreStr,
              daoyinValue: formatValueForBackend(levelData.actualD || 1),
              fuzhongValue: formatValueForBackend(levelData.actualF || 1),
              yueguangValue: formatValueForBackend(levelData.actualY || 1)
            };
          }
        }
        
        try {
          // 调用后端API进行预测计算（显式 CORS 与禁用缓存）
          const response = await fetch(`${API_BASE}/api/predict`, {
            method: 'POST',
            mode: 'cors',
            cache: 'no-store',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              baseScore,
              finalMultiplier,
              currentLevel: startLevel,
              levelData: futureLevels,
              type,
              triggers: {
                daoyin: trigD,
                fuzhong: trigF,
                yueguang: trigY
              }
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.error) {
            throw new Error(result.message || result.error);
          }
          
          // 处理预测结果
            if (result.canPass) {
            // 写入快速状态（全部通关时仅清空或显示一个总徽章）
            try {
              const quickEl = type === 'current' ? document.getElementById('currentPredQuickStatus') : document.getElementById('maxPredQuickStatus');
              if (quickEl) {
                quickEl.innerHTML = '<span class="predict-badge ok">全部通关</span>';
              }
            } catch (_) {}
            return '<div class="predict-list"><div class="predict-row"><span class="predict-badge ok">全部通关</span><span class="predict-meta">该配置可超过所有后续关卡</span></div></div>';
          } else {
            let html = '<div class="predict-list">';
            const triggerText = result.triggerText;
            
            // 显示最后一个通过的关卡（若存在）
            if (result.lastValidLevel && result.lastValidScore) {
              const lastValidDisplay = formatTargetScore(result.lastValidScore);
              const lastValidTargetDisplay = formatTargetScore(result.lastValidTarget);
              html += `
                <div class="predict-row">
                  <span class="predict-badge ok">通过</span>
                  <span class="prediction-score-highlight">${lastValidDisplay}</span>
                  <span class="predict-meta">≥ ${lastValidTargetDisplay}</span>
                  <span class="predict-meta">@ ${result.lastValidLevel}</span>
                </div>
              `;
            }
            
            // 第一个无法通过的关卡
            const failedDisplay = formatTargetScore(result.firstFailedScore);
            const targetDisplay = formatTargetScore(result.firstFailedTarget);
            html += `
              <div class="predict-row">
                <span class="predict-badge fail">败北</span>
                <span class="prediction-score-highlight">${failedDisplay}</span>
                <span class="predict-meta">< ${targetDisplay}</span>
                <span class="prediction-level-warning">@ ${result.firstFailedLevel}</span>
              </div>
            `;
            
            // 标题行右侧快速状态：复制“关卡：通过 / 关卡：败北”
            try {
              const quickHtml = `
                ${result.lastValidLevel ? `<span class=\"predict-badge ok\">${result.lastValidLevel}：通过</span>` : ''}
                <span class=\"predict-badge fail\">${result.firstFailedLevel}：败北</span>
              `;
              const quickEl = type === 'current' ? document.getElementById('currentPredQuickStatus') : document.getElementById('maxPredQuickStatus');
              if (quickEl) quickEl.innerHTML = quickHtml;
            } catch (_) {}

            html += '</div>';
            return html;
          }
          
        } catch (error) {
          console.error('预测计算失败:', error);
          return `<span style="color: var(--danger);">预测计算失败: ${error.message}</span>`;
        }
      }
      
      // 防止重复绑定事件监听器
      let btnListenerAdded = false;
      let updatePredictionListenerAdded = false;
      
      // 监听计算按钮点击，更新预测
      if (!btnListenerAdded) {
        const btn = document.getElementById('btn');
        if (btn) {
          btn.addEventListener('click', () => {
            // 先执行计算，然后更新预测
            computeWithForm().then(() => {
              updatePrediction();
            });
          });
          btnListenerAdded = true;
        }
      }
      
      // 监听更新预测按钮点击
      if (!updatePredictionListenerAdded) {
        const updatePredictionBtn = document.getElementById('updatePrediction');
        if (updatePredictionBtn) {
          updatePredictionBtn.addEventListener('click', () => {
            debouncedUpdatePrediction();
          });
          updatePredictionListenerAdded = true;
        }
      }
      
      // 添加防抖机制，避免重复调用
      let predictionUpdateTimeout = null;
      const debouncedUpdatePrediction = () => {
        if (predictionUpdateTimeout) {
          clearTimeout(predictionUpdateTimeout);
        }
        predictionUpdateTimeout = setTimeout(() => {
          updatePrediction();
        }, 100);
      };
      
      // 页面初始化时触发关卡选择联动
      document.addEventListener('DOMContentLoaded', () => {
        // 初始化时触发关卡选择的change事件，确保联动生效
        const levelSelect = document.getElementById('levelSelect');
        if (levelSelect) {
          levelSelect.dispatchEvent(new Event('change'));
        }

        // 初始化配置区块拖拽调整宽度
        const grid = document.getElementById('blocksGrid');
        let dragging = null; // { block, startX, startBasis, side }
        function onMove(e){
          if (!dragging) return;
          const dx = e.clientX - dragging.startX;
          const block = dragging.block;
          const containerWidth = grid.getBoundingClientRect().width;
          let basisPx = dragging.startBasis;
          basisPx += (dragging.side === 'right' ? dx : -dx);
          const minPx = 180; // 最小宽度
          const maxPx = containerWidth - 180; // 防止过大
          basisPx = Math.max(minPx, Math.min(maxPx, basisPx));
          block.style.flex = `0 0 ${basisPx}px`;
        }
        function onUp(){
          if (!dragging) return;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          dragging = null;
        }
        grid?.querySelectorAll('.config-block .resize-handle').forEach(h => {
          h.addEventListener('mousedown', (e)=>{
            const block = e.currentTarget.closest('.config-block');
            if (!block) return;
            const rect = block.getBoundingClientRect();
            const side = e.currentTarget.getAttribute('data-resize') === 'left' ? 'left' : 'right';
            dragging = {
              block,
              startX: e.clientX,
              startBasis: rect.width,
              side
            };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
            e.preventDefault();
          });
        });
      });
      
    </script>
  </body>
  </html>


