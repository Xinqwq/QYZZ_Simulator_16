<!-- Author: 16@Xinqwq -->
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>é’äº‘ä¹‹å¿— ç®—åˆ†å™¨</title>
    <link rel="icon" href="src/assets/16.ico" />
    <style>
      :root{
        --bg:#F2F2F0;        
        --text:#3F3F3A;      
        --muted:#7C7C75;     
        --card:#FFFFFF;      
        --line:#E1E1DC;      
        --primary:#9AA3A0;  
        --primary-strong:#6F7976;
        --accent:#C4B7A6;    
        --accent-light:rgba(196, 183, 166, 0.1);  /* æµ…è‰²å¼ºè°ƒ */
        --accent-hover:rgba(196, 183, 166, 0.2);  /* æ‚¬åœå¼ºè°ƒ */
        --ok:#B7D0C5;        
        --warn:#E3C9A8;      
        --danger:#D9B8B6;    
        --radius:10px;
        --gap:0px;
        /* æ¬¡æ•°åˆ—æ ·å¼å˜é‡ */
        --count-cell-bg:rgba(154, 163, 160, 0.1);
        --count-cell-border:rgba(154, 163, 160, 0.3);
        --count-cell-text:#3F3F3A;
        --count-cell-hover-bg:rgba(154, 163, 160, 0.15);
      }
      
      /* é…è‰²æ–¹æ¡ˆ */
      .theme-16QwQ {
        --bg:#F0F8FF; --text:#2C3E50; --muted:#7F8C8D; --card:#FFFFFF; --line:#D5DBDB;
        --primary:#73CCFF; --primary-strong:#5BB3FF; --accent:#ACF06D; --accent-light:rgba(172, 240, 109, 0.1); --accent-hover:rgba(172, 240, 109, 0.2); --ok:#E8A469; --warn:#F0DF6D; --danger:#AC9076;
        --count-cell-bg:rgba(115, 204, 255, 0.1); --count-cell-border:rgba(115, 204, 255, 0.3); --count-cell-text:#2C3E50; --count-cell-hover-bg:rgba(115, 204, 255, 0.15);
      }
      .theme-buxingshx {
        --bg:#F0FFF0; --text:#2F4F2F; --muted:#696969; --card:#FFFFFF; --line:#DCDCDC;
        --primary:#00E874; --primary-strong:#00CC66; --accent:#00B0F0; --accent-light:rgba(0, 176, 240, 0.1); --accent-hover:rgba(0, 176, 240, 0.2); --ok:#B6FF47; --warn:#EEFF00; --danger:#FF6B6B;
        --count-cell-bg:rgba(0, 232, 116, 0.1); --count-cell-border:rgba(0, 232, 116, 0.3); --count-cell-text:#2F4F2F; --count-cell-hover-bg:rgba(0, 232, 116, 0.15);
      }
      .theme-life {
        --bg:#F8F9FF; --text:#4A4A6A; --muted:#8A8A9A; --card:#FFFFFF; --line:#E8E8F0;
        --primary:#A5EAFF; --primary-strong:#8DD8FF; --accent:#9EC4F6; --accent-light:rgba(158, 196, 246, 0.1); --accent-hover:rgba(158, 196, 246, 0.2); --ok:#BEFFF8; --warn:#E1DCFC; --danger:#D2C0F9;
        --count-cell-bg:rgba(165, 234, 255, 0.1); --count-cell-border:rgba(165, 234, 255, 0.3); --count-cell-text:#4A4A6A; --count-cell-hover-bg:rgba(165, 234, 255, 0.15);
      }
      .theme-purple {
        --bg:#F5FFF5; --text:#2F4F2F; --muted:#696969; --card:#FFFFFF; --line:#E0E0E0;
        --primary:#65BFBE; --primary-strong:#4A9B9A; --accent:#DEEDA1; --accent-light:rgba(222, 237, 161, 0.1); --accent-hover:rgba(222, 237, 161, 0.2); --ok:#BDE031; --warn:#FFF200; --danger:#008F75;
        --count-cell-bg:rgba(101, 191, 190, 0.1); --count-cell-border:rgba(101, 191, 190, 0.3); --count-cell-text:#2F4F2F; --count-cell-hover-bg:rgba(101, 191, 190, 0.15);
      }
      .theme-rainbow {
        --bg:#FFF8F0; --text:#4A3C2A; --muted:#8A7A6A; --card:#FFFFFF; --line:#F0E0D0;
        --primary:#FFB78C; --primary-strong:#FFA066; --accent:#FFF08C; --accent-light:rgba(255, 240, 140, 0.1); --accent-hover:rgba(255, 240, 140, 0.2); --ok:#BBFF8C; --warn:#8CFFCE; --danger:#BD8CFF;
        --count-cell-bg:rgba(255, 183, 140, 0.1); --count-cell-border:rgba(255, 183, 140, 0.3); --count-cell-text:#4A3C2A; --count-cell-hover-bg:rgba(255, 183, 140, 0.15);
      }
      .theme-wonderful {
        --bg:#191A1E; --text:#968d8d; --muted:#c25252; --card:#c9c9d8; --line:#FF3B3E;
        --primary:#FF3B3E; --primary-strong:#E03437; --accent:#FF8657; --accent-light:rgba(255, 134, 87, 0.1); --accent-hover:rgba(255, 134, 87, 0.2); --ok:#FFBA70; --warn:#FF8657; --danger:#FF3B3E;
        --count-cell-bg:rgba(255, 59, 62, 0.1); --count-cell-border:rgba(255, 59, 62, 0.3); --count-cell-text:#968d8d; --count-cell-hover-bg:rgba(255, 59, 62, 0.15);
      }
      .theme-16yyds {
        --bg:#E5FD56; --text:#2D3A1A; --muted:#779149; --card:#f6ffc1; --line:#C6DC74;
        --primary:#95a3f3; --primary-strong:#D1F33A; --accent:#C6DC74; --accent-light:rgba(198, 220, 116, 0.1); --accent-hover:rgba(198, 220, 116, 0.2); --ok:#A8BB92; --warn:#899AB0; --danger:#6A79CE;
        --count-cell-bg:rgba(149, 163, 243, 0.1); --count-cell-border:rgba(149, 163, 243, 0.3); --count-cell-text:#2D3A1A; --count-cell-hover-bg:rgba(149, 163, 243, 0.15);
      }
      
      .theme-selector {
        display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
      }
      .theme-option {
        display: flex; align-items: center; gap: 6px; padding: 6px 10px; 
        border: 2px solid var(--line); border-radius: 20px; cursor: pointer; 
        transition: all 0.2s; font-size: 12px; background: var(--card);
      }
      .theme-option:hover { border-color: var(--primary); }
      .theme-option.active { border-color: var(--primary); background: var(--primary); color: white; }
      .theme-colors {
        display: flex; gap: 3px;
      }
      .theme-color {
        width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1);
      }
      
      /* æ•°å­—è¾“å…¥æŒ‰é’®æ ·å¼ */
      .number-input-group {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .number-btn {
        width: 24px; height: 24px;
        border: 1px solid var(--line);
        background: var(--card);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        color: var(--text);
        transition: all 0.15s;
      }
      .number-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .number-input-group input[type="number"] {
        flex: 1;
        text-align: center;
        padding: 4px 6px;
        font-size: 12px;
      }
      
      /* é…ç½®åŒºå—æ ·å¼ */
      .config-block {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 12px;
        min-height: 200px;
        position: relative;
      }
      .config-block h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--text);
        border-bottom: 1px solid var(--line);
        padding-bottom: 6px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .config-block .block-toggle {
        font-size: 16px;
        font-weight: bold;
        color: var(--muted);
        transition: transform 0.2s;
        margin-left: 8px;
      }
      .config-block.collapsed .block-toggle {
        transform: rotate(-90deg);
      }
      
      /* åŒºå—é€‰æ‹©å™¨æ ·å¼ */
      .block-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
        padding: 12px;
        background: transparent;
        border: none;
        border-radius: 8px;
      }
      .block-btn {
        padding: 6px 12px;
        border: 1px solid var(--line);
        background: var(--card);
        color: var(--text);
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }
      .block-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .block-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .block-btn.active:hover {
        background: var(--primary-strong);
        border-color: var(--primary-strong);
      }
      
      /* éšè—/æ˜¾ç¤ºåŒºå— */
      .config-block.hidden {
        display: none;
      }
      
      /* ç²¾åº¦æŒ‰é’®æ ·å¼ */
      .precision-buttons {
        display: flex;
        gap: 4px;
      }
      .precision-btn {
        padding: 4px 12px;
        border: 1px solid var(--line);
        background: var(--card);
        color: var(--text);
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .precision-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .precision-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }
      .config-block .block-content {
        transition: all 0.3s ease;
        overflow: hidden;
      }
      .config-block.collapsed .block-content {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
      }
      .config-block .block-content.expanded {
        max-height: none;
        opacity: 1;
      }
      
      /* ç»Ÿä¸€inputå’Œlabelå¸ƒå±€ */
      .config-block label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 12px;
        color: var(--text);
      }
      .config-block label > * {
        flex-shrink: 0;
      }
      .config-block label input,
      .config-block label select {
        flex: 1;
        min-width: 0;
      }
      
      /* æ•°æ®å°åŠ©æ‰‹æ ·å¼ */
      .data-helper {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
      }
      .data-helper h4 {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: var(--text);
        border-bottom: 1px solid var(--line);
        padding-bottom: 6px;
      }
      .data-table {
        font-size: 11px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--line);
        border-radius: 4px;
      }
      .data-table table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table th,
      .data-table td {
        padding: 4px 6px;
        text-align: center;
        border-bottom: 1px solid var(--line);
      }
      .data-table th {
        background: var(--accent);
        font-weight: 600;
        color: var(--text);
        position: sticky;
        top: 0;
      }
      .data-table td {
        color: var(--text);
      }
      
      /* æœªæ¥å…³å¡é¢„æµ‹ä½œä¸ºå­æ¨¡å—çš„æ ·å¼é€‚é… */
      .config-block[data-block="predict"] .card-header {
        background: transparent; border: none; padding: 0; margin: 0 0 8px 0;
      }
      .config-block[data-block="predict"] .card-header h4 {
        margin: 0; font-size: 14px; color: var(--text);
      }
      .config-block[data-block="predict"] .card-header .card-toggle {
        padding: 2px 6px; font-size: 12px; border-radius: 4px; color: var(--muted);
      }
      .config-block[data-block="predict"] .card-content {
        padding: 0; border: none; background: transparent; margin-top: 8px;
      }
      .config-block[data-block="predict"] #currentLevelInfo {
        margin-bottom: 8px; padding: 10px; border-radius: 6px;
      }
      /* å†…éƒ¨ä¸¤åˆ—ç»“æœé¢æ¿çš„å¡ç‰‡åŒ–å¤–è§‚ï¼Œç¼©å°è¾¹è·ä¸åœ†è§’ */
      .config-block[data-block="predict"] .card-content > div[style*="flex"] > div {
        border: 1px solid var(--line); border-radius: 6px; padding: 10px; background: var(--card);
      }
      .config-block[data-block="predict"] .card-content h5,
      .config-block[data-block="predict"] .card-content h4 {
        margin: 0 0 8px 0; font-size: 13px; color: var(--text);
      }
      .config-block[data-block="predict"] #predBreakdown {
        gap: 12px;
      }
      /* é¢„æµ‹æ¨¡å—æŒ‰é’®ï¼šæ¤­åœ†æŒ‰é’®å¤–è§‚ */
      .config-block[data-block="predict"] #updatePrediction {
        font-size: 11px; padding: 6px 14px; line-height: 1;
        border-radius: 999px; border: 1px solid var(--line);
        background: var(--primary); color: #fff;
      }
      .config-block[data-block="predict"] #updatePrediction:hover { background: var(--primary-strong); }

      /* ç‰¹å®šåŒºå—çš„è¡¨æ ¼ä¸ä½¿ç”¨æ»šåŠ¨æ¡ */
      .config-block[data-block="display"] .data-table,
      .config-block[data-block="tech"] .data-table {
        max-height: none;
        overflow-y: visible;
      }
      
      /* å•†åº—åˆ·æ–°æ˜Ÿå¸åŒºå—æ˜¾ç¤º12è¡Œæ•°æ® */
      .config-block[data-block="shop"] .data-table {
        max-height: 300px; /* 12è¡Œ Ã— 30px/è¡Œ = 360px */
        overflow-y: auto;
      }
      .data-table tr:hover {
        background: rgba(154, 163, 160, 0.1);
      }
      
      /* ç»Ÿä¸€è¡¨æ ¼æ ·å¼ï¼šå¤§æ•°å­—å•ä½ç³»ç»Ÿå¯¹ç…§è¡¨çš„"å•ä½"åˆ—ã€å•†åº—åˆ·æ–°æ˜Ÿå¸çš„"åˆ·æ–°æ¬¡æ•°"åˆ—ã€é­‚ç‰Œæ¨¡å—çš„"æ¬¡æ•°"åˆ— */
      .config-block[data-block="display"] .data-table tbody td:first-child,
      .config-block[data-block="shop"] .data-table tbody td:first-child,
      .config-block[data-block="tech"] .data-table tbody .count-cell {
        background: var(--accent-light, rgba(154, 163, 160, 0.1));
        font-weight: 500;
        color: var(--text);
      }
      
      /* ç»Ÿä¸€æ‚¬åœæ•ˆæœ */
      .config-block[data-block="display"] .data-table tr:hover td:first-child,
      .config-block[data-block="shop"] .data-table tr:hover td:first-child,
      .config-block[data-block="tech"] .data-table tr:hover .count-cell {
        background: var(--accent-hover, rgba(154, 163, 160, 0.2));
      }
      
      .number-input-group input[type="number"] {
        width: 50px; padding: 4px 6px; text-align: center;
        border: 1px solid var(--line); border-radius: 4px;
        font-size: 12px;
      }
      
      /* é…ç½®åŒºå—æ ·å¼ */
      .config-block {
        padding: 12px; border: 1px solid var(--line); border-radius: 8px;
        background: var(--card);
        position: relative;
      }
      .resize-handle {
        position: absolute; top: 0; bottom: 0; width: 6px; cursor: ew-resize; opacity: 0.2;
      }
      .resize-handle.left { left: -3px; }
      .resize-handle.right { right: -3px; }
      .resize-handle:hover { opacity: 0.5; }
      .config-block h4 {
        margin: 0 0 12px 0; font-size: 14px; color: var(--text);
        border-bottom: 1px solid var(--line); padding-bottom: 6px;
      }
      /* æŒ‡å®šå­æ¨¡å—å»é™¤æ ‡é¢˜åˆ†å‰²çº¿ */
      .config-block[data-block="level-select"] h4,
      .config-block[data-block="predict"] h4 { border-bottom: none; padding-bottom: 0; margin-bottom: 8px; }
      
      /* è½®æ’­æç¤ºæ¡† */
      .tips-carousel {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 50px;
        padding: 12px 16px;
        margin: 16px 0;
        min-height: 60px;
        display: flex;
        align-items: center;
        position: relative;
        overflow: hidden;
      }
      .tips-carousel::before {
        content: 'ğŸ’¡';
        font-size: 18px;
        margin-right: 8px;
        flex-shrink: 0;
      }
      .tips-content {
        flex: 1;
        font-size: 14px;
        color: var(--text);
        line-height: 1.4;
        opacity: 0;
        transform: translateX(20px);
        transition: all 0.5s ease;
      }
      .tips-content.active {
        opacity: 1;
        transform: translateX(0);
      }
      .tips-dots {
        position: absolute;
        bottom: 8px;
        right: 12px;
        display: flex;
        gap: 4px;
      }
      .tips-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--muted);
        cursor: pointer;
        transition: background 0.3s;
      }
      .tips-dot.active {
        background: var(--primary);
      }
      
      /* å½©è›‹æ¨¡æ€æ¡† */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .modal h2 {
        color: #FF3B3E;
        margin: 0;
      }
      .modal p {
        color: #333;
        margin: 0;
        line-height: 1.5;
      }
      .modal button {
        background: #FF3B3E;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        align-self: center;
      }
      .modal button:hover {
        background: #E03437;
      }
      *{ box-sizing:border-box }
      body { background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif; margin: 20px; }
      h1,h3{ margin:0 0 10px 0; font-weight:600 }
      .card { background:var(--card); border: 1px solid var(--line); border-radius: var(--radius); padding: 14px; box-shadow: 0 1px 0 rgba(0,0,0,0.02); position: relative; }
      .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      .card-toggle { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
      .card-toggle:hover { background: var(--line); color: var(--text); }
      .card-content { transition: all 0.3s ease; overflow: hidden; }
      .card-content.collapsed { max-height: 0; opacity: 0; margin: 0; padding: 0; }
      /* åœ¨å±•å¼€æ—¶å…è®¸å†…å®¹æº¢å‡ºå¯è§ï¼Œé˜²æ­¢å³ä¾§è¢«è£å‰ª */
      #config-content { overflow: visible; }
      #config-content.collapsed { overflow: hidden; }
      label { display: block; font-size: 12px; color: var(--muted); margin-top: 8px; }
      input, select { width: 100%; padding: 9px 10px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px; background:#FAFAF8; color:var(--text); outline:none }
      input:focus, select:focus{ border-color: var(--primary); box-shadow: 0 0 0 3px rgba(154,163,160,0.15) }
      input:disabled { opacity: 0.5; cursor: not-allowed; }
      input[readonly] { 
        background-color: #f8f9fa; 
        border-color: #e9ecef; 
        cursor: not-allowed; 
        opacity: 0.8;
      }
      button { padding: 9px 14px; border-radius: 999px; border: 1px solid var(--line); background: var(--primary); color: white; cursor: pointer; transition:.15s }
      button:hover{ background: var(--primary-strong) }
      .btn-light{ background:#F5F5F3; color:var(--text) }
      .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
      .btn-radio { padding: 10px 14px; border: 1px solid var(--line); border-radius: 999px; background: #F6F6F4; color: var(--text); cursor: pointer; transition:.15s; font-size:13px }
      .btn-radio.active { background: var(--primary); color: #fff; border-color: var(--primary); }
      .tag-d, .tag-f, .tag-y { background: #F6F6F4; color: var(--text); border-color: var(--line); }
      .tag-d.alt, .tag-f.alt, .tag-y.alt { background: #F6F6F4; color: var(--text); }
      .tag-d.selected, .tag-f.selected, .tag-y.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
      .tag-d.alt.selected, .tag-f.alt.selected, .tag-y.alt.selected { background: var(--primary); color: #fff; }
      .fill-toggle{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); margin-bottom:8px; }
      .status { padding: 6px 10px; border-radius: 999px; display: inline-block; border:1px solid var(--line); background:#F8F8F6 }
      .under { background: var(--danger); color: #5E3B3A; }
      .ok { background: var(--warn); color: #6B4F2F; }
      .over5x { background: var(--ok); color: #2C5146; }
      .grid-2 { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
      .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
      .grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
      .kv{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed var(--line) }
      .kv small{ color:var(--muted) }
      
      /* LolipopåŠ¨ç”»æ ·å¼ - 20ç§åŠ¨ç”»æ•ˆæœ */
      @keyframes lolipop-bounce {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        25% { transform: translateY(-8px) rotate(5deg); }
        50% { transform: translateY(-12px) rotate(0deg); }
        75% { transform: translateY(-6px) rotate(-3deg); }
      }
      
      @keyframes lolipop-spin {
        0% { transform: rotate(0deg) scale(1); }
        25% { transform: rotate(90deg) scale(1.1); }
        50% { transform: rotate(180deg) scale(1); }
        75% { transform: rotate(270deg) scale(0.9); }
        100% { transform: rotate(360deg) scale(1); }
      }
      
      @keyframes lolipop-wiggle {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(15deg); }
        50% { transform: rotate(-10deg); }
        75% { transform: rotate(8deg); }
      }
      
      @keyframes lolipop-pulse {
        0%, 100% { transform: scale(1); opacity: 0.7; }
        50% { transform: scale(1.2); opacity: 1; }
      }
      
      @keyframes lolipop-float {
        0%, 100% { transform: translateY(0px) translateX(0px); }
        25% { transform: translateY(-5px) translateX(3px); }
        50% { transform: translateY(-10px) translateX(0px); }
        75% { transform: translateY(-5px) translateX(-3px); }
      }
      
      @keyframes lolipop-shake {
        0%, 100% { transform: translateX(0); }
        10% { transform: translateX(-5px) rotate(-1deg); }
        20% { transform: translateX(5px) rotate(1deg); }
        30% { transform: translateX(-3px) rotate(-1deg); }
        40% { transform: translateX(3px) rotate(1deg); }
        50% { transform: translateX(-2px) rotate(-1deg); }
        60% { transform: translateX(2px) rotate(1deg); }
        70% { transform: translateX(-1px) rotate(-1deg); }
        80% { transform: translateX(1px) rotate(1deg); }
        90% { transform: translateX(-1px) rotate(-1deg); }
      }
      
      @keyframes lolipop-zoom {
        0%, 100% { transform: scale(1) rotate(0deg); }
        25% { transform: scale(1.3) rotate(5deg); }
        50% { transform: scale(0.8) rotate(-5deg); }
        75% { transform: scale(1.1) rotate(3deg); }
      }
      
      @keyframes lolipop-swing {
        0%, 100% { transform: rotate(0deg); transform-origin: top center; }
        25% { transform: rotate(15deg); }
        50% { transform: rotate(-10deg); }
        75% { transform: rotate(8deg); }
      }
      
      @keyframes lolipop-flip {
        0% { transform: rotateY(0deg) scale(1); }
        25% { transform: rotateY(90deg) scale(1.1); }
        50% { transform: rotateY(180deg) scale(0.9); }
        75% { transform: rotateY(270deg) scale(1.05); }
        100% { transform: rotateY(360deg) scale(1); }
      }
      
      @keyframes lolipop-dance {
        0%, 100% { transform: translateY(0px) rotate(0deg) scale(1); }
        20% { transform: translateY(-10px) rotate(10deg) scale(1.1); }
        40% { transform: translateY(0px) rotate(-5deg) scale(0.9); }
        60% { transform: translateY(-8px) rotate(-10deg) scale(1.05); }
        80% { transform: translateY(-5px) rotate(5deg) scale(0.95); }
      }
      
      @keyframes lolipop-twist {
        0%, 100% { transform: rotate(0deg) scaleX(1); }
        25% { transform: rotate(45deg) scaleX(0.8); }
        50% { transform: rotate(90deg) scaleX(1.2); }
        75% { transform: rotate(135deg) scaleX(0.9); }
      }
      
      @keyframes lolipop-jump {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-15px); }
      }
      
      @keyframes lolipop-rock {
        0%, 100% { transform: rotate(0deg) translateY(0px); }
        25% { transform: rotate(5deg) translateY(-3px); }
        50% { transform: rotate(0deg) translateY(0px); }
        75% { transform: rotate(-5deg) translateY(-3px); }
      }
      
      @keyframes lolipop-glide {
        0% { transform: translateX(-20px) rotate(0deg); opacity: 0.5; }
        50% { transform: translateX(0px) rotate(180deg); opacity: 1; }
        100% { transform: translateX(20px) rotate(360deg); opacity: 0.5; }
      }
      
      @keyframes lolipop-squeeze {
        0%, 100% { transform: scaleX(1) scaleY(1); }
        25% { transform: scaleX(1.2) scaleY(0.8); }
        50% { transform: scaleX(0.8) scaleY(1.2); }
        75% { transform: scaleX(1.1) scaleY(0.9); }
      }
      
      @keyframes lolipop-roll {
        0% { transform: translateX(-10px) rotate(0deg); }
        25% { transform: translateX(-5px) rotate(90deg); }
        50% { transform: translateX(0px) rotate(180deg); }
        75% { transform: translateX(5px) rotate(270deg); }
        100% { transform: translateX(10px) rotate(360deg); }
      }
      
      @keyframes lolipop-wave {
        0%, 100% { transform: rotate(0deg) translateY(0px); }
        25% { transform: rotate(10deg) translateY(-5px); }
        50% { transform: rotate(0deg) translateY(-8px); }
        75% { transform: rotate(-10deg) translateY(-5px); }
      }
      
      @keyframes lolipop-bob {
        0%, 100% { transform: translateY(0px) scale(1); }
        50% { transform: translateY(-8px) scale(1.05); }
      }
      
      @keyframes lolipop-sway {
        0%, 100% { transform: rotate(0deg) translateX(0px); }
        33% { transform: rotate(8deg) translateX(5px); }
        66% { transform: rotate(-8deg) translateX(-5px); }
      }
      
      @keyframes lolipop-elastic {
        0%, 100% { transform: scale(1); }
        10% { transform: scale(1.3); }
        20% { transform: scale(0.9); }
        30% { transform: scale(1.1); }
        40% { transform: scale(0.95); }
        50% { transform: scale(1.05); }
        60% { transform: scale(0.98); }
        70% { transform: scale(1.02); }
        80% { transform: scale(0.99); }
        90% { transform: scale(1.01); }
      }
      
      /* æ‚¬æµ®çª—æ ·å¼ */
      .floating-window {
        position: fixed;
        top: 120px;
        right: auto;
        width: auto;
        min-width: 400px;
        max-width: 90vw;
        min-height: auto;
        max-height: 80vh;
        background: var(--card);
        border: 2px solid var(--primary);
        border-radius: var(--radius);
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        z-index: 1000;
        cursor: move;
        user-select: none;
        transition: all 0.3s ease;
      }
      
      .floating-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: var(--primary);
        color: white;
        border-radius: var(--radius) var(--radius) 0 0;
        cursor: move;
        user-select: none;
      }
      .floating-title {
        font-weight: 600;
        font-size: 14px;
      }
      .floating-controls {
        display: flex;
        gap: 4px;
      }
      .floating-close {
        width: 20px;
        height: 20px;
        border: none;
        background: rgba(255,255,255,0.2);
        color: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      .floating-close:hover {
        background: rgba(255,255,255,0.3);
      }
      .floating-close:hover {
        background: #ff4444;
      }
      
      .floating-content {
        padding: 16px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      /* å¼€å…³æ ·å¼ */
      .result-toggle {
        display: flex;
        align-items: center;
      }
      .toggle-switch {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
      }
      .toggle-switch input[type="checkbox"] {
        display: none;
      }
      .toggle-slider {
        width: 50px;
        height: 24px;
        background: #ccc;
        border-radius: 12px;
        position: relative;
        transition: background 0.3s;
      }
      .toggle-slider::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .toggle-switch input[type="checkbox"]:checked + .toggle-slider {
        background: var(--primary);
      }
      .toggle-switch input[type="checkbox"]:checked + .toggle-slider::before {
        transform: translateX(26px);
      }
      .toggle-label {
        font-weight: 500;
      }
      
      /* æŒ‰é’®æ‚¬åœæç¤ºæ ·å¼ */
      .btn-tooltip {
        position: relative;
        cursor: pointer;
      }
      .btn-tooltip::before {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        margin-bottom: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      .btn-tooltip::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        margin-bottom: -1px;
      }
      .btn-tooltip:hover::before,
      .btn-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(-2px);
      }
      
      /* ç´§å‡‘æŒ‰é’®æ ·å¼ */
      .btn-radio {
        padding: 4px 8px !important;
        font-size: 10px !important;
        border-radius: 4px !important;
      }
      
      
      /* é¢„æµ‹é«˜äº®æ ·å¼ */
      .prediction-highlight {
        background: linear-gradient(120deg, var(--primary) 0%, var(--primary-strong) 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .prediction-level-highlight {
        background: linear-gradient(120deg, var(--warn) 0%, #f59e0b 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .prediction-score-highlight {
        background: linear-gradient(120deg, var(--ok) 0%, #10b981 100%);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      /* å…¨å±€ Alert æç¤ºï¼ˆå³ä¸Šè§’ï¼‰ */
      .alert-stack { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; }
      .alert { display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:6px; font-size:12px; border:1px solid var(--line); box-shadow: 0 2px 6px rgba(0,0,0,0.06); background: var(--card); color: var(--text); }
      .alert-ok { background: rgba(16,185,129,0.08); color:#065f46; border-color: rgba(16,185,129,0.25); }
      .alert-warn { background: rgba(245,158,11,0.10); color:#92400e; border-color: rgba(245,158,11,0.25); }
      .alert-danger { background: rgba(239,68,68,0.10); color:#7f1d1d; border-color: rgba(239,68,68,0.25); }
      .alert .close { background:none; border:none; color:inherit; cursor:pointer; padding:2px 6px; border-radius:4px; }

      /* é¢„æµ‹ç»“æœï¼šç´§å‡‘è¡Œæ ·å¼ */
      .predict-list { display:flex; flex-direction:column; gap:6px; }
      .predict-row { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--text); flex-wrap: wrap; overflow-wrap:anywhere; word-break:break-word; }
      .predict-badge { padding:2px 6px; border-radius:999px; font-size:11px; line-height:1; }
      .predict-badge.ok { background: rgba(16,185,129,0.12); color:#047857; border:1px solid rgba(16,185,129,0.25); }
      .predict-badge.fail { background: rgba(239,68,68,0.10); color:#991b1b; border:1px solid rgba(239,68,68,0.25); }
      .predict-meta { color: var(--muted); font-size:11px; }
      /* é¢„æµ‹æ ‡é¢˜ä¸­çš„æ‹¬å·å‚æ•°æ›´å°æ›´æ·¡ */
      .predict-trigs { font-size: 11px; color: var(--muted); font-weight: 500; }
      /* è´¥åŒ—å…³å¡çš„å…³å¡ä½è­¦å‘Šé«˜äº® */
      .prediction-level-warning { background: var(--warn); color: #4a3c2a; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
      
      /* ç´§å‡‘ä¸‹æ‹‰é€‰æ‹©æ¡†æ ·å¼ */
      .compact-select {
        padding: 2px 4px !important;
        font-size: 10px !important;
        border-radius: 4px !important;
        min-width: 80px !important;
        height: 24px !important;
        background: #F6F6F4 !important;
        border: 1px solid var(--line) !important;
        color: var(--text) !important;
      }
      
      /* ä¸‹æ‹‰é€‰æ‹©æ¡†tooltipæ”¯æŒ */
      .compact-select.btn-tooltip {
        position: relative;
        cursor: pointer;
      }
      
      /* Ant Designé£æ ¼Tabæ ·å¼ */
      .antd-tabs-container {
        max-width: 500px;
        margin: 0 auto;
        padding: 0 20px 0 20px;
        background: var(--card);
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }
      
      .antd-tabs {
        position: relative;
      }
      
      .antd-tab-nav {
        position: relative;
        margin-bottom: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .antd-tab-nav-list {
        position: relative;
        display: flex;
        transition: transform 0.3s;
        flex: 1;
      }
      
      .antd-tab-nav-wrap {
        position: relative;
        flex: none;
        min-width: 0;
      }
      
      .antd-tab-nav-extra {
        display: flex;
        align-items: center;
        padding: 0 16px;
      }
      
      .antd-tab-tab {
        position: relative;
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        font-size: 14px;
        background: transparent;
        border: 1px solid transparent;
        border-radius: 6px 6px 0 0;
        cursor: pointer;
        transition: all 0.3s;
        margin-right: 2px;
        user-select: none;
      }
      
      .antd-tab-tab:hover {
        color: var(--primary);
      }
      
      .antd-tab-tab-active {
        background: var(--card);
        border-color: var(--line);
        border-bottom-color: var(--card);
        color: var(--primary);
        font-weight: 500;
      }
      
      .antd-tab-tab-active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--primary);
        border-radius: 1px 1px 0 0;
      }
      
      .antd-tab-tab-btn {
        position: relative;
        display: inline-flex;
        align-items: center;
        padding: 4px 0;
        font-size: 12px;
        line-height: 8px;
        color: inherit;
        white-space: nowrap;
        text-align: center;
        background: transparent;
        border: 0;
        outline: none;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      /* æœˆå…‰æ§åˆ¶é¢æ¿æ ·å¼ */
      .moonlight-control-panel {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      
      .moonlight-toggle-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      
      .toggle-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      
      .moonlight-toggle-label {
        font-weight: 600;
        color: var(--primary-strong);
        font-size: 16px;
      }
      
      .moonlight-toggle-switch {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      
      .moonlight-toggle-switch input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .moonlight-toggle-slider {
        position: relative;
        width: 50px;
        height: 24px;
        background-color: var(--line);
        border-radius: 24px;
        transition: background-color 0.3s ease;
      }
      
      .moonlight-toggle-slider:before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      
      .moonlight-toggle-switch input:checked + .moonlight-toggle-slider {
        background-color: var(--primary);
      }
      
      .moonlight-toggle-switch input:checked + .moonlight-toggle-slider:before {
        transform: translateX(26px);
      }
      
      .moonlight-toggle-text {
        font-size: 14px;
        color: var(--text);
        font-weight: 500;
      }
      
      .moonlight-description {
        font-size: 13px;
        color: var(--muted);
        line-height: 1.4;
        padding-left: 75px;
      }
      
      /* Tabä¸­çš„æœˆå…‰å¼€å…³æ ·å¼ */
      .tab-moonlight-toggle {
        display: inline-block;
      }
      
      .tab-moonlight-toggle .moonlight-toggle-switch {
        transform: scale(0.7);
      }
      
      .tab-moonlight-toggle .moonlight-toggle-slider {
        width: 36px;
        height: 18px;
      }
      
      .tab-moonlight-toggle .moonlight-toggle-slider:before {
        width: 14px;
        height: 14px;
        top: 2px;
        left: 2px;
      }
      
      .tab-moonlight-toggle .moonlight-toggle-switch input:checked + .moonlight-toggle-slider:before {
        transform: translateX(18px);
      }
      
      .tab-moonlight-toggle .moonlight-toggle-text {
        font-size: 11px;
        margin-left: 6px;
      }
      
      /* ç‹ä¹‹å¬å”¤å¼€å…³æ ·å¼ */
      .king-switch-container {
        position: relative;
        display: inline-block;
        cursor: pointer;
      }
      
      .king-switch-container input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .king-switch-slider {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 22px;
        background-color: #d9d9d9;
        border-radius: 11px;
        transition: all 0.3s ease;
        overflow: hidden;
      }
      
      .king-switch-slider:before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 18px;
        height: 18px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 2;
      }
      
      .king-switch-container input:checked + .king-switch-slider {
        background-color: #1890ff;
      }
      
      .king-switch-container input:checked + .king-switch-slider:before {
        transform: translateX(22px);
      }
      
      .king-switch-text {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 10px;
        font-weight: 500;
        color: white;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }
      
      .king-switch-text-on {
        left: 6px;
        opacity: 0;
      }
      
      .king-switch-text-off {
        right: 6px;
        opacity: 1;
      }
      
      .king-switch-container input:checked + .king-switch-slider .king-switch-text-on {
        opacity: 1;
      }
      
      .king-switch-container input:checked + .king-switch-slider .king-switch-text-off {
        opacity: 0;
      }
      
      /* å°ç« æ¶ˆå¤±è®¡æ•°æ ·å¼ */
      .seal-counter-container {
        padding: 15px;
      }
      
      .seal-counter-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      
      .wooden-fish-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 20px 0;
      }
      
      .fish-and-counter-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 30px;
      }
      
      .wooden-fish {
        position: relative;
        cursor: pointer;
        user-select: none;
        transition: transform 0.1s ease;
      }
      
      .wooden-fish:active {
        transform: scale(0.95);
      }
      
      .fish-body {
        font-size: 64px;
        animation: bell-swing 3s ease-in-out infinite;
        transform-origin: top center;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .daoyin-image {
        width: 64px;
        height: 64px;
        object-fit: contain;
        user-select: none;
      }
      
      .fish-shadow {
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 8px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 50%;
        animation: shadow-pulse 3s ease-in-out infinite;
      }
      
      .counter-display {
        text-align: center;
      }
      
      .counter-number {
        font-size: 48px;
        font-weight: bold;
        color: var(--primary-strong);
        margin-bottom: 5px;
      }
      
      .counter-label {
        font-size: 14px;
        color: var(--muted);
      }
      
      @keyframes bell-swing {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(5deg); }
        75% { transform: rotate(-5deg); }
      }
      
      @keyframes shadow-pulse {
        0%, 100% { opacity: 0.2; transform: translateX(-50%) scale(1); }
        50% { opacity: 0.4; transform: translateX(-50%) scale(1.1); }
      }
      
      @keyframes bell-hit {
        0% { transform: rotate(0deg) scale(1); }
        25% { transform: rotate(15deg) scale(1.1); }
        75% { transform: rotate(-15deg) scale(1.1); }
        100% { transform: rotate(0deg) scale(1); }
      }
      
      .wooden-fish.hit {
        animation: bell-hit 0.4s ease;
      }
    </style>
  </head>
  <body>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h1>
        <img src="src/assets/fairy16.png" alt="16" style="width: 96px; height: 96px; vertical-align: middle; margin: 0 12px;" />
        é’äº‘ä¹‹å¿— ç®—åˆ†å°åŠ©æ‰‹  â€”â€”  16ç¥å„ä½å¤§å¤§æ¬§æ°”æ»¡æ»¡ï¼
      </h1>
      
      <!-- Tipsè½®æ’­æç¤ºæ¡† -->
      <div class="tips-carousel" style="flex:1; margin:0 20px;">
        <div class="tips-content active" id="tipsContent">è¿›å…¥å…³å¡å‰å’Œè‡ªæ‘¸æ—¶æ³¨æ„é¡ºåºå“¦</div>
        <div class="tips-dots" id="tipsDots"></div>
      </div>
      
      <div class="result-toggle">
        <label class="toggle-switch">
          <input type="checkbox" id="resultToggle" />
          <span class="toggle-slider"></span>
          <span class="toggle-label">è®¡ç®—ç»“æœ</span>
        </label>
      </div>
    </div>
    
    <div class="theme-selector">
      <div class="theme-option" data-theme="default">
        <span>è«å…°è¿ª</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#9AA3A0;"></div>
          <div class="theme-color" style="background:#C4B7A6;"></div>
          <div class="theme-color" style="background:#B7D0C5;"></div>
          <div class="theme-color" style="background:#E3C9A8;"></div>
          <div class="theme-color" style="background:#D9B8B6;"></div>
        </div>
      </div>
      <div class="theme-option active" data-theme="16QwQ">
        <span>16QwQ</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#73CCFF;"></div>
          <div class="theme-color" style="background:#ACF06D;"></div>
          <div class="theme-color" style="background:#F0DF6D;"></div>
          <div class="theme-color" style="background:#E8A469;"></div>
          <div class="theme-color" style="background:#AC9076;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="buxingshx">
        <span>å¸ƒè¯†æ˜Ÿæ²³</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#00E874;"></div>
          <div class="theme-color" style="background:#EEFF00;"></div>
          <div class="theme-color" style="background:#00B0F0;"></div>
          <div class="theme-color" style="background:#FFFFFF; border:1px solid #ccc;"></div>
          <div class="theme-color" style="background:#B6FF47;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="life">
        <span>ç”Ÿå‘½åºç« </span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#A5EAFF;"></div>
          <div class="theme-color" style="background:#BEFFF8;"></div>
          <div class="theme-color" style="background:#9EC4F6;"></div>
          <div class="theme-color" style="background:#E1DCFC;"></div>
          <div class="theme-color" style="background:#D2C0F9;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="purple">
        <span>ç´«é¼ æ³•ç¿ </span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#FFF200;"></div>
          <div class="theme-color" style="background:#65BFBE;"></div>
          <div class="theme-color" style="background:#BDE031;"></div>
          <div class="theme-color" style="background:#DEEDA1;"></div>
          <div class="theme-color" style="background:#008F75;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="rainbow">
        <span>å½©è™¹å°å°</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#FFB78C;"></div>
          <div class="theme-color" style="background:#FFF08C;"></div>
          <div class="theme-color" style="background:#BBFF8C;"></div>
          <div class="theme-color" style="background:#8CFFCE;"></div>
          <div class="theme-color" style="background:#BD8CFF;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="wonderful">
        <span>ä¸æ€è®®ä¸–ç•Œ</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#191A1E;"></div>
          <div class="theme-color" style="background:#482E31;"></div>
          <div class="theme-color" style="background:#FF3B3E;"></div>
          <div class="theme-color" style="background:#FF8657;"></div>
          <div class="theme-color" style="background:#FFBA70;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="16yyds">
        <span>åå…­YYDS</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#E5FD56;"></div>
          <div class="theme-color" style="background:#C6DC74;"></div>
          <div class="theme-color" style="background:#A8BB92;"></div>
          <div class="theme-color" style="background:#899AB0;"></div>
          <div class="theme-color" style="background:#6A79CE;"></div>
        </div>
      </div>
      <div class="theme-option" data-theme="easter-egg">
        <span>è®¨åŒåå…­</span>
        <div class="theme-colors">
          <div class="theme-color" style="background:#FF0000;"></div>
          <div class="theme-color" style="background:#FF6600;"></div>
          <div class="theme-color" style="background:#FFCC00;"></div>
          <div class="theme-color" style="background:#00FF00;"></div>
          <div class="theme-color" style="background:#0066FF;"></div>
        </div>
      </div>
    </div>
    
    <!-- å½©è›‹æ¨¡æ€æ¡† -->
    <div id="easterEggModal" class="modal">
      <div class="modal-content">
        <h2>ğŸ‰ å½©è›‹ï¼</h2>
        <p>ä½ æ•¢ç‚¹è¿™ä¸ªï¼Œè¾¾é¼ æ³¥ï¼Œç»™16æ‰“é’±ï¼<br>hahahahaha ğŸ˜„</p>
        <div style="text-align: center; margin: 20px 0;">
          <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 15px;">
            <img src="src/assets/yiyi.jpg" alt="notGood" style="max-width: 45%; height: auto;" />
            <img src="src/assets/appreciate.jpg" alt="appreciate" style="max-width: 45%; height: auto;" />
          </div>
          <div style="margin: 10px 0;">èŸ¹èŸ¹æ³¥~</div>
        </div>
        <button onclick="closeEasterEgg()">å…³é—­</button>
      </div>
    </div>
    

    <!-- Tabå¯¼èˆª - Ant Designé£æ ¼ -->
    <div class="antd-tabs-container">
      <div class="antd-tabs">
        <div class="antd-tab-nav">
          <div class="antd-tab-nav-list">
            <div class="antd-tab-nav-wrap">
              <div class="antd-tab-tab" data-tab="index">
                <div class="antd-tab-tab-btn">æŒ‡æ•°ä¸‰å¤§ä»¶</div>
              </div>
              <div class="antd-tab-tab antd-tab-tab-active" data-tab="hacker">
                <div class="antd-tab-tab-btn">é»‘å®¢æµæ´¾</div>
              </div>
            </div>
          </div>
          <!-- å³ä¾§å¼€å…³åŒºåŸŸ -->
          <div class="antd-tab-nav-extra">
            <div class="tab-moonlight-toggle" id="tabFuzhongToggle" style="display: none;">
              <label class="moonlight-toggle-switch">
                <input type="checkbox" id="fuzhongToggle" checked />
                <span class="moonlight-toggle-slider"></span>
                <span class="moonlight-toggle-text" id="fuzhongToggleText">è´Ÿé‡</span>
              </label>
            </div>
            <div class="tab-moonlight-toggle" id="tabMoonlightToggle" style="display: none;">
              <label class="moonlight-toggle-switch">
                <input type="checkbox" id="moonlightToggle" checked />
                <span class="moonlight-toggle-slider"></span>
                <span class="moonlight-toggle-text" id="moonlightToggleText">æœˆå…‰</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" id="main-content" style="margin-top: 0; border-top: 1px solid var(--line);">
      <div class="col-left">
        <div class="card">
        <div class="card-header">
          <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
            <h3>å…³å¡é…ç½®ä¸æŠ¤èº«ç¬¦è®¾ç½®</h3>
            <div class="block-selector" style="display:flex; gap:4px; margin:0; flex-wrap:wrap;">
              <button class="block-btn active" data-block="level-select">é€‰æ‹©å…³å¡</button>
              <button class="block-btn active" data-block="values">æ•°å€¼è®¾ç½®</button>
              <button class="block-btn active" data-block="triggers">è§¦å‘æ¬¡æ•°ä¸ç‹ä¹‹å¬å”¤</button>
              <button class="block-btn " data-block="display">å¤§æ•°å­—å•ä½</button>
              <button class="block-btn " data-block="tech">ç§‘æŠ€</button>
              <button class="block-btn " data-block="shop">å•†åº—åˆ·æ–°æ˜Ÿå¸</button>
              <button class="block-btn active" data-block="seal-counter">å°ç« æ¶ˆå¤±è®¡æ•°</button>
              <button class="block-btn active" data-block="predict">æœªæ¥å…³å¡é¢„æµ‹</button>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: var(--muted); text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span>ä¸‡ã€äº¿ã€å…†ã€äº¬ã€å“ã€ç§­ã€ç©°ã€æ²Ÿã€æ¶§ã€æ­£ã€è½½ã€æ</span>
              <img id="lolipopIcon" src="src/assets/lolipop16.png" alt="lolipop" style="width: 64px; height: 64px; opacity: 0.7; cursor: pointer;" />
            </div>
            <button class="card-toggle" data-target="config-content">âˆ’</button>
          </div>
        </div>
        <div class="card-content" id="config-content">
        
        <!-- ä¸¤åˆ—å¸ƒå±€ï¼šå·¦ä¾§é€‰æ‹©å…³å¡(15%)ï¼Œå³ä¾§å…¶ä»–åŒºå—(85%) -->
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
          
          <!-- å·¦ä¾§ï¼šé€‰æ‹©å…³å¡ -->
          <div class="config-block" data-block="level-select" style="flex: 0 0 15%; min-width: 180px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 style="margin:0;">é€‰æ‹©å…³å¡</h4>
              <div style="display:flex; gap:4px;">
                <button id="prevLevel" style="padding:4px 8px; font-size:12px;" title="ä¸Šä¸€å…³">â—€</button>
                <button id="nextLevel" style="padding:4px 8px; font-size:12px;" title="ä¸‹ä¸€å…³">â–¶</button>
              </div>
            </div>
            <div class="block-content expanded">
            <label>ç›®æ ‡åˆ†æ•°
              <input id="targetScore" value="200" />
            </label>
            <label>é€‰æ‹©å…³å¡
              <select id="levelSelect"></select>
            </label>
            
            <!-- èµ·å§‹å…³å¡è®¾ç½® -->
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span style="font-weight:600; color:var(--text);">èµ·å§‹å…³å¡</span>
                <button id="unlockApply" style="padding:4px 8px; font-size:12px;">ç¡®è®¤</button>
              </div>
              <label>ç›—å°
                <select id="unlockD"></select>
              </label>
              <label>è´Ÿé‡
                <select id="unlockF"></select>
              </label>
              <label>æœˆå…‰
                <select id="unlockY"></select>
              </label>
            </div>
            </div>
          </div>
          <!-- å³ä¾§ï¼šå…¶ä»–åŒºå—flexå¸ƒå±€ -->
          <div class="blocks-grid" id="blocksGrid" style="display: flex; flex-wrap: wrap; gap: 8px; flex: 1; width: 100%;">
          <!-- åŒºå—2ï¼šæ•°å€¼è®¾ç½® -->
          <div class="config-block" data-block="values" style="flex: 1; min-width: 200px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>æ•°å€¼è®¾ç½®<span class="block-toggle">â–¼</span></h4>
            <div class="block-content expanded">
            <label>èƒ¡ç‰Œç•ªæ•°
              <input id="finalMulInput" value="30" />
            </label>
            <label>å°åˆ†åˆ†å€¼
              <input id="baseScore" value="77" />
            </label>
            <label>ç›—å°ç•ªæ•°
              <input id="daoyin" value="2" readonly />
            </label>
            <div id="daoyin_display" style="font-size:10px; color:#9ca3af; margin:2px 0 8px 0; min-height:12px; text-align:right; padding-right:4px;"></div>
            <label>è´Ÿé‡ç•ªæ•°
              <input id="fuzhong" value="1.5" readonly />
            </label>
            <div id="fuzhong_display" style="font-size:10px; color:#9ca3af; margin:2px 0 8px 0; min-height:12px; text-align:right; padding-right:4px;"></div>
            <label>æœˆå…‰ç•ªæ•°
              <input id="yueguang" value="2.5" readonly />
            </label>
            <div id="yueguang_display" style="font-size:10px; color:#9ca3af; margin:2px 0 8px 0; min-height:12px; text-align:right; padding-right:4px;"></div>
            </div>
          </div>
          <!-- åŒºå—4ï¼šè§¦å‘æ¬¡æ•°ä¸ç‹ä¹‹å¬å”¤ -->
          <div class="config-block" data-block="triggers" style="flex: 1; min-width: 200px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>è§¦å‘æ¬¡æ•°ä¸ç‹ä¹‹å¬å”¤<span class="block-toggle">â–¼</span></h4>
            <div class="block-content expanded">
            
            <!-- è§¦å‘æ¬¡æ•°å’Œç†è®ºæœ€å¤§æ¬¡æ•°åœ¨åŒä¸€è¡Œ -->
            <div style="display:flex; gap:16px; margin-bottom:12px;">
              <!-- å®é™…è§¦å‘æ¬¡æ•° -->
              <div style="flex:1;">
                <div style="font-size:12px;color:#374151;margin-bottom:8px;">å®é™…è§¦å‘æ¬¡æ•°</div>
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">ç›—å°:</label>
                    <input id="trigD" type="number" value="4" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">è´Ÿé‡:</label>
                    <input id="trigF" type="number" value="7" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">æœˆå…‰:</label>
                    <input id="trigY" type="number" value="5" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                </div>
              </div>
              
              <!-- ç†è®ºæœ€å¤§æ¬¡æ•° -->
              <div style="flex:1;">
                <div style="font-size:12px;color:#374151;margin-bottom:8px;">ç†è®ºæœ€å¤§æ¬¡æ•°</div>
                <div style="display:flex; flex-direction:column; gap:6px;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">ç›—å°:</label>
                    <input id="theoD" type="number" value="6" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">è´Ÿé‡:</label>
                    <input id="theoF" type="number" value="7" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">æœˆå…‰:</label>
                    <input id="theoY" type="number" value="5" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ç‹ä¹‹å¬å”¤ -->
            <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--line);">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <label class="king-switch-container">
                  <input type="checkbox" id="kingEnabled" />
                  <span class="king-switch-slider">
                    <span class="king-switch-text king-switch-text-on">å¼€å¯</span>
                    <span class="king-switch-text king-switch-text-off">å…³é—­</span>
                  </span>
                </label>
                <span style="font-size:12px;color:#374151;">ç‹ä¹‹å¬å”¤</span>
              </div>
              <div id="kingBox" style="display:none;">
                <div style="font-size:12px;color:#374151;margin-bottom:8px;">ç‹ä¹‹å¬å”¤è§¦å‘æ¬¡æ•°</div>
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">å®é™…:</label>
                    <input id="trigK" type="number" value="4" min="0" step="1" style="padding:4px; flex:1;" />
              </div>
                  <div style="display:flex; align-items:center; gap:8px;">
                    <label style="font-size:11px;color:#6b7280; min-width:40px;">ç†è®º:</label>
                    <input id="maxTrigK" type="number" value="4" min="0" step="1" style="padding:4px; flex:1;" />
                  </div>
                </div>
                <div style="font-size:11px;color:#6b7280; margin-bottom:8px;">ç‹ä¹‹å¬å”¤ ä»¥14å¼ å…¨é­‚ç‰Œä¸ºåŸºç¡€è®¡ç®—<br>è‹¥æœ‰ç­’ç´¢å¤±æ•ˆdebuffè¯·è‡ªè¡Œä¿®æ”¹ä¸‹ä¸€å…³ç•ªæ•°:P</div>
              </div>
            </div>
            </div>
          </div>
          <!-- åŒºå—5ï¼šå¤§æ•°å­—å•ä½ -->
          <div class="config-block" data-block="display" style="flex: 1; min-width: 200px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>å¤§æ•°å­—å•ä½ç³»ç»Ÿå¯¹ç…§è¡¨<span class="block-toggle">â–¼</span></h4>
            <div class="block-content expanded">
            <div class="data-table">
              <table>
                <thead>
                  <tr>
                    <th>å•ä½</th>
                    <th>æŒ‡æ•°</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>ä¸‡</td><td>10^4</td></tr>
                  <tr><td>äº¿</td><td>10^8</td></tr>
                  <tr><td>å…†</td><td>10^12</td></tr>
                  <tr><td>äº¬</td><td>10^16</td></tr>
                  <tr><td>å“</td><td>10^20</td></tr>
                  <tr><td>ç§­</td><td>10^24</td></tr>
                  <tr><td>ç©°</td><td>10^28</td></tr>
                  <tr><td>æ²Ÿ</td><td>10^32</td></tr>
                  <tr><td>æ¶§</td><td>10^36</td></tr>
                  <tr><td>æ­£</td><td>10^40</td></tr>
                  <tr><td>è½½</td><td>10^44</td></tr>
                  <tr><td>æ</td><td>10^48</td></tr>
                </tbody>
              </table>
            </div>
            </div>
          </div>
          <!-- åŒºå—678åˆå¹¶ï¼šé­‚ç‰Œ/å…¬å¼€ç‰Œ/å®ç‰ŒæŒ‡ç¤ºç‰Œ -->
          <div class="config-block" data-block="tech" style="flex: 1; min-width: 300px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>é­‚ç‰Œ - å…¬å¼€ç‰Œ - å®ç‰ŒæŒ‡ç¤ºç‰Œ<span class="block-toggle">â–¼</span></h4>
            <div class="block-content expanded">
            <div class="data-table">
              <table>
                <thead>
                  <tr>
                    <th>æ¬¡æ•°</th>
                    <th>æ˜Ÿå¸</th>
                    <th>æ¬¡æ•°</th>
                    <th>æ˜Ÿå¸</th>
                    <th>æ¬¡æ•°</th>
                    <th>æ˜Ÿå¸</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td class="count-cell">0/9</td><td>10</td><td class="count-cell">6/18</td><td>2</td><td class="count-cell">1/10</td><td>5</td></tr>
                  <tr><td class="count-cell">1/9</td><td>20</td><td class="count-cell">7/18</td><td>4</td><td class="count-cell">2/10</td><td>10</td></tr>
                  <tr><td class="count-cell">2/9</td><td>30</td><td class="count-cell">8/18</td><td>6</td><td class="count-cell">3/10</td><td>15</td></tr>
                  <tr><td class="count-cell">3/9</td><td>40</td><td class="count-cell">9/18</td><td>8</td><td class="count-cell">4/10</td><td>20</td></tr>
                  <tr><td class="count-cell">4/9</td><td>50</td><td class="count-cell">10/18</td><td>10</td><td class="count-cell">5/10</td><td>30</td></tr>
                  <tr><td class="count-cell">5/9</td><td>80</td><td class="count-cell">11/18</td><td>20</td><td class="count-cell">6/10</td><td>50</td></tr>
                  <tr><td class="count-cell">6/9</td><td>100</td><td class="count-cell">12/18</td><td>30</td><td class="count-cell">7/10</td><td>80</td></tr>
                  <tr><td class="count-cell">7/9</td><td>150</td><td class="count-cell">13/18</td><td>40</td><td class="count-cell">8/10</td><td>120</td></tr>
                  <tr><td class="count-cell">8/9</td><td>200</td><td class="count-cell">14/18</td><td>50</td><td class="count-cell">9/10</td><td>160</td></tr>
                  <tr><td class="count-cell"> </td><td> </td><td class="count-cell">15/18</td><td>80</td><td class="count-cell"> </td><td> </td></tr>
                  <tr><td class="count-cell"> </td><td> </td><td class="count-cell">16/18</td><td>120</td><td class="count-cell"> </td><td> </td></tr>
                  <tr><td class="count-cell"> </td><td> </td><td class="count-cell">17/18</td><td>160</td><td class="count-cell"> </td><td> </td></tr>
                </tbody>
              </table>
            </div>
            </div>
          </div>
          
          <!-- åŒºå—8ï¼šå•†åº—åˆ·æ–°æ˜Ÿå¸ -->
          <div class="config-block" data-block="shop" style="flex: 1; min-width: 200px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>å•†åº—åˆ·æ–°æ˜Ÿå¸<span class="block-toggle">â–¼</span></h4>
            <div class="block-content expanded">
          <div class="data-table">
            <table>
              <thead>
                <tr>
                  <th>åˆ·æ–°æ¬¡æ•°</th>
                  <th>æ‰€éœ€æ˜Ÿå¸</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>1</td><td>2</td></tr>
                <tr><td>2</td><td>3</td></tr>
                <tr><td>3</td><td>5</td></tr>
                <tr><td>4</td><td>8</td></tr>
                <tr><td>5</td><td>12</td></tr>
                <tr><td>6</td><td>18</td></tr>
                <tr><td>7</td><td>27</td></tr>
                <tr><td>8</td><td>41</td></tr>
                <tr><td>9</td><td>93</td></tr>
                <tr><td>10</td><td>140</td></tr>
                <tr><td>11</td><td>210</td></tr>
                <tr><td>12</td><td>315</td></tr>
                <tr><td>13</td><td>473</td></tr>
                <tr><td>14</td><td>710</td></tr>
                <tr><td>15</td><td>1065</td></tr>
                <tr><td>16</td><td>1598</td></tr>
                <tr><td>17</td><td>2397</td></tr>
                <tr><td>18</td><td>3596</td></tr>
                <tr><td>19</td><td>5394</td></tr>
                <tr><td>20</td><td>8091</td></tr>
                <tr><td>21</td><td>12137</td></tr>
                <tr><td>22</td><td>18206</td></tr>
              </tbody>
            </table>
          </div>
            </div>
          </div>
          
          <!-- åŒºå—ï¼šå°ç« æ¶ˆå¤±è®¡æ•° -->
          <div class="config-block" data-block="seal-counter" style="flex: 1; min-width: 300px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <h4>å°ç« æ¶ˆå¤±è®¡æ•°<span class="block-toggle">â–¼</span></h4>
            <div class="block-content expanded">
              <div class="seal-counter-container">
                <label>ä½ æƒ³ä»å“ªä¸€å…³çš„ç›—å°å¼€å§‹åŠ å‘¢ï¼Ÿ
                  <select id="sealCounterLevel" class="compact-select">
                    <option value="">è¯·é€‰æ‹©å…³å¡...</option>
                  </select>
                </label>
                
                <div class="seal-counter-actions" style="margin-top: 15px;">
                  <button id="confirmSealLevel" class="btn" disabled style="background-color: #ccc; color: #666; cursor: not-allowed;">ç¡®è®¤å…³å¡</button>
                  <button id="resetSealCounter" class="btn btn-secondary">æ¸…é›¶</button>
                </div>
                
                <div class="seal-counter-display" id="sealCounterDisplay" style="display: none; margin-top: 20px; text-align: center;">
                  <div class="current-level-info" style="margin-bottom: 15px; padding: 10px; background: var(--accent-light); border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--muted);">å°ç« ç±»å‹: <span id="currentGrowthType">-</span></div>
                  </div>
                  
                  <div class="wooden-fish-container">
                    <div class="fish-and-counter-row">
                      <div class="wooden-fish" id="woodenFish">
                        <div class="fish-body">
                          <img src="src/assets/daoyin.png" alt="ç›—å°" class="daoyin-image" />
                        </div>
                        <div class="fish-shadow"></div>
                      </div>
                      <div class="counter-display">
                        <div class="counter-number" id="sealCounterNumber">0</div>
                        <div class="counter-label">æ•²å‡»æ¬¡æ•°</div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="seal-value-display" style="margin-top: 15px; padding: 10px; background: var(--card); border: 1px solid var(--line); border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 5px;">å…³å¡: <span id="currentSealLevel">-</span> ç›—å°ç•ªæ•°å˜åŒ–:</div>
                    <div id="sealValueChange" style="font-size: 14px; color: var(--primary-strong);">0 â†’ 0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- åŒºå—9ï¼šæœªæ¥å…³å¡é¢„æµ‹åŒºå— -->
          <div class="config-block" data-block="predict" style="flex: 1; min-width: 300px;">
            <div class="resize-handle left" data-resize="left"></div>
            <div class="resize-handle right" data-resize="right"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <span style="font-weight:600; color:var(--text);">æœªæ¥å…³å¡é¢„æµ‹</span>
              <button id="updatePrediction">æ›´æ–°é¢„æµ‹</button>
            </div>
            <div class="card-content" id="prediction-content">
              <!-- å½“å‰å…³å¡ä¿¡æ¯ä¸å¾—åˆ†å¯¹æ¯” -->
              <div id="currentLevelInfo" style="display:none; margin-bottom:16px; padding:12px; background:var(--accent); border-radius:8px;">
                <!-- ç¬¬ä¸€è¡Œï¼šå½“å‰å…³å¡+ç›®æ ‡åˆ†ï¼Œå®é™…å¾—åˆ†ï¼Œç†è®ºå¾—åˆ† -->
                <div style="display:flex; gap:16px; margin-bottom:12px;">
                  <div style="flex:1; min-width:250px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">å½“å‰å…³å¡ä¸ç›®æ ‡åˆ†</div>
                    <div id="predCurrentLevelTarget" style="font-size:13px; color:var(--text);">è¯·å…ˆè¿›è¡Œè®¡ç®—</div>
                  </div>
                  <div style="flex:1; min-width:200px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">å®é™…å½“å‰æ€»å¾—åˆ†</div>
                    <div id="predCurrentScore" style="font-size:13px; color:var(--text);">-</div>
                  </div>
                  <div style="flex:1; min-width:200px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">ç†è®ºæœ€é«˜å½“å‰å…³æ€»å¾—åˆ†</div>
                    <div id="predMaxScore" style="font-size:13px; color:var(--text);">-</div>
                  </div>
                </div>
                
                <!-- ç¬¬äºŒè¡Œï¼šåˆ†è§£ï¼ˆç•ªæ•°ä¸è§¦å‘æ¬¡æ•°ï¼‰ -->
                <div style="padding-top:12px; border-top:1px solid var(--line);">
                  <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">åˆ†è§£ï¼ˆç•ªæ•°ä¸è§¦å‘æ¬¡æ•°ï¼‰</div>
                  <div id="predBreakdown" style="font-size:13px; line-height:1.6; color:var(--text); display:flex; gap:16px;">-</div>
                </div>
              </div>
              
              <!-- é¢„æµ‹ç»“æœ -->
              <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:stretch;">
                <!-- å½“å‰è§¦å‘æ¬¡æ•°é¢„æµ‹ -->
                <div style="border:1px solid var(--line); border-radius:8px; padding:12px; flex:1; min-width:260px; display:flex; flex-direction:column;">
                  <h5 style="margin:0 0 12px 0; color:var(--text); font-size:14px; display:flex; align-items:center; gap:8px;">
                    <span>å®é™…é¢„æµ‹<span class="predict-trigs">ï¼ˆç›—å°=<span id="currentDaoyinTriggers">-</span>, è´Ÿé‡=<span id="currentFuzhongTriggers">-</span>, æœˆå…‰=<span id="currentYueguangTriggers">-</span>ï¼‰</span></span>
                    <span style="margin-left:auto; display:flex; gap:6px; align-items:center;" id="currentPredQuickStatus"></span>
                  </h5>
                  <div id="currentPrediction" style="font-size:11px; line-height:1.6; color:var(--text); margin-top:auto;">è¯·å…ˆè¿›è¡Œè®¡ç®—</div>
                </div>
                
                <!-- ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°é¢„æµ‹ -->
                <div style="border:1px solid var(--line); border-radius:8px; padding:12px; flex:1; min-width:260px; display:flex; flex-direction:column;">
                  <h5 style="margin:0 0 12px 0; color:var(--text); font-size:14px; display:flex; align-items:center; gap:8px;">
                    <span>ç†è®ºé¢„æµ‹<span class="predict-trigs">ï¼ˆç›—å°=<span id="maxDaoyinTriggers">-</span>, è´Ÿé‡=<span id="maxFuzhongTriggers">-</span>, æœˆå…‰=<span id="maxYueguangTriggers">-</span>ï¼‰</span></span>
                    <span style="margin-left:auto; display:flex; gap:6px; align-items:center;" id="maxPredQuickStatus"></span>
                  </h5>
                  <div id="maxPrediction" style="font-size:11px; line-height:1.6; color:var(--text); margin-top:auto;">è¯·å…ˆè¿›è¡Œè®¡ç®—</div>
                </div>
              </div>
            </div>
          </div>
        </div>
          
          </div> <!-- å…³é—­å³ä¾§åŒºå—ç½‘æ ¼ -->
        </div> <!-- å…³é—­ä¸¤åˆ—å¸ƒå±€ -->
        
        </div>
      </div>

      

      <!-- æ‚¬æµ®ç»“æœçª— -->
      <div id="floatingResult" class="floating-window" style="display:none;">
        <div class="floating-header">
          <div class="floating-title">è®¡ç®—ç»“æœ</div>
          <div class="floating-controls">
            <button class="floating-close" id="floatingClose">Ã—</button>
          </div>
        </div>
        <div class="floating-content" id="floatingContent">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:12px; color:#374151;">ç²¾åº¦:</span>
              <div class="precision-buttons">
                <button class="precision-btn active" data-precision="2">2ä½</button>
                <button class="precision-btn" data-precision="4">4ä½</button>
              </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
              <button id="btn">è®¡ç®—</button>
              <span id="status" class="status">æœªè®¡ç®—</span>
            </div>
          </div>
          <div class="grid-3">
            <div>
              <div style="font-size:12px;color:#374151;">å®é™…å½“å‰æ€»å¾—åˆ†</div>
              <div id="resTotalSci" style="font-weight:600;">-</div>
              <div id="resTotalCn" style="color:#6b7280;">-</div>
            </div>
            <div>
              <div style="font-size:12px;color:#374151;">ç†è®ºæœ€é«˜å½“å‰å…³æ€»å¾—åˆ†</div>
              <div id="resTheoSci" style="font-weight:600;">-</div>
              <div id="resTheoCn" style="color:#6b7280;">-</div>
            </div>
            <div>
              <div style="font-size:12px;color:#374151;">ç›®æ ‡åˆ†ï¼ˆç”¨äºå¯¹æ¯”ï¼‰</div>
              <div id="resTargetSci" style="font-weight:600;">-</div>
              <div id="resTargetCn" style="color:#6b7280;">-</div>
            </div>
          </div>
          <div style="margin-top:8px; font-size:12px; color:#374151;">åˆ†è§£ï¼ˆç•ªæ•°ä¸è§¦å‘æ¬¡æ•°ï¼‰</div>
          <div class="grid-3" style="margin-top:6px;">
            <div>
              <strong>ç›—å°</strong>
              <div id="bdD">-</div>
            </div>
            <div>
              <strong>è´Ÿé‡</strong>
              <div id="bdF">-</div>
            </div>
            <div>
              <strong>æœˆå…‰</strong>
              <div id="bdY">-</div>
            </div>
          </div>
          
          <!-- ç‹ä¹‹å¬å”¤è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
          <!--
          <div id="kingSummonDebug" style="display:none; margin-top:12px; padding:8px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:4px; font-size:11px;">
            <div style="font-weight:bold; margin-bottom:4px; color:#495057;">ğŸ¯ ç‹ä¹‹å¬å”¤è®¡ç®—è¯¦æƒ…</div>
            <div id="kingDebugContent" style="color:#6c757d; line-height:1.4;"></div>
          </div>
          -->
          
          <!-- è¯¦ç»†è®¡ç®—æ­¥éª¤è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
          <!--
          <div id="detailedCalculationDebug" style="display:none; margin-top:12px; padding:8px; background:#fff3cd; border:1px solid #ffeaa7; border-radius:4px; font-size:11px;">
            <div style="font-weight:bold; margin-bottom:4px; color:#856404;">ğŸ” è¯¦ç»†è®¡ç®—æ­¥éª¤</div>
            <div id="detailedDebugContent" style="color:#856404; line-height:1.4;"></div>
          </div>
          -->
        </div>
      </div>

    <div class="card" style="margin-top:var(--gap); width:100%; max-width:100%;">
      <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3>å…³å¡ç›®æ ‡åˆ†ï¼ˆåˆ†é¡µå±•ç¤ºï¼Œæ¯é¡µ6é¡¹ï¼‰</h3>
        </div>
        <div style="display:flex; gap:16px; align-items:center;">
          <div style="display:flex; gap:6px; align-items:center; flex-wrap:nowrap; white-space:nowrap;">
            <select id="historySelect" style="font-size:12px; padding:4px 8px; border:1px solid var(--line); border-radius:6px; background:var(--card); color:var(--text); min-width:180px;">
              <option value="">é€‰æ‹©å†å²é…ç½®</option>
            </select>
            <button id="dropdownDeleteBtn" class="btn-radio btn-light" style="font-size:12px; padding:4px 8px; white-space:nowrap;">åˆ é™¤å½“å‰é…ç½®â€¦</button>
          </div>

          <div style="display:flex; gap:6px; align-items:center;">
            <button id="saveCurrentBtn" class="btn-radio" style="font-size:12px; padding:4px 8px;">å­˜å‚¨å½“å‰æ•°æ®</button>
            <div id="saveFlow" style="display:none; gap:6px; align-items:center;">
              <input id="historyName" placeholder="è¾“å…¥åç§°" style="font-size:12px; padding:4px 8px; width:160px; border:1px solid var(--line); border-radius:6px; background:var(--card); color:var(--text);" />
              <button id="confirmSaveBtn" class="btn-radio" style="font-size:12px; padding:4px 8px;">ç¡®è®¤</button>
              <button id="cancelSaveBtn" class="btn-radio btn-light" style="font-size:12px; padding:4px 8px;">å–æ¶ˆ</button>
            </div>
          </div>

          <div style="display:flex; gap:4px; align-items:center; margin-left:auto;">
            <span style="font-size:12px; color:#374151;">å¸ƒå±€:</span>
            <button id="layoutSwitch" class="btn-radio active" data-layout="single" style="font-size:12px; padding:4px 8px;">å•è¡Œ</button>
            <button id="layoutSwitch2" class="btn-radio" data-layout="two-column" style="font-size:12px; padding:4px 8px;">ä¸¤æ </button>
          </div>
          <button id="prev5">ä¸Šä¸€é¡µ</button>
          <div style="display:flex; align-items:center; gap:4px;">
            <span style="font-size:12px; color:#374151;">ç¬¬</span>
            <input type="number" id="pageInput5" min="1" max="1" style="width:50px; padding:2px 4px; text-align:center; font-size:12px;" oninput="this.value = Math.max(this.min, Math.min(this.max, this.value))" />
            <span style="font-size:12px; color:#374151;">é¡µ</span>
            <button id="goToPage5" style="font-size:12px; padding:2px 6px;">è·³è½¬</button>
          </div>
          <button id="next5">ä¸‹ä¸€é¡µ</button>
          <span id="pageInfo5"></span>
          <button class="card-toggle" data-target="level5-content">âˆ’</button>
        </div>
      </div>
      <div class="card-content" id="level5-content">
        <div id="levelList5"></div>
      </div>
    </div>


    
    <script>
      // è‡ªåŠ¨ç«¯å£/ç¯å¢ƒæ£€æµ‹
      // ç”Ÿäº§ç¯å¢ƒï¼ˆå¦‚ Azureï¼‰ä½¿ç”¨åŒæºç›¸å¯¹è·¯å¾„ï¼›æœ¬åœ°å¼€å‘ä¿æŒç«¯å£æ‰«æ
      let API_BASE = '';
      let api = '/api/calc';
      
      // æ£€æµ‹åç«¯ç«¯å£
      async function detectBackendPort() {
        const ports = [6001, 6002, 6003, 6004, 6005, 6006, 6007, 6008, 6009, 6010];
        
        console.log('ğŸ” Starting backend port detection...');
        
        for (const port of ports) {
          try {
            console.log(`ğŸ” Checking port ${port}...`);
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 1000);
            
            const response = await fetch(`http://127.0.0.1:${port}/api/health`, {
              method: 'GET',
              mode: 'cors',
              cache: 'no-store',
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
              const data = await response.json();
              if (data.status === 'ok') {
                console.log(`ğŸ¯ Backend detected on port ${port}`);
                return port;
              }
            }
          } catch (error) {
            // ç«¯å£ä¸å¯ç”¨ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
            console.log(`âŒ Port ${port} not available: ${error.message}`);
            continue;
          }
        }
        
        throw new Error('Backend server not found on any port');
      }
      
      // åˆå§‹åŒ–APIé…ç½®
      async function initAPI() {
        try {
          // åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬åœ°ç¯å¢ƒï¼šhostname ä¸º localhost/127.0.0.1
          const isLocal = ['localhost', '127.0.0.1'].includes(location.hostname);
          if (isLocal) {
            const port = await detectBackendPort();
            API_BASE = `http://127.0.0.1:${port}`;
            api = `${API_BASE}/api/calc`;
            console.log(`âœ… API configured: ${API_BASE}`);
            showPortStatus(port);
          } else {
            // ç”Ÿäº§ç¯å¢ƒç›´æ¥ä½¿ç”¨åŒæºç›¸å¯¹è·¯å¾„ï¼Œé¿å… CORS/ç«¯å£é—®é¢˜
            API_BASE = '';
            api = '/api/calc';
            console.log(`âœ… API configured (production same-origin): ${location.origin}`);
          }
        } catch (error) {
          console.error('âŒ Failed to detect backend:', error.message);
          console.log('ğŸ”„ Using default port 6001');
          showPortStatus(6001, true);
        }
      }
      
      // æ˜¾ç¤ºç«¯å£çŠ¶æ€
      function showPortStatus(port, isDefault = false) {
        // åˆ›å»ºæˆ–æ›´æ–°ç«¯å£çŠ¶æ€æ˜¾ç¤º
        let statusEl = document.getElementById('port-status');
        if (!statusEl) {
          statusEl = document.createElement('div');
          statusEl.id = 'port-status';
          statusEl.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
            z-index: 10000;
            pointer-events: none;
            transition: opacity 0.3s;
          `;
          document.body.appendChild(statusEl);
        }
        
        statusEl.innerHTML = `
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="color: ${isDefault ? '#ff6b6b' : '#51cf66'};">
              ${isDefault ? 'âš ï¸' : 'âœ…'}
            </span>
            <span>Backend: ${port}</span>
          </div>
        `;
        
        // 3ç§’åå®Œå…¨æ¶ˆå¤±
        setTimeout(() => {
          if (statusEl) {
            statusEl.style.opacity = '0';
            // ç­‰å¾…è¿‡æ¸¡åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
            setTimeout(() => {
              if (statusEl && statusEl.parentNode) {
                statusEl.parentNode.removeChild(statusEl);
              }
            }, 300); // ç­‰å¾…0.3sçš„è¿‡æ¸¡åŠ¨ç”»å®Œæˆ
          }
        }, 3000);
      }
      
      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç«¯å£
      initAPI();
      // å‰ç«¯åŒæ ·æä¾›å¤§æ•°è§£æä¸æ ¼å¼åŒ–ï¼Œç”¨äºè¾“å…¥/å›æ˜¾
      const CN_UNITS = ["ä¸‡","äº¿","å…†","äº¬","å“","ç§­","ç©°","æ²Ÿ","æ¶§","æ­£","è½½","æ"]; const CN_EXPS = [4,8,12,16,20,24,28,32,36,40,44,48];
      function parseChinaJiLocal(raw) {
        const s = String(raw||'').trim();
        if (!s) return null;
        if (/^[-+]?\d+(?:\.\d+)?(?:e[-+]?\d+)?$/i.test(s)) return s;
        
        // ä¿®å¤ï¼šæ”¯æŒ"20000ä¸‡.3434"è¿™ç§æ ¼å¼ï¼Œæ­£ç¡®å¤„ç†å°æ•°éƒ¨åˆ†
        // å…ˆå°è¯•åŒ¹é…ï¼šæ•°å­— + å•ä½ + .å°æ•° æ ¼å¼
        let m = s.match(/^\s*([-+]?\d+)\s*([ä¸‡äº¿å…†äº¬å“ç§­ç©°æ²Ÿæ¶§æ­£è½½])\s*(\.\d+)\s*(æ*)\s*$/);
        if (m) {
          const integerPart = parseFloat(m[1]);
          const unit = m[2];
          const decimalPart = m[3];
          const j = (m[4]||'').length;
          
          const idx = CN_UNITS.indexOf(unit);
          if (idx >= 0) {
            const base = CN_EXPS[idx];
            const result = (integerPart + parseFloat(decimalPart)) * Math.pow(10, base + j*48);
            return result.toString();
          }
        }
        
        // åŒ¹é…æ ¼å¼ï¼šæ•°å­—(å¯é€‰å°æ•°) + å•ä½(å¯é€‰) + æ(å¯é€‰)
        m = s.match(/^\s*([-+]?\d+(?:\.\d+)?)\s*([ä¸‡äº¿å…†äº¬å“ç§­ç©°æ²Ÿæ¶§æ­£è½½]?)(æ*)\s*$/);
        if (!m) return null;
        
        const coeff = parseFloat(m[1]); 
        const unit = m[2]||''; 
        const j = (m[3]||'').length;
        
        let base = 0; 
        if (unit) { 
          const idx = CN_UNITS.indexOf(unit); 
          if (idx >= 0) base = CN_EXPS[idx]; 
        }
        
        // è®¡ç®—æœ€ç»ˆç»“æœ
        const result = coeff * Math.pow(10, base + j*48);
        return result.toString();
      }

      // æ”¯æŒä¸­å›½å¤§æ•°å­—å•ä½çš„é€šç”¨è§£æï¼šä¼˜å…ˆå¤§æ•°å­—å†é€€åŒ–ä¸ºæµ®ç‚¹
      function parseManualToNumber(val) {
        if (val == null) return null;
        if (typeof val === 'number') return val;
        const s = String(val).trim();
        if (!s) return null;
        const sci = parseChinaJiLocal(s);
        if (sci) {
          const n = parseFloat(sci);
          return isNaN(n) ? null : n;
        }
        const n = parseFloat(s);
        return isNaN(n) ? null : n;
      }
      // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤ºï¼ˆçº¯æ•°å­— + ç§‘å­¦è®¡æ•°æ³• + å¤§æ•°å­—ï¼‰
      function formatNumberDisplay(value, digits=2) {
        if (!value || value === '-' || value === 0) return { raw: value || '0', sci: value || '0', cn: value || '0' };
        
        const num = parseFloat(value);
        if (!isFinite(num)) return { raw: '-', sci: '-', cn: '-' };
        
        // çº¯æ•°å­—æ ¼å¼
        let rawStr = num.toString();
        if (num >= 1e8) rawStr = ''; // è¶…è¿‡10^8ä¸æ˜¾ç¤ºçº¯æ•°å­—
        
        // ç§‘å­¦è®¡æ•°æ³•æ ¼å¼
        const sciStr = num.toExponential(digits);
        
        // å¤§æ•°å­—æ ¼å¼
        const cnStr = formatChinaJiLocal(num.toString(), digits);
        
        return { raw: rawStr, sci: sciStr, cn: cnStr };
      }

      function formatChinaJiLocal(expStr, digits=2){
        const s = String(expStr||'');
        
        // å¤„ç†çº¯æ•°å­—æ ¼å¼ï¼ˆéç§‘å­¦è®¡æ•°æ³•ï¼‰
        if (/^\s*[-+]?\d+(?:\.\d+)?\s*$/.test(s)) {
          const num = parseFloat(s);
          if (!isFinite(num)) return '-';
          if (num < 10000) return num.toString();
          
          // å°†çº¯æ•°å­—è½¬æ¢ä¸ºç§‘å­¦è®¡æ•°æ³•å¤„ç†
          const sciStr = num.toExponential();
          return formatChinaJiLocal(sciStr, digits);
        }
        
        // å¤„ç†ç§‘å­¦è®¡æ•°æ³•æ ¼å¼
        const m = s.match(/^\s*([-+]?\d+(?:\.\d+)?)e([-+]?\d+)\s*$/i);
        if (!m) return '-';
        
        let coeff = parseFloat(m[1]);
        let expo = parseInt(m[2], 10);
        
        // å¦‚æœç³»æ•°æˆ–æŒ‡æ•°æ— æ³•è§£æï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²
        if (!isFinite(coeff) || !isFinite(expo)) {
          return s;
        }
        
        // å¤„ç†è´Ÿæ•°æŒ‡æ•°ï¼ˆå°äº1çš„æ•°å­—ï¼‰
        if (expo < 0) {
          return coeff.toFixed(digits);
        }
        
        // å¤„ç†è¶…å¤§æŒ‡æ•°ï¼ˆè¶…è¿‡ JavaScript å®‰å…¨èŒƒå›´ï¼‰
        if (expo > 1000) {
          // å¯¹äºè¶…å¤§æ•°å­—ï¼Œç›´æ¥ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤ºï¼Œä¸è¿›è¡Œä¸­å›½å¤§æ•°å­—è½¬æ¢
          return `${coeff.toFixed(digits)}e${expo}`;
        }
        
        // å½’ä¸€åŒ–åˆ° [1,10)
        while (coeff >= 10) { coeff /= 10; expo += 1; }
        while (coeff < 1 && coeff > 0) { coeff *= 10; expo -= 1; }
        if (coeff === 0) return '0';
        
        const ji = Math.floor(expo / 48);
        let rem = expo % 48; if (rem < 0) rem += 48; // é˜²å¾¡æ€§å¤„ç†
        let unit = '';
        let shift = rem;
        
        // ä¿®å¤ï¼šç¡®ä¿èƒ½æ‰¾åˆ°åˆé€‚çš„å•ä½
        for (let i = CN_EXPS.length - 1; i >= 0; i--) {
          if (rem >= CN_EXPS[i]) { 
            unit = CN_UNITS[i]; 
            shift = rem - CN_EXPS[i]; 
            break; 
          }
        }
        
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å•ä½ï¼Œç›´æ¥ä½¿ç”¨æ•°å­—
        if (!unit && shift === 0) {
          return `${coeff.toFixed(digits)}${'æ'.repeat(ji)}`;
        }
        
        const coeffAdj = coeff * Math.pow(10, shift);
        return `${coeffAdj.toFixed(digits)}${unit}${'æ'.repeat(ji)}`;
      }

      function parseESci(str){
        const s = String(str||'');
        const m = s.match(/^\s*([-+]?\d+(?:\.\d+)?)e([-+]?\d+)\s*$/i);
        if (!m) return null;
        return { c: parseFloat(m[1]), e: parseInt(m[2],10) };
      }

      function compareStatusBySci(totalSci, targetSci){
        const a = parseESci(totalSci);
        const b = parseESci(targetSci);
        if (!a || !b) return null;
        if (a.e > b.e) return 'over5x';
        if (a.e < b.e) return 'under';
        // same exponent
        if (a.c >= 5 * b.c) return 'over5x';
        if (a.c >= b.c) return 'ok';
        return 'under';
      }
      const $ = (id) => document.getElementById(id);

      function setStatus(s) {
        const el = $('status');
        el.className = `status ${s}`;
        el.textContent = s;
      }

      async function computeWithForm(payloadOverride) {
        try {
          setStatus('è®¡ç®—ä¸­â€¦');
          const basePayload = (() => {
            const levelConfig = { targetScore: $('targetScore').value.trim() };
            if (document.getElementById('kingEnabled') && document.getElementById('kingEnabled').checked) {
              levelConfig.kingCallInitialMultiplier = '1'; // ç‹ä¹‹å¬å”¤åˆå§‹ç•ªæ•°å›ºå®šä¸º1
              const t = $('trigK') ? $('trigK').value.trim() : '4';
              if (t) levelConfig.kingCallTriggers = Number(t);
              levelConfig.kingCallBase = '30'; // åŸºç¡€ç•ªæ•°å›ºå®šä¸º30
            }
            const sequence = { baseScore: $('baseScore').value.trim(), items: [] };

            const options = {
              daoyinValue: $('daoyin').value.trim(),
              fuzhongValue: $('fuzhong').value.trim(),
              yueguangValue: $('yueguang').value.trim(),
              overrideTriggers: {
                daoyin: Number($('trigD').value.trim() || '0'),
                fuzhong: Number($('trigF').value.trim() || '0'),
                yueguang: Number($('trigY').value.trim() || '0'),
              },
              overrideTheoreticalMaxes: {
                daoyin: Number($('theoD').value.trim() || '0'),
                fuzhong: Number($('theoF').value.trim() || '0'),
                yueguang: Number($('theoY').value.trim() || '0'),
                kingCall: Number($('maxTrigK').value.trim() || '0') // æ·»åŠ ç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°
              }
            };
            return { levelConfig, sequence, options };
          })();
          if (!basePayload) return;

          const payload = payloadOverride ? { ...basePayload, ...payloadOverride } : basePayload;
          // è¦†ç›–èƒ¡ç‰Œç•ªæ•° - å¦‚æœæœ‰ç‹ä¹‹å¬å”¤ï¼Œä½¿ç”¨ç‹ä¹‹å¬å”¤è®¡ç®—å‡ºçš„èƒ¡ç‰Œç•ªæ•°
          const kingEnabled = document.getElementById('kingEnabled')?.checked;
          if (kingEnabled) {
            // è®¡ç®—ç‹ä¹‹å¬å”¤ä¹˜æ•°æ¥æ›¿æ¢èƒ¡ç‰Œç•ªæ•°
            const currentLevel = $('levelSelect')?.value || 'Ex61';
            const all = computeRecommendedAll();
            const levelData = all[currentLevel];
            
            if (levelData?.actualK && levelData?.actualKH) {
              const currentKingFan = levelData.actualK;
              const winCountFromSettings = parseFloat($('finalMulInput').value) || 1;
              const triggerCount = parseInt($('trigK').value) || 4;
              
              // ä½¿ç”¨ç»Ÿä¸€çš„ç‹ä¹‹å¬å”¤ä¹˜æ•°è®¡ç®—å‡½æ•°
              const kingMultiplier = calculateKingCallMultiplier(currentKingFan, triggerCount, winCountFromSettings);
              
              // ä½¿ç”¨ç‹ä¹‹å¬å”¤ä¹˜æ•°ç›´æ¥æ›¿æ¢èƒ¡ç‰Œç•ªæ•°
              // console.log('ğŸ¯ åç«¯è°ƒç”¨ç‹ä¹‹å¬å”¤è®¡ç®—:', {
              //   currentKingFan,
              //   winCountFromSettings,
              //   triggerCount,
              //   kingMultiplier,
              //   finalMultiplierOverride: kingMultiplier.toString()
              // });
              payload.options.finalMultiplierOverride = kingMultiplier.toString();
              
              // å¦‚æœç‹ä¹‹å¬å”¤å¼€å¯ï¼Œè¿˜éœ€è¦è®¡ç®—ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°å¯¹åº”çš„ç‹ä¹‹å¬å”¤ä¹˜æ•°
              const maxTrigK = parseInt($('maxTrigK').value) || 4;
              // console.log('ğŸ” å‰ç«¯ç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°è°ƒè¯•:', {
              //   currentKingFan,
              //   maxTrigK,
              //   winCountFromSettings,
              //   triggerCount
              // });
              
              if (maxTrigK > 0) {
                const theoreticalKingMultiplier = calculateKingCallMultiplier(currentKingFan, maxTrigK, winCountFromSettings);
                payload.options.theoreticalFinalMultiplierOverride = theoreticalKingMultiplier.toString();
                // console.log('ğŸ¯ å‰ç«¯è®¡ç®—ç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§ä¹˜æ•°:', theoreticalKingMultiplier.toString());
              } else {
                // å¦‚æœç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°ä¸º0ï¼Œä½¿ç”¨åŸå§‹èƒ¡ç‰Œç•ªæ•°
                payload.options.theoreticalFinalMultiplierOverride = $('finalMulInput').value.trim();
                // console.log('ğŸ¯ ç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°ä¸º0ï¼Œä½¿ç”¨åŸå§‹èƒ¡ç‰Œç•ªæ•°:', $('finalMulInput').value.trim());
              }
            } else {
          payload.options.finalMultiplierOverride = $('finalMulInput').value.trim();
              // ç‹ä¹‹å¬å”¤å…³é—­æ—¶ï¼Œç†è®ºæœ€å¤§ä¹˜æ•°ä¹Ÿä½¿ç”¨åŸå§‹èƒ¡ç‰Œç•ªæ•°
              payload.options.theoreticalFinalMultiplierOverride = $('finalMulInput').value.trim();
            }
          } else {
            payload.options.finalMultiplierOverride = $('finalMulInput').value.trim();
          }
          // å°†ä¸‰ç±»ç•ªæ•°è¾“å…¥ä¹Ÿå…è®¸ä¸­æ–‡å¤§æ•°ï¼šé¢„è§£æä¸ºç§‘å­¦è®¡æ•°
          ['daoyinValue','fuzhongValue','yueguangValue'].forEach(k=>{
            const v = payload.options[k];
            const p = parseChinaJiLocal(v);
            if (p) payload.options[k] = p;
          });
          // baseScore/targetScore äº¦æœ¬åœ°è§£æ
          const pt = parseChinaJiLocal(payload.levelConfig.targetScore); if (pt) payload.levelConfig.targetScore = pt;
          const pb = parseChinaJiLocal(payload.sequence.baseScore); if (pb) payload.sequence.baseScore = pb;
          // è§¦å‘æ¬¡æ•°ä¸ç†è®ºæœ€å¤§æ¬¡æ•°ç¡®ä¿ä¸ºæ•°å­—
          payload.options.overrideTriggers = payload.options.overrideTriggers || {};
          payload.options.overrideTheoreticalMaxes = payload.options.overrideTheoreticalMaxes || {};
          ['daoyin','fuzhong','yueguang','kingCall'].forEach(k=>{
            payload.options.overrideTriggers[k] = Number(payload.options.overrideTriggers[k]||0);
            payload.options.overrideTheoreticalMaxes[k] = Number(payload.options.overrideTheoreticalMaxes[k]||0);
          });

          const resp = await fetch(api, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          const prec = getCurrentPrecision();
          $('resTotalSci').textContent = data.totalScore || '-';
          $('resTotalCn').textContent = data.totalScore ? formatChinaJiLocal(data.totalScore, prec) : '-';
          $('resTheoSci').textContent = data.theoreticalTotalScore || '-';
          $('resTheoCn').textContent = data.theoreticalTotalScore ? formatChinaJiLocal(data.theoreticalTotalScore, prec) : '-';
          $('resTargetSci').textContent = (payload.levelConfig && payload.levelConfig.targetScore) || '-';
          $('resTargetCn').textContent = (payload.levelConfig && payload.levelConfig.targetScore) ? formatChinaJiLocal(payload.levelConfig.targetScore, prec) : '-';
          const dv = data.breakdown?.daoyin?.value;
          const fv = data.breakdown?.fuzhong?.value;
          const yv = data.breakdown?.yueguang?.value;
          const dvSci = dv != null ? parseFloat(dv).toExponential(prec) : '-';
          const fvSci = fv != null ? parseFloat(fv).toExponential(prec) : '-';
          const yvSci = yv != null ? parseFloat(yv).toExponential(prec) : '-';
          const dvCn = dv != null ? formatChinaJiLocal(dvSci, getCurrentPrecision()) : '-';
          const fvCn = fv != null ? formatChinaJiLocal(fvSci, getCurrentPrecision()) : '-';
          const yvCn = yv != null ? formatChinaJiLocal(yvSci, getCurrentPrecision()) : '-';
          $('bdD').textContent = `ç•ªæ•°=${dvSci} / ${dvCn}  è§¦å‘=${data.breakdown?.daoyin?.triggers ?? '-'}`;
          $('bdF').textContent = `ç•ªæ•°=${fvSci} / ${fvCn}  è§¦å‘=${data.breakdown?.fuzhong?.triggers ?? '-'}`;
          $('bdY').textContent = `ç•ªæ•°=${yvSci} / ${yvCn}  è§¦å‘=${data.breakdown?.yueguang?.triggers ?? '-'}`;
          
          // æ˜¾ç¤ºç‹ä¹‹å¬å”¤è°ƒè¯•ä¿¡æ¯
          /*
          const kingDebugEl = document.getElementById('kingSummonDebug');
          const kingDebugContentEl = document.getElementById('kingDebugContent');
          if (kingDebugEl && kingDebugContentEl) {
            const kingEnabled = document.getElementById('kingEnabled')?.checked;
            if (kingEnabled) {
              // è·å–ç‹ä¹‹å¬å”¤ç›¸å…³å‚æ•°
              const currentLevel = $('levelSelect')?.value || 'Ex61';
              const triggerCount = parseInt($('trigK')?.value) || 4; // ç‹ä¹‹å¬å”¤å®é™…è§¦å‘æ¬¡æ•°
              
              // è·å–è¯¥å…³å¡çš„ç‹ä¹‹å¬å”¤ç•ªæ•°å’Œæ•°å€¼è®¾ç½®ä¸­çš„èƒ¡ç‰Œç•ªæ•°
              const all = computeRecommendedAll();
              const levelData = all[currentLevel];
              const currentKingFan = levelData?.actualK || 1; // è·å–è¯¥å…³å¡çš„ç‹ä¹‹å¬å”¤ç•ªæ•°
              const winCountFromSettings = parseFloat($('finalMulInput')?.value) || 1; // æ•°å€¼è®¾ç½®ä¸­çš„èƒ¡ç‰Œç•ªæ•°
              
              // ä½¿ç”¨ç»Ÿä¸€çš„ç‹ä¹‹å¬å”¤ä¹˜æ•°è®¡ç®—å‡½æ•°
              const kingMultiplier = calculateKingCallMultiplier(currentKingFan, triggerCount, winCountFromSettings);
              
              // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
              kingDebugContentEl.innerHTML = `
                <div><strong>å…³å¡:</strong> ${currentLevel}</div>
                <div><strong>å½“å‰å…³å¡ç‹ä¹‹å¬å”¤ç•ªæ•°:</strong> ${currentKingFan}</div>
                <div><strong>ç‹ä¹‹å¬å”¤å®é™…è§¦å‘æ¬¡æ•°:</strong> ${triggerCount}</div>
                <div><strong>æ•°å€¼è®¾ç½®ä¸­çš„èƒ¡ç‰Œç•ªæ•°:</strong> ${winCountFromSettings}</div>
                <div><strong>ç‹ä¹‹å¬å”¤ä¹˜æ•°:</strong> ${kingMultiplier.toExponential(2)}</div>
                <div><strong>æ€»åˆ†æ•°:</strong> ${data.totalScore ? formatChinaJiLocal(data.totalScore, prec) : '-'}</div>
              `;
              kingDebugEl.style.display = 'block';
            } else {
              kingDebugEl.style.display = 'none';
            }
          */
            
            // æ˜¾ç¤ºè¯¦ç»†è®¡ç®—æ­¥éª¤è°ƒè¯•ä¿¡æ¯
            /*
            const detailedDebugEl = document.getElementById('detailedCalculationDebug');
            const detailedDebugContentEl = document.getElementById('detailedDebugContent');
            if (detailedDebugEl && detailedDebugContentEl) {
              // è·å–å½“å‰å…³å¡æ•°æ®
              const currentLevel = $('levelSelect')?.value || 'Ex61';
              const all = computeRecommendedAll();
              const levelData = all[currentLevel];
              
              // è·å–å„ç§å‚æ•°
              const baseScore = parseFloat($('baseScore')?.value) || 0;
              const finalMultiplier = parseFloat($('finalMulInput')?.value) || 1;
              const trigD = parseInt($('trigD')?.value) || 0;
              const trigF = parseInt($('trigF')?.value) || 0;
              const trigY = parseInt($('trigY')?.value) || 0;
              const trigK = parseInt($('trigK')?.value) || 0;
              
              // è®¡ç®—å„ç§ä¹˜æ•°ï¼ˆå½“ç•ªæ•°ä¸º0æ—¶å¿½ç•¥è¯¥æŠ¤èº«ç¬¦ï¼‰
              const daoyinMultiplier = (trigD === 0 || levelData.actualD === 0) ? 1 : Math.pow(levelData.actualD, trigD);
              const fuzhongMultiplier = (trigF === 0 || levelData.actualF === 0) ? 1 : Math.pow(levelData.actualF, trigF);
              const yueguangMultiplier = (trigY === 0 || levelData.actualY === 0) ? 1 : Math.pow(levelData.actualY, trigY);
              
              // ç‹ä¹‹å¬å”¤ä¹˜æ•°ï¼ˆå½“ç‹ä¹‹å¬å”¤ç•ªæ•°ä¸º0æ—¶å¿½ç•¥ï¼‰
              let kingMultiplier = 1;
              const kingEnabled = document.getElementById('kingEnabled')?.checked;
              if (kingEnabled && levelData.actualK && levelData.actualKH && levelData.actualK !== 0) {
                const currentKingFan = levelData.actualK;
                const winCountFromSettings = parseFloat($('finalMulInput').value) || 1;
                // ä½¿ç”¨ç»Ÿä¸€çš„ç‹ä¹‹å¬å”¤ä¹˜æ•°è®¡ç®—å‡½æ•°
                kingMultiplier = calculateKingCallMultiplier(currentKingFan, trigK, winCountFromSettings);
              }
              
                // è®¡ç®—æœ€ç»ˆæ€»åˆ†
                let actualFinalMultiplier = finalMultiplier;
                if (kingEnabled && kingMultiplier > 1) {
                  // ç‹ä¹‹å¬å”¤å¼€å¯æ—¶ï¼Œä½¿ç”¨ç‹ä¹‹å¬å”¤ä¹˜æ•°æ›¿æ¢èƒ¡ç‰Œç•ªæ•°
                  actualFinalMultiplier = kingMultiplier;
                }
                const totalScore = baseScore * actualFinalMultiplier * daoyinMultiplier * fuzhongMultiplier * yueguangMultiplier;
              
              // æ˜¾ç¤ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ˆæ”¹è¿›æ•°å€¼æ ¼å¼åŒ–ï¼‰
              const formatValue = (value) => {
                if (!isFinite(value) || value === Infinity || value === -Infinity) {
                  return 'Infinity';
                }
                // å¯¹äºæ‰€æœ‰æ•°å€¼ï¼Œéƒ½å°è¯•ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤ºï¼Œé¿å…æ•°å€¼è¿‡å¤§
                if (value > 1e6) {
                  return value.toExponential(2);
                }
                return value.toString();
              };
              
              // ä¸“é—¨ç”¨äºæ˜¾ç¤ºæœ€ç»ˆæ€»åˆ†çš„æ ¼å¼åŒ–å‡½æ•°
              const formatTotalScore = (value) => {
                if (!isFinite(value) || value === Infinity || value === -Infinity) {
                  return 'Infinity';
                }
                // å¯¹äºæ€»åˆ†ï¼Œå¦‚æœæ•°å€¼è¿‡å¤§ï¼Œä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º
                if (value > 1e100) {
                  return value.toExponential(2);
                }
                // å¦åˆ™ç›´æ¥æ˜¾ç¤ºæ•°å€¼ï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨å¤„ç†
                return value.toString();
              };
              
              detailedDebugContentEl.innerHTML = `
                <div><strong>å…³å¡:</strong> ${currentLevel}</div>
                <div><strong>åŸºç¡€å‚æ•°:</strong></div>
                <div style="margin-left:10px;">å°åˆ†åˆ†å€¼: ${formatValue(baseScore)}</div>
                ${kingEnabled && kingMultiplier > 1 ? 
                  `<div style="margin-left:10px;">åŸå§‹èƒ¡ç‰Œç•ªæ•°: ${formatValue(finalMultiplier)}</div>
                   <div style="margin-left:10px;">ç‹ä¹‹å¬å”¤æ›¿æ¢å: ${formatValue(kingMultiplier)}</div>` :
                  `<div style="margin-left:10px;">èƒ¡ç‰Œç•ªæ•°: ${formatValue(finalMultiplier)}</div>`
                }
                <div><strong>å„ç±»ç•ªæ•°:</strong></div>
                <div style="margin-left:10px;">ç›—å°ç•ªæ•°: ${formatValue(levelData.actualD)} (è§¦å‘${trigD}æ¬¡)</div>
                <div style="margin-left:10px;">è´Ÿé‡ç•ªæ•°: ${formatValue(levelData.actualF)} (è§¦å‘${trigF}æ¬¡)</div>
                <div style="margin-left:10px;">æœˆå…‰ç•ªæ•°: ${formatValue(levelData.actualY)} (è§¦å‘${trigY}æ¬¡)</div>
                ${kingEnabled ? `<div style="margin-left:10px;">ç‹ä¹‹å¬å”¤ç•ªæ•°: ${formatValue(levelData.actualK)} (è§¦å‘${trigK}æ¬¡)</div>` : ''}
                <div><strong>å„ä¹˜æ•°è®¡ç®—:</strong></div>
                <div style="margin-left:10px;">ç›—å°ä¹˜æ•°: ${formatValue(levelData.actualD)}^${trigD} = ${formatValue(daoyinMultiplier)}</div>
                <div style="margin-left:10px;">è´Ÿé‡ä¹˜æ•°: ${formatValue(levelData.actualF)}^${trigF} = ${formatValue(fuzhongMultiplier)}</div>
                <div style="margin-left:10px;">æœˆå…‰ä¹˜æ•°: ${formatValue(levelData.actualY)}^${trigY} = ${formatValue(yueguangMultiplier)}</div>
                ${kingEnabled ? `<div style="margin-left:10px;">ç‹ä¹‹å¬å”¤ä¹˜æ•°: ${formatValue(kingMultiplier)}</div>` : ''}
                <div><strong>æœ€ç»ˆè®¡ç®—:</strong></div>
                <div style="margin-left:10px;">æ€»åˆ† = ${formatValue(baseScore)} Ã— ${formatValue(actualFinalMultiplier)} Ã— ${formatValue(daoyinMultiplier)} Ã— ${formatValue(fuzhongMultiplier)} Ã— ${formatValue(yueguangMultiplier)}</div>
                <div style="margin-left:10px;">å‰ç«¯è®¡ç®—æ€»åˆ† = ${formatTotalScore(totalScore)}</div>
                <div style="margin-left:10px;">åç«¯è¿”å›æ€»åˆ† = ${data.totalScore || '-'}</div>
                <div style="margin-left:10px;">åç«¯è¿”å›æ€»åˆ†ä¸­æ–‡ = ${data.totalScore ? formatChinaJiLocal(data.totalScore, getCurrentPrecision()) : '-'}</div>
              `;
              detailedDebugEl.style.display = 'block';
            } else {
              detailedDebugEl.style.display = 'none';
            }
            */
          
          const localStatus = compareStatusBySci(data.totalScore, payload.levelConfig?.targetScore);
          setStatus(localStatus || data.status || 'å®Œæˆ');
        } catch (err) {
          $('resTotalSci').textContent = '-';
          $('resTotalCn').textContent = '-';
          $('resTheoSci').textContent = '-';
          $('resTheoCn').textContent = '-';
          $('resTargetSci').textContent = '-';
          $('resTargetCn').textContent = '-';
          $('bdD').textContent = String(err);
          $('bdF').textContent = '';
          $('bdY').textContent = '';
          setStatus('under');
        }
      }

      $('btn').addEventListener('click', async () => computeWithForm());

      // å¢é•¿ç±»å‹é€‰æ‹©åŠŸèƒ½å·²ç§»é™¤ï¼Œä¸å†éœ€è¦æŒ‰é’®å¼å•é€‰ç»‘å®š

      // å¢é•¿åŒºé—´ï¼ˆæ¯5å…³ï¼‰ç¼–è¾‘å™¨
      const ivData = {}; // key -> { dType, fType, yType } - ä¿ç•™ç»™æ¯é¡µ5é¡¹ä½¿ç”¨

      // å…³å¡ç›®æ ‡åˆ†æ•°æ®ï¼ˆä½ æä¾›çš„ JSONï¼‰
      const LEVEL_TARGETS = {
        "1-1": "200","1-2": "400","1-3": "800","2-1": "1000","2-2": "1500","2-3": "2100","3-1": "3000","3-2": "4000","3-3": "5200","4-1": "7000","4-2": "9800","4-3": "15000","5-1": "22500","5-2": "33300","5-3": "50000","Ex1": "1000000","Ex2": "12000000","Ex3": "90750000","Ex4": "8.11äº¿","Ex5": "84.28äº¿","Ex6": "1003.54äº¿","Ex7": "1.35å…†","Ex8": "20.56å…†","Ex9": "348.31å…†","Ex10": "6542.41å…†","Ex11": "13.55äº¬","Ex12": "308.54äº¬","Ex13": "7681.69äº¬","Ex14": "20.84å“","Ex15": "664.10å“","Ex16": "2.46ç§­","Ex17": "105.10ç§­","Ex18": "5154.00ç§­","Ex19": "28.82ç©°","Ex20": "1830.00ç©°","Ex21": "13.14æ²Ÿ","Ex22": "1066.00æ²Ÿ","Ex23": "9.72æ¶§","Ex24": "994.10æ¶§","Ex25": "11.38æ­£","Ex26": "1456.00æ­£","Ex27": "20.79è½½","Ex28": "3306.0è½½","Ex29": "58.49æ","Ex30": "1.25ä¸‡æ","Ex31": "300.70ä¸‡æ","Ex32": "8.71äº¿æ","Ex33": "2792.00äº¿æ","Ex34": "108.20å…†æ","Ex35": "4.63äº¬æ","Ex36": "2398.00äº¬æ","Ex37": "136.90å“æ","Ex38": "9.41ç§­æ","Ex39": "7147.00ç§­æ","Ex40": "708.60ç©°æ","Ex41": "91.69æ²Ÿæ","Ex42": "15.46æ¶§æ","Ex43": "3.40æ­£æ","Ex44": "9734.00æ­£æ","Ex45": "3627.00è½½æ","Ex46": "1759.00ææ","Ex47": "1109.00ä¸‡ææ","Ex48": "910.80äº¿ææ","Ex49": "972.20å…†ææ","Ex50": "1349.00äº¬ææ","Ex51": "2811.00å“ææ","Ex52": "8787.00ç§­ææ","Ex53": "4.12æ²Ÿææ","Ex54": "28.99æ¶§ææ","Ex55": "306.00æ­£ææ","Ex56": "4844.00è½½ææ","Ex57": "11.5ä¸‡æææ","Ex58": "409.9äº¿æææ","Ex59": "2.19äº¬æææ","Ex60": "175.50å“æææ","Ex61": "2.11ç©°æææ","Ex62": "380.79æ²Ÿæææ","Ex63": "10.30æ­£æææ","Ex64": "4180.00è½½æææ","Ex65": "254.4ä¸‡ææææ","Ex66": "23.23å…†ææææ","Ex67": "3.18å“ææææ","Ex68": "6538.00ç§­ææææ","Ex69": "2015.00æ²Ÿææææ","Ex70": "931.40æ­£ææææ","Ex71": "645.80æææææ","Ex72": "671.70äº¿æææææ","Ex73": "1047.00äº¬æææææ","Ex74": "2452.00ç§­æææææ","Ex75": "8608.00æ²Ÿæææææ","Ex76": "4.53è½½æææææ","Ex77": "35.79ä¸‡ææææææ","Ex78": "424.00å…†ææææææ","Ex79": "5.70E+310","Ex80": "5.70E+318","Ex81": "5.70E+326","Ex82": "5.70E+334","Ex83": "5.70E+342","Ex84": "5.70E+350","Ex85": "5.70E+359","Ex86": "5.70E+368","Ex87": "5.70E+377","Ex88": "5.70E+386","Ex89": "5.70E+395","Ex90": "5.70E+405","Ex91": "5.70E+415","Ex92": "5.70E+425","Ex93": "5.70E+435","Ex94": "5.70E+445","Ex95": "5.70E+455","Ex96": "5.70E+466","Ex97": "5.70E+477","Ex98": "5.70E+488","Ex99": "5.70E+499","Ex100": "9.99E+510","Ex101": "9.99E+522","Ex102": "9.99E+534","Ex103": "9.99E+546","Ex104": "9.99E+558","Ex105": "9.99E+571","Ex106": "9.99E+584","Ex107": "9.99E+597","Ex108": "9.99E+611","Ex109": "9.99E+625","Ex110": "9.99E+639","Ex111": "9.99E+654","Ex112": "9.99E+669","Ex113": "9.99E+684","Ex114": "9.99E+699","Ex115": "9.99E+715","Ex116": "9.99E+731","Ex117": "9.99E+748","Ex118": "9.99E+765","Ex119": "9.99E+783","Ex120": "9.99E+801"
      };

      // åˆ†é¡µå±•ç¤º + å¢é•¿/æ²¿ç”¨/æ‰‹å¡« + å…³å¡é€‰æ‹©å¡«å……
      const PAGE_SIZE = 10;
      const entries = Object.entries(LEVEL_TARGETS);
      const keyOrder = entries.map(([k]) => k);
      // å›æº¯æŸå…³çš„ç”Ÿæ•ˆç±»å‹ï¼šè‹¥å½“å‰å…³æœªæ˜¾å¼è®¾ç½®ï¼Œå›æº¯åˆ°æœ€è¿‘ä¸€æ¬¡è®¾ç½®ï¼›å†æ²¡æœ‰åˆ™ç”¨å…¨å±€é€‰æ‹©
      function resolveTypeAtIndex(kind, idx){
        let cur = kind==='d' ? growthChoice.daoyin : kind==='f' ? growthChoice.fuzhong : growthChoice.yueguang;
        for (let i=0;i<=idx;i++){
          const k = keyOrder[i];
          const row = ivData[k];
          if (!row) continue;
          if (kind==='d' && row.dType) cur = row.dType;
          if (kind==='f' && row.fType) cur = row.fType;
          if (kind==='y' && row.yType) cur = row.yType;
        }
        return cur;
      }
      const levelsState = {}; // key -> { lockD, lockF, lockY, lockK, manuD, manuF, manuY, manuK, manuKH }

      const GROWTH = {
        daoyin: {
          'æ™®é€šç›—å°': Math.pow(1.3, 1),
          'å¤©ä½¿ç›—å°': 1.6,
          'è†¨èƒ€ç›—å°': Math.pow(1.3, 2),
          'è†¨èƒ€ç›—å°åƒå¡ç»´': Math.pow(1.3, 4),
        },
        fuzhong: {
          'æ™®é€šè´Ÿé‡': Math.pow(1.5, 1),
          'å¤©ä½¿è´Ÿé‡': 2.0,
          'è†¨èƒ€è´Ÿé‡': Math.pow(1.5, 2),
        },
        yueguang: {
          'æ™®é€šæœˆå…‰': Math.pow(1.5, 1),
          'å¤©ä½¿æœˆå…‰': 2.0,
          'è†¨èƒ€æœˆå…‰': Math.pow(1.5, 2),
        }
      };

      let growthChoice = { daoyin: 'æ™®é€šç›—å°', fuzhong: 'æ™®é€šè´Ÿé‡', yueguang: 'æ™®é€šæœˆå…‰' };

      // ç»Ÿä¸€çš„ç‹ä¹‹å¬å”¤ä¹˜æ•°è®¡ç®—å‡½æ•°
      function calculateKingCallMultiplier(currentKingFan, triggerCount, winCountFromSettings) {
        if (!currentKingFan || !triggerCount) return 1;
        
        // è®¡ç®—EffectiveFan = 14 Ã— å½“å‰å…³å¡çš„ç‹ä¹‹å¬å”¤ç•ªæ•°
        const effectiveFan = 14 * currentKingFan;
        
        // è®¡ç®—FinalFan = (EffectiveFan + 10 + æ•°å€¼è®¾ç½®ä¸­çš„èƒ¡ç‰Œç•ªæ•°)
        const finalFan = effectiveFan + 10 + winCountFromSettings;
        
        // æœ€ç»ˆè¿ä¹˜ï¼šFinalFan Ã— (å½“å‰ç‹ä¹‹å¬å”¤ç•ªæ•°+1) Ã— (å½“å‰ç‹ä¹‹å¬å”¤ç•ªæ•°+2) Ã— ... Ã— (å½“å‰ç‹ä¹‹å¬å”¤ç•ªæ•°+è§¦å‘æ¬¡æ•°)
        let kingMultiplier = finalFan;
        for (let k = currentKingFan + 1; k <= currentKingFan + triggerCount; k++) {
          kingMultiplier *= k;
        }
        
        return kingMultiplier;
      }

      function computeRecommendedAll() {
        const result = {};
        let prev = { d: 1, f: 1, y: 1, k: 1 }; // æ·»åŠ ç‹ä¹‹å¬å”¤åˆå§‹ç•ªæ•°
        
        // å¦‚æœæ˜¯ä»å­˜æ¡£åŠ è½½ï¼Œå°è¯•ä»levelsStateä¸­æ¢å¤prev.kçš„åˆå§‹å€¼
        const firstEx61Index = keyOrder.indexOf('Ex61');
        if (firstEx61Index > 0) {
          // æ£€æŸ¥Ex61ä¹‹å‰æ˜¯å¦æœ‰ç‹ä¹‹å¬å”¤æ•°æ®
          for (let i = 0; i < firstEx61Index; i++) {
            const key = keyOrder[i];
            const st = levelsState[key] || {};
            if (st.recK !== undefined && st.recK !== null) {
              prev.k = st.recK;
              break;
            }
          }
        }
        
        const uD = $('unlockD').value; const uF = $('unlockF').value; const uY = $('unlockY').value;
        const idxD = keyOrder.indexOf(uD); const idxF = keyOrder.indexOf(uF); const idxY = keyOrder.indexOf(uY);

        // ç‹ä¹‹å¬å”¤ï¼šæ”¯æŒæ‰‹åŠ¨ä»ä»»æ„å…³å¡å¼€å§‹çº§è”
        const ex61Index = keyOrder.indexOf('Ex61');
        let manualKStartIndex = -1;
        let manualKStartValue = null;
        for (let i = 0; i < keyOrder.length; i++) {
          const key = keyOrder[i];
          const st = levelsState[key] || {};
          const parsedK = parseManualToNumber(st.manuK);
          if (parsedK != null && parsedK > 0) {
            manualKStartIndex = i;
            manualKStartValue = parsedK;
            break;
          }
        }
        
        for (let i = 0; i < keyOrder.length; i++) {
          const key = keyOrder[i];
          const st = levelsState[key] || {};
          const ivRow = ivData[key] || {};
          
          // ä¼˜å…ˆä½¿ç”¨ ivData ä¸­çš„å¢é•¿ç±»å‹ï¼Œå¦åˆ™ä½¿ç”¨å…¨å±€é»˜è®¤
          const dType = ivRow.dType || growthChoice.daoyin;
          const fType = ivRow.fType || growthChoice.fuzhong;
          const yType = ivRow.yType || growthChoice.yueguang;
          
          const gd = GROWTH.daoyin[dType] || 1.3;
          const gf = GROWTH.fuzhong[fType] || 1.5;
          const gy = GROWTH.yueguang[yType] || 1.5;

          // è®¡ç®—è§£é”ä¸æˆé•¿ï¼šè§£é”å…³ä¸º 1 ç•ªï¼›è§£é”åä¸‹ä¸€å…³å¼€å§‹æˆé•¿
          const recD = (i === idxD) ? 1 : (i < idxD || idxD<0) ? 0 : (st.lockD ? prev.d : prev.d * gd);
          const recF = (i === idxF) ? 1 : (i < idxF || idxF<0) ? 0 : (st.lockF ? prev.f : prev.f * gf);
          const recY = (i === idxY) ? 1 : (i < idxY || idxY<0) ? 0 : (st.lockY ? prev.y : prev.y * gy);

          // ç‹ä¹‹å¬å”¤è®¡ç®—é€»è¾‘ï¼ˆæ”¯æŒæ‰‹åŠ¨èµ·å§‹çº§è”ï¼‰
          let recK = 0; // é»˜è®¤ 0
          const kStartIndex = (manualKStartIndex !== -1) ? manualKStartIndex : ex61Index;
          if (kStartIndex >= 0) {
            if (i < kStartIndex) {
              recK = 0;
            } else if (i === kStartIndex) {
              recK = (manualKStartIndex !== -1) ? manualKStartValue : 1; // æ‰‹åŠ¨èµ·å§‹ç”¨æ‰‹åŠ¨å€¼ï¼Œå¦åˆ™ Ex61 é»˜è®¤ 1
            } else {
              recK = prev.k; // ä¹‹åä½¿ç”¨ä¸Šä¸€å…³çš„å®é™…ç•ªæ•°ä½œä¸ºåŸºç¡€
            }
          }
          
          // å¦‚æœæ‰‹åŠ¨è®¾ç½®äº†ç•ªæ•°ï¼ŒrecKä¿æŒä¸å˜ï¼ŒactualKä¼šä½¿ç”¨æ‰‹åŠ¨è®¾ç½®çš„å€¼

          const actualD = st.manuD ? parseFloat(st.manuD) : recD;
          const actualF = st.manuF ? parseFloat(st.manuF) : recF;
          const actualY = st.manuY ? parseFloat(st.manuY) : recY;
          const actualK = st.manuK ? parseFloat(st.manuK) : recK;
          const actualKH = st.manuKH ? parseInt(st.manuKH) : (st.recKH || 1); // èƒ¡ç‰Œæ¬¡æ•°ï¼Œä¼˜å…ˆä½¿ç”¨recKHï¼Œé»˜è®¤1
          
          // ç¡®ä¿æ¨èå€¼è¢«ä¿å­˜åˆ°levelsStateä¸­ï¼ˆç”¨äºå†å²æ•°æ®ä¿å­˜ï¼‰
          if (st.manuK === undefined && recK !== 0) {
            levelsState[key] = levelsState[key] || {};
            levelsState[key].recK = recK; // ä¿å­˜æ¨èå€¼
          }
          if (st.manuKH === undefined) {
            levelsState[key] = levelsState[key] || {};
            levelsState[key].recKH = actualKH; // ä¿å­˜æ¨èèƒ¡ç‰Œæ¬¡æ•°
          }

          // è®¡ç®—ä¸‹ä¸€å…³çš„ç‹ä¹‹å¬å”¤ç•ªæ•°ï¼šå½“å‰ç•ªæ•° +ï¼ˆè§¦å‘æ¬¡æ•° Ã— èƒ¡ç‰Œæ¬¡æ•°ï¼‰
          const triggerCount = parseInt($('trigK').value) || 4; // ä½¿ç”¨ç‹ä¹‹å¬å”¤ä¸“ç”¨çš„è§¦å‘æ¬¡æ•°ï¼Œé»˜è®¤4æ¬¡
          const nextK = actualK + (triggerCount * actualKH);

          result[key] = { 
            recD, recF, recY, recK,
            actualD, actualF, actualY, actualK, actualKH,
            nextK // ä¸‹ä¸€å…³çš„ç‹ä¹‹å¬å”¤ç•ªæ•°
          };
          prev = { d: actualD, f: actualF, y: actualY, k: nextK };
        }
        return result;
      }

  // ===== å­˜å‚¨/è¯»å– æ¯å…³ç•ªæ•°ä¸å¢é•¿ç±»å‹ =====
  // å…¨å±€ Alert æ ˆä¸å·¥å…·
  function ensureAlertStack(){
    let s = document.getElementById('alertStack');
    if (!s){
      s = document.createElement('div');
      s.id = 'alertStack';
      s.className = 'alert-stack';
      document.body.appendChild(s);
    }
    return s;
  }
  function showAlert(kind, text){
    const s = ensureAlertStack();
    const el = document.createElement('div');
    el.className = 'alert ' + (kind||'');
    el.innerHTML = `<span>${text}</span><button class="close">Ã—</button>`;
    el.querySelector('.close').addEventListener('click', ()=> el.remove());
    s.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 3000);
  }
  const STORAGE_KEY = 'qyzz_level_data_v1'; // å•æ§½æ—§é”®ï¼Œä¿ç•™å…¼å®¹
  const STORAGE_KEYS_MULTI = 'qyzz_level_data_multi_v1'; // å¤šæ§½ç®¡ç†
  const STORAGE_MULTI_KEY = 'qyzz_level_data_multi_v1';
  function snapshotLevelData(){
    const all = computeRecommendedAll();
    const data = { 
      levels: {}, 
      growthDefault: growthChoice,
      kingSummon: {
        enabled: document.getElementById('kingEnabled')?.checked || false,
        actualTriggers: parseInt($('trigK')?.value) || 4,
        maxTriggers: parseInt($('maxTrigK')?.value) || 4
      }
    };
    for (const key of keyOrder){
      const st = levelsState[key] || {};
      const ivRow = ivData[key] || {};
      const a = all[key] || {};
      data.levels[key] = {
        manuD: st.manuD ?? null,
        manuF: st.manuF ?? null,
        manuY: st.manuY ?? null,
        manuK: st.manuK ?? null,
        manuKH: st.manuKH ?? null,
        recK: st.recK ?? null,
        recKH: st.recKH ?? null,
        lockD: !!st.lockD,
        lockF: !!st.lockF,
        lockY: !!st.lockY,
        lockK: !!st.lockK,
        dType: ivRow.dType || null,
        fType: ivRow.fType || null,
        yType: ivRow.yType || null,
        recD: a.recD ?? null,
        recF: a.recF ?? null,
        recY: a.recY ?? null,
        recK: a.recK ?? null,
        actualD: a.actualD ?? null,
        actualF: a.actualF ?? null,
        actualY: a.actualY ?? null,
        actualK: a.actualK ?? null,
        actualKH: a.actualKH ?? null,
      };
    }
    return data;
  }

  function saveCurrentLevelData(){
    try{
      const data = snapshotLevelData();
      // å†™å…¥å¤šæ§½ï¼šéœ€è¦åç§°
      const name = (document.getElementById('historyName')?.value || '').trim();
      if (!name){ showAlert('alert-warn','è¯·è¾“å…¥åç§°'); return; }
      const multiRaw = localStorage.getItem(STORAGE_KEYS_MULTI);
      const multi = multiRaw ? JSON.parse(multiRaw) : {};
      multi[name] = { t: Date.now(), data };
      localStorage.setItem(STORAGE_KEYS_MULTI, JSON.stringify(multi));
      populateHistorySelect();
      const sel = document.getElementById('historySelect'); if (sel) sel.value = name;
      showAlert('alert-ok','å·²ä¿å­˜ï¼š' + name);
    }catch(e){
      console.error('ä¿å­˜å¤±è´¥', e);
      showAlert('alert-danger','ä¿å­˜å¤±è´¥');
    }
  }

  function loadHistoryLevelData(){
    try{
      const sel = document.getElementById('historySelect');
      const key = sel ? sel.value : '';
      const multiRaw = localStorage.getItem(STORAGE_KEYS_MULTI);
      const multi = multiRaw ? JSON.parse(multiRaw) : {};
      const obj = multi[key];
      const data = obj && obj.data;
      if(!data || !data.levels){ showAlert('alert-danger','å†å²æ•°æ®æ ¼å¼ä¸æ­£ç¡®'); return; }
      // æ¢å¤é»˜è®¤å¢é•¿é€‰æ‹©
      if (data.growthDefault){
        growthChoice = { ...growthChoice, ...data.growthDefault };
      }
      
      // æ¢å¤ç‹ä¹‹å¬å”¤è®¾ç½®
      if (data.kingSummon) {
        const kingEnabled = document.getElementById('kingEnabled');
        if (kingEnabled) {
          kingEnabled.checked = data.kingSummon.enabled || false;
          // è§¦å‘ç‹ä¹‹å¬å”¤å¼€å…³äº‹ä»¶ï¼Œæ˜¾ç¤º/éšè—ç›¸å…³UI
          kingEnabled.dispatchEvent(new Event('change'));
        }
        const trigKInput = document.getElementById('trigK');
        if (trigKInput) {
          trigKInput.value = data.kingSummon.actualTriggers || 4;
        }
        const maxTrigKInput = document.getElementById('maxTrigK');
        if (maxTrigKInput) {
          maxTrigKInput.value = data.kingSummon.maxTriggers || 4;
        }
      }
      // æ¢å¤ per-level çŠ¶æ€ä¸å¢é•¿ç±»å‹
      for (const key of Object.keys(data.levels)){
        const v = data.levels[key] || {};
        levelsState[key] = levelsState[key] || {};
        ivData[key] = ivData[key] || {};
        // æ¢å¤æ‰‹åŠ¨/æ²¿ç”¨
        levelsState[key].manuD = v.manuD ?? null;
        levelsState[key].manuF = v.manuF ?? null;
        levelsState[key].manuY = v.manuY ?? null;
        levelsState[key].manuK = v.manuK ?? null;
        levelsState[key].manuKH = v.manuKH ?? null;
        levelsState[key].recK = v.recK ?? null;
        levelsState[key].recKH = v.recKH ?? null;
        levelsState[key].lockD = !!v.lockD;
        levelsState[key].lockF = !!v.lockF;
        levelsState[key].lockY = !!v.lockY;
        levelsState[key].lockK = !!v.lockK;
        // æ¢å¤å¢é•¿ç±»å‹
        if (v.dType) ivData[key].dType = v.dType;
        if (v.fType) ivData[key].fType = v.fType;
        if (v.yType) ivData[key].yType = v.yType;
      }
      renderPage5();
      showAlert('alert-ok','å·²è¯»å–ï¼š' + key);
    }catch(e){
      console.error('è¯»å–å¤±è´¥', e);
      showAlert('alert-danger','è¯»å–å¤±è´¥');
    }
  }

  function deleteHistory(){
    const sel = document.getElementById('historySelect');
    const key = sel ? sel.value : '';
    if (!key){ showAlert('alert-warn','è¯·é€‰æ‹©è¦åˆ é™¤çš„é…ç½®'); return; }
    if (!confirm(`ç¡®è®¤åˆ é™¤å†å²é…ç½®â€œ${key}â€å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
    try{
      const multiRaw = localStorage.getItem(STORAGE_KEYS_MULTI);
      const multi = multiRaw ? JSON.parse(multiRaw) : {};
      delete multi[key];
      localStorage.setItem(STORAGE_KEYS_MULTI, JSON.stringify(multi));
      populateHistorySelect();
      showAlert('alert-ok','å·²åˆ é™¤ï¼š' + key);
    }catch(e){
      console.error('åˆ é™¤å¤±è´¥', e);
      showAlert('alert-danger','åˆ é™¤å¤±è´¥');
    }
  }

  function populateHistorySelect(){
    const sel = document.getElementById('historySelect');
    if (!sel) return;
    const multiRaw = localStorage.getItem(STORAGE_KEYS_MULTI);
    const multi = multiRaw ? JSON.parse(multiRaw) : {};
    const current = sel.value;
    sel.innerHTML = '<option value="">é€‰æ‹©å†å²é…ç½®</option>' +
      Object.keys(multi).sort().map(k=>`<option value="${k}">${k}</option>`).join('');
    if (current && multi[current]) sel.value = current;
  }

  // ===== å¤šä»½å†å²é…ç½® =====
  function readAllSlots(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_MULTI_KEY)||'{}'); }catch{ return {}; }
  }
  function writeAllSlots(obj){
    localStorage.setItem(STORAGE_MULTI_KEY, JSON.stringify(obj));
  }
  function refreshHistorySelect(){
    const sel = document.getElementById('historySelect');
    if (!sel) return;
    const all = readAllSlots();
    const current = sel.value;
    sel.innerHTML = '<option value="">é€‰æ‹©å†å²é…ç½®</option>' + Object.keys(all).map(k=>`<option value="${k}">${k}</option>`).join('');
    if (current && all[current]) sel.value = current;
  }
  function saveNamedSlot(){
    const name = (document.getElementById('historyName')?.value||'').trim();
    if (!name){ alert('è¯·è¾“å…¥åç§°'); return; }
    const all = readAllSlots();
    all[name] = { t: Date.now(), data: snapshotLevelData() };
    writeAllSlots(all);
    refreshHistorySelect();
    alert('å·²å‘½åä¿å­˜');
  }
  function loadNamedSlot(){
    const sel = document.getElementById('historySelect');
    const key = sel?.value||'';
    if (!key){ return; }
    const all = readAllSlots();
    const slot = all[key];
    if (!slot){ alert('æœªæ‰¾åˆ°è¯¥é…ç½®'); return; }
    const obj = slot.data;
    if (!obj || !obj.levels){ alert('å†å²æ•°æ®æ ¼å¼ä¸æ­£ç¡®'); return; }
    // å¤ç”¨å•æ§½åŠ è½½é€»è¾‘
    const data = { data: obj };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    loadHistoryLevelData();
  }
  function deleteNamedSlot(){
    const sel = document.getElementById('historySelect');
    const key = sel?.value||'';
    if (!key){ alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„é…ç½®'); return; }
    const all = readAllSlots();
    if (!all[key]){ alert('æœªæ‰¾åˆ°è¯¥é…ç½®'); return; }
    delete all[key];
    writeAllSlots(all);
    refreshHistorySelect();
    alert('å·²åˆ é™¤é…ç½®');
  }

      // renderPageå‡½æ•°å·²åˆ é™¤ï¼Œå› ä¸º"æ¯é¡µ10é¡¹"åŒºå—å·²è¢«ç§»é™¤
      function renderAll(){ /* ä¸å†éœ€è¦ */ }
      // è§£é”å…³å¡ä¸‹æ‹‰å¡«å……
      function fillUnlockSelects(){
        // ä»…æä¾› 1-1 ~ Ex10 çš„å…³å¡ä¾›é€‰æ‹©
        const ex10Idx = keyOrder.indexOf('Ex10');
        const allowKeys = ex10Idx >= 0 ? keyOrder.slice(0, ex10Idx + 1) : keyOrder;
        const opts = allowKeys.map(k=>`<option value="${k}">${k}</option>`).join('');
        $('unlockD').innerHTML = opts;
        $('unlockF').innerHTML = opts;
        $('unlockY').innerHTML = opts;
        // é»˜è®¤å€¼ï¼šç›—å°3-1ã€è´Ÿé‡4-2ã€æœˆå…‰3-3 è‹¥å­˜åœ¨ï¼Œå¦åˆ™ç½®ä¸ºé¦–å…³
        const fallback = keyOrder[0];
        const setIfExists = (elId, key)=>{ const el=$(elId); el.value = keyOrder.includes(key)? key : fallback; };
        setIfExists('unlockD','1-1'); setIfExists('unlockF','1-2'); setIfExists('unlockY','1-3');
      }
      fillUnlockSelects();
      // ç¡®è®¤èµ·å§‹å…³åï¼Œåˆ·æ–°å³ä¾§è”åŠ¨
      document.getElementById('unlockApply').addEventListener('click', ()=>{
        renderPage5();
      });

      // å…³å¡ä¸‹æ‹‰
      const sel = $('levelSelect');
      sel.innerHTML = keyOrder.map(k => `<option value="${k}">${k}</option>`).join('');
      sel.addEventListener('change', () => {
        const k = sel.value;
        $('targetScore').value = LEVEL_TARGETS[k];
        
        // è”åŠ¨è¯»å–å…³å¡ç›®æ ‡åˆ†æ¨¡å—çš„ç•ªæ•°å¹¶å¡«å……åˆ°æ•°å€¼è®¾ç½®æ¨¡å—
        const all = computeRecommendedAll();
        const levelData = all[k];
        if (levelData) {
          $('daoyin').value = `${(levelData.actualD || 0).toFixed(6)}`;
          $('fuzhong').value = `${(levelData.actualF || 0).toFixed(6)}`;
          $('yueguang').value = `${(levelData.actualY || 0).toFixed(6)}`;
          // åŒæ­¥åˆ·æ–°å³ä¸‹è§’æ ¼å¼æ˜¾ç¤º
          updateStampDisplay();
        }
      });
      $('prevLevel').addEventListener('click', ()=>{ const idx=keyOrder.indexOf(sel.value); if(idx>0){ sel.value=keyOrder[idx-1]; sel.dispatchEvent(new Event('change')); }});
      $('nextLevel').addEventListener('click', ()=>{ const idx=keyOrder.indexOf(sel.value); if(idx>=0 && idx<keyOrder.length-1){ sel.value=keyOrder[idx+1]; sel.dispatchEvent(new Event('change')); }});

      // æ–°çš„æ¯é¡µ6é¡¹åˆ—è¡¨ï¼Œå®Œå…¨å‚ç…§æ¯é¡µ10é¡¹çš„æˆåŠŸæ¨¡å¼
      const PAGE5 = 6;
      let page5 = 0;
      // é˜²æ­¢è¾“å…¥æ¡† blur è§¦å‘çš„é‡æ¸²æŸ“æŠ¢å…ˆäºâ€œç¡®è®¤æ‰‹åŠ¨è¾“å…¥å˜æ›´â€ç‚¹å‡»ï¼Œå¯¼è‡´é¦–æ¬¡ç‚¹å‡»æ— æ•ˆ
      let suppressRenderOnBlur = false;
      let currentLayout = 'single'; // 'single' æˆ– 'two-column'

      // è·å–ç½‘æ ¼ç±»å
      function getGridClass(isMoonlightEnabled, isFuzhongEnabled, isKingEnabled) {
        let columnCount = 1; // åŸºç¡€ï¼šç›—å°
        if (isFuzhongEnabled) columnCount++; // è´Ÿé‡
        if (isMoonlightEnabled) columnCount++; // æœˆå…‰
        if (isKingEnabled) columnCount++; // ç‹ä¹‹å¬å”¤
        return `grid-${columnCount}`;
      }

      // è¡Œå†…æœªä¿å­˜ä¿®æ”¹çš„æš‚å­˜ï¼ˆæŒ‰æ¸²æŸ“ç”¨çš„ rowId å½’æ¡£ï¼‰ï¼Œç”¨äºï¼š
      // 1) å¤±ç„¦/é‡æ¸²æŸ“åä»ä¿ç•™è¾“å…¥å€¼
      // 2) é«˜äº®å±•ç¤ºå“ªäº›è¾“å…¥å·²ä¿®æ”¹
      // 3) ç‚¹å‡»â€œç¡®è®¤æ‰‹åŠ¨è¾“å…¥å˜æ›´â€åç»Ÿä¸€æäº¤å¹¶æ¸…ç©ºé«˜äº®
      const pendingEditsByRowId = {};

      function setPending(rowId, fieldKey, rawValue) {
        if (!pendingEditsByRowId[rowId]) pendingEditsByRowId[rowId] = {};
        pendingEditsByRowId[rowId][fieldKey] = rawValue;
      }

      function getPending(rowId, fieldKey) {
        return pendingEditsByRowId[rowId] ? pendingEditsByRowId[rowId][fieldKey] : undefined;
      }

      function clearPendingRow(rowId) {
        if (pendingEditsByRowId[rowId]) delete pendingEditsByRowId[rowId];
      }

      // æ ¹æ®è¾“å…¥æ¡† id è§£æ rowId ä¸å­—æ®µé”®
      function parseInputId(inputId) {
        // æ”¯æŒå¤šå­—ç¬¦å‰ç¼€ï¼ˆKH å¿…é¡»ä¼˜å…ˆäº Kï¼‰
        const m = inputId.match(/^g5(KH|D|F|Y|K)_([A-Za-z0-9_]+)$/);
        if (!m) return { rowId: '', field: '' };
        return { rowId: m[2], field: m[1] };
      }

      function getInputClassById(inputId) {
        const { rowId, field } = parseInputId(inputId);
        const pending = getPending(rowId, field);
        return pending != null && String(pending).trim() !== '' ? 'modified-input' : '';
      }

      // è·å–è¾“å…¥æ¡†æ˜¾ç¤ºå€¼çš„å‡½æ•°ï¼Œä¼˜å…ˆä½¿ç”¨ç”¨æˆ·çš„åŸå§‹è¾“å…¥ï¼ˆä¸­æ–‡å•ä½ï¼‰
      function getInputDisplayValue(actualValue, inputId) {
        // å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨æœªä¿å­˜çš„æš‚å­˜å€¼
        const { rowId, field } = parseInputId(inputId);
        const pending = getPending(rowId, field);
        if (pending != null && String(pending).trim() !== '') return pending;
        // å¦åˆ™ä½¿ç”¨è§£æåçš„æ•°å€¼ï¼›èƒ¡ç‰Œæ¬¡æ•°ä¸ºæ•´æ•°ï¼Œå…¶å®ƒä¿ç•™å°æ•°
        if (field === 'KH') {
          const v = actualValue == null ? 1 : parseInt(actualValue);
          return String(isNaN(v) ? 1 : v);
        }
        return (actualValue || 0).toFixed(4);
      }

      function renderPage5(){
        const start = page5 * PAGE5;
        const keys = keyOrder.slice(start, start + PAGE5);
        const all = computeRecommendedAll();
        const mode = 'both'; // å›ºå®šä½¿ç”¨bothæ¨¡å¼
        
        // æ£€æŸ¥æœˆå…‰å¼€å…³çŠ¶æ€
        const moonlightToggle = document.getElementById('moonlightToggle');
        const isMoonlightEnabled = moonlightToggle ? moonlightToggle.checked : true;
        
        // æ£€æŸ¥è´Ÿé‡å¼€å…³çŠ¶æ€
        const fuzhongToggle = document.getElementById('fuzhongToggle');
        const isFuzhongEnabled = fuzhongToggle ? fuzhongToggle.checked : true;
        
        // æ£€æŸ¥ç‹ä¹‹å¬å”¤å¼€å…³çŠ¶æ€
        const kingToggle = document.getElementById('kingEnabled');
        const isKingEnabled = kingToggle ? kingToggle.checked : false;
        
        let html = '';
        
        if (currentLayout === 'single') {
          // å•è¡Œå¸ƒå±€ï¼šæ¯ä¸ªå…³å¡å ä¸€æ•´è¡Œ
          html = keys.map((k, index)=>{
          const vSci = parseChinaJiLocal(LEVEL_TARGETS[k]) || LEVEL_TARGETS[k];
          const vCn = parseChinaJiLocal(LEVEL_TARGETS[k]) ? formatChinaJiLocal(parseChinaJiLocal(LEVEL_TARGETS[k]), getCurrentPrecision()) : LEVEL_TARGETS[k];
          const vDisp = mode==='sci'? vSci : mode==='cn'? vCn : `${vSci} / ${vCn}`;
          const a = all[k];
          const rowId = k.replace(/[^a-zA-Z0-9]/g,'_');
          const st = levelsState[k] || {};
          
          return `
            <div style="border-bottom:1px solid #eee; padding:12px 0;">
              ${index === 0 ? `
              <!-- ç›—å°ã€è´Ÿé‡ã€æœˆå…‰ã€ç‹ä¹‹å¬å”¤æ ‡é¢˜ï¼ˆåªåœ¨æ¯é¡µç¬¬ä¸€å…³æ˜¾ç¤ºï¼‰ -->
              <div class="${getGridClass(isMoonlightEnabled, isFuzhongEnabled, isKingEnabled)}" style="margin-bottom:12px; font-weight:600; color:var(--text); text-align:center;">
                <div style="padding:4px;">ç›—å°</div>
                ${isFuzhongEnabled ? '<div style="padding:4px;">è´Ÿé‡</div>' : ''}
                ${isMoonlightEnabled ? '<div style="padding:4px;">æœˆå…‰</div>' : ''}
                ${isKingEnabled ? '<div style="padding:4px;">ç‹ä¹‹å¬å”¤</div>' : ''}
              </div>
              ` : ''}
              
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <strong>${k}</strong>
                <span style="color:#6b7280;">ç›®æ ‡åˆ†æ•°ï¼š${vDisp}</span>
                <div style="display:flex; gap:8px;">
                  <button type="button" data-confirm5="${k}" class="btn-light">ç¡®è®¤æ‰‹åŠ¨è¾“å…¥å˜æ›´</button>
                  <button type="button" data-calc5="${k}">ç”¨æœ¬å…³å‚æ•°è®¡ç®—</button>
                </div>
              </div>
              
              <div class="${getGridClass(isMoonlightEnabled, isFuzhongEnabled, isKingEnabled)}" style="margin-top:6px;">
                <div>
                  <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                    <input type="text" id="g5D_${rowId}" name="g5D_${rowId}" value="${getInputDisplayValue(a.actualD, `g5D_${rowId}`)}" class="${getInputClassById(`g5D_${rowId}`)}" style="flex:1; padding:4px;" />
                  </div>
                  <div id="g5D_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                    ${(() => {
                      const formats = formatNumberDisplay((a.actualD||0), 2);
                      let displayText = '';
                      if (formats.raw) displayText += formats.raw;
                      if (formats.raw && formats.sci) displayText += ' / ';
                      if (formats.sci) displayText += formats.sci;
                      if (formats.cn && (a.actualD||0) >= 10000) {
                        displayText += ' / ' + formats.cn;
                      }
                      return displayText;
                    })()}
                  </div>
                  <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <small style="color:#6b7280;">æ¨è: ${(() => {
                      const val = (a.recD||0);
                      return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                    })()}</small>
                    <div class="btn-group" style="display:flex; gap:4px;">
                      <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:æ™®é€šç›—å°" data-gtype="æ™®é€šç›—å°" data-tooltip="æ™®é€šç›—å°1.3">æ™®é€šç›—å°</button>
                      <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:å¤©ä½¿ç›—å°" data-gtype="å¤©ä½¿ç›—å°" data-tooltip="å¤©ä½¿ç›—å°1.6">å¤©ä½¿ç›—å°</button>
                      <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:è†¨èƒ€ç›—å°" data-gtype="è†¨èƒ€ç›—å°" data-tooltip="è†¨èƒ€ç›—å°1.3^2">è†¨èƒ€ç›—å°</button>
                      <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:è†¨èƒ€ç›—å°åƒå¡ç»´" data-gtype="è†¨èƒ€ç›—å°åƒå¡ç»´" data-tooltip="è†¨èƒ€ç›—å°åƒå¡ç»´1.3^4">è†¨èƒ€ç›—å°åƒå¡ç»´</button>
                    </div>
                    <button type="button" class="btn-tooltip" data-lock5d="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockD ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockD ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                  </div>
                </div>
                ${isFuzhongEnabled ? `
                <div>
                  <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                    <input type="text" id="g5F_${rowId}" name="g5F_${rowId}" value="${getInputDisplayValue(a.actualF, `g5F_${rowId}`)}" class="${getInputClassById(`g5F_${rowId}`)}" style="flex:1; padding:4px;" />
                  </div>
                  <div id="g5F_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                    ${(() => {
                      const formats = formatNumberDisplay((a.actualF||0), 2);
                      let displayText = '';
                      if (formats.raw) displayText += formats.raw;
                      if (formats.raw && formats.sci) displayText += ' / ';
                      if (formats.sci) displayText += formats.sci;
                      if (formats.cn && (a.actualF||0) >= 10000) {
                        displayText += ' / ' + formats.cn;
                      }
                      return displayText;
                    })()}
                  </div>
                  <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <small style="color:#6b7280;">æ¨è: ${(() => {
                      const val = (a.recF||0);
                      return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                    })()}</small>
                    <div class="btn-group" style="display:flex; gap:4px;">
                      <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:æ™®é€šè´Ÿé‡" data-gtype="æ™®é€šè´Ÿé‡" data-tooltip="æ™®é€šè´Ÿé‡1.5">æ™®é€šè´Ÿé‡</button>
                      <button type="button" class="btn-radio tag-f alt btn-tooltip" data-growth5="f:${k}:å¤©ä½¿è´Ÿé‡" data-gtype="å¤©ä½¿è´Ÿé‡" data-tooltip="å¤©ä½¿è´Ÿé‡2">å¤©ä½¿è´Ÿé‡</button>
                      <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:è†¨èƒ€è´Ÿé‡" data-gtype="è†¨èƒ€è´Ÿé‡" data-tooltip="è†¨èƒ€è´Ÿé‡2.25">è†¨èƒ€è´Ÿé‡</button>
                    </div>
                    <button type="button" class="btn-tooltip" data-lock5f="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockF ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockF ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                  </div>
                </div>
                ` : ''}
                ${isMoonlightEnabled ? `
                <div>
                  <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                  <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                    <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                    <input type="text" id="g5Y_${rowId}" name="g5Y_${rowId}" value="${getInputDisplayValue(a.actualY, `g5Y_${rowId}`)}" class="${getInputClassById(`g5Y_${rowId}`)}" style="flex:1; padding:4px;" />
                  </div>
                  <div id="g5Y_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                    ${(() => {
                      const formats = formatNumberDisplay((a.actualY||0), 2);
                      let displayText = '';
                      if (formats.raw) displayText += formats.raw;
                      if (formats.raw && formats.sci) displayText += ' / ';
                      if (formats.sci) displayText += formats.sci;
                      if (formats.cn && (a.actualY||0) >= 10000) {
                        displayText += ' / ' + formats.cn;
                      }
                      return displayText;
                    })()}
                  </div>
                  <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <small style="color:#6b7280;">æ¨è: ${(() => {
                      const val = (a.recY||0);
                      return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                    })()}</small>
                    <div class="btn-group" style="display:flex; gap:4px;">
                      <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:æ™®é€šæœˆå…‰" data-gtype="æ™®é€šæœˆå…‰" data-tooltip="æ™®é€šæœˆå…‰1.5">æ™®é€šæœˆå…‰</button>
                      <button type="button" class="btn-radio tag-y alt btn-tooltip" data-growth5="y:${k}:å¤©ä½¿æœˆå…‰" data-gtype="å¤©ä½¿æœˆå…‰" data-tooltip="å¤©ä½¿æœˆå…‰2">å¤©ä½¿æœˆå…‰</button>
                      <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:è†¨èƒ€æœˆå…‰" data-gtype="è†¨èƒ€æœˆå…‰" data-tooltip="è†¨èƒ€æœˆå…‰2.25">è†¨èƒ€æœˆå…‰</button>
                    </div>
                    <button type="button" class="btn-tooltip" data-lock5y="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockY ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockY ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                  </div>
                </div>
                ` : ''}
                ${isKingEnabled ? `
                <div>
                  <!-- ç‹ä¹‹å¬å”¤ç•ªæ•°å’Œèƒ¡ç‰Œåœ¨åŒä¸€è¡Œ -->
                  <div style="display:flex; gap:8px; margin-bottom:6px;">
                    <div style="flex:1;">
                      <div style="display:flex; align-items:center; gap:4px;">
                        <span style="font-size:12px;color:#374151; min-width:30px;">ç•ªæ•°:</span>
                        <input type="text" id="g5K_${rowId}" name="g5K_${rowId}" value="${getInputDisplayValue(a.actualK, `g5K_${rowId}`)}" class="${getInputClassById(`g5K_${rowId}`)}" style="flex:1; padding:4px;" />
                      </div>
                      <div id="g5K_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 0 34px; min-height:12px;">
                        ${(() => {
                          const formats = formatNumberDisplay((a.actualK||0), 2);
                          let displayText = '';
                          if (formats.raw) displayText += formats.raw;
                          if (formats.raw && formats.sci) displayText += ' / ';
                          if (formats.sci) displayText += formats.sci;
                          if (formats.cn && (a.actualK||0) >= 10000) {
                            displayText += ' / ' + formats.cn;
                          }
                          return displayText;
                        })()}
                      </div>
                    </div>
                    <div style="flex:1;">
                      <div style="display:flex; align-items:center; gap:4px;">
                        <span style="font-size:12px;color:#374151; min-width:30px;">èƒ¡ç‰Œ:</span>
                        <input type="number" id="g5KH_${rowId}" name="g5KH_${rowId}" value="${getInputDisplayValue(a.actualKH, `g5KH_${rowId}`)}" class="${getInputClassById(`g5KH_${rowId}`)}" min="1" style="flex:1; padding:4px;" />
                      </div>
                      <div id="g5KH_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 0 34px; min-height:12px;">
                        <!-- èƒ¡ç‰Œæ¬¡æ•°ä¸éœ€è¦æ˜¾ç¤ºå¤§æ•°å­—æ ¼å¼ï¼Œå› ä¸ºå®ƒæ˜¯æ•´æ•° -->
                      </div>
                    </div>
                  </div>
                  <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <small style="color:#6b7280;">æ¨è: ${(() => {
                      const val = (a.recK||0);
                      return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                    })()}</small>
                    <button type="button" class="btn-tooltip" data-lock5k="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockK ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockK ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                  </div>
                </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
        
        } else if (currentLayout === 'two-column') {
          // ä¸¤æ å¸ƒå±€ï¼šå·¦è¾¹å‰3ä¸ªå…³å¡ï¼Œå³è¾¹å3ä¸ªå…³å¡
          const leftColumn = keys.slice(0, 3);
          const rightColumn = keys.slice(3, 6);
          
          html = `
            <div style="display:flex; gap:16px; position:relative;">
              <div style="position:absolute; left:50%; top:0; bottom:0; width:1px; background:var(--line); pointer-events:none;"></div>
              <!-- å·¦æ  -->
              <div style="flex:1; padding-right:8px;">
                ${leftColumn.length > 0 ? `
                <!-- å·¦æ æ ‡é¢˜ -->
                <div class="${getGridClass(isMoonlightEnabled, isFuzhongEnabled, isKingEnabled)}" style="margin-bottom:12px; font-weight:600; color:var(--text); text-align:center;">
                  <div style="padding:4px;">ç›—å°</div>
                  ${isFuzhongEnabled ? '<div style="padding:4px;">è´Ÿé‡</div>' : ''}
                  ${isMoonlightEnabled ? '<div style="padding:4px;">æœˆå…‰</div>' : ''}
                  ${isKingEnabled ? '<div style="padding:4px;">ç‹ä¹‹å¬å”¤</div>' : ''}
                </div>
                ` : ''}
                
                ${leftColumn.map((k, index) => {
                  const vSci = parseChinaJiLocal(LEVEL_TARGETS[k]) || LEVEL_TARGETS[k];
                  const vCn = parseChinaJiLocal(LEVEL_TARGETS[k]) ? formatChinaJiLocal(parseChinaJiLocal(LEVEL_TARGETS[k]), getCurrentPrecision()) : LEVEL_TARGETS[k];
                  const vDisp = mode==='sci'? vSci : mode==='cn'? vCn : `${vSci} / ${vCn}`;
                  const a = all[k];
                  const rowId = k.replace(/[^a-zA-Z0-9]/g,'_');
                  const st = levelsState[k] || {};
                  
                  return `
                    <div style="border-bottom:1px solid #eee; padding:12px 0;">
                      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <strong>${k}</strong>
                        <span style="color:#6b7280;">ç›®æ ‡åˆ†æ•°ï¼š${vDisp}</span>
                        <div style="display:flex; gap:8px;">
                          <button type="button" data-confirm5="${k}" class="btn-light">ç¡®è®¤æ‰‹åŠ¨è¾“å…¥å˜æ›´</button>
                          <button type="button" data-calc5="${k}">ç”¨æœ¬å…³å‚æ•°è®¡ç®—</button>
                        </div>
                      </div>
                      
                      <div class="${getGridClass(isMoonlightEnabled, isFuzhongEnabled, isKingEnabled)}" style="margin-top:6px;">
                        <div>
                          <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                            <input type="text" id="g5D_${rowId}" name="g5D_${rowId}" value="${getInputDisplayValue(a.actualD, `g5D_${rowId}`)}" class="${getInputClassById(`g5D_${rowId}`)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5D_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualD||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualD||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">æ¨è: ${(() => {
                              const val = (a.recD||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:æ™®é€šç›—å°" data-gtype="æ™®é€šç›—å°" data-tooltip="æ™®é€šç›—å°">æ™®é€šç›—å°</button>
                              <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:å¤©ä½¿ç›—å°" data-gtype="å¤©ä½¿ç›—å°" data-tooltip="å¤©ä½¿ç›—å°">å¤©ä½¿ç›—å°</button>
                              <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:è†¨èƒ€ç›—å°" data-gtype="è†¨èƒ€ç›—å°" data-tooltip="è†¨èƒ€ç›—å°">è†¨èƒ€ç›—å°</button>
                              <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:è†¨èƒ€ç›—å°åƒå¡ç»´" data-gtype="è†¨èƒ€ç›—å°åƒå¡ç»´" data-tooltip="è†¨èƒ€ç›—å°åƒå¡ç»´">è†¨èƒ€ç›—å°åƒå¡ç»´</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5d="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockD ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockD ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                          </div>
                        </div>
                        ${isFuzhongEnabled ? `
                        <div>
                          <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                            <input type="text" id="g5F_${rowId}" name="g5F_${rowId}" value="${getInputDisplayValue(a.actualF, `g5F_${rowId}`)}" class="${getInputClassById(`g5F_${rowId}`)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5F_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualF||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualF||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">æ¨è: ${(() => {
                              const val = (a.recF||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:æ™®é€šè´Ÿé‡" data-gtype="æ™®é€šè´Ÿé‡" data-tooltip="æ™®é€šè´Ÿé‡">æ™®é€šè´Ÿé‡</button>
                              <button type="button" class="btn-radio tag-f alt btn-tooltip" data-growth5="f:${k}:å¤©ä½¿è´Ÿé‡" data-gtype="å¤©ä½¿è´Ÿé‡" data-tooltip="å¤©ä½¿è´Ÿé‡">å¤©ä½¿è´Ÿé‡</button>
                              <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:è†¨èƒ€è´Ÿé‡" data-gtype="è†¨èƒ€è´Ÿé‡" data-tooltip="è†¨èƒ€è´Ÿé‡">è†¨èƒ€è´Ÿé‡</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5f="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockF ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockF ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                          </div>
                        </div>
                        ` : ''}
                        ${isMoonlightEnabled ? `
                        <div>
                          <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                            <input type="text" id="g5Y_${rowId}" name="g5Y_${rowId}" value="${getInputDisplayValue(a.actualY, `g5Y_${rowId}`)}" class="${getInputClassById(`g5Y_${rowId}`)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5Y_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualY||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualY||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">æ¨è: ${(() => {
                              const val = (a.recY||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:æ™®é€šæœˆå…‰" data-gtype="æ™®é€šæœˆå…‰" data-tooltip="æ™®é€šæœˆå…‰">æ™®é€šæœˆå…‰</button>
                              <button type="button" class="btn-radio tag-y alt btn-tooltip" data-growth5="y:${k}:å¤©ä½¿æœˆå…‰" data-gtype="å¤©ä½¿æœˆå…‰" data-tooltip="å¤©ä½¿æœˆå…‰">å¤©ä½¿æœˆå…‰</button>
                              <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:è†¨èƒ€æœˆå…‰" data-gtype="è†¨èƒ€æœˆå…‰" data-tooltip="è†¨èƒ€æœˆå…‰">è†¨èƒ€æœˆå…‰</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5y="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockY ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockY ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                          </div>
                        </div>
                        ` : ''}
                        ${isKingEnabled ? `
                        <div>
                          <!-- ç‹ä¹‹å¬å”¤ç•ªæ•°å’Œèƒ¡ç‰Œåœ¨åŒä¸€è¡Œ -->
                          <div style="display:flex; gap:8px; margin-bottom:6px;">
                            <div style="flex:1;">
                              <div style="display:flex; align-items:center; gap:4px;">
                                <span style="font-size:12px;color:#374151; min-width:30px;">ç•ªæ•°:</span>
                                <input type="text" id="g5K_${rowId}" name="g5K_${rowId}" value="${getInputDisplayValue(a.actualK, `g5K_${rowId}`)}" class="${getInputClassById(`g5K_${rowId}`)}" style="flex:1; padding:4px;" />
                              </div>
                              <div id="g5K_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 0 34px; min-height:12px;">
                                ${(() => {
                                  const formats = formatNumberDisplay((a.actualK||0), 2);
                                  let displayText = '';
                                  if (formats.raw) displayText += formats.raw;
                                  if (formats.raw && formats.sci) displayText += ' / ';
                                  if (formats.sci) displayText += formats.sci;
                                  if (formats.cn && (a.actualK||0) >= 10000) {
                                    displayText += ' / ' + formats.cn;
                                  }
                                  return displayText;
                                })()}
                              </div>
                            </div>
                            <div style="flex:1;">
                              <div style="display:flex; align-items:center; gap:4px;">
                                <span style="font-size:12px;color:#374151; min-width:30px;">èƒ¡ç‰Œ:</span>
                                <input type="number" id="g5KH_${rowId}" name="g5KH_${rowId}" value="${getInputDisplayValue(a.actualKH, `g5KH_${rowId}`)}" class="${getInputClassById(`g5KH_${rowId}`)}" min="1" style="flex:1; padding:4px;" />
                              </div>
                              <div id="g5KH_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 0 34px; min-height:12px;">
                                <!-- èƒ¡ç‰Œæ¬¡æ•°ä¸éœ€è¦æ˜¾ç¤ºå¤§æ•°å­—æ ¼å¼ï¼Œå› ä¸ºå®ƒæ˜¯æ•´æ•° -->
                              </div>
                            </div>
                          </div>
                          <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">æ¨è: ${(() => {
                              const val = (a.recK||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <button type="button" class="btn-tooltip" data-lock5k="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockK ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockK ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                          </div>
                        </div>
                        ` : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
              
              <!-- å³æ  -->
              <div style="flex:1; padding-left:8px;">
                ${rightColumn.length > 0 ? `
                <!-- å³æ æ ‡é¢˜ -->
                <div class="${getGridClass(isMoonlightEnabled, isFuzhongEnabled, isKingEnabled)}" style="margin-bottom:12px; font-weight:600; color:var(--text); text-align:center;">
                  <div style="padding:4px;">ç›—å°</div>
                  ${isFuzhongEnabled ? '<div style="padding:4px;">è´Ÿé‡</div>' : ''}
                  ${isMoonlightEnabled ? '<div style="padding:4px;">æœˆå…‰</div>' : ''}
                  ${isKingEnabled ? '<div style="padding:4px;">ç‹ä¹‹å¬å”¤</div>' : ''}
                </div>
                ` : ''}
                
                ${rightColumn.map((k, index) => {
                  const vSci = parseChinaJiLocal(LEVEL_TARGETS[k]) || LEVEL_TARGETS[k];
                  const vCn = parseChinaJiLocal(LEVEL_TARGETS[k]) ? formatChinaJiLocal(parseChinaJiLocal(LEVEL_TARGETS[k]), getCurrentPrecision()) : LEVEL_TARGETS[k];
                  const vDisp = mode==='sci'? vSci : mode==='cn'? vCn : `${vSci} / ${vCn}`;
                  const a = all[k];
                  const rowId = k.replace(/[^a-zA-Z0-9]/g,'_');
                  const st = levelsState[k] || {};
                  
                  return `
                    <div style="border-bottom:1px solid #eee; padding:12px 0;">
                      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <strong>${k}</strong>
                        <span style="color:#6b7280;">ç›®æ ‡åˆ†æ•°ï¼š${vDisp}</span>
                        <div style="display:flex; gap:8px;">
                          <button type="button" data-confirm5="${k}" class="btn-light">ç¡®è®¤æ‰‹åŠ¨è¾“å…¥å˜æ›´</button>
                          <button type="button" data-calc5="${k}">ç”¨æœ¬å…³å‚æ•°è®¡ç®—</button>
                        </div>
                      </div>
                      
                      <div class="${getGridClass(isMoonlightEnabled, isFuzhongEnabled, isKingEnabled)}" style="margin-top:6px;">
                        <div>
                          <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                            <input type="text" id="g5D_${rowId}" name="g5D_${rowId}" value="${getInputDisplayValue(a.actualD, `g5D_${rowId}`)}" class="${getInputClassById(`g5D_${rowId}`)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5D_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualD||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualD||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">æ¨è: ${(() => {
                              const val = (a.recD||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:æ™®é€šç›—å°" data-gtype="æ™®é€šç›—å°" data-tooltip="æ™®é€šç›—å°">æ™®é€šç›—å°</button>
                              <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:å¤©ä½¿ç›—å°" data-gtype="å¤©ä½¿ç›—å°" data-tooltip="å¤©ä½¿ç›—å°">å¤©ä½¿ç›—å°</button>
                              <button type="button" class="btn-radio tag-d btn-tooltip" data-growth5="d:${k}:è†¨èƒ€ç›—å°" data-gtype="è†¨èƒ€ç›—å°" data-tooltip="è†¨èƒ€ç›—å°">è†¨èƒ€ç›—å°</button>
                              <button type="button" class="btn-radio tag-d alt btn-tooltip" data-growth5="d:${k}:è†¨èƒ€ç›—å°åƒå¡ç»´" data-gtype="è†¨èƒ€ç›—å°åƒå¡ç»´" data-tooltip="è†¨èƒ€ç›—å°åƒå¡ç»´">è†¨èƒ€ç›—å°åƒå¡ç»´</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5d="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockD ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockD ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                          </div>
                        </div>
                        ${isFuzhongEnabled ? `
                        <div>
                          <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                            <input type="text" id="g5F_${rowId}" name="g5F_${rowId}" value="${getInputDisplayValue(a.actualF, `g5F_${rowId}`)}" class="${getInputClassById(`g5F_${rowId}`)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5F_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualF||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualF||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">æ¨è: ${(() => {
                              const val = (a.recF||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:æ™®é€šè´Ÿé‡" data-gtype="æ™®é€šè´Ÿé‡" data-tooltip="æ™®é€šè´Ÿé‡">æ™®é€šè´Ÿé‡</button>
                              <button type="button" class="btn-radio tag-f alt btn-tooltip" data-growth5="f:${k}:å¤©ä½¿è´Ÿé‡" data-gtype="å¤©ä½¿è´Ÿé‡" data-tooltip="å¤©ä½¿è´Ÿé‡">å¤©ä½¿è´Ÿé‡</button>
                              <button type="button" class="btn-radio tag-f btn-tooltip" data-growth5="f:${k}:è†¨èƒ€è´Ÿé‡" data-gtype="è†¨èƒ€è´Ÿé‡" data-tooltip="è†¨èƒ€è´Ÿé‡">è†¨èƒ€è´Ÿé‡</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5f="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockF ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockF ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                          </div>
                        </div>
                        ` : ''}
                        ${isMoonlightEnabled ? `
                        <div>
                          <!-- ç•ªæ•°è¾“å…¥è¡Œ -->
                          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                            <span style="font-size:12px;color:#374151; min-width:40px;">ç•ªæ•°:</span>
                            <input type="text" id="g5Y_${rowId}" name="g5Y_${rowId}" value="${getInputDisplayValue(a.actualY, `g5Y_${rowId}`)}" class="${getInputClassById(`g5Y_${rowId}`)}" style="flex:1; padding:4px;" />
                          </div>
                          <div id="g5Y_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 6px 44px; min-height:12px;">
                            ${(() => {
                              const formats = formatNumberDisplay((a.actualY||0), 2);
                              let displayText = '';
                              if (formats.raw) displayText += formats.raw;
                              if (formats.raw && formats.sci) displayText += ' / ';
                              if (formats.sci) displayText += formats.sci;
                              if (formats.cn && (a.actualY||0) >= 10000) {
                                displayText += ' / ' + formats.cn;
                              }
                              return displayText;
                            })()}
                          </div>
                          <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">æ¨è: ${(() => {
                              const val = (a.recY||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <div class="btn-group" style="display:flex; gap:4px;">
                              <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:æ™®é€šæœˆå…‰" data-gtype="æ™®é€šæœˆå…‰" data-tooltip="æ™®é€šæœˆå…‰">æ™®é€šæœˆå…‰</button>
                              <button type="button" class="btn-radio tag-y alt btn-tooltip" data-growth5="y:${k}:å¤©ä½¿æœˆå…‰" data-gtype="å¤©ä½¿æœˆå…‰" data-tooltip="å¤©ä½¿æœˆå…‰">å¤©ä½¿æœˆå…‰</button>
                              <button type="button" class="btn-radio tag-y btn-tooltip" data-growth5="y:${k}:è†¨èƒ€æœˆå…‰" data-gtype="è†¨èƒ€æœˆå…‰" data-tooltip="è†¨èƒ€æœˆå…‰">è†¨èƒ€æœˆå…‰</button>
                            </div>
                            <button type="button" class="btn-tooltip" data-lock5y="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockY ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockY ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                          </div>
                        </div>
                        ` : ''}
                        ${isKingEnabled ? `
                        <div>
                          <!-- ç‹ä¹‹å¬å”¤ç•ªæ•°å’Œèƒ¡ç‰Œåœ¨åŒä¸€è¡Œ -->
                          <div style="display:flex; gap:8px; margin-bottom:6px;">
                            <div style="flex:1;">
                              <div style="display:flex; align-items:center; gap:4px;">
                                <span style="font-size:12px;color:#374151; min-width:30px;">ç•ªæ•°:</span>
                                <input type="text" id="g5K_${rowId}" name="g5K_${rowId}" value="${getInputDisplayValue(a.actualK, `g5K_${rowId}`)}" class="${getInputClassById(`g5K_${rowId}`)}" style="flex:1; padding:4px;" />
                              </div>
                              <div id="g5K_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 0 34px; min-height:12px;">
                                ${(() => {
                                  const formats = formatNumberDisplay((a.actualK||0), 2);
                                  let displayText = '';
                                  if (formats.raw) displayText += formats.raw;
                                  if (formats.raw && formats.sci) displayText += ' / ';
                                  if (formats.sci) displayText += formats.sci;
                                  if (formats.cn && (a.actualK||0) >= 10000) {
                                    displayText += ' / ' + formats.cn;
                                  }
                                  return displayText;
                                })()}
                              </div>
                            </div>
                            <div style="flex:1;">
                              <div style="display:flex; align-items:center; gap:4px;">
                                <span style="font-size:12px;color:#374151; min-width:30px;">èƒ¡ç‰Œ:</span>
                                <input type="number" id="g5KH_${rowId}" name="g5KH_${rowId}" value="${getInputDisplayValue(a.actualKH, `g5KH_${rowId}`)}" class="${getInputClassById(`g5KH_${rowId}`)}" min="1" style="flex:1; padding:4px;" />
                              </div>
                              <div id="g5KH_display_${rowId}" style="font-size:10px; color:#9ca3af; margin:2px 0 0 34px; min-height:12px;">
                                <!-- èƒ¡ç‰Œæ¬¡æ•°ä¸éœ€è¦æ˜¾ç¤ºå¤§æ•°å­—æ ¼å¼ï¼Œå› ä¸ºå®ƒæ˜¯æ•´æ•° -->
                              </div>
                            </div>
                          </div>
                          <!-- æŒ‰é’®å’Œæ¨èè¡Œ -->
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <small style="color:#6b7280;">æ¨è: ${(() => {
                              const val = (a.recK||0);
                              return val >= 10000 ? val.toExponential(2) : val.toFixed(2);
                            })()}</small>
                            <button type="button" class="btn-tooltip" data-lock5k="${k}" style="font-size:11px; padding:2px 6px;" data-tooltip="${st.lockK ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}">${st.lockK ? 'å–æ¶ˆæ²¿ç”¨' : 'æ²¿ç”¨ä¸Šä¸€å…³'}</button>
                          </div>
                        </div>
                        ` : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }
        
        $('levelList5').innerHTML = html;
        
        // ç»‘å®šäº‹ä»¶ï¼ˆæ¯æ¬¡æ¸²æŸ“åé‡æ–°ç»‘å®šï¼‰- é™å®šåœ¨ levelList5 å®¹å™¨å†…
        const container5 = document.getElementById('levelList5');
        
        // æ›´æ–°æŒ‰é’®é€‰ä¸­çŠ¶æ€çš„å‡½æ•°ï¼ˆåœ¨ renderPage5 å†…éƒ¨å®šä¹‰ï¼Œä¾›å†…éƒ¨ä½¿ç”¨ï¼‰
        const updateButtonStates = () => {
          // éå†æ‰€æœ‰å…³å¡çš„å¢é•¿ç±»å‹æŒ‰é’®
          keyOrder.forEach(level => {
            // ç›—å°æŒ‰é’®
            ['æ™®é€šç›—å°', 'å¤©ä½¿ç›—å°', 'è†¨èƒ€ç›—å°', 'è†¨èƒ€ç›—å°åƒå¡ç»´'].forEach(type => {
              const btn = container5.querySelector(`button[data-gtype="${type}"][data-growth5^="d:${level}:"]`);
              if (btn) {
                const currentType = resolveTypeAtIndex('d', keyOrder.indexOf(level));
                btn.classList.toggle('selected', currentType === type);
              }
            });
            
            // è´Ÿé‡æŒ‰é’®
            ['æ™®é€šè´Ÿé‡', 'å¤©ä½¿è´Ÿé‡', 'è†¨èƒ€è´Ÿé‡'].forEach(type => {
              const btn = container5.querySelector(`button[data-gtype="${type}"][data-growth5^="f:${level}:"]`);
              if (btn) {
                const currentType = resolveTypeAtIndex('f', keyOrder.indexOf(level));
                btn.classList.toggle('selected', currentType === type);
              }
            });
            
            // æœˆå…‰æŒ‰é’®
            ['æ™®é€šæœˆå…‰', 'å¤©ä½¿æœˆå…‰', 'è†¨èƒ€æœˆå…‰'].forEach(type => {
              const btn = container5.querySelector(`button[data-gtype="${type}"][data-growth5^="y:${level}:"]`);
              if (btn) {
                const currentType = resolveTypeAtIndex('y', keyOrder.indexOf(level));
                btn.classList.toggle('selected', currentType === type);
              }
            });
          });
        };

        // å¢é•¿ç±»å‹æŒ‰é’®
        container5.querySelectorAll('button[data-growth5]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Growth button clicked:', btn.getAttribute('data-growth5'));
            
            const dataValue = btn.getAttribute('data-growth5');
            const parts = dataValue.split(':');
            if (parts.length < 3) return;
            const kind = parts[0];
            const key = parts[1];
            const type = parts[2];
            
            console.log('Applying type:', type, 'from level:', key);
            
            const startIdx = keyOrder.indexOf(key);
            if (startIdx === -1) return;
            
            // ä»è¯¥å…³èµ·åº”ç”¨åˆ°æ‰€æœ‰åç»­å…³å¡
            for (let i=startIdx; i<keyOrder.length; i++){
              const k2 = keyOrder[i];
              ivData[k2] = ivData[k2] || {};
              if (kind === 'd') ivData[k2].dType = type;
              if (kind === 'f') ivData[k2].fType = type;
              if (kind === 'y') ivData[k2].yType = type;
            }
            console.log('ivData updated, sample:', {
              '1-1': ivData['1-1'],
              '1-2': ivData['1-2'],
              '1-3': ivData['1-3']
            });
            
            // æ›´æ–°æŒ‰é’®é€‰ä¸­çŠ¶æ€
            updateButtonStates();
            
            // æ£€æŸ¥æ˜¯å¦å½±å“å½“å‰å°ç« è®¡æ•°å…³å¡
            if (window.selectedSealLevel && kind === 'd') {
              const selectedLevelIdx = keyOrder.indexOf(window.selectedSealLevel);
              if (selectedLevelIdx >= startIdx) {
                // å½±å“å½“å‰é€‰æ‹©çš„å…³å¡ï¼Œæ˜¾ç¤ºæç¤º
                showSealCounterNotification();
              }
            }
            
            renderPage5();
          });
        });
        
        // æ²¿ç”¨ä¸Šä¸€å…³æŒ‰é’® - å‚è€ƒ renderPage çš„å®ç°
        container5.querySelectorAll('button[data-lock5d]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-lock5d');
            console.log('Lock D clicked for:', k);
            // åˆ‡æ¢ lockD çŠ¶æ€ï¼ˆä¸ renderPage ä¸€è‡´ï¼‰
            levelsState[k] = levelsState[k] || {};
            levelsState[k].lockD = !levelsState[k].lockD;
            console.log('lockD state:', levelsState[k].lockD);
            renderPage5();
          });
        });
        container5.querySelectorAll('button[data-lock5f]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-lock5f');
            levelsState[k] = levelsState[k] || {};
            levelsState[k].lockF = !levelsState[k].lockF;
            renderPage5();
          });
        });
        container5.querySelectorAll('button[data-lock5y]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-lock5y');
            levelsState[k] = levelsState[k] || {};
            levelsState[k].lockY = !levelsState[k].lockY;
            renderPage5();
          });
        });
        container5.querySelectorAll('button[data-lock5k]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-lock5k');
            levelsState[k] = levelsState[k] || {};
            levelsState[k].lockK = !levelsState[k].lockK;
            renderPage5();
          });
        });
        
        // ç”¨æœ¬å…³å‚æ•°è®¡ç®—æŒ‰é’®
        container5.querySelectorAll('button[data-calc5]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-calc5');
            const a = all[k];
            
            // ä¿®å¤ï¼šåŒæ­¥è®¾ç½®å…³å¡é€‰æ‹©å™¨å’Œç›®æ ‡åˆ†æ•°
            $('levelSelect').value = k;
            $('targetScore').value = LEVEL_TARGETS[k];
            
            $('daoyin').value = `${(a.actualD||0).toFixed(6)}`;
            $('fuzhong').value = `${(a.actualF||0).toFixed(6)}`;
            $('yueguang').value = `${(a.actualY||0).toFixed(6)}`;
            
            // è®¾ç½®ç‹ä¹‹å¬å”¤å‚æ•°ï¼ˆå¦‚æœç‹ä¹‹å¬å”¤å¼€å¯ï¼‰
            const kingEnabled = document.getElementById('kingEnabled');
            if (kingEnabled && kingEnabled.checked) {
              // ç‹ä¹‹å¬å”¤è§¦å‘æ¬¡æ•°ä¿æŒå½“å‰è®¾ç½®ï¼Œä¸éœ€è¦ä»å…³å¡æ•°æ®ä¸­è·å–
              // å› ä¸ºè§¦å‘æ¬¡æ•°æ˜¯å…¨å±€è®¾ç½®ï¼Œä¸æ˜¯æ¯ä¸ªå…³å¡å•ç‹¬çš„
            }
            
            // åŒæ­¥åˆ·æ–°å³ä¸‹è§’æ ¼å¼æ˜¾ç¤º
            updateStampDisplay();
            const unlockD = $('unlockD').value;
            const unlockF = $('unlockF').value;
            const unlockY = $('unlockY').value;
            const kIdx = keyOrder.indexOf(k);
            const idxD = keyOrder.indexOf(unlockD);
            const idxF = keyOrder.indexOf(unlockF);
            const idxY = keyOrder.indexOf(unlockY);
            $('trigD').value = kIdx >= idxD && idxD>=0 ? $('trigD').value : '0';
            $('trigF').value = kIdx >= idxF && idxF>=0 ? $('trigF').value : '0';
            $('trigY').value = kIdx >= idxY && idxY>=0 ? $('trigY').value : '0';
            await computeWithForm();
            
            // è‡ªåŠ¨å¼¹å‡ºè®¡ç®—ç»“æœæ¨¡æ€æ¡†
            const resultToggle = document.getElementById('resultToggle');
            const floatingResult = document.getElementById('floatingResult');
            if (resultToggle && floatingResult) {
              resultToggle.checked = true;
              floatingResult.style.display = 'block';
            }
            // æ›´æ–°é¢„æµ‹
            updatePrediction();
          });
        });
        
        // ä¸ºç•ªæ•°è¾“å…¥æ¡†æ·»åŠ å®æ—¶æ˜¾ç¤ºå¤§æ•°å­—ç³»ç»Ÿçš„äº‹ä»¶ç›‘å¬å™¨
        container5.querySelectorAll('input[id^="g5D_"], input[id^="g5F_"], input[id^="g5Y_"], input[id^="g5K_"], input[id^="g5KH_"]').forEach(input => {
          input.addEventListener('input', function() {
            const value = this.value.trim();
            const displayId = this.id.replace(/^g5([DFYKH]?)_/, 'g5$1_display_');
            const displayEl = document.getElementById(displayId);
            
            if (displayEl) {
              if (!value) {
                displayEl.textContent = '';
                return;
              }
              
              // å°è¯•è§£æè¾“å…¥å€¼
              let num = parseFloat(value);
              if (isNaN(num)) {
                const sciStr = parseChinaJiLocal(value);
                if (sciStr) {
                  num = parseFloat(sciStr);
                }
              }
              
              if (!isNaN(num)) {
                const formats = formatNumberDisplay(num, 2);
                let displayText = '';
                
                if (formats.raw) displayText += formats.raw;
                if (formats.raw && formats.sci) displayText += ' / ';
                if (formats.sci) displayText += formats.sci;
                if (formats.cn && num >= 10000) {
                  displayText += ' / ' + formats.cn;
                }
                
                displayEl.textContent = displayText;
              } else {
                displayEl.textContent = '';
              }
            }
            
            // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œä¿å­˜åˆ°levelsStateï¼Œåªåœ¨ç¡®è®¤æŒ‰é’®ç‚¹å‡»æ—¶ä¿å­˜
            // è¿™æ ·å¯ä»¥é¿å…è¾“å…¥è¿‡ç¨‹ä¸­é¢‘ç¹æ›´æ–°çŠ¶æ€ï¼ŒåŒæ—¶ä¿æŒä¸backversionä¸€è‡´çš„è¡Œä¸º
            
            // ä½†æ˜¯éœ€è¦ä¿æŒè¾“å…¥æ¡†çš„åŸå§‹å€¼ï¼Œé¿å…åœ¨é‡æ–°æ¸²æŸ“æ—¶ä¸¢å¤±ç”¨æˆ·çš„ä¸­æ–‡å•ä½è¾“å…¥
            // è®°å½•æœ¬è¡Œæœªä¿å­˜ä¿®æ”¹ï¼Œå¹¶é«˜äº®è¯¥è¾“å…¥æ¡†
            const info = parseInputId(this.id);
            setPending(info.rowId, info.field, this.value);
            this.classList.add('modified-input');
          });
        });

        // åœ¨è¾“å…¥ç»“æŸï¼ˆå¤±ç„¦ï¼‰æ—¶å†ç»Ÿä¸€é‡æ¸²æŸ“ï¼Œæ›´æ–°æ¨èå€¼/æŒ‰é’®çŠ¶æ€ï¼Œé¿å…æ‰“å­—è¿‡ç¨‹ä¸­ç„¦ç‚¹ä¸¢å¤±
        container5.querySelectorAll('input[id^="g5D_"], input[id^="g5F_"], input[id^="g5Y_"], input[id^="g5K_"], input[id^="g5KH_"]').forEach(input => {
          input.addEventListener('blur', function() {
            if (suppressRenderOnBlur) return;
            // å¼‚æ­¥æ‰§è¡Œï¼Œç¡®ä¿ä¼˜å…ˆå¤„ç†ç‚¹å‡»äº‹ä»¶
            setTimeout(() => {
              if (suppressRenderOnBlur) return;
              renderPage5();
            }, 0);
          });
        });
        
        // ç¡®è®¤æ‰‹åŠ¨è¾“å…¥å˜æ›´æŒ‰é’®
        container5.querySelectorAll('button[data-confirm5]').forEach(btn => {
          // åœ¨æŒ‰ä¸‹æ—¶å…ˆæ ‡è®°ï¼Œé¿å…è¾“å…¥æ¡† blur çš„é‡æ¸²æŸ“æ‰“æ–­ç¬¬ä¸€æ¬¡ç‚¹å‡»
          btn.addEventListener('pointerdown', () => { suppressRenderOnBlur = true; });
          btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const k = btn.getAttribute('data-confirm5');
            const rowId = k.replace(/[^a-zA-Z0-9]/g,'_');
            
            // è·å–ç”¨æˆ·è¾“å…¥çš„ç•ªæ•°å€¼ï¼ˆä¼˜å…ˆä½¿ç”¨ pendingEdits æš‚å­˜ï¼Œç¡®ä¿ä¸€æ¬¡ç‚¹å‡»æäº¤æ•´è¡Œä¿®æ”¹ï¼‰
            const inputD = document.getElementById(`g5D_${rowId}`);
            const inputF = document.getElementById(`g5F_${rowId}`);
            const inputY = document.getElementById(`g5Y_${rowId}`);
            const inputK = document.getElementById(`g5K_${rowId}`);
            const inputKH = document.getElementById(`g5KH_${rowId}`);
            
            // æ£€æŸ¥å¿…éœ€çš„è¾“å…¥æ¡†
            if (!inputD) return;
            
            // æ£€æŸ¥è´Ÿé‡è¾“å…¥æ¡†æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚æœè´Ÿé‡å¼€å¯ï¼‰
            const fuzhongToggle = document.getElementById('fuzhongToggle');
            if (fuzhongToggle && fuzhongToggle.checked) {
              if (!inputF) {
                console.warn('è´Ÿé‡å¼€å¯ä½†è¾“å…¥æ¡†ä¸å­˜åœ¨:', { inputF });
                return;
              }
            }
            
            // æ£€æŸ¥æœˆå…‰è¾“å…¥æ¡†æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚æœæœˆå…‰å¼€å¯ï¼‰
            const moonlightToggle = document.getElementById('moonlightToggle');
            if (moonlightToggle && moonlightToggle.checked) {
              if (!inputY) {
                console.warn('æœˆå…‰å¼€å¯ä½†è¾“å…¥æ¡†ä¸å­˜åœ¨:', { inputY });
                return;
              }
            }
            
            // æ£€æŸ¥ç‹ä¹‹å¬å”¤è¾“å…¥æ¡†æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚æœç‹ä¹‹å¬å”¤å¼€å¯ï¼‰
            const kingEnabled = document.getElementById('kingEnabled');
            if (kingEnabled && kingEnabled.checked) {
              if (!inputK || !inputKH) {
                console.warn('ç‹ä¹‹å¬å”¤å¼€å¯ä½†è¾“å…¥æ¡†ä¸å­˜åœ¨:', { inputK, inputKH });
                return;
              }
            }
            
            // è§£æè¾“å…¥å€¼ï¼ˆæ”¯æŒå¤§æ•°å­—ç³»ç»Ÿï¼‰
            const parseInput = (value) => {
              const trimmed = value.trim();
              if (!trimmed) return null;
              
              // å…ˆå°è¯•è§£æå¤§æ•°å­—ç³»ç»Ÿï¼ˆåŒ…æ‹¬å°æ•°éƒ¨åˆ†ï¼‰
              const sciStr = parseChinaJiLocal(trimmed);
              if (sciStr) {
                const num = parseFloat(sciStr);
                return isNaN(num) ? null : num;
              }
              
              // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ç›´æ¥è§£ææ•°å­—
              const num = parseFloat(trimmed);
              return isNaN(num) ? null : num;
            };
            
            const pend = pendingEditsByRowId[rowId] || {};
            const valD = pend.D != null ? String(pend.D) : (inputD ? inputD.value : '');
            const valF = pend.F != null ? String(pend.F) : (inputF ? inputF.value : '');
            const valY = pend.Y != null ? String(pend.Y) : (inputY ? inputY.value : '');
            const valK = pend.K != null ? String(pend.K) : (inputK ? inputK.value : '');
            const valKH = pend.KH != null ? String(pend.KH) : (inputKH ? inputKH.value : '');

            const newD = parseInput(valD);
            const newF = inputF ? parseInput(valF) : null;
            const newY = inputY ? parseInput(valY) : null;
            const newK = inputK ? parseInput(valK) : null;
            const newKH = inputKH ? (parseInt(valKH) || 1) : null;
            
            console.log('Confirming manual input for:', k, { newD, newF, newY, newK, newKH });
            
            // æ›´æ–° levelsState ä¸­çš„æ‰‹åŠ¨è¾“å…¥å€¼ï¼ˆä¿å­˜è§£æåçš„æ•°å€¼å­—ç¬¦ä¸²ï¼‰ï¼Œä¸å—å¼€å…³æ˜¾ç¤ºå½±å“
            levelsState[k] = levelsState[k] || {};
            if (newD !== null) levelsState[k].manuD = newD.toString();
            if (newF !== null) levelsState[k].manuF = newF.toString();
            if (newY !== null) levelsState[k].manuY = newY.toString();
            if (newK !== null) levelsState[k].manuK = newK.toString();
            if (newKH !== null) levelsState[k].manuKH = newKH.toString();
            
            // è”åŠ¨æ›´æ–°è§£é”å…³ï¼šè‹¥æœ¬å…³æ‰‹åŠ¨è¾“å…¥ >0ï¼Œåˆ™æŠŠå¯¹åº”è§£é”é€‰æ‹©å™¨æ›´æ–°ä¸ºå½“å‰å…³
            const currentIndex = keyOrder.indexOf(k);
            const updateUnlock = (selId, enabled, val) => {
              const sel = $(selId);
              if (!sel) return;
              if (enabled && val != null && val > 0) {
                const idx = keyOrder.indexOf(sel.value);
                if (idx < 0 || currentIndex < idx) sel.value = k;
              }
            };
            updateUnlock('unlockD', true, newD);
            updateUnlock('unlockF', (fuzhongToggle && fuzhongToggle.checked), newF);
            updateUnlock('unlockY', (moonlightToggle && moonlightToggle.checked), newY);
            // ç‹ä¹‹å¬å”¤çš„çº§è”èµ·ç‚¹ç”± computeRecommendedAll çš„ manualKStartIndex/Value è‡ªåŠ¨å¤„ç†
            
            // ç¡®è®¤è¾ƒæ—©è¡Œæ—¶ï¼Œæ¸…é™¤ä¹‹åæ‰€æœ‰å…³å¡çš„æ‰‹åŠ¨è¦†ç›–ï¼Œç¡®ä¿é‡æ–°æŒ‰é“¾å¼æ¨èç”Ÿæ•ˆ
            if (currentIndex >= 0) {
              for (let i = currentIndex + 1; i < keyOrder.length; i++) {
                const nk = keyOrder[i];
                if (levelsState[nk]) {
                  delete levelsState[nk].manuD;
                  delete levelsState[nk].manuF;
                  delete levelsState[nk].manuY;
                  delete levelsState[nk].manuK;
                  delete levelsState[nk].manuKH;
                }
              }
            }

            // æ¸…ç©ºæœ¬è¡Œ pending é«˜äº®
            clearPendingRow(rowId);
            
            // åˆ·æ–°é¡µé¢æ˜¾ç¤ºï¼ˆå”¯ä¸€åˆ·æ–°ç‚¹ï¼‰ï¼Œå¹¶è§£é™¤æŠ‘åˆ¶æ ‡è®°
            renderPage5();
            suppressRenderOnBlur = false;
          });
        });
        
        // åœ¨äº‹ä»¶ç»‘å®šå®Œæˆåæ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtonStates();
        
        $('pageInfo5').textContent = `ç¬¬ ${page5+1} é¡µ / å…± ${Math.ceil(keyOrder.length/PAGE5)} é¡µ`;
        
        // æ›´æ–°é¡µé¢é€‰æ‹©å™¨
        const pageInput5 = document.getElementById('pageInput5');
        if (pageInput5) {
          pageInput5.max = Math.ceil(keyOrder.length/PAGE5);
          pageInput5.value = page5 + 1;
        }
      }
      
      document.getElementById('prev5').addEventListener('click', ()=>{ if (page5>0){ page5--; renderPage5(); }});
      document.getElementById('next5').addEventListener('click', ()=>{ if ((page5+1)*PAGE5 < keyOrder.length){ page5++; renderPage5(); }});
      
      // é¡µé¢é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬å™¨
      document.getElementById('goToPage5').addEventListener('click', () => {
        const pageInput = document.getElementById('pageInput5');
        const targetPage = parseInt(pageInput.value);
        
        // ç”±äºè¾“å…¥æ¡†å·²ç»é™åˆ¶äº†èŒƒå›´ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–çš„éªŒè¯
        page5 = targetPage - 1; // è½¬æ¢ä¸º0åŸºç´¢å¼•
        renderPage5();
      });
      
      // é¡µé¢è¾“å…¥æ¡†å›è½¦äº‹ä»¶
      document.getElementById('pageInput5').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('goToPage5').click();
        }
      });
      
      // å¸ƒå±€åˆ‡æ¢æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      document.getElementById('layoutSwitch').addEventListener('click', () => {
        currentLayout = 'single';
        document.getElementById('layoutSwitch').classList.add('active');
        document.getElementById('layoutSwitch2').classList.remove('active');
        renderPage5();
      });
      
      document.getElementById('layoutSwitch2').addEventListener('click', () => {
        currentLayout = 'two-column';
        document.getElementById('layoutSwitch2').classList.add('active');
        document.getElementById('layoutSwitch').classList.remove('active');
        renderPage5();
      });
      
      // åˆå§‹åŒ–æ¸²æŸ“æ¯é¡µ6é¡¹åˆ—è¡¨ï¼ˆæ”¾åœ¨å®šä¹‰ä¸ç›‘å¬ä¹‹åï¼Œé¿å…å¼•ç”¨é¡ºåºé”™è¯¯ï¼‰
      renderPage5();
  // åˆå§‹åŒ–å†å²åˆ—è¡¨
  populateHistorySelect();
  // ç»‘å®šæ–°æµç¨‹æ§ä»¶
  const saveBtn = document.getElementById('saveCurrentBtn');
  if (saveBtn) saveBtn.addEventListener('click', ()=>{ const f=document.getElementById('saveFlow'); if (f) f.style.display='flex'; });
  const confirmSaveBtn = document.getElementById('confirmSaveBtn');
  if (confirmSaveBtn) confirmSaveBtn.addEventListener('click', ()=>{ saveCurrentLevelData(); const f=document.getElementById('saveFlow'); const i=document.getElementById('historyName'); if(f) f.style.display='none'; if(i) i.value=''; });
  const cancelSaveBtn = document.getElementById('cancelSaveBtn');
  if (cancelSaveBtn) cancelSaveBtn.addEventListener('click', ()=>{ const f=document.getElementById('saveFlow'); const i=document.getElementById('historyName'); if(f) f.style.display='none'; if(i) i.value=''; });
  const delBtn = document.getElementById('dropdownDeleteBtn');
  if (delBtn) delBtn.addEventListener('click', deleteHistory);
  const historySelect = document.getElementById('historySelect');
  if (historySelect) historySelect.addEventListener('change', ()=>{ if(historySelect.value) loadHistoryLevelData(); });
      
      
      // æœªæ¥å…³å¡é¢„æµ‹åŠŸèƒ½
      function predictFutureLevels() {
        try {
          const all = computeRecommendedAll();
          const currentLevel = $('levelSelect')?.value;
          const currentIdx = currentLevel ? keyOrder.indexOf(currentLevel) : -1;
          
          // å¦‚æœæ‰¾ä¸åˆ°å½“å‰å…³å¡ï¼Œä¸æ‰§è¡Œé¢„æµ‹
          if (currentIdx === -1) {
            const currentEl = document.getElementById('currentPrediction');
            const maxEl = document.getElementById('maxPrediction');
            if (currentEl) currentEl.innerHTML = '<span style="color: var(--muted);">è¯·å…ˆé€‰æ‹©å…³å¡</span>';
            if (maxEl) maxEl.innerHTML = '<span style="color: var(--muted);">è¯·å…ˆé€‰æ‹©å…³å¡</span>';
            return;
          }
          
          // è·å–å½“å‰è§¦å‘æ¬¡æ•°
          const currentTrigD = Number(($('trigD')?.value) || '0');
          const currentTrigF = Number(($('trigF')?.value) || '0');
          const currentTrigY = Number(($('trigY')?.value) || '0');
          
          // è·å–æœ€å¤§è§¦å‘æ¬¡æ•°
          const maxTrigD = Number(($('maxTrigD')?.value) || '0');
          const maxTrigF = Number(($('maxTrigF')?.value) || '0');
          const maxTrigY = Number(($('maxTrigY')?.value) || '0');
        
        // é¢„æµ‹å‡½æ•°
        const predict = (trigD, trigF, trigY, label) => {
          let result = '';
          let found = false;
          
          for (let i = currentIdx + 1; i < keyOrder.length; i++) {
            const level = keyOrder[i];
            const targetScore = parseFloat(parseChinaJiLocal(LEVEL_TARGETS[level]) || LEVEL_TARGETS[level]);
            const levelData = all[level];
            
            if (!levelData) continue;
            
            // è®¡ç®—æ€»åˆ†æ•°ï¼ˆä½¿ç”¨æŒ‡å®šçš„è§¦å‘æ¬¡æ•°ï¼‰
            // å¦‚æœè§¦å‘æ¬¡æ•°ä¸º0æˆ–ç•ªæ•°ä¸º0ï¼Œåˆ™å¿½ç•¥è¯¥æŠ¤ç¬¦ï¼Œå¦åˆ™ä½¿ç”¨ç•ªæ•°çš„è§¦å‘æ¬¡æ–¹
            const daoyinMultiplier = (trigD === 0 || levelData.actualD === 0) ? 1 : Math.pow(levelData.actualD, trigD);
            const fuzhongMultiplier = (trigF === 0 || levelData.actualF === 0) ? 1 : Math.pow(levelData.actualF, trigF);
            const yueguangMultiplier = (trigY === 0 || levelData.actualY === 0) ? 1 : Math.pow(levelData.actualY, trigY);
            
            // ç‹ä¹‹å¬å”¤è¿ä¹˜è®¡ç®—ï¼šä½¿ç”¨ç»Ÿä¸€çš„è®¡ç®—å‡½æ•°ï¼ˆå½“ç‹ä¹‹å¬å”¤ç•ªæ•°ä¸º0æ—¶å¿½ç•¥ï¼‰
            let kingMultiplier = 1;
            if (levelData.actualK && levelData.actualKH && levelData.actualK !== 0) {
              const currentKingFan = levelData.actualK; // å½“å‰å…³å¡çš„ç‹ä¹‹å¬å”¤ç•ªæ•°
              const winCountFromSettings = parseFloat($('finalMulInput').value) || 1; // æ•°å€¼è®¾ç½®ä¸­çš„èƒ¡ç‰Œç•ªæ•°
              const triggerCount = parseInt($('trigK').value) || 4; // ç‹ä¹‹å¬å”¤å®é™…è§¦å‘æ¬¡æ•°
              
              // ä½¿ç”¨ç»Ÿä¸€çš„ç‹ä¹‹å¬å”¤ä¹˜æ•°è®¡ç®—å‡½æ•°
              kingMultiplier = calculateKingCallMultiplier(currentKingFan, triggerCount, winCountFromSettings);
            }
            
            const totalScore = levelData.baseScore * levelData.finalMultiplier * 
                             daoyinMultiplier * 
                             fuzhongMultiplier * 
                             yueguangMultiplier * 
                             kingMultiplier;
            
            // ç‹ä¹‹å¬å”¤è°ƒè¯•ä¿¡æ¯ï¼ˆæ˜¾ç¤ºåœ¨æ§åˆ¶å°ï¼‰
            /*
            if (levelData.actualK && levelData.actualKH) {
              const currentKingFan = levelData.actualK;
              const winCountFromSettings = parseFloat($('finalMulInput').value) || 1;
              const triggerCount = parseInt($('trigK').value) || 4;
              
              // console.log(`ğŸ¯ ç‹ä¹‹å¬å”¤è°ƒè¯• - ${level}:`);
              // console.log(`   å½“å‰å…³å¡ç‹ä¹‹å¬å”¤ç•ªæ•°: ${currentKingFan}`);
              // console.log(`   ç‹ä¹‹å¬å”¤å®é™…è§¦å‘æ¬¡æ•°: ${triggerCount}`);
              // console.log(`   æ•°å€¼è®¾ç½®ä¸­çš„èƒ¡ç‰Œç•ªæ•°: ${winCountFromSettings}`);
              // console.log(`   ç‹ä¹‹å¬å”¤ä¹˜æ•°: ${kingMultiplier}`);
              console.log(`   æ€»åˆ†æ•°: ${totalScore}`);
              console.log('---');
            }
            */
            
            if (totalScore > targetScore) {
              const ratio = totalScore / targetScore;
              const targetDisp = formatChinaJiLocal(targetScore.toString(), 2);
              const scoreDisp = formatChinaJiLocal(totalScore.toString(), 2);
              
              result = `<span style="color: var(--ok); font-weight: bold;">${level}</span> - ç›®æ ‡: ${targetDisp}, é¢„è®¡å¾—åˆ†: ${scoreDisp} (${ratio.toFixed(1)}å€)`;
              found = true;
              break;
            }
          }
          
          if (!found) {
            result = '<span style="color: var(--muted);">æ— æ³•åœ¨å½“å‰é…ç½®ä¸‹è¶…è¶Šç›®æ ‡åˆ†</span>';
          }
          
          return result;
        };
        
          // æ›´æ–°é¢„æµ‹æ˜¾ç¤º
          const currentEl = document.getElementById('currentPrediction');
          const maxEl = document.getElementById('maxPrediction');
          
          if (currentEl) {
            currentEl.innerHTML = predict(currentTrigD, currentTrigF, currentTrigY, 'å½“å‰é…ç½®');
          }
          
          if (maxEl) {
            maxEl.innerHTML = predict(maxTrigD, maxTrigF, maxTrigY, 'æœ€å¤§é…ç½®');
          }
        } catch (error) {
          console.error('é¢„æµ‹æœªæ¥å…³å¡æ—¶å‡ºé”™:', error);
          const currentEl = document.getElementById('currentPrediction');
          const maxEl = document.getElementById('maxPrediction');
          if (currentEl) currentEl.innerHTML = '<span style="color: var(--danger);">é¢„æµ‹å‡ºé”™</span>';
          if (maxEl) maxEl.innerHTML = '<span style="color: var(--danger);">é¢„æµ‹å‡ºé”™</span>';
        }
      }
      
      // åœ¨è®¡ç®—å®Œæˆåæ›´æ–°é¢„æµ‹ï¼ˆå·²ç§»é™¤ï¼Œé¿å…é‡å¤è°ƒç”¨ï¼‰
      // const originalComputeWithForm = window.computeWithForm;
      // window.computeWithForm = async function() {
      //   const result = await originalComputeWithForm();
      //   updatePrediction(); // ä½¿ç”¨æ–°çš„é¢„æµ‹å‡½æ•°
      //   return result;
      // };
      
      
      // åŒºå—é€‰æ‹©å™¨åŠŸèƒ½
      function updateBlockVisibility() {
        const blocks = document.querySelectorAll('.config-block');
        blocks.forEach(block => {
          const blockType = block.dataset.block;
          const button = document.querySelector(`[data-block="${blockType}"].block-btn`);
          if (button) {
            if (button.classList.contains('active')) {
              block.classList.remove('hidden');
            } else {
              block.classList.add('hidden');
            }
          }
        });
      }
      
      // åŒºå—æŠ˜å åŠŸèƒ½
      function toggleBlockCollapse(block) {
        const content = block.querySelector('.block-content');
        const toggle = block.querySelector('.block-toggle');
        
        if (content.classList.contains('expanded')) {
          content.classList.remove('expanded');
          content.classList.add('collapsed');
          block.classList.add('collapsed');
          toggle.textContent = 'â–¶';
        } else {
          content.classList.remove('collapsed');
          content.classList.add('expanded');
          block.classList.remove('collapsed');
          toggle.textContent = 'â–¼';
        }
      }
      
      // åˆå§‹åŒ–åŒºå—é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
      document.querySelectorAll('.block-btn').forEach(button => {
        button.addEventListener('click', () => {
          button.classList.toggle('active');
          updateBlockVisibility();
        });
      });
      
      // åˆå§‹åŒ–åŒºå—æŠ˜å äº‹ä»¶ç›‘å¬
      document.querySelectorAll('.config-block h4').forEach(header => {
        header.addEventListener('click', () => {
          toggleBlockCollapse(header.closest('.config-block'));
        });
      });
      
      // åˆå§‹åŒ–åŒºå—å¯è§æ€§
      updateBlockVisibility();
      
      // æ‚¬æµ®çª—åŠŸèƒ½
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };
      const floatingWindow = document.getElementById('floatingResult');
      const floatingHeader = floatingWindow.querySelector('.floating-header');
      const resultToggle = document.getElementById('resultToggle');
      const floatingClose = document.getElementById('floatingClose');
      
      // å¼€å…³æ§åˆ¶æ‚¬æµ®çª—æ˜¾ç¤º/éšè—
      resultToggle.addEventListener('change', function() {
        if (this.checked) {
          floatingWindow.style.display = 'block';
        } else {
          floatingWindow.style.display = 'none';
        }
      });
      
      // å…³é—­æŒ‰é’®
      floatingClose.addEventListener('click', function(e) {
        e.stopPropagation();
        floatingWindow.style.display = 'none';
        resultToggle.checked = false;
      });
      
      // æ‹–æ‹½åŠŸèƒ½
      floatingHeader.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('floating-close')) {
          return;
        }
        
        isDragging = true;
        const rect = floatingWindow.getBoundingClientRect();
        dragOffset.x = e.clientX - rect.left;
        dragOffset.y = e.clientY - rect.top;
        
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', stopDrag);
        e.preventDefault();
      });
      
      function handleDrag(e) {
        if (!isDragging) return;
        
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        const floatingWidth = floatingWindow.offsetWidth;
        const floatingHeight = floatingWindow.offsetHeight;
        
        let newX = e.clientX - dragOffset.x;
        let newY = e.clientY - dragOffset.y;
        
        // é™åˆ¶ä¸è¶…å‡ºé¡µé¢è¾¹ç•Œ
        newX = Math.max(0, Math.min(newX, windowWidth - floatingWidth));
        newY = Math.max(0, Math.min(newY, windowHeight - floatingHeight));
        
        floatingWindow.style.left = newX + 'px';
        floatingWindow.style.top = newY + 'px';
        floatingWindow.style.right = 'auto';
      }
      
      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', handleDrag);
        document.removeEventListener('mouseup', stopDrag);
      }
      
      // åˆå§‹åŒ–æ‚¬æµ®çª—ä½ç½®
      function initFloatingWindow() {
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        
        // å…ˆæ˜¾ç¤ºæ‚¬æµ®çª—ä»¥è·å–å®é™…å°ºå¯¸
        floatingWindow.style.display = 'block';
        const floatingWidth = floatingWindow.offsetWidth;
        const floatingHeight = floatingWindow.offsetHeight;
        
        // é»˜è®¤ä½ç½®ï¼šå³ä¾§å±…ä¸­
        let defaultX = windowWidth - floatingWidth - 20;
        let defaultY = Math.max(120, (windowHeight - floatingHeight) / 2);
        
        // ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
        defaultX = Math.max(20, Math.min(defaultX, windowWidth - floatingWidth - 20));
        defaultY = Math.max(20, Math.min(defaultY, windowHeight - floatingHeight - 20));
        
        floatingWindow.style.left = defaultX + 'px';
        floatingWindow.style.top = defaultY + 'px';
        floatingWindow.style.right = 'auto';
        
        // åˆå§‹éšè—
        floatingWindow.style.display = 'none';
      }
      
      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      initFloatingWindow();
      
      // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°å®šä½
      window.addEventListener('resize', function() {
        if (floatingWindow.style.display !== 'none') {
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;
          const floatingWidth = floatingWindow.offsetWidth;
          const floatingHeight = floatingWindow.offsetHeight;
          
          const currentLeft = parseInt(floatingWindow.style.left) || 0;
          const currentTop = parseInt(floatingWindow.style.top) || 0;
          
          let newX = Math.max(0, Math.min(currentLeft, windowWidth - floatingWidth));
          let newY = Math.max(0, Math.min(currentTop, windowHeight - floatingHeight));
          
          floatingWindow.style.left = newX + 'px';
          floatingWindow.style.top = newY + 'px';
        }
      });
      
      // ç²¾åº¦æŒ‰é’®åŠŸèƒ½
      document.querySelectorAll('.precision-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // ç§»é™¤æ‰€æœ‰activeç±»
          document.querySelectorAll('.precision-btn').forEach(b => b.classList.remove('active'));
          // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
          btn.classList.add('active');
          // æ›´æ–°ç²¾åº¦å€¼
          const precision = parseInt(btn.dataset.precision);
          // è§¦å‘è®¡ç®—æ›´æ–°ï¼ˆå¦‚æœå·²ç»æœ‰ç»“æœçš„è¯ï¼‰
          if (document.getElementById('resTotalSci').textContent !== '-') {
            computeWithForm();
          }
        });
      });
      
      // è·å–å½“å‰ç²¾åº¦çš„å‡½æ•°
      function getCurrentPrecision() {
        const activeBtn = document.querySelector('.precision-btn.active');
        return activeBtn ? parseInt(activeBtn.dataset.precision) : 2;
      }

      // é…è‰²æ–¹æ¡ˆåˆ‡æ¢
      let lastActiveTheme = 'default'; // è®°å½•ä¸Šä¸€ä¸ªæœ‰æ•ˆçš„ä¸»é¢˜
      
      document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', () => {
          // è·å–ä¸»é¢˜åç§°
          const themeName = option.dataset.theme;
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯å½©è›‹ä¸»é¢˜
          if (themeName === 'easter-egg') {
            // æ¢å¤ä¹‹å‰çš„çŠ¶æ€ï¼Œä¸æ”¹å˜activeç±»
            document.getElementById('easterEggModal').style.display = 'block';
            return;
          }
          
          // æ›´æ–°è®°å½•çš„æœ‰æ•ˆä¸»é¢˜
          lastActiveTheme = themeName;
          
          // ç§»é™¤æ‰€æœ‰activeç±»
          document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active'));
          // æ·»åŠ activeç±»åˆ°å½“å‰é€‰é¡¹
          option.classList.add('active');
          
          // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
          document.body.classList.remove('theme-16QwQ', 'theme-buxingshx', 'theme-life', 'theme-purple', 'theme-rainbow', 'theme-wonderful', 'theme-16yyds');
          
          // å¦‚æœä¸æ˜¯é»˜è®¤ä¸»é¢˜ï¼Œæ·»åŠ å¯¹åº”çš„ä¸»é¢˜ç±»
          if (themeName !== 'default') {
            document.body.classList.add(`theme-${themeName}`);
          }
          
          // ä¿å­˜åˆ°localStorage
          localStorage.setItem('selectedTheme', themeName);
        });
      });
      
      // å½©è›‹æ¨¡æ€æ¡†å…³é—­å‡½æ•°
      window.closeEasterEgg = function() {
        document.getElementById('easterEggModal').style.display = 'none';
      };
      
      
      // è½®æ’­æç¤ºæ¡†åŠŸèƒ½
      const gameTips = [
        "è¿›å…¥å…³å¡å‰å’Œè‡ªæ‘¸æ—¶æ³¨æ„é¡ºåºå“¦",
        "å¸æ˜Ÿå™¨ï¼Œç‹ä¹‹å¬å”¤ç­‰æŠ¤èº«ç¬¦+0åˆ†/Ã—1ç•ªçš„æ—¶å€™å…ˆä¸è¦è¿›é“¾å“¦",
        "å¯ä»¥ç”¨è¿·é›¾å°ç« ã€æˆé•¿å°ç« è®©ç›—å°å¤šåƒå°ç« å“¦",
        "å•†åº—ä¹°ä¸åˆ°å‚¨å¤‡ç²®é£Ÿçš„è¯ï¼Œè®©æ”¹é€ ç‹æ”¹ç»¿å¡è¯•è¯•çœ‹å‘¢",
        "æ‰¾ç”Ÿå‘½çš„è¯ï¼Œè±æ©è¦æ”¾åœ¨å¢¨é•œçŒ«å³è¾¹å“¦",
        "æ‰¾ä¸åˆ°ä¼ å¯¼å¡çš„æ—¶å€™ï¼Œå¯ä»¥ç•™æ‹äººç‰Œåˆ·å‡ºä¼ å¯¼åï¼Œç”¨æ”¹é€ ç‹æ”¹å“¦",
        "åˆ©ç”¨å¥¶ç“¶åˆ·çš„æ—¶å€™çœ‹ä¸€ä¸‹å²šæ˜Ÿä½ç½®ï¼Œæ§åˆ†åˆ°åˆ«è¿‡å…³å…ˆ",
        "å†²åˆºå¯ä»¥åˆ†ä¸¤å…³ï¼Œå°½é‡åœ¨å¥–åŠ±å…³æ‰¾è½»æ¾ä¸€äº›",
        "è†¨èƒ€å¡ç»´pluså‡çº§ä¸¤è¾¹çš„å¡ï¼Œå¦‚æœå·¦è¾¹æ˜¯è†¨èƒ€å¡ï¼Œé‚£ä¼šå‡ºbug",
        "é»‘å®¢å˜çš„ç›—å°å°å¿ƒåˆ«æŠŠè†¨èƒ€è´Ÿé‡åƒäº†hhhhhhh",
        "ç­’å¤±æ•ˆæ—¶ï¼Œå¤©æ©åˆ«èƒ¡ç­’ä¸€è‰²ä¼šæ–­é“¾å­ï¼ˆæ¡åŒç†",
        "é»‘å®¢æµæ´¾çš„å‘è‚²3wå—ä»¥ä¸Šæ˜¯æ¯”è¾ƒæ­£å¸¸çš„æ˜Ÿå¸æ•°é‡o"
      ];
      
      let currentTipIndex = 0;
      let tipsInterval;
      
      function initTipsCarousel() {
        const tipsContent = document.getElementById('tipsContent');
        const tipsDots = document.getElementById('tipsDots');
        
        // åˆ›å»ºæŒ‡ç¤ºç‚¹
        gameTips.forEach((tip, index) => {
          const dot = document.createElement('div');
          dot.className = 'tips-dot';
          if (index === 0) dot.classList.add('active');
          dot.addEventListener('click', () => showTip(index));
          tipsDots.appendChild(dot);
        });
        
        // å¼€å§‹è‡ªåŠ¨è½®æ’­
        startTipsRotation();
        
        // é¼ æ ‡æ‚¬åœæ—¶æš‚åœè½®æ’­
        document.querySelector('.tips-carousel').addEventListener('mouseenter', stopTipsRotation);
        document.querySelector('.tips-carousel').addEventListener('mouseleave', startTipsRotation);
      }
      
      function showTip(index) {
        const tipsContent = document.getElementById('tipsContent');
        const dots = document.querySelectorAll('.tips-dot');
        
        // ç§»é™¤å½“å‰æ´»è·ƒçŠ¶æ€
        tipsContent.classList.remove('active');
        dots.forEach(dot => dot.classList.remove('active'));
        
        // å»¶è¿Ÿåæ˜¾ç¤ºæ–°å†…å®¹
        setTimeout(() => {
          tipsContent.textContent = gameTips[index];
          tipsContent.classList.add('active');
          dots[index].classList.add('active');
          currentTipIndex = index;
        }, 250);
      }
      
      function startTipsRotation() {
        stopTipsRotation();
        tipsInterval = setInterval(() => {
          const nextIndex = (currentTipIndex + 1) % gameTips.length;
          showTip(nextIndex);
        }, 4000); // æ¯4ç§’åˆ‡æ¢ä¸€æ¬¡
      }
      
      function stopTipsRotation() {
        if (tipsInterval) {
          clearInterval(tipsInterval);
          tipsInterval = null;
        }
      }
      
      // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
      const savedTheme = localStorage.getItem('selectedTheme') || 'default';
      const themeOption = document.querySelector(`[data-theme="${savedTheme}"]`);
      if (themeOption) {
        themeOption.click();
      }
      
      // ä¸º"é€‰é¡¹ï¼ˆå°ç« ç•ªæ•°ï¼‰"çš„è¾“å…¥æ¡†æ·»åŠ å®æ—¶æ˜¾ç¤ºä¸‰ç§æ ¼å¼
      function updateStampDisplay() {
        const inputs = [
          { input: 'daoyin', display: 'daoyin_display' },
          { input: 'fuzhong', display: 'fuzhong_display' },
          { input: 'yueguang', display: 'yueguang_display' }
        ];
        
        inputs.forEach(({ input, display }) => {
          const inputEl = document.getElementById(input);
          const displayEl = document.getElementById(display);
          
          if (inputEl && displayEl) {
            const value = inputEl.value.trim();
            if (!value) {
              displayEl.textContent = '';
              return;
            }
            
            // å°è¯•è§£æè¾“å…¥å€¼
            let num = parseFloat(value);
            if (isNaN(num)) {
              const sciStr = parseChinaJiLocal(value);
              if (sciStr) {
                num = parseFloat(sciStr);
              }
            }
            
            if (!isNaN(num)) {
              const formats = formatNumberDisplay(num, 2);
              let displayText = '';
              
              if (formats.raw) displayText += formats.raw;
              if (formats.raw && formats.sci) displayText += ' / ';
              if (formats.sci) displayText += formats.sci;
              if (formats.cn && num >= 10000) {
                displayText += ' / ' + formats.cn;
              }
              
              displayEl.textContent = displayText;
            } else {
              displayEl.textContent = '';
            }
          }
        });
      }
      
      // ä¸ºå°ç« ç•ªæ•°è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      ['daoyin', 'fuzhong', 'yueguang'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('input', updateStampDisplay);
        }
      });
      
      // åˆå§‹åŒ–æ˜¾ç¤º
      updateStampDisplay();
      
      
      // ç¡®è®¤èµ·å§‹å…³æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¸¦åé¦ˆï¼‰
      document.getElementById('unlockApply').addEventListener('click', ()=>{
        const button = document.getElementById('unlockApply');
        const originalText = button.textContent;
        
        // æ˜¾ç¤ºåé¦ˆ
        button.textContent = 'âœ“ å·²ç¡®è®¤';
        button.style.background = 'var(--ok)';
        button.style.color = 'var(--card)';
        
        // åˆ·æ–°é¡µé¢
        renderPage5();
        
        // 2ç§’åæ¢å¤åŸçŠ¶
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '';
          button.style.color = '';
        }, 2000);
      });
      
      // åˆå§‹åŒ–è½®æ’­æç¤ºæ¡†
      initTipsCarousel();

      // å¡ç‰‡æŠ˜å /å±•å¼€åŠŸèƒ½
      document.querySelectorAll('.card-toggle').forEach(button => {
        button.addEventListener('click', () => {
          const targetId = button.dataset.target;
          const content = document.getElementById(targetId);
          const isCollapsed = content.classList.contains('collapsed');
          
          if (isCollapsed) {
            content.classList.remove('collapsed');
            button.textContent = 'âˆ’';
          } else {
            content.classList.add('collapsed');
            button.textContent = '+';
          }
        });
      });
      
      // åŒºå—æŠ˜å /å±•å¼€åŠŸèƒ½
      document.querySelectorAll('.config-block h4').forEach(header => {
        header.addEventListener('click', () => {
          const block = header.closest('.config-block');
          const content = block.querySelector('.block-content');
          const toggle = block.querySelector('.block-toggle');
          const isCollapsed = block.classList.contains('collapsed');
          
          if (isCollapsed) {
            block.classList.remove('collapsed');
            content.classList.remove('collapsed');
            content.classList.add('expanded');
            toggle.textContent = 'â–¼';
          } else {
            block.classList.add('collapsed');
            content.classList.remove('expanded');
            content.classList.add('collapsed');
            toggle.textContent = 'â–¶';
          }
        });
      });

      // æ•°å­—è¾“å…¥æ§ä»¶åŠŸèƒ½
      document.querySelectorAll('.number-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const target = btn.dataset.target;
          const action = btn.dataset.action;
          const input = document.getElementById(target);
          
          if (input) {
            let value = parseInt(input.value) || 0;
            if (action === 'increase') {
              value += 1;
            } else if (action === 'decrease') {
              value = Math.max(0, value - 1);
            }
            input.value = value;
            
            // è§¦å‘inputäº‹ä»¶ï¼Œç¡®ä¿å…¶ä»–ç›‘å¬å™¨èƒ½æ”¶åˆ°æ›´æ–°
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });
      });

      // ç‹ä¹‹å¬å”¤å¼€å…³
      const kingEnabled = document.getElementById('kingEnabled');
      const kingBox = document.getElementById('kingBox');
      if (kingEnabled && kingBox) {
        kingEnabled.addEventListener('change', ()=>{
          kingBox.style.display = kingEnabled.checked ? 'block' : 'none';
          // é‡æ–°æ¸²æŸ“å…³å¡ç›®æ ‡åˆ†æ¨¡å—ä»¥æ›´æ–°ç‹ä¹‹å¬å”¤åˆ—çš„æ˜¾ç¤º
          renderPage5();
          // é‡æ–°è®¡ç®—å¹¶æ›´æ–°é¢„æµ‹
          if (document.getElementById('btn')) {
            document.getElementById('btn').click();
          }
        });
      }
      
      // ç‹ä¹‹å¬å”¤è§¦å‘æ¬¡æ•°è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
      const trigKInput = document.getElementById('trigK');
      if (trigKInput) {
        let trigKTimeout = null;
        trigKInput.addEventListener('input', () => {
          if (trigKTimeout) {
            clearTimeout(trigKTimeout);
          }
          trigKTimeout = setTimeout(() => {
            // é‡æ–°è®¡ç®—å¹¶æ›´æ–°é¢„æµ‹
            if (document.getElementById('btn')) {
              document.getElementById('btn').click();
            }
          }, 300);
        });
      }
      
      const maxTrigKInput = document.getElementById('maxTrigK');
      if (maxTrigKInput) {
        let maxTrigKTimeout = null;
        maxTrigKInput.addEventListener('input', () => {
          if (maxTrigKTimeout) {
            clearTimeout(maxTrigKTimeout);
          }
          maxTrigKTimeout = setTimeout(() => {
            // é‡æ–°è®¡ç®—å¹¶æ›´æ–°é¢„æµ‹
            if (document.getElementById('btn')) {
              document.getElementById('btn').click();
            }
          }, 300);
        });
      }
      
      // ç»‘å®šé¢„æµ‹æ›´æ–°æŒ‰é’®ï¼ˆç§»é™¤é‡å¤ç»‘å®šï¼Œç»Ÿä¸€åœ¨åº•éƒ¨ä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼‰
      // document.getElementById('updatePrediction').addEventListener('click', updatePrediction);
      
      // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤ºï¼ˆç”¨äºé¢„æµ‹åŠŸèƒ½ï¼‰
      function formatPredictionNumber(value, digits = 2) {
        if (!value || value === '-' || value === 0) return '0';
        
        let originalValue = value;
        let sciString = '';
        
        if (typeof value === 'string') {
          // å…ˆå°è¯•è§£æä¸­å›½å¤§æ•°å­—ç³»ç»Ÿæ ¼å¼
          const parsed = parseChinaJiLocal(value);
          originalValue = parsed || value;
          
          // æ£€æŸ¥æ˜¯å¦ä¸ºç§‘å­¦è®¡æ•°æ³•æ ¼å¼
          const sciMatch = originalValue.match(/^\s*([-+]?\d+(?:\.\d+)?)e([-+]?\d+)\s*$/i);
          if (sciMatch) {
            const coeff = parseFloat(sciMatch[1]);
            const expo = parseInt(sciMatch[2], 10);
            
            // å¦‚æœæŒ‡æ•°è¶…è¿‡ JavaScript å®‰å…¨èŒƒå›´ï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²å¤„ç†
            if (expo > 1000 || !isFinite(coeff) || !isFinite(expo)) {
              sciString = originalValue;
            } else {
              const num = parseFloat(originalValue);
              if (isFinite(num)) {
                // 1ä¸‡ä»¥ä¸‹çš„æ•°ä¸æ˜¾ç¤ºç§‘å­¦è®¡æ•°æ³•
                if (num < 10000) {
                  return num.toFixed(digits);
                }
                sciString = num.toExponential(15);
              } else {
                sciString = originalValue;
              }
            }
          } else {
            // å°è¯•è§£æä¸ºæ™®é€šæ•°å­—
            const num = parseFloat(originalValue);
            if (isFinite(num)) {
              // 1ä¸‡ä»¥ä¸‹çš„æ•°ä¸æ˜¾ç¤ºç§‘å­¦è®¡æ•°æ³•
              if (num < 10000) {
                return num.toFixed(digits);
              }
              sciString = num.toExponential(15);
            } else {
              // å¦‚æœ parseFloat å¤±è´¥ï¼Œå¯èƒ½æ˜¯è¶…å¤§æ•°å­—ï¼Œå°è¯•ç›´æ¥å¤„ç†
              sciString = originalValue;
            }
          }
        } else {
          const num = parseFloat(value);
          if (isFinite(num)) {
            // 1ä¸‡ä»¥ä¸‹çš„æ•°ä¸æ˜¾ç¤ºç§‘å­¦è®¡æ•°æ³•
            if (num < 10000) {
              return num.toFixed(digits);
            }
            sciString = num.toExponential(15);
          } else {
            sciString = value.toString();
          }
        }
        
        // å¦‚æœ sciString ä¸ºç©ºæˆ–æ— æ•ˆï¼Œè¿”å› '-'
        if (!sciString) return '-';
        
        // ç”Ÿæˆç§‘å­¦è®¡æ•°æ³•æ˜¾ç¤º
        let sciDisplay = sciString;
        if (sciString.includes('e') || sciString.includes('E')) {
          const sciMatch = sciString.match(/^\s*([-+]?\d+(?:\.\d+)?)e([-+]?\d+)\s*$/i);
          if (sciMatch) {
            const coeff = parseFloat(sciMatch[1]);
            const expo = parseInt(sciMatch[2], 10);
            if (isFinite(coeff) && isFinite(expo)) {
              sciDisplay = `${coeff.toFixed(digits)}e${expo}`;
            }
          }
        }
        
        // ä¸­å›½å¤§æ•°å­—ç³»ç»Ÿè½¬æ¢
        const cn = formatChinaJiLocal(sciString, digits);
        
        return `${sciDisplay} / ${cn}`;
      }
      
      // æ ¼å¼åŒ–ç›®æ ‡åˆ†æ•°æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºåŸå§‹æ ·å¼ï¼‰
      function formatTargetScore(value) {
        if (!value || value === '-' || value === 0) return '0';
        
        // å…ˆå°è¯•è§£æä¸­å›½å¤§æ•°å­—ç³»ç»Ÿæ ¼å¼
        const parsed = parseChinaJiLocal(value);
        const num = parseFloat(parsed || value);
        
        // è‹¥è¶…å‡º JS Number èŒƒå›´æˆ–è§£æå¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸² + ä¸­å›½å¤§æ•°æ ¼å¼
        if (!isFinite(num) || isNaN(num)) {
          const raw = String(value);
          const cn = formatChinaJiLocal(raw, 2);
          return `${raw} / ${cn}`;
        }
        
        // 1ä¸‡ä»¥ä¸‹çš„æ•°ä¸æ˜¾ç¤ºç§‘å­¦è®¡æ•°æ³•
        if (num < 10000) {
          return num.toString();
        }
        
        // ç§‘å­¦è®¡æ•°æ³•
        const sci = num.toExponential(2);
        
        // ä¸­å›½å¤§æ•°å­—ç³»ç»Ÿ
        const cn = formatChinaJiLocal(num.toString(), 2);
        
        return `${sci} / ${cn}`;
      }
      
      // æ¯”è¾ƒå¾—åˆ†å’Œç›®æ ‡åˆ†çš„è¾…åŠ©å‡½æ•°ï¼ˆå¤„ç†ç§‘å­¦è®¡æ•°æ³•æ ¼å¼ï¼‰
      function compareScores(score, targetStr) {
        if (!targetStr || targetStr === '-') return true; // æ²¡æœ‰ç›®æ ‡åˆ†åˆ™é€šè¿‡
        
        // è§£æç›®æ ‡åˆ†ä¸ºç§‘å­¦è®¡æ•°æ³•æ ¼å¼
        const parsedTarget = parseChinaJiLocal(targetStr) || targetStr;
        
        // å¦‚æœç›®æ ‡åˆ†æ˜¯ç§‘å­¦è®¡æ•°æ³•æ ¼å¼ï¼ˆå¦‚ "5.70E+310"ï¼‰
        if (typeof parsedTarget === 'string' && parsedTarget.includes('E')) {
          // å°†å¾—åˆ†è½¬æ¢ä¸ºç§‘å­¦è®¡æ•°æ³•è¿›è¡Œæ¯”è¾ƒ
          const scoreStr = score.toExponential();
          return compareScientificNotation(scoreStr, parsedTarget);
        }
        
        // æ™®é€šæ•°å­—æ¯”è¾ƒ
        const targetNum = parseFloat(parsedTarget);
        if (isFinite(targetNum)) {
          return score >= targetNum;
        }
        
        // å¦‚æœæ— æ³•è§£æç›®æ ‡åˆ†ï¼Œé»˜è®¤é€šè¿‡
        return true;
      }
      
      // æ¯”è¾ƒä¸¤ä¸ªç§‘å­¦è®¡æ•°æ³•å­—ç¬¦ä¸²
      function compareScientificNotation(scoreStr, targetStr) {
        try {
          // è§£æç§‘å­¦è®¡æ•°æ³•
          const parseSci = (str) => {
            const match = str.match(/^([+-]?\d+(?:\.\d+)?)[eE]([+-]?\d+)$/);
            if (!match) return null;
            return {
              coefficient: parseFloat(match[1]),
              exponent: parseInt(match[2])
            };
          };
          
          const scoreParts = parseSci(scoreStr);
          const targetParts = parseSci(targetStr);
          
          if (!scoreParts || !targetParts) return true;
          
          // æ¯”è¾ƒæŒ‡æ•°
          if (scoreParts.exponent > targetParts.exponent) return true;
          if (scoreParts.exponent < targetParts.exponent) return false;
          
          // æŒ‡æ•°ç›¸åŒï¼Œæ¯”è¾ƒç³»æ•°
          return scoreParts.coefficient >= targetParts.coefficient;
        } catch (e) {
          console.warn('ç§‘å­¦è®¡æ•°æ³•æ¯”è¾ƒå¤±è´¥:', e);
          return true;
        }
      }
      
      // é¢„æµ‹åŠŸèƒ½ - å¤ç”¨è®¡ç®—ç»“æœåŒºå—çš„è®¡ç®—é€»è¾‘
      async function updatePrediction() {
        try {
          // ä½¿ç”¨computeWithFormçš„è®¡ç®—é€»è¾‘æ¥è·å–å‡†ç¡®çš„ç»“æœ
          const currentLevel = document.getElementById('levelSelect').value;
          const baseScore = parseFloat(document.getElementById('baseScore').value) || 0;
          
          if (baseScore <= 0) {
            // æ¸…ç©ºæ˜¾ç¤º
            const clearElement = (id) => {
              const el = document.getElementById(id);
              if (el) el.textContent = 'è¯·å…ˆè¿›è¡Œè®¡ç®—';
            };
            
            clearElement('predCurrentLevelTarget');
            clearElement('predCurrentScore');
            clearElement('predMaxScore');
            clearElement('predBreakdown');
            clearElement('currentPrediction');
            clearElement('maxPrediction');
            return;
          }
          
          // è°ƒç”¨computeWithFormè·å–è®¡ç®—ç»“æœï¼Œä½†ä¸æ›´æ–°UI
          const result = await computeWithFormInternal();
          
          if (result) {
            // è·å–è§¦å‘æ¬¡æ•°
            const trigD = parseInt(document.getElementById('trigD').value) || 0;
            const trigF = parseInt(document.getElementById('trigF').value) || 0;
            const trigY = parseInt(document.getElementById('trigY').value) || 0;
            const maxTrigD = parseInt(document.getElementById('theoD').value) || 0;
            const maxTrigF = parseInt(document.getElementById('theoF').value) || 0;
            const maxTrigY = parseInt(document.getElementById('theoY').value) || 0;
            
            // è·å–æŠ¤èº«ç¬¦æ•°å€¼
            const daoyinValue = parseFloat(document.getElementById('daoyin').value) || 1;
            const fuzhongValue = parseFloat(document.getElementById('fuzhong').value) || 1;
            const yueguangValue = parseFloat(document.getElementById('yueguang').value) || 1;
            
            // æ›´æ–°å½“å‰å…³å¡ä¿¡æ¯ä¸ç›®æ ‡åˆ†
            const targetScoreStr = LEVEL_TARGETS[currentLevel];
            
            document.getElementById('predCurrentLevelTarget').innerHTML = `
              å½“å‰å…³å¡ï¼š${currentLevel}  ç›®æ ‡åˆ†:${formatTargetScore(targetScoreStr)}
            `;
            
            // ä½¿ç”¨APIè¿”å›çš„ç»“æœæ›´æ–°é¢„æµ‹æ˜¾ç¤º
            document.getElementById('predCurrentScore').textContent = result.totalScore || '-';
            document.getElementById('predMaxScore').textContent = result.theoreticalTotalScore || '-';
            
            // æ›´æ–°åˆ†è§£ï¼ˆç•ªæ•°ä¸è§¦å‘æ¬¡æ•°ï¼‰æ˜¾ç¤º - ä½¿ç”¨APIè¿”å›çš„å‡†ç¡®æ•°æ®
            const dv = result.breakdown?.daoyin?.value;
            const fv = result.breakdown?.fuzhong?.value;
            const yv = result.breakdown?.yueguang?.value;
            const dvSci = dv != null ? parseFloat(dv).toExponential(2) : '-';
            const fvSci = fv != null ? parseFloat(fv).toExponential(2) : '-';
            const yvSci = yv != null ? parseFloat(yv).toExponential(2) : '-';
            const dvCn = dv != null ? formatChinaJiLocal(dvSci, 2) : '-';
            const fvCn = fv != null ? formatChinaJiLocal(fvSci, 2) : '-';
            const yvCn = yv != null ? formatChinaJiLocal(yvSci, 2) : '-';
            
            document.getElementById('predBreakdown').innerHTML = `
              <div style="flex:1;">ç›—å° ç•ªæ•°=${dvSci} / ${dvCn}  è§¦å‘=${result.breakdown?.daoyin?.triggers ?? '-'}</div>
              <div style="flex:1;">è´Ÿé‡ ç•ªæ•°=${fvSci} / ${fvCn}  è§¦å‘=${result.breakdown?.fuzhong?.triggers ?? '-'}</div>
              <div style="flex:1;">æœˆå…‰ ç•ªæ•°=${yvSci} / ${yvCn}  è§¦å‘=${result.breakdown?.yueguang?.triggers ?? '-'}</div>
            `;
            
            // æ›´æ–°è§¦å‘æ¬¡æ•°æ˜¾ç¤º
            document.getElementById('currentDaoyinTriggers').textContent = trigD;
            document.getElementById('currentFuzhongTriggers').textContent = trigF;
            document.getElementById('currentYueguangTriggers').textContent = trigY;
            document.getElementById('maxDaoyinTriggers').textContent = maxTrigD;
            document.getElementById('maxFuzhongTriggers').textContent = maxTrigF;
            document.getElementById('maxYueguangTriggers').textContent = maxTrigY;
            
            // è®¡ç®—é¢„æµ‹ - ä½¿ç”¨åç«¯APIè¿›è¡Œå‡†ç¡®è®¡ç®—
            const currentPrediction = await calculatePrediction(baseScore, trigD, trigF, trigY, currentLevel, daoyinValue, fuzhongValue, yueguangValue, 'current');
            const maxPrediction = await calculatePrediction(baseScore, maxTrigD, maxTrigF, maxTrigY, currentLevel, daoyinValue, fuzhongValue, yueguangValue, 'max');
            
            document.getElementById('currentPrediction').innerHTML = currentPrediction;
            document.getElementById('maxPrediction').innerHTML = maxPrediction;
          }
        } catch (err) {
          console.error('é¢„æµ‹æ›´æ–°å¤±è´¥:', err);
          const currentEl = document.getElementById('currentPrediction');
          const maxEl = document.getElementById('maxPrediction');
          if (currentEl) currentEl.innerHTML = '<span style="color: var(--danger);">é¢„æµ‹å‡ºé”™</span>';
          if (maxEl) maxEl.innerHTML = '<span style="color: var(--danger);">é¢„æµ‹å‡ºé”™</span>';
        }
      }
      
      // å†…éƒ¨è®¡ç®—å‡½æ•° - å¤ç”¨computeWithFormçš„é€»è¾‘ä½†ä¸æ›´æ–°UI
      async function computeWithFormInternal() {
        try {
          const basePayload = (() => {
            const levelConfig = { targetScore: $('targetScore').value.trim() };
            if (document.getElementById('kingEnabled') && document.getElementById('kingEnabled').checked) {
              levelConfig.kingCallInitialMultiplier = '1'; // ç‹ä¹‹å¬å”¤åˆå§‹ç•ªæ•°å›ºå®šä¸º1
              const t = $('trigK') ? $('trigK').value.trim() : '4';
              if (t) levelConfig.kingCallTriggers = Number(t);
              levelConfig.kingCallBase = '30'; // åŸºç¡€ç•ªæ•°å›ºå®šä¸º30
            }
            const sequence = { baseScore: $('baseScore').value.trim(), items: [] };

            const options = {
              daoyinValue: $('daoyin').value.trim(),
              fuzhongValue: $('fuzhong').value.trim(),
              yueguangValue: $('yueguang').value.trim(),
              overrideTriggers: {
                daoyin: Number($('trigD').value.trim() || '0'),
                fuzhong: Number($('trigF').value.trim() || '0'),
                yueguang: Number($('trigY').value.trim() || '0'),
              },
              overrideTheoreticalMaxes: {
                daoyin: Number($('theoD').value.trim() || '0'),
                fuzhong: Number($('theoF').value.trim() || '0'),
                yueguang: Number($('theoY').value.trim() || '0'),
                kingCall: Number($('maxTrigK').value.trim() || '0') // æ·»åŠ ç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°
              }
            };
            return { levelConfig, sequence, options };
          })();
          if (!basePayload) return null;

          const payload = basePayload;
          // è¦†ç›–èƒ¡ç‰Œç•ªæ•° - å¦‚æœæœ‰ç‹ä¹‹å¬å”¤ï¼Œä½¿ç”¨ç‹ä¹‹å¬å”¤è®¡ç®—å‡ºçš„èƒ¡ç‰Œç•ªæ•°
          const kingEnabled = document.getElementById('kingEnabled')?.checked;
          if (kingEnabled) {
            // è®¡ç®—ç‹ä¹‹å¬å”¤ä¹˜æ•°æ¥æ›¿æ¢èƒ¡ç‰Œç•ªæ•°
            const currentLevel = $('levelSelect')?.value || 'Ex61';
            const all = computeRecommendedAll();
            const levelData = all[currentLevel];
            
            if (levelData?.actualK && levelData?.actualKH) {
              const currentKingFan = levelData.actualK;
              const winCountFromSettings = parseFloat($('finalMulInput').value) || 1;
              const triggerCount = parseInt($('trigK').value) || 4;
              
              // ä½¿ç”¨ç»Ÿä¸€çš„ç‹ä¹‹å¬å”¤ä¹˜æ•°è®¡ç®—å‡½æ•°
              const kingMultiplier = calculateKingCallMultiplier(currentKingFan, triggerCount, winCountFromSettings);
              
              // ä½¿ç”¨ç‹ä¹‹å¬å”¤ä¹˜æ•°ç›´æ¥æ›¿æ¢èƒ¡ç‰Œç•ªæ•°
              // console.log('ğŸ¯ åç«¯è°ƒç”¨ç‹ä¹‹å¬å”¤è®¡ç®—:', {
              //   currentKingFan,
              //   winCountFromSettings,
              //   triggerCount,
              //   kingMultiplier,
              //   finalMultiplierOverride: kingMultiplier.toString()
              // });
              payload.options.finalMultiplierOverride = kingMultiplier.toString();
              
              // å¦‚æœç‹ä¹‹å¬å”¤å¼€å¯ï¼Œè¿˜éœ€è¦è®¡ç®—ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°å¯¹åº”çš„ç‹ä¹‹å¬å”¤ä¹˜æ•°
              const maxTrigK = parseInt($('maxTrigK').value) || 4;
              // console.log('ğŸ” å‰ç«¯ç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°è°ƒè¯•:', {
              //   currentKingFan,
              //   maxTrigK,
              //   winCountFromSettings,
              //   triggerCount
              // });
              
              if (maxTrigK > 0) {
                const theoreticalKingMultiplier = calculateKingCallMultiplier(currentKingFan, maxTrigK, winCountFromSettings);
                payload.options.theoreticalFinalMultiplierOverride = theoreticalKingMultiplier.toString();
                // console.log('ğŸ¯ å‰ç«¯è®¡ç®—ç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§ä¹˜æ•°:', theoreticalKingMultiplier.toString());
              } else {
                // å¦‚æœç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°ä¸º0ï¼Œä½¿ç”¨åŸå§‹èƒ¡ç‰Œç•ªæ•°
                payload.options.theoreticalFinalMultiplierOverride = $('finalMulInput').value.trim();
                // console.log('ğŸ¯ ç‹ä¹‹å¬å”¤ç†è®ºæœ€å¤§è§¦å‘æ¬¡æ•°ä¸º0ï¼Œä½¿ç”¨åŸå§‹èƒ¡ç‰Œç•ªæ•°:', $('finalMulInput').value.trim());
              }
            } else {
          payload.options.finalMultiplierOverride = $('finalMulInput').value.trim();
              // ç‹ä¹‹å¬å”¤å…³é—­æ—¶ï¼Œç†è®ºæœ€å¤§ä¹˜æ•°ä¹Ÿä½¿ç”¨åŸå§‹èƒ¡ç‰Œç•ªæ•°
              payload.options.theoreticalFinalMultiplierOverride = $('finalMulInput').value.trim();
            }
          } else {
            payload.options.finalMultiplierOverride = $('finalMulInput').value.trim();
          }
          // å°†ä¸‰ç±»ç•ªæ•°è¾“å…¥ä¹Ÿå…è®¸ä¸­æ–‡å¤§æ•°ï¼šé¢„è§£æä¸ºç§‘å­¦è®¡æ•°
          ['daoyinValue','fuzhongValue','yueguangValue'].forEach(k=>{
            const v = payload.options[k];
            const p = parseChinaJiLocal(v);
            if (p) payload.options[k] = p;
          });
          // baseScore/targetScore äº¦æœ¬åœ°è§£æ
          const pt = parseChinaJiLocal(payload.levelConfig.targetScore); if (pt) payload.levelConfig.targetScore = pt;
          const pb = parseChinaJiLocal(payload.sequence.baseScore); if (pb) payload.sequence.baseScore = pb;
          // è§¦å‘æ¬¡æ•°ä¸ç†è®ºæœ€å¤§æ¬¡æ•°ç¡®ä¿ä¸ºæ•°å­—
          payload.options.overrideTriggers = payload.options.overrideTriggers || {};
          payload.options.overrideTheoreticalMaxes = payload.options.overrideTheoreticalMaxes || {};
          ['daoyin','fuzhong','yueguang','kingCall'].forEach(k=>{
            payload.options.overrideTriggers[k] = Number(payload.options.overrideTriggers[k]||0);
            payload.options.overrideTheoreticalMaxes[k] = Number(payload.options.overrideTheoreticalMaxes[k]||0);
          });

          const resp = await fetch(api, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          return data;
        } catch (err) {
          console.error('å†…éƒ¨è®¡ç®—å¤±è´¥:', err);
          return null;
        }
      }
      
      async function calculatePrediction(baseScore, trigD, trigF, trigY, startLevel, daoyinValue = 1, fuzhongValue = 1, yueguangValue = 1, type = 'current') {
        console.log('calculatePrediction', baseScore, trigD, trigF, trigY, startLevel, daoyinValue, fuzhongValue, yueguangValue, type);
        const currentLevelIdx = keyOrder.indexOf(startLevel);
        if (currentLevelIdx === -1) return 'æ— æ•ˆå…³å¡';
        
        // è·å–èƒ¡ç‰Œç•ªæ•°ï¼ˆæœ€ç»ˆç•ªæ•°ï¼‰
        const finalMultiplier = parseFloat(document.getElementById('finalMulInput').value) || 1;
        
        // å‡†å¤‡å…³å¡æ•°æ®ï¼ŒåªåŒ…å«å½“å‰å…³å¡ä¹‹åçš„å…³å¡
        const futureLevels = {};
        const all = computeRecommendedAll();
        
        for (let i = currentLevelIdx + 1; i < keyOrder.length; i++) {
          const levelKey = keyOrder[i];
          const levelData = all[levelKey];
          const targetScoreStr = LEVEL_TARGETS[levelKey];
          
          if (levelData && targetScoreStr) {
            // ç¡®ä¿ç•ªæ•°å€¼è½¬æ¢ä¸ºç§‘å­¦è®¡æ•°æ³•å­—ç¬¦ä¸²æ ¼å¼ï¼Œä»¥ä¾¿åç«¯æ­£ç¡®è§£æå¤§æ•°å­—
            const formatValueForBackend = (value) => {
              if (!value || value === 0) return '1';
              const num = parseFloat(value);
              if (!isFinite(num)) return '1';
              // ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•æ ¼å¼ï¼Œç¡®ä¿å¤§æ•°å­—ä¸ä¼šä¸¢å¤±ç²¾åº¦
              return num.toExponential(15);
            };
            
            futureLevels[levelKey] = {
              targetScore: targetScoreStr,
              daoyinValue: formatValueForBackend(levelData.actualD || 1),
              fuzhongValue: formatValueForBackend(levelData.actualF || 1),
              yueguangValue: formatValueForBackend(levelData.actualY || 1),
              kingValue: formatValueForBackend(levelData.actualK || 1) // æ·»åŠ ç‹ä¹‹å¬å”¤ç•ªæ•°
            };
          }
        }
        
        try {
          // è°ƒç”¨åç«¯APIè¿›è¡Œé¢„æµ‹è®¡ç®—ï¼ˆæ˜¾å¼ CORS ä¸ç¦ç”¨ç¼“å­˜ï¼‰
          const response = await fetch(`${API_BASE}/api/predict`, {
            method: 'POST',
            mode: 'cors',
            cache: 'no-store',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              baseScore,
              finalMultiplier,
              currentLevel: startLevel,
              levelData: futureLevels,
              type,
              triggers: {
                daoyin: trigD,
                fuzhong: trigF,
                yueguang: trigY
              },
              kingCallData: {
                enabled: document.getElementById('kingEnabled')?.checked || false,
                triggers: parseInt($('trigK')?.value) || 4,
                maxTriggers: parseInt($('maxTrigK')?.value) || 4,
                winCount: parseFloat($('finalMulInput')?.value) || 1
              }
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.error) {
            throw new Error(result.message || result.error);
          }
          
          // å¤„ç†é¢„æµ‹ç»“æœ
            if (result.canPass) {
            // å†™å…¥å¿«é€ŸçŠ¶æ€ï¼ˆå…¨éƒ¨é€šå…³æ—¶ä»…æ¸…ç©ºæˆ–æ˜¾ç¤ºä¸€ä¸ªæ€»å¾½ç« ï¼‰
            try {
              const quickEl = type === 'current' ? document.getElementById('currentPredQuickStatus') : document.getElementById('maxPredQuickStatus');
              if (quickEl) {
                quickEl.innerHTML = '<span class="predict-badge ok">å…¨éƒ¨é€šå…³</span>';
              }
            } catch (_) {}
            return '<div class="predict-list"><div class="predict-row"><span class="predict-badge ok">å…¨éƒ¨é€šå…³</span><span class="predict-meta">è¯¥é…ç½®å¯è¶…è¿‡æ‰€æœ‰åç»­å…³å¡</span></div></div>';
          } else {
            // è‹¥æ‰€é€‰å…³å¡å·²å¤„äºï¼ˆæˆ–åœ¨ï¼‰é¦–ä¸ªå¤±è´¥å…³å¡ä¹‹åï¼Œåˆ™å¿«é€ŸçŠ¶æ€ä»…æ˜¾ç¤ºâ€œæ‰€é€‰å…³å¡ï¼šè´¥åŒ—â€
            const startIdx = keyOrder.indexOf(startLevel);
            const failIdx = keyOrder.indexOf(result.firstFailedLevel);
            const selectedHasAlreadyFailed = (failIdx !== -1 && startIdx !== -1 && startIdx >= failIdx);

            if (selectedHasAlreadyFailed) {
              try {
                const quickEl = type === 'current' ? document.getElementById('currentPredQuickStatus') : document.getElementById('maxPredQuickStatus');
                if (quickEl) quickEl.innerHTML = `<span class="predict-badge fail">${startLevel}ï¼šè´¥åŒ—</span>`;
              } catch (_) {}
            }

            let html = '<div class="predict-list">';
            const triggerText = result.triggerText;
            
            // æ˜¾ç¤ºæœ€åä¸€ä¸ªé€šè¿‡çš„å…³å¡ï¼ˆä»…å½“ level/score/target åŒæ—¶å­˜åœ¨ï¼‰
            if (result.lastValidLevel && result.lastValidScore && result.lastValidTarget) {
              const lastValidDisplay = formatTargetScore(result.lastValidScore);
              const lastValidTargetDisplay = formatTargetScore(result.lastValidTarget);
              html += `
                <div class="predict-row">
                  <span class="predict-badge ok">é€šè¿‡</span>
                  <span class="prediction-score-highlight">${lastValidDisplay}</span>
                  <span class="predict-meta">â‰¥ ${lastValidTargetDisplay}</span>
                  <span class="predict-meta">@ ${result.lastValidLevel}</span>
                </div>
              `;
            }
            
            // ç¬¬ä¸€ä¸ªæ— æ³•é€šè¿‡çš„å…³å¡
            const failedDisplay = formatTargetScore(result.firstFailedScore);
            const targetDisplay = formatTargetScore(result.firstFailedTarget);
            html += `
              <div class="predict-row">
                <span class="predict-badge fail">è´¥åŒ—</span>
                <span class="prediction-score-highlight">${failedDisplay}</span>
                <span class="predict-meta">< ${targetDisplay}</span>
                <span class="prediction-level-warning">@ ${result.firstFailedLevel}</span>
              </div>
            `;
            
            // æ ‡é¢˜è¡Œå³ä¾§å¿«é€ŸçŠ¶æ€ï¼šå¤åˆ¶â€œå…³å¡ï¼šé€šè¿‡ / å…³å¡ï¼šè´¥åŒ—â€
            try {
              if (!selectedHasAlreadyFailed) {
                const hasValidPass = !!(result.lastValidLevel && result.lastValidScore && result.lastValidTarget);
                const quickHtml = `
                  ${hasValidPass ? `<span class=\"predict-badge ok\">${result.lastValidLevel}ï¼šé€šè¿‡</span>` : ''}
                  <span class=\"predict-badge fail\">${result.firstFailedLevel}ï¼šè´¥åŒ—</span>
                `;
                const quickEl = type === 'current' ? document.getElementById('currentPredQuickStatus') : document.getElementById('maxPredQuickStatus');
                if (quickEl) quickEl.innerHTML = quickHtml;
              }
            } catch (_) {}

            html += '</div>';
            return html;
          }
          
        } catch (error) {
          console.error('é¢„æµ‹è®¡ç®—å¤±è´¥:', error);
          return `<span style="color: var(--danger);">é¢„æµ‹è®¡ç®—å¤±è´¥: ${error.message}</span>`;
        }
      }
      
      // é˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      let btnListenerAdded = false;
      let updatePredictionListenerAdded = false;
      
      // ç›‘å¬è®¡ç®—æŒ‰é’®ç‚¹å‡»ï¼Œæ›´æ–°é¢„æµ‹
      if (!btnListenerAdded) {
        const btn = document.getElementById('btn');
        if (btn) {
          btn.addEventListener('click', () => {
            // å…ˆæ‰§è¡Œè®¡ç®—ï¼Œç„¶åæ›´æ–°é¢„æµ‹
            computeWithForm().then(() => {
              updatePrediction();
            });
          });
          btnListenerAdded = true;
        }
      }
      
      // ç›‘å¬æ›´æ–°é¢„æµ‹æŒ‰é’®ç‚¹å‡»
      if (!updatePredictionListenerAdded) {
        const updatePredictionBtn = document.getElementById('updatePrediction');
        if (updatePredictionBtn) {
          updatePredictionBtn.addEventListener('click', () => {
            updatePrediction();
          });
          updatePredictionListenerAdded = true;
        }
      }
      
      // æ·»åŠ é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é‡å¤è°ƒç”¨
      let predictionUpdateTimeout = null;
      const debouncedUpdatePrediction = () => {
        if (predictionUpdateTimeout) {
          clearTimeout(predictionUpdateTimeout);
        }
        predictionUpdateTimeout = setTimeout(() => {
          updatePrediction();
        }, 100);
      };
      
      // é¡µé¢åˆå§‹åŒ–æ—¶è§¦å‘å…³å¡é€‰æ‹©è”åŠ¨
      document.addEventListener('DOMContentLoaded', () => {
        // Tabåˆ‡æ¢åŠŸèƒ½
        let currentTab = 'hacker';
        const moonlightToggle = document.getElementById('moonlightToggle');
        const moonlightToggleText = document.getElementById('moonlightToggleText');
        
        // é¡µé¢åˆå§‹åŒ–æ—¶æ˜¾ç¤ºæœˆå…‰å’Œè´Ÿé‡å¼€å…³ï¼ˆå› ä¸ºé»˜è®¤æ˜¯é»‘å®¢æµæ´¾æ ‡ç­¾é¡µï¼‰
        const tabMoonlightToggle = document.getElementById('tabMoonlightToggle');
        const tabFuzhongToggle = document.getElementById('tabFuzhongToggle');
        if (tabMoonlightToggle) tabMoonlightToggle.style.display = 'block';
        if (tabFuzhongToggle) tabFuzhongToggle.style.display = 'block';
        
        // Ant Designé£æ ¼Tabäº‹ä»¶ç›‘å¬
        document.querySelectorAll('.antd-tab-tab').forEach(tabElement => {
          tabElement.addEventListener('click', () => {
            const tab = tabElement.dataset.tab;
            currentTab = tab;
            
            // æ›´æ–°tabçŠ¶æ€
            document.querySelectorAll('.antd-tab-tab').forEach(tab => tab.classList.remove('antd-tab-tab-active'));
            tabElement.classList.add('antd-tab-tab-active');
            
            // æ˜¾ç¤º/éšè—æœˆå…‰å’Œè´Ÿé‡å¼€å…³
            const tabMoonlightToggle = document.getElementById('tabMoonlightToggle');
            const tabFuzhongToggle = document.getElementById('tabFuzhongToggle');
            if (tab === 'hacker') {
              tabMoonlightToggle.style.display = 'block';
              tabFuzhongToggle.style.display = 'block';
            } else {
              tabMoonlightToggle.style.display = 'none';
              tabFuzhongToggle.style.display = 'none';
              // åˆ‡æ¢åˆ°æŒ‡æ•°ä¸‰å¤§ä»¶æ—¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºæœˆå…‰å’Œè´Ÿé‡ç›¸å…³å‚æ•°
              if (tab === 'index') {
                const moonlightToggle = document.getElementById('moonlightToggle');
                if (moonlightToggle) {
                  moonlightToggle.checked = true;
                  toggleMoonlightBlocks(true);
                }
                const fuzhongToggle = document.getElementById('fuzhongToggle');
                if (fuzhongToggle) {
                  fuzhongToggle.checked = true;
                  toggleFuzhongBlocks(true);
                }
                renderPage5();
              }
            }
          });
        });
        
        // æœˆå…‰å¼€å…³äº‹ä»¶ç›‘å¬
        if (moonlightToggle) {
          moonlightToggle.addEventListener('change', (e) => {
            const enabled = e.target.checked;
            if (moonlightToggleText) {
              moonlightToggleText.textContent = enabled ? 'æœˆå…‰' : 'æœˆå…‰';
            }
            
            // æ§åˆ¶æœˆå…‰ç›¸å…³åŒºå—çš„æ˜¾ç¤º/éšè—
            toggleMoonlightBlocks(enabled);
            
            // å¦‚æœå…³é—­æœˆå…‰ï¼Œå°†æœˆå…‰è§¦å‘æ¬¡æ•°è®¾ä¸º0
            if (!enabled) {
              document.getElementById('trigY').value = '0';
              document.getElementById('theoY').value = '0';
            }
            
            // é‡æ–°æ¸²æŸ“å…³å¡ç›®æ ‡åˆ†æ¨¡å—ä»¥æ›´æ–°æœˆå…‰åˆ—çš„æ˜¾ç¤º
            renderPage5();
            
            // è§¦å‘è®¡ç®—æ›´æ–°
            if (document.getElementById('btn')) {
              document.getElementById('btn').click();
            }
          });
        }
        
        // è´Ÿé‡å¼€å…³äº‹ä»¶ç›‘å¬
        const fuzhongToggle = document.getElementById('fuzhongToggle');
        const fuzhongToggleText = document.getElementById('fuzhongToggleText');
        if (fuzhongToggle) {
          fuzhongToggle.addEventListener('change', (e) => {
            const enabled = e.target.checked;
            if (fuzhongToggleText) {
              fuzhongToggleText.textContent = enabled ? 'è´Ÿé‡' : 'è´Ÿé‡';
            }
            
            // æ§åˆ¶è´Ÿé‡ç›¸å…³åŒºå—çš„æ˜¾ç¤º/éšè—
            toggleFuzhongBlocks(enabled);
            
            // å¦‚æœå…³é—­è´Ÿé‡ï¼Œå°†è´Ÿé‡è§¦å‘æ¬¡æ•°è®¾ä¸º0
            if (!enabled) {
              document.getElementById('trigF').value = '0';
              document.getElementById('theoF').value = '0';
            }
            
            // é‡æ–°æ¸²æŸ“å…³å¡ç›®æ ‡åˆ†æ¨¡å—ä»¥æ›´æ–°è´Ÿé‡åˆ—çš„æ˜¾ç¤º
            renderPage5();
            
            // è§¦å‘è®¡ç®—æ›´æ–°
            if (document.getElementById('btn')) {
              document.getElementById('btn').click();
            }
          });
        }
        
        // æ§åˆ¶æœˆå…‰ç›¸å…³åŒºå—çš„æ˜¾ç¤º/éšè—
        function toggleMoonlightBlocks(enabled) {
          const moonlightBlocks = [
            'values', // æ•°å€¼è®¾ç½®ä¸­çš„æœˆå…‰ç•ªæ•°
            'triggers' // è§¦å‘æ¬¡æ•°ä¸­çš„æœˆå…‰ç›¸å…³éƒ¨åˆ†
          ];
          
          moonlightBlocks.forEach(blockId => {
            const block = document.querySelector(`[data-block="${blockId}"]`);
            if (block) {
              if (!enabled) {
                // éšè—æœˆå…‰ç›¸å…³å†…å®¹
                const moonlightInputs = block.querySelectorAll('#yueguang, #trigY, #theoY');
                const moonlightLabels = block.querySelectorAll('label[for="yueguang"], label[for="trigY"], label[for="theoY"]');
                const moonlightDisplays = block.querySelectorAll('#yueguang_display');
                
                [...moonlightInputs, ...moonlightLabels, ...moonlightDisplays].forEach(el => {
                  if (el) el.style.display = 'none';
                });
                
                // éšè—æœˆå…‰ç›¸å…³çš„è¡¨æ ¼è¡Œ
                const allRows = block.querySelectorAll('tr');
                allRows.forEach(row => {
                  if (row.textContent.includes('æœˆå…‰')) {
                    row.style.display = 'none';
                  }
                });
              } else {
                // æ˜¾ç¤ºæœˆå…‰ç›¸å…³å†…å®¹
                const moonlightInputs = block.querySelectorAll('#yueguang, #trigY, #theoY');
                const moonlightLabels = block.querySelectorAll('label[for="yueguang"], label[for="trigY"], label[for="theoY"]');
                const moonlightDisplays = block.querySelectorAll('#yueguang_display');
                
                [...moonlightInputs, ...moonlightLabels, ...moonlightDisplays].forEach(el => {
                  if (el) el.style.display = '';
                });
                
                // æ˜¾ç¤ºæœˆå…‰ç›¸å…³çš„è¡¨æ ¼è¡Œ
                const moonlightRows = block.querySelectorAll('tr');
                moonlightRows.forEach(row => {
                  if (row.textContent.includes('æœˆå…‰')) {
                    row.style.display = '';
                  }
                });
              }
            }
          });
        }
        
        // æ§åˆ¶è´Ÿé‡ç›¸å…³åŒºå—çš„æ˜¾ç¤º/éšè—
        function toggleFuzhongBlocks(enabled) {
          const fuzhongBlocks = [
            'values', // æ•°å€¼è®¾ç½®ä¸­çš„è´Ÿé‡ç•ªæ•°
            'triggers' // è§¦å‘æ¬¡æ•°ä¸­çš„è´Ÿé‡ç›¸å…³éƒ¨åˆ†
          ];
          
          fuzhongBlocks.forEach(blockId => {
            const block = document.querySelector(`[data-block="${blockId}"]`);
            if (block) {
              if (!enabled) {
                // éšè—è´Ÿé‡ç›¸å…³å†…å®¹
                const fuzhongInputs = block.querySelectorAll('#fuzhong, #trigF, #theoF');
                const fuzhongLabels = block.querySelectorAll('label[for="fuzhong"], label[for="trigF"], label[for="theoF"]');
                const fuzhongDisplays = block.querySelectorAll('#fuzhong_display');
                
                [...fuzhongInputs, ...fuzhongLabels, ...fuzhongDisplays].forEach(el => {
                  if (el) el.style.display = 'none';
                });
                
                // éšè—è´Ÿé‡ç›¸å…³çš„è¡¨æ ¼è¡Œ
                const allRows = block.querySelectorAll('tr');
                allRows.forEach(row => {
                  if (row.textContent.includes('è´Ÿé‡')) {
                    row.style.display = 'none';
                  }
                });
              } else {
                // æ˜¾ç¤ºè´Ÿé‡ç›¸å…³å†…å®¹
                const fuzhongInputs = block.querySelectorAll('#fuzhong, #trigF, #theoF');
                const fuzhongLabels = block.querySelectorAll('label[for="fuzhong"], label[for="trigF"], label[for="theoF"]');
                const fuzhongDisplays = block.querySelectorAll('#fuzhong_display');
                
                [...fuzhongInputs, ...fuzhongLabels, ...fuzhongDisplays].forEach(el => {
                  if (el) el.style.display = '';
                });
                
                // æ˜¾ç¤ºè´Ÿé‡ç›¸å…³çš„è¡¨æ ¼è¡Œ
                const fuzhongRows = block.querySelectorAll('tr');
                fuzhongRows.forEach(row => {
                  if (row.textContent.includes('è´Ÿé‡')) {
                    row.style.display = '';
                  }
                });
              }
            }
          });
        }
        
        // åˆå§‹åŒ–æ—¶è§¦å‘å…³å¡é€‰æ‹©çš„changeäº‹ä»¶ï¼Œç¡®ä¿è”åŠ¨ç”Ÿæ•ˆ
        const levelSelect = document.getElementById('levelSelect');
        if (levelSelect) {
          levelSelect.dispatchEvent(new Event('change'));
        }
        
        // å°ç« æ¶ˆå¤±è®¡æ•°åŠŸèƒ½
        let sealCounter = 0;
        let selectedSealLevel = '';
        let selectedGrowthType = '';
        let originalSealValue = 0;
        
        // å°†å˜é‡æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿å…¶ä»–å‡½æ•°å¯ä»¥è®¿é—®
        window.selectedSealLevel = selectedSealLevel;
        
        // LolipopéšæœºåŠ¨ç”»åŠŸèƒ½ - 20ç§åŠ¨ç”»æ•ˆæœ
        const lolipopAnimations = [
          { name: 'lolipop-bounce', duration: '1.5s', timing: 'ease-in-out' },
          { name: 'lolipop-spin', duration: '2s', timing: 'linear' },
          { name: 'lolipop-wiggle', duration: '0.8s', timing: 'ease-in-out' },
          { name: 'lolipop-pulse', duration: '1.2s', timing: 'ease-in-out' },
          { name: 'lolipop-float', duration: '2.5s', timing: 'ease-in-out' },
          { name: 'lolipop-shake', duration: '1s', timing: 'ease-in-out' },
          { name: 'lolipop-zoom', duration: '1.8s', timing: 'ease-in-out' },
          { name: 'lolipop-swing', duration: '1.3s', timing: 'ease-in-out' },
          { name: 'lolipop-flip', duration: '2.2s', timing: 'ease-in-out' },
          { name: 'lolipop-dance', duration: '2s', timing: 'ease-in-out' },
          { name: 'lolipop-twist', duration: '1.6s', timing: 'ease-in-out' },
          { name: 'lolipop-jump', duration: '0.6s', timing: 'ease-in-out' },
          { name: 'lolipop-rock', duration: '1.4s', timing: 'ease-in-out' },
          { name: 'lolipop-glide', duration: '2.8s', timing: 'ease-in-out' },
          { name: 'lolipop-squeeze', duration: '1.1s', timing: 'ease-in-out' },
          { name: 'lolipop-roll', duration: '2.3s', timing: 'ease-in-out' },
          { name: 'lolipop-wave', duration: '1.7s', timing: 'ease-in-out' },
          { name: 'lolipop-bob', duration: '0.9s', timing: 'ease-in-out' },
          { name: 'lolipop-sway', duration: '1.5s', timing: 'ease-in-out' },
          { name: 'lolipop-elastic', duration: '2.5s', timing: 'ease-in-out' }
        ];
        
        let currentAnimationIndex = 0;
        let isPaused = false;
        let animationTimeout;
        
        function startRandomLolipopAnimation() {
          const lolipopIcon = document.getElementById('lolipopIcon');
          if (!lolipopIcon) return;
          
          function playRandomAnimation() {
            if (isPaused) return; // å¦‚æœæš‚åœï¼Œä¸æ’­æ”¾åŠ¨ç”»
            
            const animation = lolipopAnimations[currentAnimationIndex];
            lolipopIcon.style.animation = `${animation.name} ${animation.duration} ${animation.timing}`;
            
            currentAnimationIndex = (currentAnimationIndex + 1) % lolipopAnimations.length;
            
            // è®¾ç½®ä¸‹ä¸€ä¸ªåŠ¨ç”»çš„å»¶è¿Ÿæ—¶é—´ï¼ˆéšæœº1-3ç§’ï¼‰
            const animationDuration = parseFloat(animation.duration) * 1000;
            const nextDelay = Math.random() * 2000 + 1000;
            
            animationTimeout = setTimeout(() => {
              if (!isPaused) {
                lolipopIcon.style.animation = 'none';
                setTimeout(() => {
                  playRandomAnimation();
                }, 100);
              }
            }, animationDuration + nextDelay);
          }
          
          // ç‚¹å‡»lolipopå›¾æ ‡æš‚åœ/ç»§ç»­åŠ¨ç”»
          lolipopIcon.addEventListener('click', () => {
            isPaused = !isPaused;
            
            if (isPaused) {
              // æš‚åœï¼šæ¸…é™¤åŠ¨ç”»å’Œå®šæ—¶å™¨
              lolipopIcon.style.animation = 'none';
              if (animationTimeout) {
                clearTimeout(animationTimeout);
              }
              lolipopIcon.style.opacity = '0.5'; // é™ä½é€æ˜åº¦è¡¨ç¤ºæš‚åœçŠ¶æ€
            } else {
              // ç»§ç»­ï¼šæ¢å¤åŠ¨ç”»
              lolipopIcon.style.opacity = '0.7'; // æ¢å¤é€æ˜åº¦
              setTimeout(() => {
                playRandomAnimation();
              }, 100);
            }
          });
          
          // å¼€å§‹ç¬¬ä¸€ä¸ªåŠ¨ç”»
          playRandomAnimation();
        }
        
        // å¯åŠ¨lolipopåŠ¨ç”»
        startRandomLolipopAnimation();
        
        // åˆå§‹åŒ–å°ç« è®¡æ•°å™¨å…³å¡é€‰æ‹©å™¨
        const sealCounterLevel = document.getElementById('sealCounterLevel');
        if (sealCounterLevel && levelSelect) {
          // å¤åˆ¶å…³å¡é€‰é¡¹åˆ°å°ç« è®¡æ•°å™¨
          Array.from(levelSelect.options).forEach(option => {
            if (option.value) {
              const newOption = document.createElement('option');
              newOption.value = option.value;
              newOption.textContent = option.textContent;
              sealCounterLevel.appendChild(newOption);
            }
          });
        }
        
        // å°ç« è®¡æ•°å™¨å…³å¡é€‰æ‹©å˜åŒ–
        sealCounterLevel.addEventListener('change', () => {
          const confirmBtn = document.getElementById('confirmSealLevel');
          const hasValidSelection = sealCounterLevel.value && sealCounterLevel.value !== '';
          
          if (hasValidSelection) {
            confirmBtn.disabled = false;
            confirmBtn.style.backgroundColor = '';
            confirmBtn.style.color = '';
            confirmBtn.style.cursor = '';
          } else {
            confirmBtn.disabled = true;
            confirmBtn.style.backgroundColor = '#ccc';
            confirmBtn.style.color = '#666';
            confirmBtn.style.cursor = 'not-allowed';
          }
          
          // é‡æ–°é€‰æ‹©å…³å¡æ—¶è‡ªåŠ¨æ¸…é›¶
          if (sealCounterLevel.value) {
            sealCounter = 0;
            selectedSealLevel = '';
            window.selectedSealLevel = ''; // åŒæ­¥æ¸…ç©ºå…¨å±€å˜é‡
            selectedGrowthType = '';
            originalSealValue = 0;
            
            document.getElementById('sealCounterDisplay').style.display = 'none';
            document.getElementById('sealCounterNumber').textContent = '0';
            document.getElementById('sealValueChange').textContent = '0 â†’ 0';
          }
        });
        
        // ç¡®è®¤å…³å¡æŒ‰é’®
        document.getElementById('confirmSealLevel').addEventListener('click', () => {
          if (sealCounterLevel.value) {
            selectedSealLevel = sealCounterLevel.value;
            window.selectedSealLevel = selectedSealLevel; // åŒæ­¥åˆ°å…¨å±€å˜é‡
            // è·å–å¢é•¿ç±»å‹
            selectedGrowthType = getGrowthTypeForLevel(selectedSealLevel);
            // è·å–åŸå§‹ç›—å°å€¼
            originalSealValue = getCurrentSealValue();
            
            // ç›´æ¥æ˜¾ç¤ºå°ç« è®¡æ•°æ˜¾ç¤ºåŒºåŸŸ
            document.getElementById('sealCounterDisplay').style.display = 'block';
            if (window.updateSealCounterDisplay) {
              window.updateSealCounterDisplay();
            }
          }
        });
        
        // é‡ç½®æŒ‰é’®
        document.getElementById('resetSealCounter').addEventListener('click', () => {
          sealCounter = 0;
          selectedSealLevel = '';
          window.selectedSealLevel = ''; // åŒæ­¥æ¸…ç©ºå…¨å±€å˜é‡
          selectedGrowthType = '';
          originalSealValue = 0;
          
          sealCounterLevel.value = '';
          document.getElementById('confirmSealLevel').disabled = true;
          document.getElementById('sealCounterDisplay').style.display = 'none';
          document.getElementById('sealCounterNumber').textContent = '0';
          document.getElementById('sealValueChange').textContent = '0 â†’ 0';
        });
        
        // æœ¨é±¼ç‚¹å‡»äº‹ä»¶
        document.getElementById('woodenFish').addEventListener('click', () => {
          if (selectedSealLevel) {
            sealCounter++;
            window.updateSealCounterDisplay();
            window.updateSealValue();
            
            // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
            const woodenFish = document.getElementById('woodenFish');
            woodenFish.classList.add('hit');
            setTimeout(() => {
              woodenFish.classList.remove('hit');
            }, 300);
          }
        });
        
        // è·å–å…³å¡çš„å¢é•¿ç±»å‹
        function getGrowthTypeForLevel(level) {
          const levelIndex = keyOrder.indexOf(level);
          if (levelIndex === -1) return 'æ™®é€šç›—å°';
          
          // ä½¿ç”¨ä¸å…³å¡ç›®æ ‡åˆ†æ¨¡å—ç›¸åŒçš„é€»è¾‘æ¥è·å–å¢é•¿ç±»å‹
          return resolveTypeAtIndex('d', levelIndex);
        }
        
        // è·å–å½“å‰ç›—å°å€¼
        function getCurrentSealValue() {
          const all = computeRecommendedAll();
          const levelData = all[selectedSealLevel];
          return levelData ? levelData.actualD || 0 : 0;
        }
        
        // æ›´æ–°å…³å¡ç›®æ ‡åˆ†æ¨¡å—ä¸­å¯¹åº”å…³å¡çš„ç›—å°å€¼
        function updateLevelTargetDisplay(level, newValue) {
          // æ›´æ–°levelsStateä¸­çš„æ‰‹åŠ¨å€¼
          levelsState[level] = levelsState[level] || {};
          levelsState[level].manuD = newValue.toString();
          
          // é‡æ–°æ¸²æŸ“å…³å¡ç›®æ ‡åˆ†æ¨¡å—ï¼Œè¿™ä¼šé‡æ–°è®¡ç®—æ‰€æœ‰å…³å¡çš„æ¨èå€¼
          renderPage5();
          
          // å¦‚æœå½“å‰é€‰æ‹©çš„å…³å¡æ˜¯åŒä¸€ä¸ªï¼Œä¹Ÿè¦æ›´æ–°æ•°å€¼è®¾ç½®æ¨¡å—
          if (document.getElementById('levelSelect').value === level) {
            document.getElementById('daoyin').value = newValue.toFixed(6);
            updateStampDisplay();
          }
        }
        
        // æ›´æ–°è®¡æ•°å™¨æ˜¾ç¤º
        window.updateSealCounterDisplay = function() {
          document.getElementById('sealCounterNumber').textContent = sealCounter;
          document.getElementById('currentSealLevel').textContent = selectedSealLevel;
          document.getElementById('currentGrowthType').textContent = selectedGrowthType;
        };
        
        // æ˜¾ç¤ºå°ç« è®¡æ•°æç¤º
        function showSealCounterNotification() {
          // åˆ›å»ºæç¤ºå…ƒç´ 
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
            animation: slideIn 0.3s ease-out;
          `;
          notification.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 4px;">âš ï¸ å¢é•¿ç±»å‹å·²è°ƒæ•´</div>
            <div>å»ºè®®æ ¸å¯¹é‡æ–°è®¡ç®—å°ç« è®¡æ•°</div>
          `;
          
          // æ·»åŠ åŠ¨ç”»æ ·å¼
          if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
              @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
              }
            `;
            document.head.appendChild(style);
          }
          
          // æ·»åŠ åˆ°é¡µé¢
          document.body.appendChild(notification);
          
          // 3ç§’åè‡ªåŠ¨ç§»é™¤
          setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 300);
          }, 3000);
        }
        
        // æ›´æ–°ç›—å°å€¼æ˜¾ç¤º
        window.updateSealValue = function() {
          const multiplier = window.getMultiplierForGrowthType(selectedGrowthType);
          const newValue = originalSealValue * Math.pow(multiplier, sealCounter);
          
          // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤ºï¼Œå¤§äº10000æ—¶ä½¿ç”¨ä¸­å›½å¤§æ•°å­—å•ä½
          const formatNumberForDisplay = (num) => {
            if (num >= 10000) {
              return formatChinaJiLocal(num.toString(), 2);
            }
            return num.toFixed(2);
          };
          
          const originalDisplay = formatNumberForDisplay(originalSealValue);
          const newDisplay = formatNumberForDisplay(newValue);
          document.getElementById('sealValueChange').textContent = `${originalDisplay} â†’ ${newDisplay}`;
          
          // æ›´æ–°å…³å¡ç›®æ ‡åˆ†æ¨¡å—ä¸­å¯¹åº”å…³å¡çš„ç›—å°å€¼
          updateLevelTargetDisplay(selectedSealLevel, newValue);
        };
        
        // æ ¹æ®å¢é•¿ç±»å‹è·å–å€æ•°
        window.getMultiplierForGrowthType = function(growthType) {
          switch (growthType) {
            case 'è†¨èƒ€ç›—å°':
            case 'è†¨èƒ€ç›—å°åƒå¡ç»´':
              return 1.3 * 1.3; // 1.69
            case 'æ™®é€šç›—å°':
              return 1.3;
            case 'å¤©ä½¿ç›—å°':
              return 1.6;
            default:
              return 1.3;
          }
        };

        // åˆå§‹åŒ–é…ç½®åŒºå—æ‹–æ‹½è°ƒæ•´å®½åº¦
        const grid = document.getElementById('blocksGrid');
        let dragging = null; // { block, startX, startBasis, side }
        function onMove(e){
          if (!dragging) return;
          const dx = e.clientX - dragging.startX;
          const block = dragging.block;
          const containerWidth = grid.getBoundingClientRect().width;
          let basisPx = dragging.startBasis;
          basisPx += (dragging.side === 'right' ? dx : -dx);
          const minPx = 180; // æœ€å°å®½åº¦
          const maxPx = containerWidth - 180; // é˜²æ­¢è¿‡å¤§
          basisPx = Math.max(minPx, Math.min(maxPx, basisPx));
          block.style.flex = `0 0 ${basisPx}px`;
        }
        function onUp(){
          if (!dragging) return;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          dragging = null;
        }
        grid?.querySelectorAll('.config-block .resize-handle').forEach(h => {
          h.addEventListener('mousedown', (e)=>{
            const block = e.currentTarget.closest('.config-block');
            if (!block) return;
            const rect = block.getBoundingClientRect();
            const side = e.currentTarget.getAttribute('data-resize') === 'left' ? 'left' : 'right';
            dragging = {
              block,
              startX: e.clientX,
              startBasis: rect.width,
              side
            };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
            e.preventDefault();
          });
        });
      });
      
    </script>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <div id="music-player" class="music-player">
      <div class="music-player-header">
        <div class="music-info">
          <div class="album-cover" id="album-cover">
            <img id="cover-image" src="" alt="ä¸“è¾‘å°é¢">
          </div>
          <div class="song-info">
            <div class="song-title">Loading...</div>
            <div class="song-artist">16Pome</div>
          </div>
        </div>
        <div class="music-controls">
          <button id="play-pause-btn" class="control-btn" title="æ’­æ”¾/æš‚åœ">â–¶ï¸</button>
          <button id="toggle-lyrics-btn" class="control-btn" title="æ­Œè¯æ˜¾ç¤º/éšè—">ğŸ“</button>
          <button id="toggle-player-btn" class="control-btn" title="å±•å¼€/æŠ˜å ">ğŸ”½</button>
          <button id="close-player-btn" class="control-btn" title="å…³é—­æ’­æ”¾å™¨">âœ–</button>
        </div>
      </div>
      
      <div class="music-player-body" id="music-player-body" style="display: none;">
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="time-display">
            <span id="current-time">0:00</span>
            <span id="total-time">0:00</span>
          </div>
        </div>
        
        <div class="volume-container">
          <span>ğŸ”Š</span>
          <input type="range" id="volume-slider" min="0" max="100" value="50">
        </div>
        
        <div class="lyrics-container" id="lyrics-container" style="display: none;">
          <div class="lyrics-content" id="lyrics-content">
            <!-- æ­Œè¯å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </div>
        </div>
      </div>
      <div id="music-resizer" class="music-resizer" title="æ‹–æ‹½è°ƒæ•´å®½åº¦"></div>
      
      <audio id="audio-player" preload="metadata">
        <source src="src/assets/music/äººç”Ÿä¹Ÿè®¸.MP3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
      </audio>
    </div>

    <!-- æœ€å°åŒ–åœ†å½¢å…¥å£ -->
    <div id="music-mini" class="music-mini" title="æ‰“å¼€æ’­æ”¾å™¨">ğŸµ</div>

    <style>
      /* éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
      .music-player {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 520px;
        max-width: calc(100vw - 40px);
        background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 1000;
        transition: all 0.3s ease;
        font-family: 'Microsoft YaHei', sans-serif;
      }
      /* æœªä¿å­˜ä¿®æ”¹çš„é«˜äº®æ ·å¼ */
      .modified-input {
        outline: 2px solid #f59e0b; /* amber-500 */
        background: rgba(245, 158, 11, 0.08);
      }

      /* æœ€å°åŒ–åœ†å½¢å›¾æ ‡æŒ‰é’® */
      .music-mini {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 54px;
        height: 54px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color, #667eea) 0%, var(--secondary-color, #764ba2) 100%);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 22px;
        cursor: pointer;
        z-index: 1000;
        border: 1px solid rgba(255,255,255,0.2);
        transition: transform 0.2s ease, opacity 0.2s ease;
        opacity: 0.7;
      }
      .music-mini:hover { transform: scale(1.06); opacity: 1; }

      /* å·¦ä¾§æ‹–æ‹½æ‰‹æŸ„ï¼Œç”¨äºè°ƒæ•´æ’­æ”¾å™¨å®½åº¦ */
      .music-resizer {
        position: absolute;
        top: 0;
        left: 0;
        width: 10px;
        height: 100%;
        cursor: ew-resize;
        background: linear-gradient(to right, rgba(255,255,255,0.18), rgba(255,255,255,0));
        border-top-left-radius: 15px;
        border-bottom-left-radius: 15px;
      }

      .music-player-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        color: white;
      }

      .music-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
      }

      .album-cover {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        overflow: hidden;
        position: relative;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        animation: rotate 10s linear infinite;
        animation-play-state: paused;
      }

      .album-cover.playing {
        animation-play-state: running;
      }

      .album-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }

      @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .song-info {
        flex: 1;
      }

      .song-title {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 2px;
      }

      .song-artist {
        font-size: 12px;
        opacity: 0.8;
      }

      .music-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      /* æ­Œæ›²é€‰æ‹©å™¨æ ·å¼ï¼Œé€‚é…é¡µé¢é£æ ¼ */
      #music-select {
        appearance: none;
        background: rgba(255, 255, 255, 0.18);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        outline: none;
        transition: all 0.2s ease;
      }
      #music-select:hover {
        background: rgba(255, 255, 255, 0.28);
        border-color: rgba(255, 255, 255, 0.4);
      }
      #music-select option {
        color: #111;
        background: #fff;
      }

      .control-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
      }

      .control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      .music-player-body {
        padding: 0 15px 15px;
        color: white;
      }

      .progress-container {
        margin-bottom: 15px;
      }

      .progress-bar {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        cursor: pointer;
        margin-bottom: 8px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-color, #ff6b6b), var(--highlight-color, #4ecdc4));
        border-radius: 2px;
        width: 0%;
        transition: width 0.1s ease;
      }

      .time-display {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        opacity: 0.8;
      }

      .volume-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .volume-container input[type="range"] {
        flex: 1;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        outline: none;
        cursor: pointer;
      }

      .volume-container input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 12px;
        height: 12px;
        background: white;
        border-radius: 50%;
        cursor: pointer;
      }

      .lyrics-container {
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 10px;
      }

      .lyrics-content {
        font-size: 13px;
        line-height: 1.6;
        text-align: center;
      }

      .lyrics-content .verse {
        margin-bottom: 8px;
        opacity: 0.7;
      }

      .lyrics-content .verse.empty {
        height: 16px;
        margin-bottom: 4px;
        opacity: 0;
      }

      .lyrics-content .verse.active {
        opacity: 1;
        font-weight: bold;
        color: var(--accent-color, #ff6b6b);
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 4px 8px;
        margin: 2px 0;
        transform: scale(1.05);
      }

      .lyrics-content .verse.highlight {
        background: rgba(var(--accent-color-rgb, 255, 107, 107), 0.3);
        padding: 2px 6px;
        border-radius: 4px;
      }

      /* æ»šåŠ¨æ¡æ ·å¼ */
      .lyrics-container::-webkit-scrollbar {
        width: 4px;
      }

      .lyrics-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
      }

      .lyrics-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
      }

      .lyrics-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .music-player {
          width: calc(100vw - 40px);
          right: 20px;
          left: 20px;
        }
      }
    </style>

    <script>
      // éŸ³ä¹æ’­æ”¾å™¨åŠŸèƒ½
      (function() {
        const audio = document.getElementById('audio-player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const toggleLyricsBtn = document.getElementById('toggle-lyrics-btn');
        const togglePlayerBtn = document.getElementById('toggle-player-btn');
        const closePlayerBtn = document.getElementById('close-player-btn');
        const musicMini = document.getElementById('music-mini');
        const musicResizer = document.getElementById('music-resizer');
        const musicPlayerBody = document.getElementById('music-player-body');
        const lyricsContainer = document.getElementById('lyrics-container');
        const progressBar = document.getElementById('progress-bar');
        const progressFill = document.getElementById('progress-fill');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const volumeSlider = document.getElementById('volume-slider');
        const albumCover = document.getElementById('album-cover');
          const coverImage = document.getElementById('cover-image');
          const lyricsContent = document.getElementById('lyrics-content');
          const songTitleEl = document.querySelector('.song-title');
          const controlsEl = document.querySelector('.music-controls');

          // æ’­æ”¾æ¨¡å¼æŒ‰é’®ä¸æ­Œæ›²é€‰æ‹©å™¨ï¼ˆUIåŠ¨æ€æ’å…¥ï¼‰
          const playModeBtn = document.createElement('button');
          playModeBtn.className = 'control-btn';
          playModeBtn.id = 'play-mode-btn';
          playModeBtn.title = 'æ’­æ”¾æ¨¡å¼ï¼šå•æ›²(ğŸ”‚)/åˆ—è¡¨(ğŸ”)/éšæœº(ğŸ”€)';
          controlsEl.appendChild(playModeBtn);

          const musicSelect = document.createElement('select');
          musicSelect.id = 'music-select';
          musicSelect.style.cssText = 'background: rgba(255,255,255,0.2); color:#fff; border:none; border-radius:6px; padding:4px 6px; max-width:140px;';
          controlsEl.appendChild(musicSelect);

        // æŠ¤èº«ç¬¦å›¾ç‰‡åˆ—è¡¨
        const amuletImages = [
          'fu_0001.png', 'fu_0002.png', 'fu_0004.png', 'fu_0006.png', 'fu_0007.png', 'fu_0009.png',
          'fu_0011.png', 'fu_0012.png', 'fu_0013.png', 'fu_0014.png', 'fu_0016.png', 'fu_0017.png',
          'fu_0018.png', 'fu_0019.png', 'fu_0020.png', 'fu_0023.png', 'fu_0024.png', 'fu_0025.png',
          'fu_0027.png', 'fu_0028.png', 'fu_0029.png', 'fu_0030.png', 'fu_0031.png', 'fu_0032.png',
          'fu_0033.png', 'fu_0035.png', 'fu_0036.png', 'fu_0037.png', 'fu_0038.png', 'fu_0040.png',
          'fu_0042.png', 'fu_0046.png', 'fu_0047.png', 'fu_0049.png', 'fu_0058.png', 'fu_0064.png',
          'fu_0065.png', 'fu_0066.png', 'fu_0067.png', 'fu_0071.png', 'fu_0074.png', 'fu_0075.png',
          'fu_0076.png', 'fu_0077.png', 'fu_0079.png', 'fu_0080.png', 'fu_0089.png', 'fu_0090.png',
          'fu_0091.png', 'fu_0092.png', 'fu_0093.png', 'fu_0094.png', 'fu_0095.png', 'fu_0096.png',
          'fu_0097.png', 'fu_0098.png', 'fu_0099.png', 'fu_0100.png', 'fu_0101.png', 'fu_0102.png',
          'fu_0105.png', 'fu_0106.png', 'fu_0108.png', 'fu_0110.png', 'fu_0111.png', 'fu_0112.png',
          'fu_0113.png', 'fu_0115.png', 'fu_0116.png', 'fu_0118.png', 'fu_0119.png', 'fu_0120.png',
          'fu_0122.png', 'fu_0124.png', 'fu_0126.png', 'fu_0127.png', 'fu_0128.png', 'fu_0129.png',
          'fu_0130.png', 'fu_0131.png', 'fu_0132.png', 'fu_0133.png', 'fu_0134.png', 'fu_0135.png',
          'fu_0136.png', 'fu_0137.png', 'fu_0138.png', 'fu_0139.png', 'fu_0141.png', 'fu_0142.png',
          'fu_0143.png', 'fu_0144.png', 'fu_0145.png', 'fu_0146.png', 'fu_0147.png', 'fu_0148.png',
          'fu_0149.png', 'fu_0151.png', 'fu_0152.png', 'fu_0153.png', 'fu_0154.png', 'fu_0156.png',
          'fu_0157.png', 'fu_0158.png', 'fu_0159.png', 'fu_0160.png', 'fu_0161.png', 'fu_0162.png',
          'fu_0163.png', 'fu_0164.png', 'fu_0165.png', 'fu_0166.png', 'fu_0167.png', 'fu_0168.png',
          'fu_0169.png', 'fu_0170.png', 'fu_0171.png', 'fu_0172.png', 'fu_0173.png', 'fu_0174.png',
          'fu_0175.png', 'fu_0176.png', 'fu_0177.png', 'fu_0178.png', 'fu_0179.png', 'fu_0180.png',
          'fu_0181.png', 'fu_0182.png', 'fu_0183.png', 'fu_0184.png', 'fu_0185.png', 'fu_0186.png',
          'fu_0187.png', 'fu_0188.png', 'fu_0189.png', 'fu_0190.png', 'fu_0191.png', 'fu_0192.png',
          'fu_0193.png', 'fu_0194.png', 'fu_0195.png'
        ];

        // æ­Œè¯æ•°æ® - ä»LRCæ–‡ä»¶è§£æ
        let lyrics = [];
        
        // è§£æLRCæ–‡ä»¶
          async function parseLRCFile() {
          try {
             // åŸºäºå½“å‰éŸ³é¢‘æºå°è¯•åŠ è½½åŒå .lrc æ–‡ä»¶
             const currentSource = audio.querySelector('source')?.getAttribute('src') || '';
             const base = currentSource ? currentSource.replace(/\.[^.]+$/, '') : 'src/assets/music/äººç”Ÿä¹Ÿè®¸';
             // å…ˆè¯¢é—®åç«¯æ˜¯å¦å­˜åœ¨ LRCï¼Œé¿å…ç›´æ¥ 404
             const headResp = await fetch(`/api/music/has-lrc?base=${encodeURIComponent(base)}`);
             const headJson = await headResp.json().catch(()=>({ exists:false }));
             if (!headJson.exists) {
               lyrics = [ { time: 0, text: 'è¯¥éŸ³ä¹æš‚æ— æ­Œè¯', type: 'verse' } ];
               return;
             }
             const lrcPath = `${base}.lrc`;
             const response = await fetch(lrcPath, { cache: 'no-store' });
             if (!response.ok) throw new Error('LRC not found');
            const lrcText = await response.text();
            const lines = lrcText.split('\n');
            
            lyrics = [];
            for (const line of lines) {
              const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2})\](.*)/);
              if (match) {
                const minutes = parseInt(match[1]);
                const seconds = parseInt(match[2]);
                const centiseconds = parseInt(match[3]);
                const time = minutes * 60 + seconds + centiseconds / 100;
                const text = match[4].trim();
                
                // ä¿ç•™ç©ºè¡Œï¼Œç”¨ç‰¹æ®Šæ ‡è®°
                lyrics.push({
                  time: time,
                  text: text || ' ', // ç©ºè¡Œç”¨ç©ºæ ¼ä»£æ›¿
                  type: text.includes('ã€') ? 'section' : (text ? 'verse' : 'empty')
                });
              }
            }
            
            // æŒ‰æ—¶é—´æ’åº
            lyrics.sort((a, b) => a.time - b.time);
            //console.log('LRCæ­Œè¯åŠ è½½å®Œæˆ:', lyrics.length, 'è¡Œ');
            } catch (error) {
             // æ— å¯¹åº”æ­Œè¯æ–‡ä»¶
             lyrics = [ { time: 0, text: 'è¯¥éŸ³ä¹æš‚æ— æ­Œè¯', type: 'verse' } ];
          }
        }

        let isPlaying = false;
        let currentLyricIndex = 0;
        let currentThemeColors = null; // å­˜å‚¨å½“å‰ä¸»é¢˜çš„å›ºå®šé¢œè‰²ç»„åˆ

        // æ›´æ–°éŸ³ä¹æ’­æ”¾å™¨ä¸»é¢˜è‰²
        function updateMusicPlayerTheme() {
          const musicPlayer = document.getElementById('music-player');
          if (!musicPlayer) return;
          
          // è·å–å½“å‰bodyæˆ–htmlä¸Šçš„ä¸»é¢˜ç±»
          const bodyClasses = document.body.className;
          const htmlClasses = document.documentElement.className;
          const allClasses = bodyClasses + ' ' + htmlClasses;
          
          //console.log('å½“å‰ä¸»é¢˜ç±»:', allClasses);
          
          // å®šä¹‰æ¯ä¸ªä¸»é¢˜çš„å¤šä¸ªé¢œè‰²ç»„åˆé€‰é¡¹
          const themeColorOptions = {
            'theme-16QwQ': [
              { primary: '#73CCFF', secondary: '#5BB3FF', accent: '#ACF06D', highlight: '#E8A469' },
              { primary: '#5BB3FF', secondary: '#73CCFF', accent: '#E8A469', highlight: '#ACF06D' },
              { primary: '#ACF06D', secondary: '#E8A469', accent: '#73CCFF', highlight: '#5BB3FF' }
            ],
            'theme-buxingshx': [
              { primary: '#00E874', secondary: '#00CC66', accent: '#00B0F0', highlight: '#B6FF47' },
              { primary: '#00CC66', secondary: '#00E874', accent: '#B6FF47', highlight: '#00B0F0' },
              { primary: '#00B0F0', secondary: '#B6FF47', accent: '#00E874', highlight: '#00CC66' }
            ],
            'theme-life': [
              { primary: '#A5EAFF', secondary: '#8DD8FF', accent: '#9EC4F6', highlight: '#BEFFF8' },
              { primary: '#8DD8FF', secondary: '#A5EAFF', accent: '#BEFFF8', highlight: '#9EC4F6' },
              { primary: '#9EC4F6', secondary: '#BEFFF8', accent: '#A5EAFF', highlight: '#8DD8FF' }
            ],
            'theme-purple': [
              { primary: '#65BFBE', secondary: '#4A9B9A', accent: '#DEEDA1', highlight: '#BDE031' },
              { primary: '#4A9B9A', secondary: '#65BFBE', accent: '#BDE031', highlight: '#DEEDA1' },
              { primary: '#DEEDA1', secondary: '#BDE031', accent: '#65BFBE', highlight: '#4A9B9A' }
            ],
            'theme-rainbow': [
              { primary: '#FFB78C', secondary: '#FFA066', accent: '#FFF08C', highlight: '#BBFF8C' },
              { primary: '#FFA066', secondary: '#FFB78C', accent: '#BBFF8C', highlight: '#FFF08C' },
              { primary: '#FFF08C', secondary: '#BBFF8C', accent: '#FFB78C', highlight: '#FFA066' }
            ],
            'theme-wonderful': [
              { primary: '#FF3B3E', secondary: '#E03437', accent: '#FF8657', highlight: '#FFBA70' },
              { primary: '#E03437', secondary: '#FF3B3E', accent: '#FFBA70', highlight: '#FF8657' },
              { primary: '#FF8657', secondary: '#FFBA70', accent: '#FF3B3E', highlight: '#E03437' }
            ],
            'theme-16yyds': [
              { primary: '#95a3f3', secondary: '#D1F33A', accent: '#C6DC74', highlight: '#A8BB92' },
              { primary: '#D1F33A', secondary: '#95a3f3', accent: '#A8BB92', highlight: '#C6DC74' },
              { primary: '#C6DC74', secondary: '#A8BB92', accent: '#95a3f3', highlight: '#D1F33A' }
            ],
            'default': [
              { primary: '#9AA3A0', secondary: '#6F7976', accent: '#C4B7A6', highlight: '#C4B7A6' },
              { primary: '#6F7976', secondary: '#9AA3A0', accent: '#C4B7A6', highlight: '#9AA3A0' },
              { primary: '#C4B7A6', secondary: '#C4B7A6', accent: '#9AA3A0', highlight: '#6F7976' }
            ]
          };
          
          // æ£€æµ‹å½“å‰ä¸»é¢˜å¹¶è·å–é¢œè‰²é€‰é¡¹
          let colorOptions = themeColorOptions.default;
          let currentTheme = 'default';
          
          for (const themeClass in themeColorOptions) {
            if (themeClass !== 'default' && allClasses.includes(themeClass)) {
              colorOptions = themeColorOptions[themeClass];
              currentTheme = themeClass;
              break;
            }
          }
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°éšæœºé€‰æ‹©é¢œè‰²ï¼ˆä¸»é¢˜å˜åŒ–æˆ–é¦–æ¬¡åŠ è½½ï¼‰
          const lastTheme = localStorage.getItem('musicPlayerLastTheme');
          if (lastTheme !== currentTheme || !currentThemeColors) {
            // éšæœºé€‰æ‹©ä¸€ä¸ªé¢œè‰²ç»„åˆ
            const randomIndex = Math.floor(Math.random() * colorOptions.length);
            currentThemeColors = colorOptions[randomIndex];
            localStorage.setItem('musicPlayerLastTheme', currentTheme);
            localStorage.setItem('musicPlayerColors', JSON.stringify(currentThemeColors));
            //console.log('ä¸»é¢˜å˜åŒ–ï¼Œé‡æ–°éšæœºé€‰æ‹©é¢œè‰²ç»„åˆ:', currentTheme, randomIndex);
          } else {
            // ä½¿ç”¨å­˜å‚¨çš„é¢œè‰²ç»„åˆ
            const storedColors = localStorage.getItem('musicPlayerColors');
            if (storedColors) {
              currentThemeColors = JSON.parse(storedColors);
            }
          }
          
          // æ”¹å–„å¯¹æ¯”åº¦ - ä¸ºæ­Œè¯é«˜äº®é€‰æ‹©æ›´å¥½çš„é¢œè‰²
          const { primary, secondary, accent, highlight } = currentThemeColors;
          
          // è®¡ç®—é¢œè‰²çš„äº®åº¦ï¼Œé€‰æ‹©å¯¹æ¯”åº¦æ›´å¥½çš„é¢œè‰²ä½œä¸ºæ­Œè¯é«˜äº®è‰²
          const getLuminance = (hex) => {
            const rgb = hexToRgb(hex);
            if (!rgb) return 0;
            const { r, g, b } = rgb;
            return (0.299 * r + 0.587 * g + 0.114 * b) / 255;
          };
          
          // é€‰æ‹©å¯¹æ¯”åº¦æœ€å¥½çš„é¢œè‰²ä½œä¸ºæ­Œè¯é«˜äº®è‰²
          const colors = [primary, secondary, accent, highlight];
          let bestContrastColor = accent;
          let bestContrast = 0;
          
          colors.forEach(color => {
            const luminance = getLuminance(color);
            const contrast = Math.abs(luminance - 0.5); // è·ç¦»ä¸­ç°åº¦çš„è·ç¦»
            if (contrast > bestContrast) {
              bestContrast = contrast;
              bestContrastColor = color;
            }
          });
          
          // è®¡ç®—èƒŒæ™¯äº®åº¦ï¼Œå†³å®šä½¿ç”¨æ·±è‰²è¿˜æ˜¯äº®è‰²æ–‡å­—
          const primaryLuminance = getLuminance(primary);
          const secondaryLuminance = getLuminance(secondary);
          const backgroundLuminance = (primaryLuminance + secondaryLuminance) / 2;
          
          let enhancedAccent;
          
          // æ ¹æ®èƒŒæ™¯äº®åº¦é€‰æ‹©å›ºå®šçš„é«˜å¯¹æ¯”åº¦é¢œè‰²
          if (backgroundLuminance > 0.5) {
            // èƒŒæ™¯è¾ƒäº®ï¼Œä½¿ç”¨å›ºå®šçš„æ·±è‰²æ–‡å­—ç¡®ä¿å¯¹æ¯”åº¦
            enhancedAccent = '#212596'; // é’äº‘è“
          } else {
            // èƒŒæ™¯è¾ƒæš—ï¼Œä½¿ç”¨å›ºå®šçš„äº®è‰²æ–‡å­—ç¡®ä¿å¯¹æ¯”åº¦
            enhancedAccent = '#FFFFFF'; // çº¯ç™½è‰²
          }
          
          //console.log('èƒŒæ™¯äº®åº¦:', backgroundLuminance, 'æ­Œè¯ä½¿ç”¨å›ºå®šé¢œè‰²:', enhancedAccent);
          
          //
          
          // æ›´æ–°CSSå˜é‡
          musicPlayer.style.setProperty('--primary-color', primary);
          musicPlayer.style.setProperty('--secondary-color', secondary);
          musicPlayer.style.setProperty('--accent-color', enhancedAccent);
          musicPlayer.style.setProperty('--highlight-color', highlight);
          
          // å¤„ç†RGBé¢œè‰²ç”¨äºrgba
          const accentRgb = hexToRgb(enhancedAccent);
          if (accentRgb) {
            musicPlayer.style.setProperty('--accent-color-rgb', `${accentRgb.r}, ${accentRgb.g}, ${accentRgb.b}`);
          }
        }
        
        // åå…­è¿›åˆ¶é¢œè‰²è½¬RGB
        function hexToRgb(hex) {
          const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
          } : null;
        }

        // åˆå§‹åŒ–éšæœºå°é¢
        function setRandomCover() {
          const randomImage = amuletImages[Math.floor(Math.random() * amuletImages.length)];
          coverImage.src = `src/assets/amulet/${randomImage}`;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
          const progress = (audio.currentTime / audio.duration) * 100;
          progressFill.style.width = progress + '%';
          currentTimeEl.textContent = formatTime(audio.currentTime);
        }

        // æ›´æ–°æ­Œè¯é«˜äº®
        function updateLyrics() {
          const currentTime = audio.currentTime;
          
          // æ‰¾åˆ°å½“å‰åº”è¯¥é«˜äº®çš„æ­Œè¯
          let activeIndex = -1;
          for (let i = 0; i < lyrics.length; i++) {
            if (lyrics[i].time <= currentTime) {
              activeIndex = i;
            } else {
              break;
            }
          }

          if (activeIndex !== currentLyricIndex) {
            currentLyricIndex = activeIndex;
            
            // ç§»é™¤æ‰€æœ‰é«˜äº®
            const verseElements = lyricsContent.querySelectorAll('.verse');
            verseElements.forEach(el => el.classList.remove('active', 'highlight'));
            
            // é«˜äº®å½“å‰æ­Œè¯
            if (activeIndex >= 0 && verseElements[activeIndex]) {
              verseElements[activeIndex].classList.add('active');
              
              // æ»šåŠ¨åˆ°å½“å‰æ­Œè¯
              verseElements[activeIndex].scrollIntoView({
                behavior: 'smooth',
                block: 'center'
              });
            }
          }
        }

        // æ¸²æŸ“æ­Œè¯
        function renderLyrics() {
          lyricsContent.innerHTML = lyrics.map(lyric => {
            let className = 'verse';
            if (lyric.type === 'section') {
              className = 'verse section';
            } else if (lyric.type === 'empty') {
              className = 'verse empty';
            }
            return `<div class="${className}">${lyric.text}</div>`;
          }).join('');
        }

        // æ’­æ”¾/æš‚åœ
        function togglePlayPause() {
          if (isPlaying) {
            audio.pause();
            playPauseBtn.textContent = 'â–¶ï¸';
            albumCover.classList.remove('playing');
          } else {
            audio.play();
            playPauseBtn.textContent = 'â¸ï¸';
            albumCover.classList.add('playing');
          }
          isPlaying = !isPlaying;
        }

        // åˆ‡æ¢æ­Œè¯æ˜¾ç¤º
        function toggleLyrics() {
          const isVisible = lyricsContainer.style.display !== 'none';
          lyricsContainer.style.display = isVisible ? 'none' : 'block';
          toggleLyricsBtn.textContent = isVisible ? 'ğŸ“' : 'ğŸ“–';
          
          // å¦‚æœæ­Œè¯æ˜¾ç¤ºä¸”æ’­æ”¾å™¨æœªå±•å¼€ï¼Œè‡ªåŠ¨å±•å¼€æ’­æ”¾å™¨
          if (!isVisible && musicPlayerBody.style.display === 'none') {
            musicPlayerBody.style.display = 'block';
            togglePlayerBtn.textContent = 'ğŸ”¼';
          }
        }

        // åˆ‡æ¢æ’­æ”¾å™¨å±•å¼€/æŠ˜å 
        function togglePlayer() {
          const isExpanded = musicPlayerBody.style.display !== 'none';
          musicPlayerBody.style.display = isExpanded ? 'none' : 'block';
          togglePlayerBtn.textContent = isExpanded ? 'ğŸ”½' : 'ğŸ”¼';
        }

        // ç‚¹å‡»è¿›åº¦æ¡è·³è½¬
        function seekTo(event) {
          const rect = progressBar.getBoundingClientRect();
          const clickX = event.clientX - rect.left;
          const percentage = clickX / rect.width;
          const newTime = percentage * audio.duration;
          audio.currentTime = newTime;
        }

        // åˆå§‹åŒ–å‡½æ•°
        async function initializeMusicPlayer() {
          setRandomCover();
          await parseLRCFile(); // åŠ è½½LRCæ­Œè¯
          renderLyrics();
            audio.volume = 0.5;
            updateMusicPlayerTheme(); // æ›´æ–°ä¸»é¢˜è‰²
            
            // æ’­æ”¾æ¨¡å¼ï¼š0 å•æ›²å¾ªç¯ï¼Œ1 åˆ—è¡¨å¾ªç¯ï¼Œ2 éšæœº
            let playMode = 1;
            // äº¤æ¢å›¾æ ‡ï¼šå•æ›²ğŸ”‚ï¼Œåˆ—è¡¨ğŸ”ï¼ŒéšæœºğŸ”€
            const modeIcons = ['ğŸ”‚','ğŸ”','ğŸ”€'];
            const updateModeIcon = () => { playModeBtn.textContent = modeIcons[playMode]; };
            updateModeIcon();
            playModeBtn.addEventListener('click', () => { 
              playMode = (playMode + 1) % 3; 
              updateModeIcon(); 
              // åŒæ­¥æ›´æ–°æ‚¬åœæç¤º
              const titles = ['æ’­æ”¾æ¨¡å¼ï¼šå•æ›²å¾ªç¯ (ğŸ”‚)','æ’­æ”¾æ¨¡å¼ï¼šåˆ—è¡¨å¾ªç¯ (ğŸ”)','æ’­æ”¾æ¨¡å¼ï¼šéšæœºæ’­æ”¾ (ğŸ”€)'];
              playModeBtn.title = titles[playMode];
            });
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨ï¼ˆç¡®ä¿DOMå…ƒç´ å·²å‡†å¤‡å¥½ï¼‰
          playPauseBtn.addEventListener('click', togglePlayPause);
          toggleLyricsBtn.addEventListener('click', toggleLyrics);
          togglePlayerBtn.addEventListener('click', togglePlayer);
          if (closePlayerBtn) closePlayerBtn.addEventListener('click', () => {
            const player = document.getElementById('music-player');
            if (!player || !musicMini) return;
            player.style.display = 'none';
            musicMini.style.display = 'flex';
          });
          if (musicMini) musicMini.addEventListener('click', () => {
            const player = document.getElementById('music-player');
            if (!player) return;
            player.style.display = 'block';
            musicMini.style.display = 'none';
          });
          progressBar.addEventListener('click', seekTo);

          // è¯»å–å¹¶åº”ç”¨ç”¨æˆ·è‡ªå®šä¹‰å®½åº¦
          try {
            const savedWidth = localStorage.getItem('musicPlayerWidth');
            if (savedWidth) {
              const player = document.getElementById('music-player');
              if (player) player.style.width = savedWidth + 'px';
            }
          } catch(_) {}

          // å®½åº¦æ‹–æ‹½è°ƒæ•´
          if (musicResizer) {
            let resizing = false;
            let startX = 0;
            let startWidth = 0;
            const player = document.getElementById('music-player');
            const minWidth = 360; // æœ€å°å®½åº¦
            const maxWidth = Math.max(window.innerWidth - 40, 480); // ä¿è¯ä¸è¶…å±

            const onMouseDown = (e) => {
              resizing = true;
              startX = e.clientX;
              startWidth = player ? player.offsetWidth : 0;
              document.body.style.cursor = 'ew-resize';
              e.preventDefault();
            };
            const onMouseMove = (e) => {
              if (!resizing || !player) return;
              // å·¦ä¾§æ‹–æ‹½ï¼šé¼ æ ‡å·¦ç§»åº”å¢å¤§å®½åº¦ï¼Œå³ç§»åº”å‡å°å®½åº¦ï¼Œä»…æ”¹å˜å®½åº¦
              const delta = e.clientX - startX; // é¼ æ ‡å³ç§»ä¸ºæ­£ã€å·¦ç§»ä¸ºè´Ÿ
              let newWidth = startWidth - delta;
              newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
              player.style.width = newWidth + 'px';
            };
            const onMouseUp = () => {
              if (!resizing || !player) return;
              resizing = false;
              document.body.style.cursor = '';
              try { localStorage.setItem('musicPlayerWidth', parseInt(player.style.width, 10)); } catch(_) {}
            };
            musicResizer.addEventListener('mousedown', onMouseDown);
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
          }

          audio.addEventListener('timeupdate', () => {
            updateProgress();
            updateLyrics();
          });

          audio.addEventListener('loadedmetadata', () => {
            totalTimeEl.textContent = formatTime(audio.duration);
          });

            audio.addEventListener('ended', async () => {
              const options = Array.from(musicSelect.options);
              const curSrc = audio.querySelector('source')?.getAttribute('src');
              const norm = (s) => decodeURIComponent(String(s || '')).toLowerCase();
              const curIdx = options.findIndex(o => norm(o.value) === norm(curSrc));

              const playCurrent = async () => {
                audio.currentTime = 0;
                await parseLRCFile();
                renderLyrics();
                audio.play().catch(()=>{});
              };
              const playByIndex = async (idx) => {
                if (!options.length) return playCurrent();
                const safeIdx = (idx + options.length) % options.length;
                const src = options[safeIdx].value;
                const sourceEl = audio.querySelector('source');
                if (sourceEl) sourceEl.setAttribute('src', src);
                audio.load();
                await parseLRCFile();
                renderLyrics();
                songTitleEl.textContent = options[safeIdx].textContent;
                audio.play().catch(()=>{});
                musicSelect.value = src;
              };

              // è¯»å–å½“å‰ç´¢å¼•ï¼ˆæ›´å¥å£®ï¼šè‹¥åŒ¹é…ä¸åˆ°åˆ™ç”¨ä¸‹æ‹‰å·²é€‰é¡¹æˆ–0ï¼‰
              const safeCurIdx = curIdx >= 0 ? curIdx : (musicSelect.selectedIndex >= 0 ? musicSelect.selectedIndex : 0);

              if (playMode === 0) {
                // å•æ›²å¾ªç¯
                await playCurrent();
              } else if (playMode === 1) {
                // åˆ—è¡¨å¾ªç¯ï¼ˆé¡ºåºï¼‰
                const nextIdx = (safeCurIdx + 1) % (options.length || 1);
                await playByIndex(nextIdx);
              } else {
                // éšæœº
                if (!options.length) return playCurrent();
                let nextIdx = Math.floor(Math.random() * options.length);
                if (options.length > 1 && nextIdx === safeCurIdx) nextIdx = (nextIdx + 1) % options.length;
                await playByIndex(nextIdx);
              }
            });

          volumeSlider.addEventListener('input', (e) => {
            audio.volume = e.target.value / 100;
          });
          
           // åŠ è½½éŸ³ä¹åˆ—è¡¨å¹¶å¡«å……é€‰æ‹©å™¨ï¼ˆéšè—æ‰©å±•åï¼‰
           try {
             const res = await fetch('/api/music/list');
             const data = await res.json();
             const files = Array.isArray(data.files) ? data.files : [];
             musicSelect.innerHTML = '';
             files.forEach(fn => {
               const opt = document.createElement('option');
               opt.value = `src/assets/music/${fn}`;
               opt.textContent = fn.replace(/\.[^.]+$/, '');
               musicSelect.appendChild(opt);
             });
             // åˆå§‹é»˜è®¤â€œäººç”Ÿä¹Ÿè®¸â€ï¼Œå¼‚æ­¥åŠ è½½å®Œåå†æŒ‰é¡ºåºå°è¯•æ’­æ”¾å…¶ä»–
             const preferred = 'src/assets/music/äººç”Ÿä¹Ÿè®¸.MP3';
             const sourceEl = audio.querySelector('source');
             if (sourceEl) sourceEl.setAttribute('src', preferred);
             audio.load();
             await parseLRCFile();
             renderLyrics();
             songTitleEl.textContent = 'äººç”Ÿä¹Ÿè®¸';
             // åŒæ­¥ä¸‹æ‹‰å½“å‰å€¼ï¼Œé¿å… ended æ—¶æ‰¾ä¸åˆ°å½“å‰ç´¢å¼•
             try { musicSelect.value = preferred; } catch(_) {}
             // è‹¥ç”¨æˆ·æ‰‹åŠ¨æ’­æ”¾åï¼Œæ ¹æ®æ’­æ”¾æ¨¡å¼å¤„ç† ended é€»è¾‘
           } catch(_) {}

           // åˆ‡æ¢æ­Œæ›²
           musicSelect.addEventListener('change', async () => {
             const src = musicSelect.value;
             const sourceEl = audio.querySelector('source');
             if (sourceEl) sourceEl.setAttribute('src', src);
             audio.load();
             await parseLRCFile();
             renderLyrics();
             songTitleEl.textContent = musicSelect.options[musicSelect.selectedIndex]?.textContent || '';
             if (isPlaying) audio.play().catch(()=>{});
           });

           //console.log('éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨æ’­æ”¾');
          
          // ç›‘å¬ä¸»é¢˜å˜åŒ–
          observeThemeChanges();
        }
        
        // ç›‘å¬ä¸»é¢˜å˜åŒ–
        function observeThemeChanges() {
          // åˆ›å»ºMutationObserverç›‘å¬DOMå˜åŒ–
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === 'attributes' && 
                  (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                // ä¸»é¢˜å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°éŸ³ä¹æ’­æ”¾å™¨ä¸»é¢˜è‰²
                //console.log('æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–:', mutation.attributeName);
                setTimeout(updateMusicPlayerTheme, 100);
              }
            });
          });
          
          // ç›‘å¬document.documentElementçš„å˜åŒ–
          observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['style', 'class']
          });
          
          // ä¹Ÿç›‘å¬bodyçš„å˜åŒ–
          observer.observe(document.body, {
            attributes: true,
            attributeFilter: ['style', 'class']
          });
          
          // ç›‘å¬æ‰€æœ‰å¯èƒ½çš„ä¸»é¢˜åˆ‡æ¢å…ƒç´ 
          const themeElements = document.querySelectorAll('[data-theme], .theme-switch, .color-picker, input[type="color"]');
          themeElements.forEach(el => {
            el.addEventListener('change', () => {
              //console.log('ä¸»é¢˜åˆ‡æ¢å…ƒç´ å˜åŒ–');
              setTimeout(updateMusicPlayerTheme, 200);
            });
            el.addEventListener('click', () => {
              //console.log('ä¸»é¢˜åˆ‡æ¢å…ƒç´ ç‚¹å‡»');
              setTimeout(updateMusicPlayerTheme, 200);
            });
          });
          
          // ç›‘å¬æ‰€æœ‰æŒ‰é’®ç‚¹å‡»ï¼ˆå¯èƒ½åŒ…å«ä¸»é¢˜åˆ‡æ¢ï¼‰
          document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.classList.contains('theme') || e.target.classList.contains('color')) {
              //('æ£€æµ‹åˆ°å¯èƒ½çš„ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ç‚¹å‡»');
              setTimeout(updateMusicPlayerTheme, 300);
            }
          });
          
          // å®šæœŸæ£€æŸ¥ä¸»é¢˜è‰²å˜åŒ–ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
          setInterval(() => {
            updateMusicPlayerTheme();
          }, 1000); // æ”¹ä¸º1ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        // æ‰§è¡Œåˆå§‹åŒ–
        initializeMusicPlayer();

        // æ¯15ç§’éšæœºæ›´æ¢å°é¢
        setInterval(setRandomCover, 15000);
      })();
    </script>
  </body>
  </html>


